# æŠ€æœ¯è®¾è®¡æ–‡æ¡£

## æ–‡æ¡£ä¿¡æ¯

### æ–‡æ¡£ä¿®è®¢å†å²

| ç‰ˆæœ¬ | æ—¥æœŸ       | ä½œè€…    | æè¿°                         |
|------|------------|---------|------------------------------|
| 1.1  | 2025-10-30 | dhc.qiangshi | å®Œæˆç³»ç»Ÿä¼˜åŒ–è°ƒæ•´ï¼Œç»Ÿä¸€æ•°æ®æ ¼å¼ï¼Œå®Œå–„ä¸šåŠ¡é€»è¾‘ï¼Œé‡æ„è®¤è¯æœºåˆ¶ï¼Œå¹¶å»ºç«‹å®Œæ•´çš„æµ‹è¯•ç­–ç•¥ã€‚ |
| 1.0  | 2025-08-19 | dhc.qiangshi | å®Œæˆç³»ç»ŸåŸºç¡€æ¶æ„æ­å»ºï¼ŒåŒ…æ‹¬ç”¨æˆ·æ³¨å†Œç™»å½•ã€è´¦æˆ·ç®¡ç†ã€é—®è¯¢ã€é¡¹ç›®åŠæ–‡ä»¶ç®¡ç†ç­‰æ ¸å¿ƒæ¨¡å—ã€‚ |

### æ–‡æ¡£è¯„å®¡å†å²

| ç‰ˆæœ¬ | æ—¥æœŸ       | è¯„å®¡äºº | è¯„è®º |
|------|------------|--------|------|
| 1.0  | 2025-07-28 |    |      |

## ç›®å½•

- [æŠ€æœ¯è®¾è®¡æ–‡æ¡£](#æŠ€æœ¯è®¾è®¡æ–‡æ¡£)
  - [æ–‡æ¡£ä¿¡æ¯](#æ–‡æ¡£ä¿¡æ¯)
    - [æ–‡æ¡£ä¿®è®¢å†å²](#æ–‡æ¡£ä¿®è®¢å†å²)
    - [æ–‡æ¡£è¯„å®¡å†å²](#æ–‡æ¡£è¯„å®¡å†å²)
  - [ç›®å½•](#ç›®å½•)
  - [1. é¡¹ç›®èƒŒæ™¯ä¸æ¦‚è¿°](#1-é¡¹ç›®èƒŒæ™¯ä¸æ¦‚è¿°)
    - [1.1 é¡¹ç›®éœ€æ±‚èƒŒæ™¯](#11-é¡¹ç›®éœ€æ±‚èƒŒæ™¯)
    - [1.2 æœ¯è¯­å’Œå®šä¹‰](#12-æœ¯è¯­å’Œå®šä¹‰)
    - [1.3 çº¦æŸ](#13-çº¦æŸ)
      - [1.3.1 ç”¨æˆ·çŠ¶æ€ç®¡ç†çº¦æŸ](#131-ç”¨æˆ·çŠ¶æ€ç®¡ç†çº¦æŸ)
        - [Portalç«¯](#portalç«¯)
        - [Viewç«¯](#viewç«¯)
    - [1.4 ç³»ç»Ÿæ¶æ„](#14-ç³»ç»Ÿæ¶æ„)
      - [1.4.1 Portalç«¯æ¶æ„æ—¶åºå›¾](#141-portalç«¯æ¶æ„æ—¶åºå›¾)
      - [1.4.2 WeChatæˆæƒæ³¨å†Œæµç¨‹](#142-wechatæˆæƒæ³¨å†Œæµç¨‹)
      - [1.4.3 Viewç«¯ä¸šåŠ¡æ—¶åºå›¾](#143-viewç«¯ä¸šåŠ¡æ—¶åºå›¾)
  - [2. Portalç«¯å…¬å…±æ¨¡å—è®¾è®¡åŠåŠŸèƒ½](#2-portalç«¯å…¬å…±æ¨¡å—è®¾è®¡åŠåŠŸèƒ½)
    - [2.1 å¾®ä¿¡æˆæƒç»„ä»¶è®¾è®¡](#21-å¾®ä¿¡æˆæƒç»„ä»¶è®¾è®¡)
      - [2.1.1 WechatAuthService](#211-wechatauthservice)
      - [2.1.2 WechatMessageService](#212-wechatmessageservice)
      - [2.1.3 æ¶‰åŠæ•°æ®è¡¨](#213-æ¶‰åŠæ•°æ®è¡¨)
    - [2.2 è®¤è¯æˆæƒç»„ä»¶è®¾è®¡](#22-è®¤è¯æˆæƒç»„ä»¶è®¾è®¡)
      - [2.2.1 ç»„ä»¶å…³ç³»è¯´æ˜](#221-ç»„ä»¶å…³ç³»è¯´æ˜)
      - [2.2.2 AuthMiddleware](#222-authmiddleware)
      - [2.2.3 PermissionMiddleware](#223-permissionmiddleware)
      - [2.2.4 UserPermissionService](#224-userpermissionservice)
      - [2.2.5 ç±»å…³ç³»å›¾](#225-ç±»å…³ç³»å›¾)
    - [2.3 å…¬å…±ä¸šåŠ¡ç»„ä»¶è®¾è®¡](#23-å…¬å…±ä¸šåŠ¡ç»„ä»¶è®¾è®¡)
      - [2.3.1 CompanyService](#231-companyservice)
      - [2.3.2 SmsVerificationService](#232-smsverificationservice)
      - [2.3.3 æ¶‰åŠæ•°æ®è¡¨](#233-æ¶‰åŠæ•°æ®è¡¨)
    - [2.4 ç³»ç»Ÿé›†æˆç»„ä»¶è®¾è®¡](#24-ç³»ç»Ÿé›†æˆç»„ä»¶è®¾è®¡)
      - [2.4.1 InterSystemService](#241-intersystemservice)
    - [2.5 Laravelå†…ç½®åŠŸèƒ½å®ç°](#25-laravelå†…ç½®åŠŸèƒ½å®ç°)
      - [2.5.1 é™æµæ§åˆ¶](#251-é™æµæ§åˆ¶)
      - [2.5.2 æ—¥å¿—è®°å½•](#252-æ—¥å¿—è®°å½•)
      - [2.5.3 ç³»ç»Ÿé…ç½®](#253-ç³»ç»Ÿé…ç½®)
      - [2.5.4 å›½é™…åŒ–](#254-å›½é™…åŒ–)
    - [2.6 å¼‚å¸¸å¤„ç†ç»„ä»¶è®¾è®¡](#26-å¼‚å¸¸å¤„ç†ç»„ä»¶è®¾è®¡)
      - [2.6.1 ç»Ÿä¸€å¼‚å¸¸å¤„ç†](#261-ç»Ÿä¸€å¼‚å¸¸å¤„ç†)
      - [2.6.2 å‰ç«¯é”™è¯¯å¤„ç†](#262-å‰ç«¯é”™è¯¯å¤„ç†)
    - [2.7 å…¬å…±æ¨¡å—æ€»ç»“](#27-å…¬å…±æ¨¡å—æ€»ç»“)
      - [2.7.1 ç»„ä»¶ä¾èµ–å…³ç³»å›¾](#271-ç»„ä»¶ä¾èµ–å…³ç³»å›¾)
      - [2.7.2 æ ¸å¿ƒæ¨¡å—åˆ—è¡¨](#272-æ ¸å¿ƒæ¨¡å—åˆ—è¡¨)
  - [3. Portalç«¯ ä¸šåŠ¡æµç¨‹è®¾è®¡](#3-portalç«¯-ä¸šåŠ¡æµç¨‹è®¾è®¡)
    - [3.1 æ³¨å†Œä¸šåŠ¡æ¨¡å—](#31-æ³¨å†Œä¸šåŠ¡æ¨¡å—)
      - [3.1.1 ä¸šåŠ¡æµç¨‹](#311-ä¸šåŠ¡æµç¨‹)
      - [3.1.2 å½±å“çš„æ•°æ®è¡¨](#312-å½±å“çš„æ•°æ®è¡¨)
      - [3.1.3 å‰ç«¯å®ç°](#313-å‰ç«¯å®ç°)
        - [3.1.3.1 è§†å›¾ç›®å½•ç»“æ„](#3131-è§†å›¾ç›®å½•ç»“æ„)
        - [3.1.3.2 å…³é”®ç»„ä»¶åŠŸèƒ½](#3132-å…³é”®ç»„ä»¶åŠŸèƒ½)
        - [3.1.3.3 APIè®¾è®¡](#3133-apiè®¾è®¡)
      - [3.1.4 åŠŸèƒ½å¼€å‘ä¸å®ç°](#314-åŠŸèƒ½å¼€å‘ä¸å®ç°)
        - [3.1.4.1 ç±»å…³ç³»å›¾](#3141-ç±»å…³ç³»å›¾)
        - [3.1.4.2 ä»£ç å®ç°](#3142-ä»£ç å®ç°)
    - [3.2 ç™»å½•ä¸šåŠ¡æ¨¡å—](#32-ç™»å½•ä¸šåŠ¡æ¨¡å—)
      - [3.2.1 ä¸šåŠ¡æµç¨‹](#321-ä¸šåŠ¡æµç¨‹)
        - [3.2.1.1 ä¸šåŠ¡èƒŒæ™¯](#3211-ä¸šåŠ¡èƒŒæ™¯)
      - [3.2.2 å½±å“çš„æ•°æ®è¡¨](#322-å½±å“çš„æ•°æ®è¡¨)
      - [3.2.3 å‰ç«¯å®ç°](#323-å‰ç«¯å®ç°)
        - [3.2.3.1 è§†å›¾ç›®å½•ç»“æ„](#3231-è§†å›¾ç›®å½•ç»“æ„)
        - [3.2.3.2 å…³é”®ç»„ä»¶åŠŸèƒ½](#3232-å…³é”®ç»„ä»¶åŠŸèƒ½)
        - [3.2.3.3 APIè®¾è®¡](#3233-apiè®¾è®¡)
      - [3.2.4 åŠŸèƒ½å¼€å‘ä¸å®ç°](#324-åŠŸèƒ½å¼€å‘ä¸å®ç°)
        - [3.2.4.1 ç±»å…³ç³»å›¾](#3241-ç±»å…³ç³»å›¾)
        - [3.2.4.2 ä»£ç å®ç°](#3242-ä»£ç å®ç°)
    - [3.3 MyInfo æ¨¡å—](#33-myinfo-æ¨¡å—)
      - [3.3.1 ä¸šåŠ¡æµç¨‹](#331-ä¸šåŠ¡æµç¨‹)
        - [3.3.1.1 ä¸šåŠ¡èƒŒæ™¯](#3311-ä¸šåŠ¡èƒŒæ™¯)
      - [3.3.2 å½±å“çš„æ•°æ®è¡¨](#332-å½±å“çš„æ•°æ®è¡¨)
      - [3.3.3 å‰ç«¯å®ç°](#333-å‰ç«¯å®ç°)
        - [3.3.3.1 è§†å›¾ç›®å½•ç»“æ„](#3331-è§†å›¾ç›®å½•ç»“æ„)
        - [3.3.3.2 å…³é”®ç»„ä»¶åŠŸèƒ½](#3332-å…³é”®ç»„ä»¶åŠŸèƒ½)
        - [3.3.3.3 APIè®¾è®¡](#3333-apiè®¾è®¡)
      - [3.3.4 åŠŸèƒ½å¼€å‘ä¸å®ç°](#334-åŠŸèƒ½å¼€å‘ä¸å®ç°)
        - [3.3.4.1 ç±»å…³ç³»å›¾](#3341-ç±»å…³ç³»å›¾)
        - [3.3.4.2 ä»£ç å®ç°](#3342-ä»£ç å®ç°)
    - [3.4 Inquiry æ¨¡å—](#34-inquiry-æ¨¡å—)
      - [3.4.1 ä¸šåŠ¡æµç¨‹](#341-ä¸šåŠ¡æµç¨‹)
        - [3.4.1.1 ä¸šåŠ¡èƒŒæ™¯](#3411-ä¸šåŠ¡èƒŒæ™¯)
      - [3.4.2 å½±å“çš„æ•°æ®è¡¨](#342-å½±å“çš„æ•°æ®è¡¨)
      - [3.4.3 å‰ç«¯å®ç°](#343-å‰ç«¯å®ç°)
        - [3.4.3.1 è§†å›¾ç›®å½•ç»“æ„](#3431-è§†å›¾ç›®å½•ç»“æ„)
        - [3.4.3.2 å…³é”®ç»„ä»¶åŠŸèƒ½](#3432-å…³é”®ç»„ä»¶åŠŸèƒ½)
        - [3.4.3.3 APIè®¾è®¡](#3433-apiè®¾è®¡)
      - [3.4.4 åŠŸèƒ½å¼€å‘ä¸å®ç°](#344-åŠŸèƒ½å¼€å‘ä¸å®ç°)
        - [3.4.4.1 ç±»å…³ç³»å›¾](#3441-ç±»å…³ç³»å›¾)
        - [3.4.4.2 ä»£ç å®ç°](#3442-ä»£ç å®ç°)
    - [3.5 Projectæ¨¡å—](#35-projectæ¨¡å—)
      - [3.5.1 ä¸šåŠ¡æµç¨‹](#351-ä¸šåŠ¡æµç¨‹)
        - [3.5.1.1 ä¸šåŠ¡èƒŒæ™¯](#3511-ä¸šåŠ¡èƒŒæ™¯)
      - [3.5.2 å½±å“çš„æ•°æ®è¡¨](#352-å½±å“çš„æ•°æ®è¡¨)
      - [3.5.3 å‰ç«¯å®ç°](#353-å‰ç«¯å®ç°)
        - [3.5.3.1 è§†å›¾ç›®å½•ç»“æ„](#3531-è§†å›¾ç›®å½•ç»“æ„)
        - [3.5.3.2 å…³é”®ç»„ä»¶åŠŸèƒ½](#3532-å…³é”®ç»„ä»¶åŠŸèƒ½)
        - [3.5.3.3 APIè®¾è®¡](#3533-apiè®¾è®¡)
      - [3.5.4 åŠŸèƒ½å¼€å‘ä¸å®ç°](#354-åŠŸèƒ½å¼€å‘ä¸å®ç°)
        - [3.5.4.1 ç±»å…³ç³»å›¾](#3541-ç±»å…³ç³»å›¾)
        - [3.5.4.2 ä»£ç å®ç°](#3542-ä»£ç å®ç°)
    - [3.6 TKE Libraryæ¨¡å—](#36-tke-libraryæ¨¡å—)
      - [3.6.1 ä¸šåŠ¡æµç¨‹](#361-ä¸šåŠ¡æµç¨‹)
        - [3.6.1.1 ä¸šåŠ¡èƒŒæ™¯](#3611-ä¸šåŠ¡èƒŒæ™¯)
      - [3.6.2 å½±å“çš„æ•°æ®è¡¨](#362-å½±å“çš„æ•°æ®è¡¨)
      - [3.6.3 å‰ç«¯å®ç°](#363-å‰ç«¯å®ç°)
        - [3.6.3.1 è§†å›¾ç›®å½•ç»“æ„](#3631-è§†å›¾ç›®å½•ç»“æ„)
        - [3.6.3.2 å…³é”®ç»„ä»¶åŠŸèƒ½](#3632-å…³é”®ç»„ä»¶åŠŸèƒ½)
        - [3.6.3.3 TKE Library APIè®¾è®¡](#3633-tke-library-apiè®¾è®¡)
      - [3.6.4 åŠŸèƒ½å¼€å‘ä¸å®ç°](#364-åŠŸèƒ½å¼€å‘ä¸å®ç°)
        - [3.6.4.1 ç±»å…³ç³»å›¾](#3641-ç±»å…³ç³»å›¾)
        - [3.6.4.2 ä»£ç å®ç°](#3642-ä»£ç å®ç°)
    - [3.7 AGR Homepage](#37-agr-homepage)
      - [3.7.1 ä¸šåŠ¡æµç¨‹](#371-ä¸šåŠ¡æµç¨‹)
        - [3.7.1.1 ä¸šåŠ¡èƒŒæ™¯](#3711-ä¸šåŠ¡èƒŒæ™¯)
      - [3.7.2 æ•°æ®è¡¨è®¾è®¡](#372-æ•°æ®è¡¨è®¾è®¡)
      - [3.7.3 åŠŸèƒ½å¼€å‘ä¸å®ç°](#373-åŠŸèƒ½å¼€å‘ä¸å®ç°)
        - [3.7.3.1 ç±»å…³ç³»å›¾](#3731-ç±»å…³ç³»å›¾)
        - [3.7.3.2 APIè®¾è®¡](#3732-apiè®¾è®¡)
        - [3.7.3.3 ä»£ç å®ç°](#3733-ä»£ç å®ç°)
  - [4. Portalç«¯ Testing Strategy](#4-portalç«¯-testing-strategy)
    - [4.1 PHPUnit å•å…ƒæµ‹è¯•è®¾è®¡](#41-phpunit-å•å…ƒæµ‹è¯•è®¾è®¡)
      - [4.1.1 æœåŠ¡å±‚æµ‹è¯•è®¾è®¡](#411-æœåŠ¡å±‚æµ‹è¯•è®¾è®¡)
        - [4.1.1.1 Registration æ¨¡å—æœåŠ¡æµ‹è¯•](#4111-registration-æ¨¡å—æœåŠ¡æµ‹è¯•)
        - [4.1.1.2 Login æ¨¡å—æœåŠ¡æµ‹è¯•](#4112-login-æ¨¡å—æœåŠ¡æµ‹è¯•)
        - [4.1.1.3 MyInfo æ¨¡å—æœåŠ¡æµ‹è¯•](#4113-myinfo-æ¨¡å—æœåŠ¡æµ‹è¯•)
        - [4.1.1.4 Inquiry æ¨¡å—æœåŠ¡æµ‹è¯•](#4114-inquiry-æ¨¡å—æœåŠ¡æµ‹è¯•)
        - [4.1.1.5 Project æ¨¡å—æœåŠ¡æµ‹è¯•](#4115-project-æ¨¡å—æœåŠ¡æµ‹è¯•)
        - [4.1.1.6 TKE Library æ¨¡å—æœåŠ¡æµ‹è¯•](#4116-tke-library-æ¨¡å—æœåŠ¡æµ‹è¯•)
        - [4.1.1.7 AGR Homepage æ¨¡å—æœåŠ¡æµ‹è¯•](#4117-agr-homepage-æ¨¡å—æœåŠ¡æµ‹è¯•)
    - [4.2 BDDæµ‹è¯•æ¡†æ¶ï¼ˆCucumberï¼‰](#42-bddæµ‹è¯•æ¡†æ¶cucumber)
      - [4.2 BDD æµ‹è¯•æ¡†æ¶ï¼ˆCucumberï¼‰](#42-bdd-æµ‹è¯•æ¡†æ¶cucumber)
        - [4.2.1.1 æ³¨å†Œå…¨æµç¨‹](#4211-æ³¨å†Œå…¨æµç¨‹)
        - [4.2.1.2 ç™»å½•ä¸å…¬å¸åˆ‡æ¢](#4212-ç™»å½•ä¸å…¬å¸åˆ‡æ¢)
        - [4.2.1.3 MyInfo ä¿¡æ¯ç»´æŠ¤](#4213-myinfo-ä¿¡æ¯ç»´æŠ¤)
        - [4.2.1.4 Inquiry é—®è¯¢æµç¨‹](#4214-inquiry-é—®è¯¢æµç¨‹)
        - [4.2.1.5 Project é¡¹ç›®ç®¡ç†](#4215-project-é¡¹ç›®ç®¡ç†)
        - [4.2.1.6 TKE Library æ–‡ä»¶è®¿é—®](#4216-tke-library-æ–‡ä»¶è®¿é—®)
        - [4.2.1.7 AGR è·³è½¬æµç¨‹](#4217-agr-è·³è½¬æµç¨‹)
  - [5. Viewç«¯å…¬å…±ç»„ä»¶è®¾è®¡](#5-viewç«¯å…¬å…±ç»„ä»¶è®¾è®¡)
    - [5.1 æ•°æ®æ¥æ”¶è·¯ç”±ç»„ä»¶](#51-æ•°æ®æ¥æ”¶è·¯ç”±ç»„ä»¶)
      - [5.1.1 ModChannelDataReceiver](#511-modchanneldatareceiver)
      - [5.1.2 æ•°æ®åˆ†å‘è·¯ç”±é€»è¾‘](#512-æ•°æ®åˆ†å‘è·¯ç”±é€»è¾‘)
    - [5.2 ä¸šåŠ¡æ•°æ®å¤„ç†æœåŠ¡ï¼ˆHandlerï¼‰](#52-ä¸šåŠ¡æ•°æ®å¤„ç†æœåŠ¡handler)
      - [5.2.1 UserRegistrationHandler](#521-userregistrationhandler)
      - [5.2.2 InquiryHandler](#522-inquiryhandler)
      - [5.2.3 ProjectHandler](#523-projecthandler)
      - [5.2.4 UserDataPullHandler](#524-userdatapullhandler)
    - [5.3 æ•°æ®æ¨é€ç»„ä»¶](#53-æ•°æ®æ¨é€ç»„ä»¶)
      - [5.3.1 ModChannelDataSender](#531-modchanneldatasender)
    - [5.4 é€šçŸ¥æœåŠ¡ç»„ä»¶](#54-é€šçŸ¥æœåŠ¡ç»„ä»¶)
      - [5.4.1 ModChannelNotificationService](#541-modchannelnotificationservice)
    - [5.5 ModChannelé›†æˆé…ç½®ç®¡ç†](#55-modchannelé›†æˆé…ç½®ç®¡ç†)
      - [5.5.1 é™æµæ§åˆ¶](#551-é™æµæ§åˆ¶)
      - [5.5.2 ç³»ç»Ÿé…ç½®](#552-ç³»ç»Ÿé…ç½®)
  - [6. CNViewç«¯ ä¸šåŠ¡æµç¨‹è®¾è®¡](#6-cnviewç«¯-ä¸šåŠ¡æµç¨‹è®¾è®¡)
    - [6.1 Channel Partner Uploadæ¨¡å—](#61-channel-partner-uploadæ¨¡å—)
      - [6.1.1 ä¸šåŠ¡æµç¨‹](#611-ä¸šåŠ¡æµç¨‹)
        - [6.1.1.1 ä¸šåŠ¡èƒŒæ™¯](#6111-ä¸šåŠ¡èƒŒæ™¯)
      - [6.1.2 å½±å“çš„æ•°æ®è¡¨](#612-å½±å“çš„æ•°æ®è¡¨)
      - [6.1.3 å‰ç«¯å®ç°](#613-å‰ç«¯å®ç°)
        - [6.1.3.1 è§†å›¾ç›®å½•ç»“æ„](#6131-è§†å›¾ç›®å½•ç»“æ„)
        - [6.1.3.2 å…³é”®è§†å›¾åŠŸèƒ½](#6132-å…³é”®è§†å›¾åŠŸèƒ½)
        - [6.1.3.3 è·¯ç”±è®¾è®¡](#6133-è·¯ç”±è®¾è®¡)
        - [6.1.3.4 æ—¥å¿—è®°å½•](#6134-æ—¥å¿—è®°å½•)
      - [6.1.5 åŠŸèƒ½å¼€å‘ä¸å®ç°](#615-åŠŸèƒ½å¼€å‘ä¸å®ç°)
        - [6.1.5.1 ç±»å…³ç³»å›¾](#6151-ç±»å…³ç³»å›¾)
        - [6.1.5.2 ä»£ç å®ç°](#6152-ä»£ç å®ç°)
    - [6.2 Channel Partner Dashboardæ¨¡å—](#62-channel-partner-dashboardæ¨¡å—)
      - [6.2.1 ä¸šåŠ¡æµç¨‹](#621-ä¸šåŠ¡æµç¨‹)
        - [6.2.1.1 ä¸šåŠ¡èƒŒæ™¯](#6211-ä¸šåŠ¡èƒŒæ™¯)
      - [6.2.2 å½±å“çš„æ•°æ®è¡¨](#622-å½±å“çš„æ•°æ®è¡¨)
      - [6.2.3 å‰ç«¯å®ç°](#623-å‰ç«¯å®ç°)
        - [6.2.3.1 è§†å›¾ç›®å½•ç»“æ„](#6231-è§†å›¾ç›®å½•ç»“æ„)
        - [6.2.3.2 å…³é”®è§†å›¾åŠŸèƒ½](#6232-å…³é”®è§†å›¾åŠŸèƒ½)
      - [6.2.4 è·¯ç”±è®¾è®¡](#624-è·¯ç”±è®¾è®¡)
      - [6.2.5 é”™è¯¯å¤„ç†å’Œæ—¥å¿—è®°å½•](#625-é”™è¯¯å¤„ç†å’Œæ—¥å¿—è®°å½•)
        - [6.2.5.1 æ—¥å¿—è®°å½•](#6251-æ—¥å¿—è®°å½•)
      - [6.2.6 åŠŸèƒ½å¼€å‘ä¸å®ç°](#626-åŠŸèƒ½å¼€å‘ä¸å®ç°)
        - [6.2.6.1 ç±»å…³ç³»å›¾](#6261-ç±»å…³ç³»å›¾)
        - [6.2.6.2 ä»£ç å®ç°](#6262-ä»£ç å®ç°)
    - [6.3 Channel Partner Approvalæ¨¡å—](#63-channel-partner-approvalæ¨¡å—)
      - [6.3.1 ä¸šåŠ¡æµç¨‹](#631-ä¸šåŠ¡æµç¨‹)
        - [6.3.1.1 ä¸šåŠ¡èƒŒæ™¯](#6311-ä¸šåŠ¡èƒŒæ™¯)
      - [6.3.2 å½±å“çš„æ•°æ®è¡¨](#632-å½±å“çš„æ•°æ®è¡¨)
      - [6.3.3 å‰ç«¯å®ç°](#633-å‰ç«¯å®ç°)
        - [6.3.3.1 è§†å›¾ç›®å½•ç»“æ„](#6331-è§†å›¾ç›®å½•ç»“æ„)
        - [6.3.3.2 å…³é”®è§†å›¾åŠŸèƒ½](#6332-å…³é”®è§†å›¾åŠŸèƒ½)
      - [6.3.4 è·¯ç”±è®¾è®¡](#634-è·¯ç”±è®¾è®¡)
      - [6.3.5 é”™è¯¯å¤„ç†å’Œæ—¥å¿—è®°å½•](#635-é”™è¯¯å¤„ç†å’Œæ—¥å¿—è®°å½•)
        - [6.3.5.1 æ—¥å¿—è®°å½•](#6351-æ—¥å¿—è®°å½•)
      - [6.3.6 åŠŸèƒ½å¼€å‘ä¸å®ç°](#636-åŠŸèƒ½å¼€å‘ä¸å®ç°)
        - [6.3.6.1 ç±»å…³ç³»å›¾](#6361-ç±»å…³ç³»å›¾)
        - [6.3.6.2 æ§åˆ¶å™¨å®ç°](#6362-æ§åˆ¶å™¨å®ç°)
    - [6.4 Channel Partner Status Summaryæ¨¡å—](#64-channel-partner-status-summaryæ¨¡å—)
      - [6.4.1 ä¸šåŠ¡æµç¨‹](#641-ä¸šåŠ¡æµç¨‹)
        - [6.4.1.1 ä¸šåŠ¡èƒŒæ™¯](#6411-ä¸šåŠ¡èƒŒæ™¯)
      - [6.4.2 å½±å“çš„æ•°æ®è¡¨](#642-å½±å“çš„æ•°æ®è¡¨)
      - [6.4.3 å‰ç«¯å®ç°](#643-å‰ç«¯å®ç°)
        - [6.4.3.1 è§†å›¾ç›®å½•ç»“æ„](#6431-è§†å›¾ç›®å½•ç»“æ„)
        - [6.4.3.2 å…³é”®ç»„ä»¶åŠŸèƒ½](#6432-å…³é”®ç»„ä»¶åŠŸèƒ½)
        - [6.4.3.3 è·¯ç”±è®¾è®¡](#6433-è·¯ç”±è®¾è®¡)
      - [6.4.4 é”™è¯¯å¤„ç†å’Œæ—¥å¿—è®°å½•](#644-é”™è¯¯å¤„ç†å’Œæ—¥å¿—è®°å½•)
        - [6.4.4.1 æ—¥å¿—è®°å½•](#6441-æ—¥å¿—è®°å½•)
      - [6.4.5 åŠŸèƒ½å¼€å‘ä¸å®ç°](#645-åŠŸèƒ½å¼€å‘ä¸å®ç°)
        - [6.4.5.1 ç±»å…³ç³»å›¾](#6451-ç±»å…³ç³»å›¾)
        - [6.4.5.2 ä»£ç å®ç°](#6452-ä»£ç å®ç°)
    - [6.5 Pre-Lead Project Upload, Creation and Updatesæ¨¡å—](#65-pre-lead-project-upload-creation-and-updatesæ¨¡å—)
      - [6.5.1 ä¸šåŠ¡æµç¨‹](#651-ä¸šåŠ¡æµç¨‹)
        - [6.5.1.1 ä¸šåŠ¡èƒŒæ™¯](#6511-ä¸šåŠ¡èƒŒæ™¯)
      - [6.5.2 å½±å“çš„æ•°æ®è¡¨](#652-å½±å“çš„æ•°æ®è¡¨)
      - [6.5.3 å‰ç«¯å®ç°](#653-å‰ç«¯å®ç°)
        - [6.5.3.1 è§†å›¾ç›®å½•ç»“æ„](#6531-è§†å›¾ç›®å½•ç»“æ„)
        - [6.5.3.2 å…³é”®ç»„ä»¶åŠŸèƒ½](#6532-å…³é”®ç»„ä»¶åŠŸèƒ½)
        - [6.5.3.3 è·¯ç”±è®¾è®¡](#6533-è·¯ç”±è®¾è®¡)
      - [6.5.4 é”™è¯¯å¤„ç†å’Œæ—¥å¿—è®°å½•](#654-é”™è¯¯å¤„ç†å’Œæ—¥å¿—è®°å½•)
        - [6.5.4.1 æ—¥å¿—è®°å½•](#6541-æ—¥å¿—è®°å½•)
      - [6.5.5 åŠŸèƒ½å¼€å‘ä¸å®ç°](#655-åŠŸèƒ½å¼€å‘ä¸å®ç°)
        - [6.5.5.1 ç±»å…³ç³»å›¾](#6551-ç±»å…³ç³»å›¾)
        - [6.5.5.2 ä»£ç å®ç°](#6552-ä»£ç å®ç°)
    - [6.6 Channel Partner Project Summaryæ¨¡å—](#66-channel-partner-project-summaryæ¨¡å—)
      - [6.6.1 ä¸šåŠ¡æµç¨‹](#661-ä¸šåŠ¡æµç¨‹)
        - [6.6.1.1 ä¸šåŠ¡èƒŒæ™¯](#6611-ä¸šåŠ¡èƒŒæ™¯)
      - [6.6.2 å½±å“çš„æ•°æ®è¡¨](#662-å½±å“çš„æ•°æ®è¡¨)
      - [6.6.3 å‰ç«¯å®ç°](#663-å‰ç«¯å®ç°)
        - [6.6.3.1 è§†å›¾ç›®å½•ç»“æ„](#6631-è§†å›¾ç›®å½•ç»“æ„)
        - [6.6.3.2 å…³é”®ç»„ä»¶åŠŸèƒ½](#6632-å…³é”®ç»„ä»¶åŠŸèƒ½)
        - [6.6.3.3 è·¯ç”±è®¾è®¡](#6633-è·¯ç”±è®¾è®¡)
      - [6.6.4 é”™è¯¯å¤„ç†å’Œæ—¥å¿—è®°å½•](#664-é”™è¯¯å¤„ç†å’Œæ—¥å¿—è®°å½•)
        - [6.6.4.1 æ—¥å¿—è®°å½•](#6641-æ—¥å¿—è®°å½•)
      - [6.6.5 åŠŸèƒ½å¼€å‘ä¸å®ç°](#665-åŠŸèƒ½å¼€å‘ä¸å®ç°)
        - [6.6.5.1 ç±»å…³ç³»å›¾](#6651-ç±»å…³ç³»å›¾)
        - [6.6.5.2 ä»£ç å®ç°](#6652-ä»£ç å®ç°)
    - [6.7 Channel Partner Project Reportæ¨¡å—](#67-channel-partner-project-reportæ¨¡å—)
      - [6.7.1 ä¸šåŠ¡æµç¨‹](#671-ä¸šåŠ¡æµç¨‹)
        - [6.7.1.1 ä¸šåŠ¡èƒŒæ™¯](#6711-ä¸šåŠ¡èƒŒæ™¯)
      - [6.7.2 å½±å“çš„æ•°æ®è¡¨](#672-å½±å“çš„æ•°æ®è¡¨)
      - [6.7.3 å‰ç«¯å®ç°](#673-å‰ç«¯å®ç°)
        - [6.7.3.1 è§†å›¾ç›®å½•ç»“æ„](#6731-è§†å›¾ç›®å½•ç»“æ„)
        - [6.7.3.2 å…³é”®ç»„ä»¶åŠŸèƒ½](#6732-å…³é”®ç»„ä»¶åŠŸèƒ½)
        - [6.7.3.3 è·¯ç”±è®¾è®¡](#6733-è·¯ç”±è®¾è®¡)
      - [6.7.4 é”™è¯¯å¤„ç†å’Œæ—¥å¿—è®°å½•](#674-é”™è¯¯å¤„ç†å’Œæ—¥å¿—è®°å½•)
        - [6.7.4.1 æ—¥å¿—è®°å½•](#6741-æ—¥å¿—è®°å½•)
      - [6.7.5 åŠŸèƒ½å¼€å‘ä¸å®ç°](#675-åŠŸèƒ½å¼€å‘ä¸å®ç°)
        - [6.7.5.1 ç±»å…³ç³»å›¾](#6751-ç±»å…³ç³»å›¾)
        - [6.7.5.2 ä»£ç å®ç°](#6752-ä»£ç å®ç°)
    - [6.8 Inquiry æ¨¡å—](#68-inquiry-æ¨¡å—)
      - [6.8.1 ä¸šåŠ¡æµç¨‹](#681-ä¸šåŠ¡æµç¨‹)
        - [6.8.1.1 ä¸šåŠ¡èƒŒæ™¯](#6811-ä¸šåŠ¡èƒŒæ™¯)
      - [6.8.2 å½±å“çš„æ•°æ®è¡¨](#682-å½±å“çš„æ•°æ®è¡¨)
      - [6.8.3 å‰ç«¯å®ç°](#683-å‰ç«¯å®ç°)
        - [6.8.3.1 è§†å›¾ç›®å½•ç»“æ„](#6831-è§†å›¾ç›®å½•ç»“æ„)
        - [6.8.3.2 å…³é”®ç»„ä»¶åŠŸèƒ½](#6832-å…³é”®ç»„ä»¶åŠŸèƒ½)
        - [6.8.3.3 è·¯ç”±è®¾è®¡](#6833-è·¯ç”±è®¾è®¡)
      - [6.8.4 é”™è¯¯å¤„ç†å’Œæ—¥å¿—è®°å½•](#684-é”™è¯¯å¤„ç†å’Œæ—¥å¿—è®°å½•)
        - [6.8.4.1 æ—¥å¿—è®°å½•](#6841-æ—¥å¿—è®°å½•)
      - [6.8.5 åŠŸèƒ½å¼€å‘ä¸å®ç°](#685-åŠŸèƒ½å¼€å‘ä¸å®ç°)
        - [6.8.5.1 ç±»å…³ç³»å›¾](#6851-ç±»å…³ç³»å›¾)
        - [6.8.5.2 ä»£ç å®ç°](#6852-ä»£ç å®ç°)
    - [6.9 TKE Libraryæ¨¡å—](#69-tke-libraryæ¨¡å—)
      - [6.9.1 ä¸šåŠ¡æµç¨‹](#691-ä¸šåŠ¡æµç¨‹)
        - [6.9.1.1 ä¸šåŠ¡èƒŒæ™¯](#6911-ä¸šåŠ¡èƒŒæ™¯)
      - [6.9.2 å½±å“çš„æ•°æ®è¡¨](#692-å½±å“çš„æ•°æ®è¡¨)
      - [6.9.3 å‰ç«¯å®ç°](#693-å‰ç«¯å®ç°)
        - [6.9.3.1 è§†å›¾ç›®å½•ç»“æ„](#6931-è§†å›¾ç›®å½•ç»“æ„)
        - [6.9.3.2 å…³é”®ç»„ä»¶åŠŸèƒ½](#6932-å…³é”®ç»„ä»¶åŠŸèƒ½)
        - [6.9.3.3 è·¯ç”±è®¾è®¡](#6933-è·¯ç”±è®¾è®¡)
      - [6.9.4 é”™è¯¯å¤„ç†å’Œæ—¥å¿—è®°å½•](#694-é”™è¯¯å¤„ç†å’Œæ—¥å¿—è®°å½•)
        - [6.9.4.1 æ—¥å¿—è®°å½•](#6941-æ—¥å¿—è®°å½•)
      - [6.9.5 åŠŸèƒ½å¼€å‘ä¸å®ç°](#695-åŠŸèƒ½å¼€å‘ä¸å®ç°)
        - [6.9.5.1 ç±»å…³ç³»å›¾](#6951-ç±»å…³ç³»å›¾)
        - [6.9.5.2 ä»£ç å®ç°](#6952-ä»£ç å®ç°)
  - [ç¬¬7ç« ï¼šViewç«¯ Testing Strategy](#ç¬¬7ç« viewç«¯-testing-strategy)
    - [7.1 å•å…ƒæµ‹è¯•ï¼ˆPHPUnitï¼‰](#71-å•å…ƒæµ‹è¯•phpunit)
      - [7.1.1 æœåŠ¡å±‚æµ‹è¯•è®¾è®¡](#711-æœåŠ¡å±‚æµ‹è¯•è®¾è®¡)
        - [7.1.1.1 Channel Partner Upload æ¨¡å—æœåŠ¡æµ‹è¯•](#7111-channel-partner-upload-æ¨¡å—æœåŠ¡æµ‹è¯•)
        - [7.1.1.2 Channel Partner Dashboard æ¨¡å—æœåŠ¡æµ‹è¯•](#7112-channel-partner-dashboard-æ¨¡å—æœåŠ¡æµ‹è¯•)
        - [7.1.1.3 Channel Partner Approval æ¨¡å—æœåŠ¡æµ‹è¯•](#7113-channel-partner-approval-æ¨¡å—æœåŠ¡æµ‹è¯•)
        - [7.1.1.4 Channel Partner Status Summary æ¨¡å—æœåŠ¡æµ‹è¯•](#7114-channel-partner-status-summary-æ¨¡å—æœåŠ¡æµ‹è¯•)
        - [7.1.1.5 Pre-Lead Project Upload/Creation æ¨¡å—æœåŠ¡æµ‹è¯•](#7115-pre-lead-project-uploadcreation-æ¨¡å—æœåŠ¡æµ‹è¯•)
        - [7.1.1.6 Channel Partner Project Summary/Report æ¨¡å—æœåŠ¡æµ‹è¯•](#7116-channel-partner-project-summaryreport-æ¨¡å—æœåŠ¡æµ‹è¯•)
        - [7.1.1.7 Inquiry æ¨¡å—æœåŠ¡æµ‹è¯•](#7117-inquiry-æ¨¡å—æœåŠ¡æµ‹è¯•)
        - [7.1.1.8 TKE Library æ¨¡å—æœåŠ¡æµ‹è¯•](#7118-tke-library-æ¨¡å—æœåŠ¡æµ‹è¯•)
    - [7.2 BDDæµ‹è¯•æ¡†æ¶ï¼ˆCucumberï¼‰](#72-bddæµ‹è¯•æ¡†æ¶cucumber)
      - [7.2.1 åŠŸèƒ½æ–‡ä»¶è®¾è®¡](#721-åŠŸèƒ½æ–‡ä»¶è®¾è®¡)
        - [7.2.1.1 Channel Partner Upload åŠŸèƒ½æ–‡ä»¶](#7211-channel-partner-upload-åŠŸèƒ½æ–‡ä»¶)
        - [7.2.1.2 Channel Partner Approval åŠŸèƒ½æ–‡ä»¶](#7212-channel-partner-approval-åŠŸèƒ½æ–‡ä»¶)
        - [7.2.1.3 Pre-Lead Project åŠŸèƒ½æ–‡ä»¶](#7213-pre-lead-project-åŠŸèƒ½æ–‡ä»¶)
        - [7.2.1.4 Inquiry ç®¡ç†åŠŸèƒ½æ–‡ä»¶](#7214-inquiry-ç®¡ç†åŠŸèƒ½æ–‡ä»¶)
        - [7.2.1.5 TKE Library æ–‡ä»¶ç®¡ç†åŠŸèƒ½æ–‡ä»¶](#7215-tke-library-æ–‡ä»¶ç®¡ç†åŠŸèƒ½æ–‡ä»¶)
        - [7.2.1.6 Portalæ•°æ®åŒæ­¥åŠŸèƒ½æ–‡ä»¶](#7216-portalæ•°æ®åŒæ­¥åŠŸèƒ½æ–‡ä»¶)
  - [8. é™„å½•](#8-é™„å½•)
    - [8.1 æ•°æ®åº“è¡¨è®¾è®¡](#81-æ•°æ®åº“è¡¨è®¾è®¡)
      - [8.1.1 Portalç«¯](#811-portalç«¯)
      - [8.1.2 Viewç«¯](#812-viewç«¯)
      - [8.1.3 Portalç«¯\&Viewç«¯ ERå…³ç³»å›¾](#813-portalç«¯viewç«¯-erå…³ç³»å›¾)
    - [8.2 é‚®ä»¶é€šçŸ¥è§„åˆ™](#82-é‚®ä»¶é€šçŸ¥è§„åˆ™)
    - [8.3 å¾®ä¿¡æ¨é€é€šçŸ¥è§„åˆ™](#83-å¾®ä¿¡æ¨é€é€šçŸ¥è§„åˆ™)
    - [8.4 Portalç«¯APIå“åº”æ ¼å¼å®Œæ•´è§„èŒƒ](#84-portalç«¯apiå“åº”æ ¼å¼å®Œæ•´è§„èŒƒ)
      - [8.4.1 ç»Ÿä¸€å“åº”æ ¼å¼](#841-ç»Ÿä¸€å“åº”æ ¼å¼)
      - [8.4.2 ä¸šåŠ¡çŠ¶æ€ç å®Œæ•´å®šä¹‰](#842-ä¸šåŠ¡çŠ¶æ€ç å®Œæ•´å®šä¹‰)
      - [8.4.3 å‰ç«¯å¤„ç†ç¤ºä¾‹](#843-å‰ç«¯å¤„ç†ç¤ºä¾‹)
      - [8.4.4 Portalç«¯ API æ¥å£å“åº”ç¤ºä¾‹(VUE)](#844-portalç«¯-api-æ¥å£å“åº”ç¤ºä¾‹vue)
      - [8.4.5 Portal ä¸ CNView åŒå‘ API æ¥å£æ¸…å•](#845-portal-ä¸-cnview-åŒå‘-api-æ¥å£æ¸…å•)
        - [8.4.5.1 Portal æä¾›ç»™ CNView çš„ APIï¼ˆCNView è°ƒç”¨ Portalï¼‰](#8451-portal-æä¾›ç»™-cnview-çš„-apicnview-è°ƒç”¨-portal)
        - [8.4.5.2 CNView æä¾›ç»™ Portal çš„ APIï¼ˆPortal è°ƒç”¨ CNViewï¼‰](#8452-cnview-æä¾›ç»™-portal-çš„-apiportal-è°ƒç”¨-cnview)
        - [8.4.5.3 Portal ä¸»åŠ¨æ¨é€æ•°æ®åˆ° CNView çš„ APIï¼ˆPortal è°ƒç”¨ CNViewï¼‰](#8453-portal-ä¸»åŠ¨æ¨é€æ•°æ®åˆ°-cnview-çš„-apiportal-è°ƒç”¨-cnview)

## 1. é¡¹ç›®èƒŒæ™¯ä¸æ¦‚è¿°

### 1.1 é¡¹ç›®éœ€æ±‚èƒŒæ™¯

æœ¬é¡¹ç›®æ—¨åœ¨å¼€å‘ä¸€ä¸ªåŸºäºå¾®ä¿¡æœåŠ¡å·çš„Partneræ¸ é“ç»¼åˆç®¡ç†å¹³å°ï¼Œä¸ºTKEæ¸ é“ä»£ç†å•†å’Œç»é”€å•†æä¾›å®Œæ•´çš„ä¸šåŠ¡ç”Ÿå‘½å‘¨æœŸç®¡ç†æœåŠ¡ã€‚é€šè¿‡Portal-VIEWåŒç«¯æ¶æ„è®¾è®¡ï¼Œå®ç°Partneræ³¨å†Œå®¡æ‰¹ã€å¤šå…¬å¸è´¦å·ç®¡ç†ã€åˆ†å±‚æƒé™æ§åˆ¶ã€é—®è¯¢å’¨è¯¢ç®¡ç†ã€é¡¹ç›®å…¨æµç¨‹ç®¡ç†ã€æ–‡ä»¶æƒé™è®¿é—®ç­‰æ ¸å¿ƒä¸šåŠ¡åŠŸèƒ½ï¼Œæœ‰æ•ˆæ‰©å¤§æ¸ é“ä¾›åº”å•†è§„æ¨¡,å®ç°è®¢å•å¢é•¿ç›®æ ‡ã€‚

### 1.2 æœ¯è¯­å’Œå®šä¹‰

| æœ¯è¯­ | è§£é‡Š |
|------|------|
| **openid** | ç”¨æˆ·åœ¨å¾®ä¿¡æœåŠ¡å·ä¸‹çš„å”¯ä¸€æ ‡è¯† |
| **Sceneå‚æ•°** | äºŒç»´ç åœºæ™¯å€¼ï¼Œç”¨äºè¿½è¸ªæ³¨å†Œæ¥æºå’Œé”€å”®åˆ†é…ï¼šé”€å”®äºŒç»´ç åŒ…å«SalesIdï¼Œå…¬å¸äºŒç»´ç åŒ…å«å…¬å¸æ ‡è¯† |
| **Partner** | 1ä¸ªuser + 1ä¸ªcompany = 1æ¡å®Œæ•´ä¸šåŠ¡æ•°æ®è®°å½• = Partner = 1ä¸ªcustomer + 1ä¸ª contact |
| **PartnerçŠ¶æ€** | pending(å¾…å®¡æ‰¹), active(å·²æ¿€æ´»), signed(å·²ç­¾çº¦), declined(å·²æ‹’ç») |
| **UserçŠ¶æ€** | active(æ¿€æ´»), banned(å·²å°ç¦), deleted(å·²æ³¨é”€) |

### 1.3 çº¦æŸ

#### 1.3.1 ç”¨æˆ·çŠ¶æ€ç®¡ç†çº¦æŸ

##### Portalç«¯

- **æ ¸å¿ƒç†å¿µ**ï¼š1ä¸ªç”¨æˆ· + 1ä¸ªå…¬å¸ = 1æ¡å®Œæ•´ä¸šåŠ¡æ•°æ®è®°å½• = Partnerï¼ˆä»…é€‚ç”¨äºPortalç«¯ï¼‰
- **æ•°æ®å½’å±**ï¼šæ‰€æœ‰ä¸šåŠ¡æ“ä½œã€æƒé™æ§åˆ¶ã€çŠ¶æ€ç®¡ç†éƒ½åŸºäº `user_company` å…³è”è®°å½•
- **å¤šå…¬å¸æ”¯æŒ**ï¼šç”¨æˆ·ä¸å…¬å¸ä¸ºå¤šå¯¹å¤šå…³ç³»ï¼Œé€šè¿‡ `user_company` è¡¨ç»´æŠ¤ç»‘å®š
- **ç‹¬ç«‹çŠ¶æ€**ï¼šæ¯ä¸ª `user_company` è®°å½•æ‹¥æœ‰ç‹¬ç«‹çš„ `Status`ï¼ˆpending/active/declined/signedï¼‰ï¼Œäº’ä¸å½±å“
- **çŠ¶æ€é©±åŠ¨æƒé™**ï¼š
  - `pending`ï¼šå¯ç¼–è¾‘ä¸ªäººåŠå…¬å¸ä¿¡æ¯ï¼Œå¯åˆ›å»º Inquiry/Projectï¼Œä»…æŸ¥çœ‹è‡ªå·±æ•°æ®
  - `active`ï¼šä»…å¯ç¼–è¾‘ä¸ªäººä¿¡æ¯ï¼Œå…¬å¸ä¿¡æ¯åªè¯»ï¼Œå¯æŸ¥çœ‹å…¨å…¬å¸æ•°æ®ï¼Œå¯æ¥å—/æ‹’ç» TKE é¡¹ç›®
  - `declined`ï¼šæ— å…¬å¸ç»‘å®šï¼Œä»…å¯ç¼–è¾‘ä¸ªäººä¿¡æ¯ï¼Œéœ€é‡æ–°ç”³è¯·
  - `signed`ï¼šè‡ªåŠ¨è·³è½¬è‡³ View AGR Homepage
- **åˆ†é…é€»è¾‘**ï¼š
  - é¡¹ç›®åˆ†é…ä»…å¯¹ `active` çŠ¶æ€çš„ Partner ç”Ÿæ•ˆ
  - TKE é¡¹ç›®åˆ†é…åŸºäº `CompanyId`ï¼Œä¸ç›´æ¥ç»‘å®š `UserId`
- **æ•°æ®åŒæ­¥è§¦å‘**ï¼š
  - ä»…å½“ `user_company.Status` ä» `pending` â†’ `active` æ—¶ï¼Œè§¦å‘å‘ View ç«¯åŒæ­¥å†å² Inquiry/Project æ•°æ®
- **æ³¨é”€å½±å“**ï¼š
  - ç”¨æˆ·ä¸»åŠ¨æ³¨é”€ä»…è§£ç»‘å½“å‰ `user_company` å…³ç³»ï¼Œä¸å½±å“ View ç«¯å·²åˆ›å»ºçš„ Customer/Contact

##### Viewç«¯

- **æ ¸å¿ƒç†å¿µ**ï¼šPartner = Customerï¼ˆå…¬å¸ï¼‰ + Contractï¼ˆè”ç³»äººï¼‰ï¼ŒçŠ¶æ€ç”± **å®¡æ‰¹æµç¨‹** é©±åŠ¨ï¼Œä¸æ•°æ®æ¥æºï¼ˆUpload / Portalï¼‰æ— å…³ã€‚
- **ç»Ÿä¸€çŠ¶æ€æ¨¡å‹**ï¼š
  - æ‰€æœ‰æ–°ç”³è¯·ï¼ˆæ— è®º Upload æˆ– Portalï¼‰åˆå§‹çŠ¶æ€å‡ä¸º **å¾…å®¡æ‰¹ï¼ˆpending/inactiveï¼‰**ï¼›
  - å®¡æ‰¹é€šè¿‡ â†’ çŠ¶æ€å˜ä¸º **active**ï¼Œåˆ›å»º `customer` + `contract`ï¼›
  - å®¡æ‰¹æ‹’ç» â†’ çŠ¶æ€å˜ä¸º **declined**ï¼Œä¸åˆ›å»ºæ­£å¼å®¢æˆ·ï¼Œä»…è®°å½•æ‹’ç»æ—¥å¿—ï¼›
  - è¢«æ‹’ç»è®°å½•å¯ **é‡æ–°æ¿€æ´»**ï¼Œæ¿€æ´»é€»è¾‘ä¸é¦–æ¬¡å®¡æ‰¹ä¸€è‡´ã€‚
- **Portal Account æ§åˆ¶**ï¼š
  - ä»…å½“ **å‹¾é€‰ Portal Account** æ—¶ï¼Œæ‰åœ¨ Portal ç«¯åˆ›å»º `users` å¹¶ç»‘å®š `user_company`ï¼›
  - æœªå‹¾é€‰ â†’ ä»…å­˜åœ¨äº View ç«¯ï¼Œæ—  Portal ç™»å½•èƒ½åŠ›ï¼›
  - **Portal ç«¯æ³¨å†Œé»˜è®¤å‹¾é€‰ä¸”ä¸å¯ç¼–è¾‘**ï¼ŒUpload æ•°æ®å¯ç”±é”€å”®å†³å®šæ˜¯å¦å‹¾é€‰ã€‚
- **çŠ¶æ€å˜æ›´åŒæ­¥**ï¼š
  - **å®¡æ‰¹é€šè¿‡**ï¼š
    - åˆ›å»º `customer` / `contract`ï¼›
    - è‹¥å‹¾é€‰ Portal Accountï¼Œåˆ™æ¨é€ `active` çŠ¶æ€è‡³ Portalï¼›
    - åŒæ­¥å†å² Inquiry / Projectï¼ˆä»… Portal æ¥æºæœ‰æ•°æ®ï¼‰ï¼›
    - å‘é€å¾®ä¿¡æ¿€æ´»é€šçŸ¥ï¼ˆä»… Portal Account ç”¨æˆ·ï¼‰ã€‚
  - **å®¡æ‰¹æ‹’ç»**ï¼š
    - ä¸åˆ›å»º `customer`ï¼›
    - è°ƒç”¨ Portal API è§£ç»‘ `user_company`ï¼ˆä»… Portal æ¥æºï¼‰ï¼›
    - **ä¸å‘é€å¾®ä¿¡é€šçŸ¥**ï¼›
    - è®°å½• `declined` çŠ¶æ€ï¼Œä¾›åç»­é‡æ–°æ¿€æ´»ã€‚
- **æ•°æ®å”¯ä¸€æ€§**ï¼š
  - ä»¥ `TaxCode` ä¸ºå”¯ä¸€æ ‡è¯†ï¼›
  - **Active çŠ¶æ€è®°å½•ç¦æ­¢è¢«è¦†ç›–**ï¼ˆæ— è®º Upload æˆ– Portalï¼‰ï¼›
  - é‡å¤ TaxCode æ—¶ï¼š
    - Active â†’ è‡ªåŠ¨è·³è¿‡ï¼›
    - Inactive/Declined â†’ å…è®¸æ›¿æ¢ï¼ˆéœ€ç¡®è®¤ï¼‰ã€‚
- **æƒé™ä¸æ“ä½œ**ï¼š
  - é”€å”®å¯å¯¹ **æ‰€æœ‰å¾…å®¡æ‰¹ Partner**ï¼ˆUpload / Portalï¼‰æ‰§è¡Œï¼šç¼–è¾‘ã€åˆ†é…ã€å®¡æ‰¹ã€é‡æ–°æ¿€æ´»ï¼›
  - å®¡æ‰¹é¡µé¢é€»è¾‘å®Œå…¨ä¸€è‡´ï¼Œä»… **æ•°æ®è·å–æ–¹å¼ä¸åŒ**ï¼š
    - Uploadï¼šè¯»æœ¬åœ° `mod_channel_partner_companies`ï¼›
    - Portalï¼šè°ƒ Portal API å®æ—¶æ‹‰å–ã€‚

### 1.4 ç³»ç»Ÿæ¶æ„

#### 1.4.1 Portalç«¯æ¶æ„æ—¶åºå›¾

```mermaid
sequenceDiagram
    actor ç”¨æˆ· as Partner
    participant WeChat as å¾®ä¿¡æœåŠ¡å·
    participant Portal as Portalç«¯
    participant VIEW as VIEWç«¯
    actor é”€å”® as TKEé”€å”®

    %% 1. æ³¨å†Œ
    rect rgb(255,255,204)
    Note over ç”¨æˆ·,Portal: ğŸŸ¨ ã€1. æ³¨å†Œã€‘
    ç”¨æˆ·->>WeChat: æ‰«ç è¿›å…¥æ³¨å†Œé¡µ
    WeChat->>Portal: æ‰“å¼€æ³¨å†Œé¡µ & æ£€æŸ¥OpenID
    alt æœªæˆæƒ
        WeChat-->>ç”¨æˆ·: å¼¹çª—æˆæƒ
        ç”¨æˆ·->>WeChat: åŒæ„æˆæƒ
    end
    WeChat->>Portal: è¿”å›OpenID
    Portal-->>ç”¨æˆ·: å±•ç¤ºæ³¨å†Œè¡¨å•
    ç”¨æˆ·->>Portal: å¡«å†™å¹¶æäº¤
    Portal->>Portal: æ ¹æ®æ‰‹æœºå·æŸ¥è¯¢
    alt å·²å­˜åœ¨
        Portal-->>ç”¨æˆ·: æç¤ºâ€œè´¦å·å·²å­˜åœ¨ï¼Œè¯·ç›´æ¥ç™»å½•â€
    else æ–°ç”¨æˆ·
        Portal->>VIEW: [API: æŒ‰TaxCodeæŸ¥è¯¢]
        alt TaxCodeä¸å­˜åœ¨
            VIEW-->>Portal: ä¸å­˜åœ¨
            Portal->>VIEW: [API: æ–°æ³¨å†Œç”³è¯·]
            VIEW->>é”€å”®: å‘é€å¾…å®¡æ‰¹é‚®ä»¶
            Portal-->>ç”¨æˆ·: æç¤ºâ€œæ³¨å†ŒæˆåŠŸâ€ï¼Œå¼•å¯¼å…³æ³¨æœåŠ¡å·
            ç”¨æˆ·->>WeChat: å…³æ³¨TKEå®˜æ–¹æœåŠ¡å·
            WeChat-->>ç”¨æˆ·: å‘é€æ¬¢è¿æ¶ˆæ¯
        else TaxCodeå·²å­˜åœ¨ä½†æœªç»‘å®š
            VIEW-->>Portal: è¿”å›å…¬å¸ä¿¡æ¯
            Portal-->>ç”¨æˆ·: æç¤ºéœ€æ‰‹æœºå·+éªŒè¯ç ç»‘å®š
            ç”¨æˆ·->>Portal: éªŒè¯æ‰‹æœºå·
            Portal->>Portal: [API: å®Œæˆç»‘å®šæ“ä½œ]
            Portal->>VIEW: [API: æ–°æ³¨å†Œç”³è¯·]
            VIEW->>é”€å”®: å‘é€å¾…å®¡æ‰¹é‚®ä»¶
            Portal-->>ç”¨æˆ·: æç¤ºâ€œæ³¨å†ŒæˆåŠŸâ€ï¼Œå¼•å¯¼å…³æ³¨æœåŠ¡å·
            ç”¨æˆ·->>WeChat: å…³æ³¨TKEå®˜æ–¹æœåŠ¡å·
            WeChat-->>ç”¨æˆ·: å‘é€æ¬¢è¿æ¶ˆæ¯
        else å·²ç»‘å®šç”¨æˆ·
            VIEW-->>Portal: å·²ç»‘å®š
            Portal-->>ç”¨æˆ·: æç¤ºâ€œè´¦å·å·²å­˜åœ¨ï¼Œè¯·ç›´æ¥ç™»å½•â€
        end
    end
    Note over é”€å”®: å®¡æ‰¹
    é”€å”®->>VIEW: æŸ¥çœ‹æ¸ é“partnerä»ªè¡¨æ¿
    Note left of é”€å”®: ğŸŸ¨ å¦‚æœpartneræ˜¯è¢«å¯¼å…¥çš„<br>ä¹‹åæ‰«æåŒ¹é…åˆ°å¯¼å…¥è®°å½•ï¼Œ<br>å…¶æ¥æºå°†æ›´æ”¹ä¸ºè‡ªæ‰«æã€‚
    VIEW-->>é”€å”®: æ˜¾ç¤ºpartnerä»ªè¡¨æ¿
    é”€å”®->>VIEW: æŸ¥çœ‹Self-Scanè¯·æ±‚è¯¦æƒ…
    VIEW->>Portal: [API: è·å–Portalæ•°æ®]
    Portal-->>VIEW: è¿”å›Portalæ•°æ®
    VIEW-->>é”€å”®: æ˜¾ç¤ºæ–°partnerè¯·æ±‚æ˜ç»†
    alt å®¡æ‰¹é€šè¿‡
        VIEW->>Portal: [API: è·å–æ‰€æœ‰partneræ•°æ®]
        Portal-->>VIEW: è¿”å›é¡¹ç›®/å®¢æˆ·/è”ç³»äºº/é—®è¯¢æ•°æ®
        VIEW->>VIEW: å­˜å‚¨æ¿€æ´»æ•°æ®
        VIEW->>Portal: [API: è¿”å›æ¿€æ´»ç»“æœ]
        Portal->>Portal: æ›´æ–°partnerçŠ¶æ€ä¸ºå·²æ¿€æ´»
        Portal-->>WeChat: å‘é€æ¿€æ´»é€šçŸ¥
        WeChat-->>ç”¨æˆ·: æç¤ºè´¦å·å·²æ¿€æ´»
    else å®¡æ‰¹æ‹’ç»
        VIEW->>Portal: [API: è¿”å›æ‹’ç»ç»“æœ]
        Portal-->>WeChat: å‘é€æ‹’ç»é€šçŸ¥
        WeChat-->>ç”¨æˆ·: æç¤ºæ³¨å†Œç”³è¯·è¢«æ‹’ï¼Œå¯é‡æ–°ç”³è¯·
    end
    end

    %% 2. ç™»å½•
    rect rgb(204,255,255)
    Note over ç”¨æˆ·,Portal: ğŸŸ¦ ã€2. ç™»å½•ã€‘
    alt WeChatæˆæƒç™»å½•
        ç”¨æˆ·->>WeChat: WeChatæˆæƒ
        WeChat->>Portal: è¿”å›OpenID
        Portal->>Portal: æ ¡éªŒè´¦å·
        alt å¤šå®¶å…¬å¸
            alt æœ‰å†å²å…¬å¸
                Portal->>Portal: æ‰“å¼€ä¸Šæ¬¡å…¬å¸
            else
                Portal->>Portal: é»˜è®¤è¿›ç¬¬ä¸€ä¸ªå…¬å¸
            end
            Portal-->>ç”¨æˆ·: è‡ªåŠ¨è¿›å…¥å…¬å¸(å¯åˆ‡æ¢)
        else å•å…¬å¸
            Portal-->>ç”¨æˆ·: ç›´æ¥è¿›å…¥å…¬å¸
        end
    else æ‰‹æœºå·éªŒè¯ç ç™»å½•
        ç”¨æˆ·->>Portal: è¾“å…¥æ‰‹æœºå·+éªŒè¯ç 
        Portal->>Portal: æ ¡éªŒè´¦å·
        alt å¤šå®¶å…¬å¸
            Portal-->>ç”¨æˆ·: å±•ç¤ºå…¬å¸åˆ—è¡¨
            ç”¨æˆ·->>Portal: æ‰‹åŠ¨é€‰æ‹©
        else å•å…¬å¸
            Portal-->>ç”¨æˆ·: ç›´æ¥è¿›å…¥
        end
    end
    end

    %% 3. AGRç™»å½• / è·³è½¬ (phase2)
    rect rgb(255,255,204)
    Note over ç”¨æˆ·,VIEW: ğŸŸ¨ ã€3. AGRç™»å½•(phase2)ã€‘
    alt é€šè¿‡Portalè¿›å…¥
        ç”¨æˆ·->>Portal: åœ¨å…¬å¸é€‰æ‹©ç•Œé¢é€‰æ‹©AGRå…¬å¸
        Portal->>VIEW: è·³è½¬VIEW
        VIEW-->>ç”¨æˆ·: å±•ç¤ºAGR Homepage
        ç”¨æˆ·->>VIEW: é¡¹ç›®æ“ä½œ
        VIEW->>Portal: è¿”å›Portalå¹¶é‡æ–°é€‰æ‹©å…¬å¸
    else ç”¨æˆ·ç›´æ¥Viewç«¯ç™»å½•
        ç”¨æˆ·->>VIEW: ç›´æ¥ç”¨VIEWè´¦æˆ·ç™»å½•
        VIEW-->>ç”¨æˆ·: å±•ç¤ºAGR Homepage (æ— éœ€Portalè·³è½¬)
        ç”¨æˆ·->>VIEW: é¡¹ç›®æ“ä½œ
    end
    end

    %% 4. é—®è¯¢ç®¡ç†
    rect rgb(204,255,255)
    Note over ç”¨æˆ·,VIEW: ğŸŸ¦ ã€4. é—®è¯¢ç®¡ç†ã€‘
    alt æœªæ¿€æ´»ç”¨æˆ·
        ç”¨æˆ·->>Portal: å‘èµ·é—®è¯¢
        Portal->>Portal: æœ¬åœ°å­˜å‚¨æ•°æ®
        Portal->>VIEW: [API: å‘é€é—®è¯¢é€šçŸ¥]
        VIEW-->>é”€å”®: é‚®ä»¶æ¨é€
        é”€å”®->>VIEW: æŸ¥çœ‹æœªå›å¤é—®è¯¢
        VIEW->>Portal: [API: è·å–é—®è¯¢ä¿¡æ¯] 
        Portal-->>VIEW: è¿”å›é—®è¯¢ä¿¡æ¯
        é”€å”®->>VIEW: å›å¤é—®è¯¢
        VIEW->>Portal: [API: æ›´æ–°Portal]
        Portal->>Portal: æœ¬åœ°å­˜å‚¨æ•°æ®
        Portal-->>WeChat: æ–°å›å¤é€šçŸ¥
        WeChat-->>ç”¨æˆ·: æé†’æŸ¥çœ‹
        ç”¨æˆ·->>Portal: æŸ¥çœ‹é—®è¯¢
        Portal-->>ç”¨æˆ·: æ˜¾ç¤ºé—®è¯¢è¯¦æƒ…
    else å·²æ¿€æ´»
        ç”¨æˆ·->>Portal: å‘èµ·é—®è¯¢
        Portal->>VIEW: [API: æ¨é€é—®è¯¢æ•°æ®]
        VIEW->>VIEW: å­˜å‚¨é—®è¯¢æ•°æ®
        é”€å”®->>VIEW: å›å¤é—®è¯¢
        VIEW->>VIEW: å­˜å‚¨å›å¤æ•°æ®
        VIEW->>Portal: [API: è¿”å›å›å¤ç»“æœ]
        Portal-->>WeChat: æ¨é€é€šçŸ¥
        WeChat-->>ç”¨æˆ·: é€šçŸ¥æ–°å›å¤
        ç”¨æˆ·->>Portal: æŸ¥çœ‹é—®è¯¢
        Portal->>VIEW: [API: è·å–é—®è¯¢ä¿¡æ¯]
        VIEW-->>Portal: è¿”å›é—®è¯¢æ•°æ®
        Portal-->>ç”¨æˆ·: æ˜¾ç¤ºé—®è¯¢è¯¦æƒ…
    end
    end

    %% 5. é¡¹ç›®ç®¡ç†
    rect rgb(255,255,204)
    Note over ç”¨æˆ·,VIEW: ğŸŸ¨ ã€5. é¡¹ç›®ç®¡ç†ã€‘
    alt æœªæ¿€æ´»
        ç”¨æˆ·->>Portal: æ–°å»º/ç¼–è¾‘Pre-Leadé¡¹ç›®
        Portal->>Portal: æš‚å­˜Portal
        Portal-->>ç”¨æˆ·: æ˜¾ç¤ºæ•°æ®
    else å·²æ¿€æ´»
        ç”¨æˆ·->>Portal: æŸ¥çœ‹é¡¹ç›®åˆ—è¡¨
        Portal->>VIEW: [API: è·å–é¡¹ç›®æ•°æ®]
        VIEW-->>Portal: è¿”å›é¡¹ç›®æ•°æ®ï¼ˆåŒ…æ‹¬åˆ†é…çš„é¡¹ç›®ï¼‰
        Portal-->>ç”¨æˆ·: æ˜¾ç¤ºé¡¹ç›®åˆ—è¡¨
        ç”¨æˆ·->>VIEW: æ–°å»º/ç¼–è¾‘Pre-Leadé¡¹ç›®
        VIEW->>VIEW: å­˜å‚¨æ•°æ®
        é”€å”®->>VIEW: åˆ†é…TKEé¡¹ç›®
        VIEW-->>Portal: [API: åˆ†é…é¡¹ç›®ä¿¡æ¯]
        Portal-->>WeChat: æ¨é€é€šçŸ¥
        WeChat-->>ç”¨æˆ·: é€šçŸ¥ç”¨æˆ·
        ç”¨æˆ·->>Portal: æ¥å—/æ‹’ç»
        Portal->>VIEW: [API: åŒæ­¥å†³ç­–]
        VIEW->>VIEW: å­˜å‚¨æ•°æ®
    end
    end

    %% 6. æ–‡ä»¶ç®¡ç†
    rect rgb(204,255,255)
    Note over ç”¨æˆ·,VIEW: ğŸŸ¦ ã€6. æ–‡ä»¶ç®¡ç† (TKE Library)ã€‘
    é”€å”®->>VIEW: ä¸Šä¼ æ–‡ä»¶ (å­˜å‚¨NAS)
    VIEW->>Portal: åŒæ­¥æ–‡ä»¶åŸºç¡€ä¿¡æ¯
    ç”¨æˆ·->>Portal: æ‰“å¼€æ–‡ä»¶åº“
    Portal->>VIEW: æ‹‰å–æ–‡ä»¶ç›®å½•(ä¾æ®çŠ¶æ€: Active/Inactive/AGR)
    VIEW-->>Portal: è¿”å›æ–‡ä»¶æ¸…å•å’Œä¸‹è½½é“¾æ¥
    Portal-->>ç”¨æˆ·: å±•ç¤ºæ–‡ä»¶å…¥å£
    ç”¨æˆ·->>Portal: ä¸‹è½½æ–‡ä»¶/é¢„è§ˆ (NAS)
    end

    %% 7. è´¦æˆ·çŠ¶æ€å˜æ›´
    rect rgb(255,255,204)
    Note over VIEW,Portal: ğŸŸ¨ ã€7. è´¦æˆ·çŠ¶æ€å˜æ›´ã€‘
    opt Portalè´¦æˆ·è¢«ç¦ç”¨
        ç”¨æˆ·->>Portal: æ³¨é”€è´¦æˆ·
        Portal->>Portal: çŠ¶æ€æ›´æ–°=ç¦ç”¨å¹¶è§£ç»‘WeChat
        Portal->>VIEW: [API: æ³¨é”€è´¦æˆ·ä¿¡æ¯]
        VIEW->>VIEW: Portalç«¯è´¦æˆ·æ³¨é”€, VIEWç«¯è”ç³»äººæ•°æ®ä¸å—å½±å“
        VIEW-->>Portal: è¿”å›ç¡®è®¤
        Portal-->>WeChat: æ¨é€è´¦å·æ³¨é”€é€šçŸ¥
        WeChat-->>ç”¨æˆ·: æç¤ºâ€œè´¦æˆ·æ³¨é”€æˆåŠŸâ€œ
    end
    opt VIEW customer/contacts è¢«åˆ é™¤
        é”€å”®->>VIEW: åˆ é™¤customer/contacts
        VIEW->>Portal: [API: åˆ é™¤çš„customer/contactsä¿¡æ¯]
        Portal->>Portal: åˆ é™¤ç”¨æˆ·å’Œè¯¥å…¬å¸ç»‘å®šå…³ç³»
        Portal-->>WeChat: æ¨é€å…¬å¸è§£ç»‘é€šçŸ¥
        WeChat-->>ç”¨æˆ·: æç¤ºâ€œå…¬å¸å·²è§£ç»‘â€œ
    end
    opt VIEW AGRè´¦æˆ·è¢«ç¦ç”¨ï¼ˆphase2ï¼‰
        é”€å”®->>VIEW: ç¦ç”¨Partnerè´¦æˆ·
        VIEW->>Portal: [API: ç¦ç”¨Portalè´¦æˆ·]
        Portal->>Portal: çŠ¶æ€æ›´æ–°=ç¦ç”¨
        Portal-->>WeChat: æ¨é€è´¦å·ç¦ç”¨
        WeChat-->>ç”¨æˆ·: æç¤º"è´¦æˆ·è¢«ç¦ç”¨"
    end
    end
```

#### 1.4.2 WeChatæˆæƒæ³¨å†Œæµç¨‹

```mermaid
flowchart TD
    A[æ‰«ç è¿›å…¥] --> B{å·²å…³æ³¨?}
    B -->|æ˜¯| C[é™é»˜æˆæƒsnsapi_base]
    B -->|å¦| D[å¼•å¯¼æˆæƒsnsapi_userinfo] 
    C --> E[ç”Ÿæˆç”¨æˆ·Token]
    D --> E
    E --> F[æ³¨å†Œæµç¨‹]
    F --> G[å®¡æ‰¹ç”³è¯·]
    G --> H{å·²å…³æ³¨?}
    H -->|æ˜¯| I[æ¨é€æ³¨å†ŒæˆåŠŸæ¶ˆæ¯]
    H -->|å¦| J[å¼•å¯¼å…³æ³¨æœåŠ¡å·]
    J --> K[å…³æ³¨åæ¨é€æ¶ˆæ¯]
```

#### 1.4.3 Viewç«¯ä¸šåŠ¡æ—¶åºå›¾

```mermaid
sequenceDiagram
    actor TKESales as TKEé”€å”®
    participant View as Viewç«¯
    participant Portal as Portalç«¯
    participant WeChat as å¾®ä¿¡æœåŠ¡
    actor Partner as Partner

    %% 1. Partner Upload
    rect rgb(255,255,204)
    Note over TKESales,View: ã€1. Potential Channel Partner Uploadã€‘
    TKESales->>View: Excelæ‰¹é‡ä¸Šä¼ Partnerä¿¡æ¯
    View->>View: éªŒè¯æ•°æ®ï¼Œæ£€æŸ¥é‡å¤ TaxCode
    
    alt å‘ç°é‡å¤ç¨å·
        View-->>TKESales: å¼¹å‡ºæ›¿æ¢ç¡®è®¤æç¤º (activeçš„è®°å½•ç›´æ¥è·³è¿‡,å¹¶è®°å½•å¤±è´¥)
        TKESales->>View: ç¡®è®¤æ˜¯å¦æ›¿æ¢
        alt ç¡®è®¤æ›¿æ¢
            View->>View: æ›¿æ¢æ—§è®°å½•ï¼ˆä»…æ›¿æ¢inactive/declineè®°å½•ï¼‰
        else å–æ¶ˆæ›¿æ¢
            View->>View: è·³è¿‡é‡å¤è®°å½•,å¹¶æ ‡è®°ä¸ºå¤±è´¥è®°å½•
        end
    else æ— é‡å¤ç¨å·
        View->>View: ç›´æ¥å­˜å‚¨æ–°è®°å½•
    end
    
    View-->>TKESales: ä¸Šä¼ ç»“æœï¼ˆæˆåŠŸ/å¤±è´¥/è·³è¿‡è®°å½•ï¼‰
    Note over View: Excelå¯¼å…¥çš„Partneræ•°æ®ï¼ŒçŠ¶æ€ä¸ºinactive
    end

    %% 2. Partner Registration (QR Code)
    rect rgb(204,255,255)
    Note over Partner,View: ã€2. Partner Registration (QR Code)ã€‘
    Partner->>Portal: æ‰«ç æ³¨å†Œç”³è¯·
    Portal->>Portal: Portalæœ¬åœ°å­˜å‚¨æ³¨å†Œç”³è¯·æ•°æ®
    Note over Portal: æ³¨å†Œæ•°æ®ä»…åœ¨Portalç«¯å­˜å‚¨ï¼Œä¸æ¨é€åˆ°View
    Note over View: Viewç«¯æ— æ³¨å†Œæ•°æ®ï¼Œç›´åˆ°å®¡æ‰¹æ¿€æ´»åæ‰åŒæ­¥
    end

    %% 3. Dashboard Management
    rect rgb(255,255,204)
    Note over TKESales,View: ã€3. Channel Partner Dashboardã€‘
    TKESales->>View: æŸ¥çœ‹Channel Partner Dashboard
    View->>Portal: æ‹‰å–Portalç«¯æ³¨å†Œæ•°æ®
    Portal-->>View: è¿”å›Portalæ³¨å†Œæ•°æ®
    View->>View: åœ¨åˆ—è¡¨ä¸­åˆ†åˆ«å±•ç¤º,Viewæœ¬åœ°æ•°æ® å’Œ Portalæ•°æ®
    View-->>TKESales: å±•ç¤ºPartneråˆ—è¡¨ï¼ˆæ¯ä¸ªå…¬å¸1æ¡è®°å½•ï¼‰
    Note over View: æ˜¾ç¤ºPartner Statusï¼ˆactive/inactive/declinedï¼‰å’ŒRequest Statusï¼ˆpending/doneï¼‰
    
    TKESales->>View: æ‰¹é‡åˆ†é…é”€å”®ç»™Partner (ä»…Inactiveæ•°æ®)
    View->>View: æ›´æ–°é”€å”®åˆ†é…ä¿¡æ¯(Partnerå¯ä»¥æœ‰å¤šä¸ªé”€å”®)
    Note over View: æ”¯æŒå¯¹å·²æœ‰é”€å”®IDçš„Partneré‡æ–°åˆ†é…
    
    alt æ–°Partnerå®¡æ‰¹
        TKESales->>View: ç‚¹å‡»ç¼–è¾‘æŒ‰é’®
        Note over View: è·³è½¬åˆ° Manage Customers Page æ–°å…¬å¸å®¡æ‰¹æµç¨‹
    else æ–°Contractå®¡æ‰¹
        TKESales->>View: ç‚¹å‡»ç¼–è¾‘æŒ‰é’®
        Note over View: è·³è½¬åˆ° Partner Info Tab å®¡æ‰¹è”ç³»äºº
    end
    end

    %% 4. Partner Approval Process
    rect rgb(204,255,255)
    Note over TKESales,Portal: ã€4. Partner Approval Processã€‘
    
    alt Manage Customers - æ–°Partnerå®¡æ‰¹
        TKESales->>View: è¿›å…¥Manage Customerså®¡æ‰¹é¡µé¢
        View->>View: è¯†åˆ«æ•°æ®æ¥æºï¼ˆPortalæ•°æ® vs Viewå¯¼å…¥æ•°æ®ï¼‰
        View->>Portal: è·å–Portalç«¯ç”¨æˆ·æ•°æ®ï¼ˆå¦‚æœæ¥æºæ˜¯Portalï¼‰
        Portal-->>View: è¿”å›ç”¨æˆ·é¡¹ç›®ã€å’¨è¯¢è®°å½•ç­‰ä¿¡æ¯
        
        alt ç”³è¯·æ—¶å¡«å†™è¿‡TaxCode
            View-->>TKESales: å±•ç¤ºå®¡æ‰¹é¡µé¢ï¼ˆå¤šä¸ªè”ç³»äººï¼Œä»…æ˜¾ç¤ºç¬¬ä¸€ä¸ªç”³è¯·äººå¡«å†™çš„Companyä¿¡æ¯ï¼‰
            Note over View: æ‰€æœ‰ç›¸åŒTaxCodeçš„è”ç³»äººæ˜¾ç¤ºåœ¨ä¸€ä¸ªå®¡æ‰¹é¡µé¢
        else ç”³è¯·æ—¶æœªå¡«å†™TaxCode
            View-->>TKESales: å±•ç¤ºå®¡æ‰¹é¡µé¢ï¼ŒTaxCodeä¸ºå¿…å¡«é¡¹(é”€å”®å¡«å†™)
            TKESales->>View: è¾“å…¥TaxCode
            View->>View: æ£€æŸ¥TaxCodeæ˜¯å¦å·²å­˜åœ¨
            alt TaxCodeå·²å­˜åœ¨
                View-->>TKESales: åœ¨inputæ¡†ä¸‹æ˜¾ç¤ºå·²å­˜åœ¨çš„å…¬å¸ä¿¡æ¯ç»™é”€å”®å‚è€ƒ
                View->>View: å¸¦å‡ºè¯¥ç¨å·ä¸‹æ‰€æœ‰ç”³è¯·çš„è”ç³»äºº
                View-->>TKESales: æ˜¾ç¤ºè¯¥TaxCodeä¸‹çš„æ‰€æœ‰è”ç³»äººï¼ˆåˆå¹¶æ˜¾ç¤ºï¼‰
            else TaxCodeä¸å­˜åœ¨
                View-->>TKESales: æ˜¾ç¤ºå½“å‰ç”³è¯·çš„è”ç³»äºº
            end
        end
        
    else Partner Info Tab - æ–°Contractå®¡æ‰¹
        TKESales->>View: è¿›å…¥Partner Info Tabå®¡æ‰¹é¡µé¢
        View->>View: è¯†åˆ«æ•°æ®æ¥æºï¼ˆPortalæ•°æ® vs Viewå¯¼å…¥æ•°æ®ï¼‰
        View->>Portal: è·å–Portalç«¯ç”¨æˆ·æ•°æ®å’ŒåŒå…¬å¸å…¶ä»–è”ç³»äººä¿¡æ¯
        Portal-->>View: è¿”å›ç”¨æˆ·é¡¹ç›®ã€å’¨è¯¢è®°å½•å’Œæ–°ç”³è¯·çš„è”ç³»äºº
        View-->>TKESales: å±•ç¤ºå·²å­˜åœ¨å…¬å¸å®¡æ‰¹é¡µé¢ï¼ˆæ˜¾ç¤ºè¯¥å…¬å¸æ–°ç”³è¯·çš„è”ç³»äººï¼Œå¯åŒæ—¶å®¡æ‰¹å¤šä¸ªï¼‰
    end

    TKESales->>View: å®¡æ‰¹é¡µé¢ - è”ç³»äººå¯æ–°å¢/ç¼–è¾‘/åˆ é™¤
    View->>View: ä»»ä½•è”ç³»äººéƒ½å¯ä»¥è¢«åˆ é™¤(å‘èµ·ç”³è¯·çš„è”ç³»äºº è¢«åˆ é™¤ é»˜è®¤æ‹’ç»)
    
    TKESales->>View: æŸ¥çœ‹ç”¨æˆ·é—®è¯¢è®°å½•
    TKESales->>View: å›å¤ç”¨æˆ·é—®è¯¢è®°å½•
    View->>View: å­˜å‚¨é—®è¯¢å›å¤ä¿¡æ¯
    
    TKESales->>View: æŸ¥çœ‹é…ç½®çš„Question List
    TKESales->>View: å›ç­”Question Listé—®é¢˜
    View->>View: å­˜å‚¨Question Listç»“æœ
    Note over View: Question Listæ˜¯ç³»ç»Ÿé…ç½®çš„æ ‡å‡†é—®é¢˜åˆ—è¡¨
    
    alt æ•°æ®æ¥æºæ˜¯Portalç”³è¯·
        Note over View: Portal Accountä¸å¯ç¼–è¾‘ï¼Œé»˜è®¤å‹¾é€‰
    else æ•°æ®æ¥æºæ˜¯Viewå¯¼å…¥
        Note over View: Portal Accountå¯ç¼–è¾‘ï¼Œå¤šæ‰‹æœºå· ä»…èƒ½ä¿ç•™ä¸»æ‰‹æœºå·
    end
    
    alt å®¡æ‰¹é€šè¿‡
        View->>View: æ‰¹é‡æ ‡è®°å®¡æ‰¹çŠ¶æ€ï¼Œç”Ÿæˆæ–°çš„Customer&Contactè®°å½•ï¼ˆä»…ä¿ç•™çš„è”ç³»äººï¼‰
        View->>View: Viewå¯¼å…¥æ•°æ®ï¼šå¤šä¸ªæ‰‹æœºå·åªä¿ç•™ä¸€ä¸ª
        
        loop æ¯ä¸ªé€šè¿‡çš„è”ç³»äºº
            alt å‹¾é€‰äº†Portal Account
                View->>Portal: å‘é€å®¡æ‰¹é€šè¿‡ç»“æœï¼Œå…è®¸Portalç™»å½•
                Portal->>Portal: æ›´æ–°ç”¨æˆ·user_company.Status = 'active'ï¼Œå¼€å¯ç™»å½•æƒé™

                View->>WeChat: å‘é€æ¿€æ´»é€šçŸ¥
                WeChat-->>Partner: æ¨é€æ¿€æ´»æ¶ˆæ¯ï¼ˆä»…é€šè¿‡çš„è”ç³»äººï¼‰
            else æœªå‹¾é€‰Portal Account  
                View->>View: ä»…ç”ŸæˆContactè®°å½•
            end
        end
        
        View->>View: Dashboardä¸­Request Status æ˜¾ç¤ºä¸ºdone
        
    else å®¡æ‰¹æ‹’ç»
        View->>View: è®°å½•æ‹’ç»åŸå› ï¼Œä¸ç”ŸæˆCustomerè®°å½•
        View->>Portal: å‘é€å®¡æ‰¹æ‹’ç»ç»“æœ
        Portal->>Portal: è§£ç»‘Companyå’ŒUserå…³ç³»,åŒæ—¶æ ‡è®°ä¸ºDecline,ç”¨æˆ·å¯ä»¥é‡æ–°å‘èµ·æ³¨å†Œç”³è¯·
        Note over View:  é”€å”®å¯ä»¥é‡æ–°æ¿€æ´»è¢« Declineæ•°æ®
        View->>View: Dashboardä¸­Request Status æ˜¾ç¤ºä¸ºdone
        Note over WeChat: æ‹’ç»æ—¶ä¸å‘é€å¾®ä¿¡æé†’
    end
    
    %% 4.1. Reactivate Declined Data
    rect rgb(255,204,204)
    Note over TKESales,View: ã€4.1. Reactivate Declined Data - è¢«Declineæ•°æ®é‡æ–°æ¿€æ´»ã€‘
    TKESales->>View: Dashboardåˆ—è¡¨ç‚¹å‡»è¢«Declineæ•°æ®è¿›å…¥ç¼–è¾‘é¡µé¢
    TKESales->>View: é‡æ–°æ¿€æ´»è¢«Declineçš„æ•°æ®
    
    alt Portalæ•°æ®è¢«é‡æ–°æ¿€æ´»
        View->>View: é‡æ–°åœ¨user_companyä¸­ å¢åŠ  userå’Œcompanyçš„å…³è”å…³ç³»
        View->>View: æ£€æŸ¥Partneræ˜¯å¦å·²å­˜åœ¨
        alt Partnerä¸å­˜åœ¨
            View->>View: ç”Ÿæˆæ–°çš„Customer&Contactè®°å½•
        else Partnerå·²å­˜åœ¨
            View->>View: ä»…ç”Ÿæˆæ–°çš„Contactè®°å½•
        end
        View->>Portal: å‘é€é‡æ–°æ¿€æ´»é€šçŸ¥ï¼Œé‡æ–°ç»‘å®šç”¨æˆ·å’Œå…¬å¸
        Portal->>Portal: é‡æ–°ç»‘å®šCompanyå’ŒUserå…³ç³»ï¼Œæ›´æ–°çŠ¶æ€ä¸ºactive
        View->>WeChat: å‘é€æ¿€æ´»é€šçŸ¥
        WeChat-->>Partner: æ¨é€æ¿€æ´»æ¶ˆæ¯
    else Viewå¯¼å…¥æ•°æ®è¢«é‡æ–°æ¿€æ´»
        View->>View: æ£€æŸ¥Partneræ˜¯å¦å·²å­˜åœ¨
        alt Partnerä¸å­˜åœ¨
            View->>View: ç”Ÿæˆæ–°çš„Customer&Contactè®°å½•ï¼ŒçŠ¶æ€ä¸ºactive
        else Partnerå·²å­˜åœ¨
            View->>View: ä»…ç”Ÿæˆæ–°çš„Contactè®°å½•ï¼ŒçŠ¶æ€ä¸ºactive
        end
        
        alt å‹¾é€‰äº†Portal Account
            View->>WeChat: å‘é€æ¿€æ´»é€šçŸ¥
            WeChat-->>Partner: æ¨é€æ¿€æ´»æ¶ˆæ¯
        else æœªå‹¾é€‰Portal Account
            Note over View: ä¸å‘é€æ¿€æ´»é€šçŸ¥
        end
    end
    end
    end

    %% 5. Status Summary
    rect rgb(255,255,204)
    Note over TKESales,View: ã€5. Channel Partner Status Summaryã€‘
    TKESales->>View: æŸ¥çœ‹Channel Partner Status Summary
    View->>Portal: è·å–Portalç«¯æ•°æ®ï¼ˆåŒ…æ‹¬inactiveçš„Portalæ•°æ®ï¼‰
    Portal-->>View: è¿”å›Portalç«¯æ‰€æœ‰æ•°æ®
    View->>View: åˆå¹¶Portalæ•°æ®+Viewæœ¬åœ°æ•°æ®è¿›è¡Œç»Ÿè®¡
    View->>View: æŒ‰Region->Branch->Partner Ownerå±‚çº§ç»Ÿè®¡
    View->>View: ç»Ÿè®¡åˆ†ç±»ï¼šAll/Pending on Branch/Pending on Sales/Declined/Active
    View-->>TKESales: å±•ç¤ºå¤šç»´åº¦ç»Ÿè®¡æ•°æ®
    Note over View: æ•°æ®æ¥æºï¼šPortalå’ŒViewåˆé›†ï¼ˆinactiveçš„Portalæ•°æ®ä¸åœ¨Viewç«¯ï¼‰
    Note over View: All - æ‰€æœ‰Partnerç»Ÿè®¡
    Note over View: Pending on Branch - ç­‰å¾…Branchå®¡æ‰¹çš„Partner
    Note over View: Pending on Sales - ç­‰å¾…Saleså®¡æ‰¹çš„Partner  
    Note over View: Declined - è¢«æ‹’ç»çš„Partner
    Note over View: Active - å·²æ¿€æ´»çš„Partner
    TKESales->>View: ç‚¹å‡»ç»Ÿè®¡æ•°å­—
    View-->>TKESales: è·³è½¬åˆ°Dashboardï¼ˆå¸¦ç­›é€‰æ¡ä»¶ï¼‰
    Note over View: Summaryå¯ä»¥è·³è½¬Dashboardè¿›è¡Œè¯¦ç»†ç®¡ç†
    end

    %% 6. Project Management
    rect rgb(204,255,255)
    Note over TKESales,Partner: ã€6. Project Managementã€‘
    
    %% 6.1. Viewç«¯é¡¹ç›®ç®¡ç†
    rect rgb(230,255,230)
    Note over TKESales,View: ã€6.1. Viewç«¯å¯¼å…¥/æ–°å»ºé¡¹ç›®ã€‘
    
    alt å¯¼å…¥é¡¹ç›®
        TKESales->>View: è¿›å…¥Upload Project Dataé¡µé¢
        TKESales->>View: é€‰æ‹©"Import Project from Offline Units"é€‰é¡¹
        TKESales->>View: ä¸‹è½½Excelæ¨¡æ¿
        TKESales->>View: ä¸Šä¼ å¡«å†™å®Œæ•´çš„Excelæ–‡ä»¶
        View->>View: éªŒè¯æ•°æ®ï¼Œæ£€æµ‹é¡¹ç›®åç§°ä¸å…è®¸é‡å¤
        View->>View: Excelä¸­å¡«å†™åˆ†é…åŸå› ï¼Œå¦‚å¡«å†™TaxCodeåˆ™å…³è”å¯¹åº”Partner
        View->>View: åˆ›å»ºé¡¹ç›®è®°å½•ï¼ŒçŠ¶æ€é»˜è®¤ä¸ºPre-Lead
        
        alt Partneræœ‰å¤šä¸ªå…³è”é”€å”®
            View->>View: é»˜è®¤å°†ç¬¬ä¸€ä¸ªé”€å”®ä½œä¸ºä¸»é”€å”®
        end
        
        View-->>TKESales: å¯¼å…¥ç»“æœï¼ˆæˆåŠŸ/å¤±è´¥/é‡å¤è®°å½•ï¼‰
        
    else æ–°å»ºé¡¹ç›®  
        TKESales->>View: æ‰‹åŠ¨æ–°å»ºé¡¹ç›®
        View->>View: åˆ›å»ºé¡¹ç›®è®°å½•ï¼ŒçŠ¶æ€ä¸ºPre-Lead
        Note over View: å¯ä»¥é€‰æ‹©åˆ†é…ç»™Partner(activeçŠ¶æ€)
    end
    
    Note over View: å¯¼å…¥å’Œæ–°å»ºçš„æœ€ç»ˆç›®çš„éƒ½æ˜¯åˆ›å»ºå¯åˆ†é…çš„é¡¹ç›®
    end
    
    %% 6.2. Portalç«¯é¡¹ç›®åˆ›å»º
    rect rgb(230,230,255)
    Note over Partner,View: ã€6.2. Portalç«¯ç”¨æˆ·åˆ›å»ºé¡¹ç›®ã€‘
    Partner->>Portal: åˆ›å»ºPre-Leadé¡¹ç›®
    Portal->>Portal: è®¾ç½®Lead Sourceä¸º"MOD Lead/æ¸ é“é¡¹ç›®"
    
    alt activeç”¨æˆ·é¡¹ç›®
        Portal->>View: æ¨é€é¡¹ç›®æ•°æ®
        View->>View: å­˜å‚¨é¡¹ç›®æ•°æ®ï¼Œè®¾ç½®ä¸ºPre-LeadçŠ¶æ€
        View-->>Portal: è¿”å›æ¥æ”¶ç¡®è®¤
    else inactiveç”¨æˆ·é¡¹ç›®
        Portal->>Portal: æœ¬åœ°å­˜å‚¨é¡¹ç›®æ•°æ®
        Note over Portal: inactiveç”¨æˆ·é¡¹ç›®å­˜åœ¨Portalç«¯ï¼Œæ¿€æ´»ååŒæ­¥åˆ°Viewç«¯
    end
    end
    
    %% 6.3. é¡¹ç›®åˆ†é…æµç¨‹
    rect rgb(255,230,230)
    Note over TKESales,Partner: ã€6.3. é¡¹ç›®åˆ†é…ç»™Partnerå…¬å¸ã€‘
    
    %% 6.3.1. å¯¼å…¥é¡¹ç›®æ—¶TaxCodeå…³è”åˆ†é…
    rect rgb(245,255,245)
    Note over TKESales,View: ã€6.3.1. å¯¼å…¥é¡¹ç›®æ—¶TaxCodeå…³è”åˆ†é…ã€‘
    TKESales->>View: Excelå¯¼å…¥é¡¹ç›®ï¼Œå¡«å†™TaxCode å’Œ åˆ†é…åŸå›  å…³è”Partner
    View->>View: æ ¹æ®TaxCodeè‡ªåŠ¨å…³è”å¯¹åº”Partner
    View->>View: åˆ›å»ºé¡¹ç›®è®°å½•ï¼ŒçŠ¶æ€ä¸ºPre-Leadï¼Œå¹¶åˆ†é…ç»™Partner
    end
    
    %% 6.3.2. æ‰‹åŠ¨æ–°å»ºé¡¹ç›®åˆ†é…
    rect rgb(255,245,245) 
    Note over TKESales,View: ã€6.3.2. æ‰‹åŠ¨æ–°å»ºé¡¹ç›®åˆ†é…ã€‘
    TKESales->>View: æ‰‹åŠ¨æ–°å»ºé¡¹ç›®
    TKESales->>View: æ·»åŠ Agent/Distributoråå…³è” Partner
    TKESales->>View: é€‰æ‹©åˆ†é…åŸå› 
    View->>View: åˆ›å»ºé¡¹ç›®è®°å½•ï¼ŒçŠ¶æ€ä¸ºPre-Leadï¼Œåˆ†é…ç»™é€‰å®šPartner
    end
    
    %% 6.3.3. Partner Info Tabæ‰¹é‡åˆ†é…
    rect rgb(245,245,255)
    Note over TKESales,View: ã€6.3.3. Partner Info Tabæ‰¹é‡åˆ†é…ã€‘
    TKESales->>View: åœ¨Partner Info Tabä¸­ç‚¹å‡»Assign ProjectæŒ‰é’®
    View-->>TKESales: è·³è½¬åˆ°å¾…åˆ†é…é¡¹ç›®åˆ—è¡¨
    View-->>TKESales: å±•ç¤ºpre-leadçŠ¶æ€çš„é¡¹ç›®
    TKESales->>View: æ‰¹é‡é€‰æ‹©é¡¹ç›®
    TKESales->>View: é€‰æ‹©åˆ†é…åŸå› 
    TKESales->>View: æ‰¹é‡åˆ†é…ç»™å½“å‰Partner
    end
    
    %% 6.3.4. Project Infoä¸­é€‰æ‹©Agent/Distributoråˆ†é…
    rect rgb(255,255,245)
    Note over TKESales,View: ã€6.3.4. Project Infoä¸­é€‰æ‹©Agent/Distributoråˆ†é…ã€‘
    TKESales->>View: åœ¨Project Infoé¡µé¢é€‰æ‹©Agent/Distributor
    TKESales->>View: é€‰æ‹©åˆ†é…åŸå› 
    TKESales->>View: åˆ†é…é¡¹ç›®ç»™é€‰å®šçš„Partner
    end
    
    %% ç»Ÿä¸€åˆ†é…åç»­æµç¨‹
    View->>View: æ£€æŸ¥Partnerå…¬å¸çŠ¶æ€
    
    alt Partnerå…¬å¸ä¸ºActiveçŠ¶æ€
        View->>Portal: å‘é€é¡¹ç›®åˆ†é…ï¼Œè®¾ç½®24å°æ—¶å“åº”æœŸé™
        Portal->>Portal: åˆ›å»ºé¡¹ç›®ï¼Œè®¾ç½®24å°æ—¶æˆªæ­¢æ—¶é—´
        Portal-->>View: è¿”å›åˆ†é…ç¡®è®¤(è¶…è¿‡24å°æ—¶æ ‡è®°ä¸º Cancel)
        
        View->>WeChat: å‘é€é¡¹ç›®åˆ†é…é€šçŸ¥
        WeChat-->>Partner: æ¨é€é¡¹ç›®é€šçŸ¥ç»™è¯¥å…¬å¸æ‰€æœ‰activeçŠ¶æ€çš„è”ç³»äººï¼ˆ24å°æ—¶å“åº”æé†’ï¼‰
        
        View->>View: é¡¹ç›®çŠ¶æ€ä¸ºPre-Leadï¼ŒAgent/Distributoré”å®šä¸å¯ç¼–è¾‘
        Note over View: Pre-LeadçŠ¶æ€æ—¶Proejct Infoä¸­å¯ä»¥æ›¿æ¢æˆ–åˆ é™¤Agent/Distributor, ä½†æ˜¯åªèƒ½ä¿ç•™ä¸€ä¸ª
        
    else Partnerå…¬å¸ä¸ºéActiveçŠ¶æ€
        View-->>TKESales: æç¤ºï¼šåªèƒ½åˆ†é…ç»™ActiveçŠ¶æ€çš„Partner
    end
    end
    
    %% 6.4. é¡¹ç›®å“åº”å¤„ç†
    rect rgb(255,255,230)
    Note over Partner,View: ã€6.4. é¡¹ç›®å“åº”å’ŒçŠ¶æ€ç®¡ç†ã€‘
    alt 24å°æ—¶å†…å“åº”
        Partner->>Portal: æ¥å—/æ‹’ç»é¡¹ç›®
        Portal->>View: æ¨é€é¡¹ç›®å“åº”
        View->>View: æ›´æ–°é¡¹ç›®ä¸­ Agent/Distributor æ¥å—çŠ¶æ€
        
        alt é¡¹ç›®è¢«æ¥å—
            View-->>TKESales: æ¨é€æ¥å—æ¶ˆæ¯(é‚®ä»¶)
            Note over View: é¡¹ç›®ç»§ç»­Pre-LeadçŠ¶æ€ï¼ŒAgent/Distributorä¿æŒé”å®š
        else é¡¹ç›®è¢«æ‹’ç»
            View->>View: è®°å½•æ‹’ç»åŸå› ï¼Œåœ¨ProjectInfoä¸­æ˜¾ç¤º
            View-->>TKESales: æ¨é€æ‹’ç»æ¶ˆæ¯ï¼ˆå«æ‹’ç»åŸå› ï¼‰(é‚®ä»¶)
            Note over View: å¯ä»¥é‡æ–°å‘èµ·åˆ†é…
        end
        
    else 24å°æ—¶è¶…æ—¶è‡ªåŠ¨å–æ¶ˆ
        View->>View: å®šæ—¶ä»»åŠ¡æ£€æŸ¥24å°æ—¶è¶…æ—¶
        View->>View: è‡ªåŠ¨æ›´æ–°é¡¹ç›®çŠ¶æ€ä¸ºcancelled
        View->>Portal: é€šçŸ¥é¡¹ç›®è‡ªåŠ¨å–æ¶ˆ
        Portal->>Portal: é¡¹ç›®ä»Partneré—¨æˆ·åˆ é™¤
        View->>WeChat: å‘é€é¡¹ç›®å–æ¶ˆé€šçŸ¥
        WeChat-->>TKESales: æ¨é€å–æ¶ˆæ¶ˆæ¯
        Note over View: å¯ä»¥é‡æ–°å‘èµ·åˆ†é…
    end
    end
    
    %% 6.5. é¡¹ç›®çŠ¶æ€å˜æ›´åç®¡ç†
    rect rgb(230,255,255)
    Note over TKESales,View: ã€6.5. é¡¹ç›®çŠ¶æ€å˜æ›´åçš„Agent/Distributorç®¡ç†ã€‘
    TKESales->>View: å°†é¡¹ç›®çŠ¶æ€ä»Pre-Leadå˜æ›´åˆ°Leadæˆ–å…¶ä»–åç»­çŠ¶æ€
    
    alt å˜æ›´åˆ°LeadåŠä¹‹åçŠ¶æ€æ—¶
        View->>View: æ£€æŸ¥Partneræ˜¯å¦å·²æ¥å—/æ‹’ç»é¡¹ç›®
        alt Partneræœªæ¥å—ä¹Ÿæœªæ‹’ç»
            View->>View: ç›´æ¥åˆ é™¤è¯¥Partner
            View->>View: ä»Partneré—¨æˆ·ç§»é™¤è¯¥é¡¹ç›®
        else Partnerå·²æ¥å—
            View->>View: ä¿æŒPartnerå…³è”ï¼ŒAgent/Distributorè§£é”å¯ç¼–è¾‘
        end
    else å˜æ›´åˆ°Pre-Leadä¹‹åçš„å…¶ä»–çŠ¶æ€
        View->>View: Agent/Distributorè§£é”ï¼Œå¯éšæ„ç¼–è¾‘
    end
    
    alt åœ¨Leadæˆ–åç»­çŠ¶æ€æ·»åŠ æ–°Agent/Distributor
        TKESales->>View: æ·»åŠ æ–°Agent/Distributoråˆ°é¡¹ç›®
        View->>Portal: ç›´æ¥æ¨é€é¡¹ç›®åˆ°æ–°Agent/Distributor
        Portal->>Portal: é¡¹ç›®ç›´æ¥æ˜¾ç¤ºåœ¨Partnerçš„Ongoingåˆ—è¡¨ä¸­ï¼Œä¸å¯ç¼–è¾‘
        Note over Portal: Partnerä¸éœ€è¦æ¥å—/æ‹’ç»ï¼Œé¡¹ç›®ç›´æ¥ç”Ÿæ•ˆä¸”Portalç«¯ä¸å¯ç¼–è¾‘
    end
    
    opt åˆ é™¤ä¹‹å‰çš„Agent/Distributor
        TKESales->>View: åˆ é™¤é¡¹ç›®ä¸­çš„Agent/Distributor
        View->>View: ä»Agent/Distributorå¯¹åº”çš„é¡¹ç›®åˆ—è¡¨ä¸­ç§»é™¤æ­¤é¡¹ç›®
        Note over View: Agent/Distributorè¢«åˆ é™¤åï¼Œé¡¹ç›®ä¸å†å‡ºç°åœ¨å…¶é¡¹ç›®åˆ—è¡¨ä¸­
    end
    
    end
    end

    %% 7. Channel Partner Project Summary
    rect rgb(255,255,204)
    Note over TKESales,View: ã€7. Channel Partner Project Summaryã€‘

    Note over View: é”€å”®ä»…èƒ½çœ‹åˆ°è‡ªå·±çš„,æœ‰å¯¹åº”branchæƒé™çš„å¯ä»¥çœ‹åˆ°æ‰€æœ‰
    TKESales->>View: æŸ¥çœ‹Channel Partner Project Summary
    View->>View: ç»Ÿè®¡ä»…Pre-LeadçŠ¶æ€çš„é¡¹ç›®æ•°æ®
    View->>View: æŒ‰Region->Branch->Partner Ownerå±‚çº§ç»Ÿè®¡
    
    View->>View: ç»Ÿè®¡é¡¹ç›®åˆ†ç±»ç»´åº¦
    Note over View: All(Created by partner) - æ‰€æœ‰æ¸ é“å•†è‡ªå¸¦é¡¹ç›®ï¼ˆPortalç«¯åˆ›å»ºçš„é¡¹ç›®ï¼‰
    Note over View: To Be Assigned - å¾…åˆ†é…é¡¹ç›®ï¼ˆPre-LeadçŠ¶æ€ï¼Œæœªåˆ†é…Agent/Distributorï¼‰
    Note over View: Accepted - å·²æ¥å—é¡¹ç›®ï¼ˆPartner Accept Status = acceptedï¼‰
    Note over View: Pending - å¾…æ¥å—é¡¹ç›®ï¼ˆPartner Accept Status = pendingï¼Œ24å°æ—¶å†…ï¼‰
    Note over View: Declined - å·²æ‹’ç»é¡¹ç›®ï¼ˆPartner Accept Status = declinedï¼‰
    Note over View: Cancelled - å·²å–æ¶ˆé¡¹ç›®ï¼ˆPartner Accept Status = cancelledï¼Œ24å°æ—¶è¶…æ—¶ï¼‰
    
    View-->>TKESales: å±•ç¤ºå¤šç»´åº¦ç»Ÿè®¡æ±‡æ€»
    Note over View: æ”¯æŒæŒ‰æ—¶é—´èŒƒå›´ç­›é€‰ï¼Œé»˜è®¤æ˜¾ç¤ºå½“å‰æœˆä»½
    Note over View: æ”¯æŒæŒ‰Region/Branch/Partner Owneré’»å–æŸ¥çœ‹
    
    TKESales->>View: ç‚¹å‡»ç»Ÿè®¡æ•°å­—è¿›è¡Œé’»å–
    View-->>TKESales: è·³è½¬åˆ°Project Reporté¡µé¢ï¼ˆå¸¦å¯¹åº”ç­›é€‰æ¡ä»¶ï¼‰
    end
    
    %% 8. Channel Partner Project Report
    rect rgb(255,230,255)
    Note over TKESales,View: ã€8. Channel Partner Project Reportã€‘
    Note over View: é”€å”®ä»…èƒ½çœ‹åˆ°è‡ªå·±çš„,æ‹¥æœ‰å¯¹åº”branchæƒé™çš„å¯ä»¥çœ‹åˆ°æ‰€æœ‰
    TKESales->>View: æŸ¥çœ‹Channel Partner Project Report
    View->>View: åŸºäºç”¨æˆ·æƒé™è¿‡æ»¤é¡¹ç›®æ•°æ®
    Note over View: ä»…æ˜¾ç¤ºactiveçŠ¶æ€Partnerçš„é¡¹ç›®ï¼Œä¸åŒ…å«inactiveçš„é¡¹ç›®
    
    alt ç­›é€‰æ¡ä»¶
        View->>View: Region - æŒ‰åŒºåŸŸç­›é€‰
        View->>View: Branch - æŒ‰åˆ†æ”¯ç­›é€‰
        View->>View: Partner - æŒ‰Partneråç§°ç­›é€‰
        View->>View: Project Sales - æŒ‰é¡¹ç›®é”€å”®ç­›é€‰
        View->>View: Project Name - æŒ‰é¡¹ç›®åç§°ç­›é€‰
        View->>View: Project ID - æŒ‰é¡¹ç›®IDç­›é€‰
        View->>View: Accept Status - æŒ‰æ¥å—çŠ¶æ€ç­›é€‰
        View->>View: Lead Source - æŒ‰çº¿ç´¢æ¥æºç­›é€‰
    end
    
    View->>View: æ”¯æŒå¤šç»´åº¦ç»„åˆç­›é€‰
    Note over View: æ”¯æŒRegion/Branch/Partner Owneræƒé™è¿‡æ»¤
    
    View-->>TKESales: å±•ç¤ºé¡¹ç›®è¯¦ç»†åˆ—è¡¨
    Note over View: Region - åŒºåŸŸ
    Note over View: Branch - åˆ†æ”¯
    Note over View: Project ID - é¡¹ç›®ID
    Note over View: Project Name - é¡¹ç›®åç§°
    Note over View: Partner Name - Partneråç§°
    Note over View: Contact - è”ç³»äºº
    Note over View: Project Sales - é¡¹ç›®é”€å”®
    Note over View: Lead Source - çº¿ç´¢æ¥æº
    Note over View: Sales Stage - é”€å”®é˜¶æ®µ
    Note over View: Accept Status - æ¥å—çŠ¶æ€
    Note over View: Partner Decline Reason - Partneræ‹’ç»åŸå› 
    Note over View: Units - æ•°é‡
    Note over View: Latest Update - æœ€è¿‘æ›´æ–°
    
    TKESales->>View: ç‚¹å‡»é¡¹ç›®åç§°
    View-->>TKESales: è·³è½¬åˆ°Project Infoè¯¦ç»†é¡µé¢
    
    end

    %% 9. Inquiry Management
    rect rgb(255,255,204)
    Note over Partner,View: ã€9. Inquiry Managementã€‘
    
    %% 9.1. ç”¨æˆ·å‘èµ·å’¨è¯¢
    rect rgb(230,255,230)
    Note over Partner,View: ã€9.1. ç”¨æˆ·å‘èµ·å’¨è¯¢ã€‘
    Partner->>Portal: å‘èµ·å’¨è¯¢
    
    alt activeç”¨æˆ·å’¨è¯¢
        Portal->>View: æ¨é€å’¨è¯¢æ•°æ®åˆ°Viewï¼ˆactiveåæ•°æ®è®°å½•åœ¨Viewç«¯ï¼‰
        View->>View: å­˜å‚¨å’¨è¯¢æ•°æ®ï¼Œåˆ†é…ç»™å¯¹åº”é”€å”®
        View-->>Portal: è¿”å›æ¥æ”¶ç¡®è®¤
    else inactiveç”¨æˆ·å’¨è¯¢
        Portal->>Portal: æœ¬åœ°å­˜å‚¨å’¨è¯¢
        Portal->>View: å‘é€å’¨è¯¢é€šçŸ¥
    end
    end
    
    %% 9.2. é”€å”®æ¥æ”¶é€šçŸ¥
    rect rgb(230,230,255)
    Note over TKESales,View: ã€9.2. é”€å”®æ¥æ”¶é€šçŸ¥ã€‘
    View->>View: æ£€æŸ¥Partnerå…³è”é”€å”®
    
    alt Partnerå…³è”å¤šä¸ªé”€å”®
        View-->>TKESales: æ‰€æœ‰å…³è”é”€å”®éƒ½æ”¶åˆ°é—®è¯¢é€šçŸ¥ï¼ˆé‚®ä»¶ï¼‰
    else Partnerå…³è”å•ä¸ªé”€å”®
        View-->>TKESales: å•ä¸ªé”€å”®æ”¶åˆ°é—®è¯¢é€šçŸ¥ï¼ˆé‚®ä»¶ï¼‰
    end
    
    Note over View: ä»…å…³è”çš„é”€å”®å¯ä»¥çœ‹åˆ°å¹¶è¿›è¡Œå›å¤é—®è¯¢
    end
    
    %% 9.3. Inquiryæ¨¡å—å›å¤å’¨è¯¢
    rect rgb(255,230,230)
    Note over TKESales,View: ã€9.3. Inquiryæ¨¡å—ä¸­å›å¤å’¨è¯¢å’Œè·³è½¬ã€‘
    TKESales->>View: è¿›å…¥Inquiryç®¡ç†æ¨¡å—
    Note over View: é”€å”®ä»…èƒ½çœ‹åˆ°è‡ªå·±çš„,æ‹¥æœ‰å¯¹åº”branchæƒé™çš„å¯ä»¥çœ‹åˆ°æ‰€æœ‰
    Note over View: é”€å”®ä¸èƒ½çœ‹ç”¨æˆ·è¯„ä»·,æ‹¥æœ‰æƒé™çš„å¯ä»¥çœ‹
    View-->>TKESales: æ˜¾ç¤ºå¯å›å¤çš„é—®è¯¢ï¼ˆä»…æ˜¾ç¤ºè¯¥é”€å”®å…³è”çš„Partneré—®è¯¢ï¼‰
    
    alt ç‚¹å‡»Partner Nameè·³è½¬
        alt Partnerä¸ºinactiveçŠ¶æ€
            TKESales->>View: ç‚¹å‡»Partner Name
            View-->>TKESales: è·³è½¬åˆ°å®¡æ‰¹é¡µé¢ï¼ˆManage Customersæˆ–Partner Infoï¼‰
        else Partnerä¸ºactiveçŠ¶æ€
            TKESales->>View: ç‚¹å‡»Partner Name
            View-->>TKESales: è·³è½¬åˆ°Customeré¡µé¢
        end
    end
    
    alt åœ¨Inquiryæ¨¡å—ä¸­å›å¤å’¨è¯¢
        alt å›å¤activeç”¨æˆ·å’¨è¯¢
            TKESales->>View: é€‰æ‹©å’¨è¯¢è¿›è¡Œå›å¤
            View->>View: å­˜å‚¨å›å¤æ•°æ®åœ¨Viewç«¯ï¼Œæ›´æ–°å’¨è¯¢çŠ¶æ€ä¸ºratingï¼Œè®¾ç½®30å¤©è¯„ä»·æˆªæ­¢æ—¶é—´
            View->>Portal: å‘é€å›å¤æ•°æ®
            View->>WeChat: å‘é€å›å¤é€šçŸ¥
            WeChat-->>Partner: æ¨é€å›å¤æ¶ˆæ¯
            
            Partner->>Portal: å¯¹å’¨è¯¢è¿›è¡Œè¯„ä»·ï¼ˆ30å¤©å†…ï¼‰
            Portal->>View: æ¨é€è¯„ä»·æ•°æ®
            View->>View: å­˜å‚¨è¯„ä»·æ•°æ®ï¼Œæ›´æ–°ç»Ÿè®¡ä¿¡æ¯
            
            opt 30å¤©æœªå¯¹å›å¤è¯„ä»·è‡ªåŠ¨å…³é—­
                View->>View: å®šæ—¶ä»»åŠ¡æ£€æŸ¥30å¤©è¶…æ—¶
                View->>View: è‡ªåŠ¨æ›´æ–°å’¨è¯¢çŠ¶æ€ä¸ºclosed
                View->>Portal: é€šçŸ¥è‡ªåŠ¨å…³é—­
                Portal->>Portal: æ›´æ–°å’¨è¯¢çŠ¶æ€ä¸ºclosed
            end
            
        else å›å¤inactiveç”¨æˆ·å’¨è¯¢
            TKESales->>View: é€‰æ‹©å’¨è¯¢è¿›è¡Œå›å¤
            View->>Portal: å­˜å‚¨å›å¤æ•°æ®åœ¨Portalç«¯ï¼Œè®¾ç½®30å¤©è¯„ä»·æˆªæ­¢æ—¶é—´
            Portal->>Portal: æ›´æ–°å’¨è¯¢çŠ¶æ€ä¸ºrating
            Portal->>WeChat: å‘é€å›å¤é€šçŸ¥
            WeChat-->>Partner: æ¨é€å›å¤æ¶ˆæ¯
            
            Partner->>Portal: å¯¹å’¨è¯¢è¿›è¡Œè¯„ä»·ï¼ˆ30å¤©å†…ï¼‰
            Portal->>View: æ¨é€è¯„ä»·æ•°æ®
            View->>View: å­˜å‚¨è¯„ä»·æ•°æ®ï¼Œæ›´æ–°ç»Ÿè®¡ä¿¡æ¯
            
            opt 30å¤©æœªå¯¹å›å¤è¯„ä»·è‡ªåŠ¨å…³é—­
                Portal->>Portal: å®šæ—¶ä»»åŠ¡æ£€æŸ¥30å¤©è¶…æ—¶
                Portal->>Portal: è‡ªåŠ¨æ›´æ–°å’¨è¯¢çŠ¶æ€ä¸ºclosed
            end
        end
    end
    
    Note over View: ä¸è®ºactiveæˆ–inactiveç”¨æˆ·ï¼Œéƒ½æœ‰30å¤©è¯„ä»·æœŸé™
    end
    
    %% 9.4. å®¡æ‰¹é¡µé¢å›å¤é—®è¯¢
    rect rgb(255,230,255)
    Note over TKESales,View: ã€9.4. å®¡æ‰¹é¡µé¢å›å¤é—®è¯¢ã€‘
    
    alt Manage Customersé¡µé¢å›å¤
        TKESales->>View: å›å¤inactiveç”¨æˆ·é—®è¯¢è®°å½•
        View->>View: å­˜å‚¨å›å¤ï¼Œè®¾ç½®30å¤©è¯„ä»·æœŸé™
        View->>Portal: å‘é€å›å¤ç»“æœ
        Portal->>WeChat: å‘é€å›å¤é€šçŸ¥
        WeChat-->>Partner: æ¨é€å›å¤æ¶ˆæ¯
        
    else Partner Infoé¡µé¢å›å¤
        alt æœ‰å¾…å®¡æ‰¹çš„inactiveç”¨æˆ·
            TKESales->>View: å›å¤inactiveç”¨æˆ·é—®è¯¢è®°å½•
        else æ— å¾…å®¡æ‰¹çš„inactiveç”¨æˆ·
            TKESales->>View: å›å¤activeç”¨æˆ·é—®è¯¢è®°å½•
        end
        View->>View: å­˜å‚¨å›å¤ï¼Œè®¾ç½®30å¤©è¯„ä»·æœŸé™
        View->>Portal: å‘é€å›å¤ç»“æœ
        Portal->>WeChat: å‘é€å›å¤é€šçŸ¥
        WeChat-->>Partner: æ¨é€å›å¤æ¶ˆæ¯
    end
    
    Partner->>Portal: å¯¹å’¨è¯¢è¿›è¡Œè¯„ä»·ï¼ˆ30å¤©å†…ï¼‰
    Portal->>View: æ¨é€è¯„ä»·æ•°æ®
    View->>View: å­˜å‚¨è¯„ä»·æ•°æ®ï¼Œæ›´æ–°ç»Ÿè®¡ä¿¡æ¯
    
    opt 30å¤©æœªè¯„ä»·è‡ªåŠ¨å…³é—­
        View->>View: å®šæ—¶ä»»åŠ¡æ£€æŸ¥30å¤©è¶…æ—¶
        View->>View: è‡ªåŠ¨æ›´æ–°å’¨è¯¢çŠ¶æ€ä¸ºclosed
    end
    end
    
    %% 9.5. è¯„ä»·ç»Ÿè®¡å±•ç¤º
    rect rgb(255,255,230)
    Note over TKESales,View: ã€9.5. è¯„ä»·ç»Ÿè®¡å±•ç¤ºã€‘
    TKESales->>View: æŸ¥çœ‹Closedåˆ—è¡¨
    View->>View: ç»Ÿè®¡è¯„ä»·æ•°æ®
    View-->>TKESales: æ˜¾ç¤ºBranch Rateså’ŒSales Ratesç»´åº¦çš„è¯„ä»·ç»Ÿè®¡
    
    TKESales->>View: æŸ¥çœ‹Countryçº§åˆ«ç»Ÿè®¡
    View->>View: ç»Ÿè®¡Countryçº§åˆ«æ•°æ®
    View-->>TKESales: æ˜¾ç¤ºCountryçº§åˆ«çš„Ratesç»Ÿè®¡
    
    Note over View: Branch Rates - æŒ‰åˆ†æ”¯æœºæ„ç»Ÿè®¡çš„è¯„ä»·
    Note over View: Sales Rates - æŒ‰é”€å”®äººå‘˜ç»Ÿè®¡çš„è¯„ä»·
    Note over View: Country Rates - æŒ‰å›½å®¶/åœ°åŒºç»Ÿè®¡çš„è¯„ä»·
    end
    end

    %% 10. TKE Library
    rect rgb(204,255,255)
    Note over TKESales,Partner: ã€10. TKE Libraryã€‘
    TKESales->>View: ä¸Šä¼ æ–‡ä»¶åˆ°TKE Libraryæ¨¡å—
    View->>View: å­˜å‚¨æ–‡ä»¶åˆ°NASï¼Œè®°å½•æ–‡ä»¶ä¿¡æ¯
    View->>Portal: åŒæ­¥æ–‡ä»¶ä¿¡æ¯
    Portal->>Portal: æ ¹æ®è®¿é—®æƒé™çº§åˆ«å­˜å‚¨æ–‡ä»¶ä¿¡æ¯
    Portal-->>View: è¿”å›åŒæ­¥ç¡®è®¤
    
    Partner->>Portal: æŸ¥çœ‹æ–‡ä»¶åº“ï¼ˆåŸºäºç”¨æˆ·çŠ¶æ€ï¼šinactive/active/agrï¼‰
    Portal->>View: è·å–æ–‡ä»¶åˆ—è¡¨
    View-->>Portal: è¿”å›åŸºäºæƒé™çš„æ–‡ä»¶åˆ—è¡¨
    Portal-->>Partner: å±•ç¤ºå¯è®¿é—®æ–‡ä»¶
    
    Partner->>Portal: ä¸‹è½½/é¢„è§ˆæ–‡ä»¶
    end
```

## 2. Portalç«¯å…¬å…±æ¨¡å—è®¾è®¡åŠåŠŸèƒ½

### 2.1 å¾®ä¿¡æˆæƒç»„ä»¶è®¾è®¡

#### 2.1.1 WechatAuthService

- **æ¦‚è¿°**ï¼šå¾®ä¿¡ç½‘é¡µæˆæƒæœåŠ¡ç»„ä»¶ï¼Œç”¨äºæ‹¼æ¥æˆæƒ URLã€é€šè¿‡ code æ¢å– openid/accessToken/refreshTokenã€æ ¡éªŒ token æœ‰æ•ˆæ€§åŠåˆ·æ–°ã€ç”Ÿæˆå’Œè§£æä¸šåŠ¡tokenã€‚
- **ä»£ç è·¯å¾„**ï¼š`packages/General/Foundation/src/Services/Wechat/WechatAuthService.php`
- **æ–‡ä»¶çŠ¶æ€**ï¼šæ–°å¢
- **å¤ç”¨åœºæ™¯**ï¼šå¾®ä¿¡æˆæƒç™»å½•ã€ç”¨æˆ·æ³¨å†Œã€è·å–ç”¨æˆ·ä¿¡æ¯ã€åˆ·æ–°æˆæƒçŠ¶æ€
- **æ¥å£å®šä¹‰**ï¼š

  - **getAuthUrl($scope, $redirectUri, $state)**
    - **åŠŸèƒ½æè¿°**ï¼šç”Ÿæˆç½‘é¡µæˆæƒé“¾æ¥ã€‚
    - **å¾®ä¿¡API URL**ï¼š<https://open.weixin.qq.com/connect/oauth2/authorize>
    - **è¯·æ±‚å‚æ•°**ï¼š

        | å‚æ•°åç§° | ç±»å‹   | å¿…å¡« | æè¿° |
        |----------|--------|------|------|
        | scope    | String | æ˜¯   | `snsapi_base` é™é»˜ / `snsapi_userinfo` è·å–èµ„æ–™ |
        | redirect_uri | String | æ˜¯ | å›è°ƒåœ°å€ï¼Œéœ€ UrlEncode |
        | state    | String | å¦   | è‡ªå®šä¹‰å‚æ•°ï¼Œå­˜æ¸ é“ scene å€¼ |

    - **å“åº”æ•°æ®**ï¼š

        | å‚æ•°åç§° | ç±»å‹   | æè¿°              |
        |----------|--------|-------------------|
        | url      | String | æ‹¼æ¥å¥½çš„æˆæƒ URL  |

  - **getAccessToken($code)**
    - **åŠŸèƒ½æè¿°**ï¼šé€šè¿‡æˆæƒcodeæ¢å–access_tokenã€‚
    - **å¾®ä¿¡API URL**ï¼š<https://api.weixin.qq.com/sns/oauth2/access_token>
    - **è¯·æ±‚å‚æ•°**ï¼š

        | å‚æ•°åç§° | ç±»å‹   | å¿…å¡« | æè¿° |
        |----------|--------|------|------|
        | code     | String | æ˜¯   | æˆæƒå›è°ƒè·å¾—çš„code |

    - **å“åº”æ•°æ®**ï¼š

        | å‚æ•°åç§°      | ç±»å‹   | æè¿° |
        |---------------|--------|------|
        | access_token  | String | ç½‘é¡µæˆæƒæ¥å£è°ƒç”¨å‡­è¯ |
        | expires_in    | Integer | access_tokenæ¥å£è°ƒç”¨å‡­è¯è¶…æ—¶æ—¶é—´ï¼Œå•ä½ï¼ˆç§’ï¼‰ |
        | refresh_token | String | ç”¨æˆ·åˆ·æ–°access_token |
        | openid        | String | ç”¨æˆ·å”¯ä¸€æ ‡è¯† |
        | scope         | String | ç”¨æˆ·æˆæƒçš„ä½œç”¨åŸŸ |

  - **getUserInfo($openid, $accessToken)**
    - **åŠŸèƒ½æè¿°**ï¼šæ‹‰å–ç”¨æˆ·ä¿¡æ¯ã€‚
    - **å¾®ä¿¡API URL**ï¼š<https://api.weixin.qq.com/sns/userinfo>
    - **è¯·æ±‚å‚æ•°**ï¼š

        | å‚æ•°åç§°     | ç±»å‹   | å¿…å¡« | æè¿° |
        |--------------|--------|------|------|
        | openid       | String | æ˜¯   | ç”¨æˆ·çš„å”¯ä¸€æ ‡è¯† |
        | access_token  | String | æ˜¯   | ç½‘é¡µæˆæƒæ¥å£è°ƒç”¨å‡­è¯ |

    - **å“åº”æ•°æ®**ï¼š

        | å‚æ•°åç§°   | ç±»å‹   | æè¿° |
        |------------|--------|------|
        | openid     | String | ç”¨æˆ·çš„å”¯ä¸€æ ‡è¯† |
        | nickname   | String | ç”¨æˆ·æ˜µç§° |
        | headimgurl | String | ç”¨æˆ·å¤´åƒ |
        | sex        | Integer | ç”¨æˆ·çš„æ€§åˆ«ï¼Œå€¼ä¸º1æ—¶æ˜¯ç”·æ€§ï¼Œå€¼ä¸º2æ—¶æ˜¯å¥³æ€§ï¼Œå€¼ä¸º0æ—¶æ˜¯æœªçŸ¥ |
        | country    | String | ç”¨æˆ·ä¸ªäººèµ„æ–™å¡«å†™çš„å›½å®¶ |
        | province   | String | ç”¨æˆ·ä¸ªäººèµ„æ–™å¡«å†™çš„çœä»½ |
        | city       | String | ç”¨æˆ·ä¸ªäººèµ„æ–™å¡«å†™çš„åŸå¸‚ |

  - **refreshAccessToken($refreshToken)**
    - **åŠŸèƒ½æè¿°**ï¼šåˆ·æ–°access_tokenã€‚
    - **å¾®ä¿¡API URL**ï¼š<https://api.weixin.qq.com/sns/oauth2/refresh_token>
    - **è¯·æ±‚å‚æ•°**ï¼š

        | å‚æ•°åç§°      | ç±»å‹   | å¿…å¡« | æè¿° |
        |---------------|--------|------|------|
        | refresh_token  | String | æ˜¯   | å¡«å†™é€šè¿‡access_tokenè·å–åˆ°çš„refresh_tokenå‚æ•° |

    - **å“åº”æ•°æ®**ï¼š

        | å‚æ•°åç§°      | ç±»å‹   | æè¿° |
        |---------------|--------|------|
        | access_token  | String | ç½‘é¡µæˆæƒæ¥å£è°ƒç”¨å‡­è¯ |
        | expires_in    | Integer | access_tokenæ¥å£è°ƒç”¨å‡­è¯è¶…æ—¶æ—¶é—´ï¼Œå•ä½ï¼ˆç§’ï¼‰ |
        | refresh_token | String | ç”¨æˆ·åˆ·æ–°access_token |
        | openid        | String | ç”¨æˆ·å”¯ä¸€æ ‡è¯† |
        | scope         | String | ç”¨æˆ·æˆæƒçš„ä½œç”¨åŸŸ |

  - **extractSceneParam($state)**
    - **åŠŸèƒ½æè¿°**ï¼šä»stateå‚æ•°ä¸­æå–åœºæ™¯å€¼ã€‚
    - **è¯·æ±‚å‚æ•°**ï¼š

        | å‚æ•°åç§° | ç±»å‹   | å¿…å¡« | æè¿° |
        |----------|--------|------|------|
        | state    | String | æ˜¯   | å¾®ä¿¡å›è°ƒä¸­çš„stateå‚æ•° |

    - **å“åº”æ•°æ®**ï¼š

        | å‚æ•°åç§° | ç±»å‹   | æè¿° |
        |----------|--------|------|
        | scene    | String | æå–çš„åœºæ™¯å€¼ |

#### 2.1.2 WechatMessageService

- **æ¦‚è¿°**ï¼šå¾®ä¿¡æ¶ˆæ¯æ¨é€æœåŠ¡ï¼Œç”¨äºå‘é€æ¨¡æ¿æ¶ˆæ¯
- **ä»£ç è·¯å¾„**ï¼š`packages/General/Foundation/src/Services/Wechat/WechatMessageService.php`
- **æ–‡ä»¶çŠ¶æ€**ï¼šæ–°å¢
- **å¤ç”¨åœºæ™¯**ï¼šæ³¨å†ŒæˆåŠŸé€šçŸ¥ã€å®¡æ‰¹ç»“æœé€šçŸ¥ã€ä¸šåŠ¡çŠ¶æ€æé†’
- **æ¥å£å®šä¹‰**ï¼š

  - **sendTemplateMessage($templateData)**
    - **åŠŸèƒ½æè¿°**ï¼šå‘é€æ¨¡æ¿æ¶ˆæ¯ã€‚
    - **å¾®ä¿¡API URL**ï¼š<https://api.weixin.qq.com/cgi-bin/message/template/send>
    - **è¯·æ±‚å‚æ•°**ï¼š

        | å‚æ•°åç§°     | ç±»å‹   | å¿…å¡« | æè¿° |
        |--------------|--------|------|------|
        | touser       | String | æ˜¯   | æ¥æ”¶è€…openid |
        | template_id  | String | æ˜¯   | æ¨¡æ¿ID |
        | url          | String | å¦   | æ¨¡æ¿è·³è½¬é“¾æ¥ |
        | data         | Object | æ˜¯   | æ¨¡æ¿æ•°æ®æ ¼å¼å½¢å¦‚ { "key1": { "value": any }, "key2": { "value": any } } |

    - **å“åº”æ•°æ®**ï¼š

        | å‚æ•°åç§° | ç±»å‹    | æè¿° |
        |----------|---------|------|
        | success  | Boolean | å‘é€æ˜¯å¦æˆåŠŸ |
        | msgid    | Integer | æ¶ˆæ¯idï¼Œ64ä½æ•´å‹ |
        | errcode  | Integer | é”™è¯¯ç  |
        | errmsg   | String  | é”™è¯¯ä¿¡æ¯ |

  - **getAccessToken()**
    - **åŠŸèƒ½æè¿°**ï¼šè·å–access_tokenã€‚
    - **å¾®ä¿¡API URL**ï¼š<https://api.weixin.qq.com/cgi-bin/token>
    - **è¯·æ±‚å‚æ•°**ï¼š

        | å‚æ•°åç§°   | ç±»å‹   | å¿…å¡« | æè¿° |
        |------------|--------|------|------|
        | grant_type | String | æ˜¯   | è·å–access_tokenå¡«å†™client_credential |
        | appid      | String | æ˜¯   | ç¬¬ä¸‰æ–¹ç”¨æˆ·å”¯ä¸€å‡­è¯ |
        | secret     | String | æ˜¯   | ç¬¬ä¸‰æ–¹ç”¨æˆ·å”¯ä¸€å‡­è¯å¯†é’¥ |

    - **å“åº”æ•°æ®**ï¼š

        | å‚æ•°åç§°     | ç±»å‹   | æè¿° |
        |--------------|--------|------|
        | access_token | String | è·å–åˆ°çš„å‡­è¯ |
        | expires_in   | Integer | å‡­è¯æœ‰æ•ˆæ—¶é—´ï¼Œå•ä½ï¼šç§’ |

#### 2.1.3 æ¶‰åŠæ•°æ®è¡¨

**wechat_tokens**

| å­—æ®µåç§° | ç±»å‹ | é•¿åº¦ | å¯ç©º | é»˜è®¤å€¼ | æè¿° |
|----------|------|------|------|--------|------|
| Id | INT | 20 | NO | | ä¸»é”®ID |
| UserId | INT | 11 | NO | | ç”¨æˆ·ID |
| OpenId | VARCHAR | 128 | NO | | å¾®ä¿¡openid |
| AccessToken | TEXT | | YES | NULL | è®¿é—®ä»¤ç‰Œ |
| RefreshToken | TEXT | | YES | NULL | åˆ·æ–°ä»¤ç‰Œ |
| ExpiresDate | DATETIME | | YES | NULL | ä»¤ç‰Œè¿‡æœŸæ—¶é—´ |
| CreatedDate | DATETIME | | YES | NULL | åˆ›å»ºæ—¶é—´ |
| LastModifiedDate | DATETIME | | YES | NULL | æ›´æ–°æ—¶é—´ |

**message_templates**

| å­—æ®µåç§° | ç±»å‹ | é•¿åº¦ | å¯ç©º | é»˜è®¤å€¼ | æè¿° |
|----------|------|------|------|--------|------|
| Id | INT | 11 | NO | | ä¸»é”®ID |
| TemplateCode | VARCHAR | 50 | NO | | æ¨¡æ¿ç¼–ç  |
| TemplateId | VARCHAR | 100 | NO | | å¾®ä¿¡æ¨¡æ¿ID |
| TemplateName | VARCHAR | 200 | NO | | æ¨¡æ¿åç§° |
| TemplateContent | TEXT | | NO | | æ¨¡æ¿å†…å®¹ |
| Status | TINYINT | 1 | NO | 1 | çŠ¶æ€ï¼š1å¯ç”¨ 0ç¦ç”¨ |
| CreatedDate | DATETIME | | YES | NULL | åˆ›å»ºæ—¶é—´ |
| LastModifiedDate | DATETIME | | YES | NULL | æ›´æ–°æ—¶é—´ |

### 2.2 è®¤è¯æˆæƒç»„ä»¶è®¾è®¡

#### 2.2.1 ç»„ä»¶å…³ç³»è¯´æ˜

è®¤è¯æˆæƒç»„ä»¶é‡‡ç”¨"ä¸­é—´ä»¶ + æœåŠ¡"çš„åˆ†å±‚æ¶æ„ï¼š

- **AuthMiddleware**ï¼šè´Ÿè´£åŸºç¡€èº«ä»½éªŒè¯ï¼ŒéªŒè¯ç”¨æˆ·Tokenæœ‰æ•ˆæ€§
- **PermissionMiddleware**ï¼šè´Ÿè´£æƒé™æ§åˆ¶ï¼Œè°ƒç”¨UserPermissionServiceè¿›è¡Œå…·ä½“æƒé™æ£€æŸ¥
- **UserPermissionService**ï¼šè´Ÿè´£æƒé™ä¸šåŠ¡é€»è¾‘ï¼Œå¤„ç†ç”¨æˆ·ä¸å…¬å¸çš„ç»‘å®šå…³ç³»ã€çŠ¶æ€æ£€æŸ¥ã€å…¬å¸åˆ‡æ¢ç­‰

**è°ƒç”¨å…³ç³»**ï¼š

```
HTTP Request â†’ AuthMiddleware â†’ PermissionMiddleware â†’ UserPermissionService â†’ Controller
```

#### 2.2.2 AuthMiddleware

- **æ¦‚è¿°**ï¼šAPIè®¤è¯ä¸­é—´ä»¶ï¼Œç»Ÿä¸€å¤„ç†è¯·æ±‚èº«ä»½éªŒè¯ï¼ŒéªŒè¯ç”¨æˆ·Tokenæœ‰æ•ˆæ€§ï¼Œè®¾ç½®ç”¨æˆ·è¯­è¨€ç¯å¢ƒã€‚
- **ä»£ç è·¯å¾„**ï¼š`app/Http/Middleware/AuthMiddleware.php`
- **æ–‡ä»¶çŠ¶æ€**ï¼šæ–°å¢
- **å¤ç”¨åœºæ™¯**ï¼šæ‰€æœ‰éœ€è¦èº«ä»½éªŒè¯çš„APIæ¥å£
- **æ¥å£å®šä¹‰**ï¼š

  - **handle($request, $next)**
    - **åŠŸèƒ½æè¿°**ï¼šå¤„ç†HTTPè¯·æ±‚çš„èº«ä»½éªŒè¯å’Œè¯­è¨€è®¾ç½®ã€‚
    - **è¯·æ±‚å‚æ•°**ï¼š

        | å‚æ•°åç§° | ç±»å‹    | å¿…å¡« | æè¿° |
        |----------|---------|------|------|
        | request  | Request | æ˜¯   | HTTPè¯·æ±‚å¯¹è±¡ |
        | next     | Closure | æ˜¯   | ä¸‹ä¸€ä¸ªä¸­é—´ä»¶ |

    - **å“åº”æ•°æ®**ï¼š

        | å‚æ•°åç§° | ç±»å‹     | æè¿° |
        |----------|----------|------|
        | response | Response | HTTPå“åº”æˆ–ç»§ç»­æ‰§è¡Œ |

#### 2.2.3 PermissionMiddleware

- **æ¦‚è¿°**ï¼šæƒé™æ§åˆ¶ä¸­é—´ä»¶ï¼Œæ£€æŸ¥ç”¨æˆ·æ˜¯å¦æœ‰æƒè®¿é—®ç‰¹å®šèµ„æºæˆ–æ‰§è¡Œç‰¹å®šæ“ä½œï¼Œé€šè¿‡è°ƒç”¨UserPermissionServiceè¿›è¡Œæƒé™éªŒè¯ã€‚
- **ä»£ç è·¯å¾„**ï¼š`app/Http/Middleware/PermissionMiddleware.php`
- **æ–‡ä»¶çŠ¶æ€**ï¼šæ–°å¢
- **å¤ç”¨åœºæ™¯**ï¼šéœ€è¦æƒé™æ§åˆ¶çš„APIæ¥å£ï¼Œå¦‚å…¬å¸ç›¸å…³æ“ä½œã€é¡¹ç›®ç®¡ç†ç­‰
- **ä¾èµ–å…³ç³»**ï¼šè°ƒç”¨UserPermissionServiceè¿›è¡Œæƒé™æ£€æŸ¥
- **æ¥å£å®šä¹‰**ï¼š

  - **handle($request, $next, $permission)**
    - **åŠŸèƒ½æè¿°**ï¼šæ£€æŸ¥ç”¨æˆ·æƒé™å¹¶æ§åˆ¶è®¿é—®ã€‚
    - **è¯·æ±‚å‚æ•°**ï¼š

        | å‚æ•°åç§°   | ç±»å‹    | å¿…å¡« | æè¿° |
        |------------|---------|------|------|
        | request    | Request | æ˜¯   | HTTPè¯·æ±‚å¯¹è±¡ |
        | next       | Closure | æ˜¯   | ä¸‹ä¸€ä¸ªä¸­é—´ä»¶ |
        | permission | String  | æ˜¯   | æƒé™æ ‡è¯† |

    - **å“åº”æ•°æ®**ï¼š

        | å‚æ•°åç§° | ç±»å‹     | æè¿° |
        |----------|----------|------|
        | response | Response | HTTPå“åº”æˆ–ç»§ç»­æ‰§è¡Œ |

#### 2.2.4 UserPermissionService

- **æ¦‚è¿°**ï¼šç”¨æˆ·æƒé™æœåŠ¡ç»„ä»¶ï¼Œå¤„ç†ç”¨æˆ·ä¸å…¬å¸çš„ç»‘å®šå…³ç³»æ£€æŸ¥ã€æƒé™çŠ¶æ€éªŒè¯ã€å…¬å¸åˆ‡æ¢ç­‰æƒé™ç›¸å…³ä¸šåŠ¡é€»è¾‘ã€‚
- **ä»£ç è·¯å¾„**ï¼š`app/Services/Auth/UserPermissionService.php`
- **æ–‡ä»¶çŠ¶æ€**ï¼šæ–°å¢
- **å¤ç”¨åœºæ™¯**ï¼šæƒé™ä¸­é—´ä»¶ã€APIæƒé™éªŒè¯ã€ç”¨æˆ·å…¬å¸åˆ‡æ¢ã€æƒé™çŠ¶æ€åŒæ­¥
- **è¢«è°ƒç”¨è€…**ï¼šPermissionMiddlewareã€ä¸šåŠ¡æ§åˆ¶å™¨
- **æ¥å£å®šä¹‰**ï¼š

  - **checkUserCompanyBinding($userId, $companyId)**
    - **åŠŸèƒ½æè¿°**ï¼šæ£€æŸ¥ç”¨æˆ·æ˜¯å¦ä¸æŒ‡å®šå…¬å¸æœ‰ç»‘å®šå…³ç³»ã€‚
    - **è¯·æ±‚å‚æ•°**ï¼š

        | å‚æ•°åç§°  | ç±»å‹    | å¿…å¡« | æè¿° |
        |-----------|---------|------|------|
        | userId    | Integer | æ˜¯   | ç”¨æˆ·ID |
        | companyId | Integer | æ˜¯   | å…¬å¸ID |

    - **å“åº”æ•°æ®**ï¼š

        | å‚æ•°åç§°  | ç±»å‹    | æè¿° |
        |-----------|---------|------|
        | isBound   | Boolean | æ˜¯å¦å­˜åœ¨ç»‘å®šå…³ç³» |

  - **getUserCompanyStatus($userId, $companyId)**
    - **åŠŸèƒ½æè¿°**ï¼šè·å–ç”¨æˆ·åœ¨æŒ‡å®šå…¬å¸çš„çŠ¶æ€ä¿¡æ¯ã€‚
    - **è¯·æ±‚å‚æ•°**ï¼š

        | å‚æ•°åç§°  | ç±»å‹    | å¿…å¡« | æè¿° |
        |-----------|---------|------|------|
        | userId    | Integer | æ˜¯   | ç”¨æˆ·ID |
        | companyId | Integer | æ˜¯   | å…¬å¸ID |

    - **å“åº”æ•°æ®**ï¼š

        | å‚æ•°åç§°      | ç±»å‹   | æè¿° |
        |---------------|--------|------|
        | contact_status | String | è”ç³»äººçŠ¶æ€ï¼šactive/inactive |
        | account_status | String | è´¦æˆ·çŠ¶æ€ï¼šnormal/agr |
        | created_date   | String | ç»‘å®šåˆ›å»ºæ—¶é—´ |

  - **checkUserCompanyPermission($userId, $companyId, $permission)**
    - **åŠŸèƒ½æè¿°**ï¼šæ£€æŸ¥ç”¨æˆ·åœ¨æŒ‡å®šå…¬å¸æ˜¯å¦å…·æœ‰ç‰¹å®šæƒé™ã€‚
    - **è¯·æ±‚å‚æ•°**ï¼š

        | å‚æ•°åç§°   | ç±»å‹    | å¿…å¡« | æè¿° |
        |------------|---------|------|------|
        | userId     | Integer | æ˜¯   | ç”¨æˆ·ID |
        | companyId  | Integer | æ˜¯   | å…¬å¸ID |
        | permission | String  | æ˜¯   | æƒé™æ ‡è¯† |

    - **å“åº”æ•°æ®**ï¼š

        | å‚æ•°åç§°      | ç±»å‹    | æè¿° |
        |---------------|---------|------|
        | hasPermission | Boolean | æ˜¯å¦å…·æœ‰æƒé™ |
        | status        | String  | å½“å‰çŠ¶æ€ |

  - **switchUserCompany($userId, $companyId)**
    - **åŠŸèƒ½æè¿°**ï¼šç”¨æˆ·åˆ‡æ¢å½“å‰æ“ä½œçš„å…¬å¸ã€‚
    - **è¯·æ±‚å‚æ•°**ï¼š

        | å‚æ•°åç§°  | ç±»å‹    | å¿…å¡« | æè¿° |
        |-----------|---------|------|------|
        | userId    | Integer | æ˜¯   | ç”¨æˆ·ID |
        | companyId | Integer | æ˜¯   | ç›®æ ‡å…¬å¸ID |

    - **å“åº”æ•°æ®**ï¼š

        | å‚æ•°åç§°    | ç±»å‹    | æè¿° |
        |-------------|---------|------|
        | success     | Boolean | åˆ‡æ¢æ˜¯å¦æˆåŠŸ |
        | companyInfo | Object  | å…¬å¸ä¿¡æ¯ |
        | permissions | Array   | ç”¨æˆ·åœ¨è¯¥å…¬å¸çš„æƒé™åˆ—è¡¨ |

  - **syncUserCompanyStatus($userId, $companyId, $statusData)**
    - **åŠŸèƒ½æè¿°**ï¼šåŒæ­¥ç”¨æˆ·å…¬å¸ç»‘å®šçŠ¶æ€ï¼ˆå½“VIEWç«¯çŠ¶æ€å‘ç”Ÿå˜åŒ–æ—¶ï¼‰ã€‚
    - **è¯·æ±‚å‚æ•°**ï¼š

        | å‚æ•°åç§°   | ç±»å‹    | å¿…å¡« | æè¿° |
        |------------|---------|------|------|
        | userId     | Integer | æ˜¯   | ç”¨æˆ·ID |
        | companyId  | Integer | æ˜¯   | å…¬å¸ID |
        | statusData | Object  | çŠ¶æ€æ•°æ® |

    - **å“åº”æ•°æ®**ï¼š

        | å‚æ•°åç§°     | ç±»å‹     | æè¿° |
        |-------------|---------|------|
        | updated     | Boolean | æ˜¯å¦æ›´æ–°æˆåŠŸ |
        | oldStatus   | Object  | æ›´æ–°å‰çŠ¶æ€ |
        | newStatus   | Object  | æ›´æ–°åçŠ¶æ€ |

#### 2.2.5 ç±»å…³ç³»å›¾

```mermaid
classDiagram
    class AuthMiddleware {
        +handle(request, next)
        -validateToken()
        -setUserLocale()
    }
    
    class PermissionMiddleware {
        +handle(request, next, permission)
        -checkPermission()
    }
    
    class UserPermissionService {
        +checkUserCompanyBinding(userId, companyId)
        +getUserCompanyStatus(userId, companyId)
        +checkUserCompanyPermission(userId, companyId, permission)
        +switchUserCompany(userId, companyId)
        +syncUserCompanyStatus(userId, companyId, statusData)
    }
    
    class User {
        +id
        +language
        +company()
    }
    
    class Company {
        +id
        +companyName
        +users()
    }
    
    class UserCompany {
        +userId
        +companyId
        +Status
        +accountStatus
        +createdDate
    }
    
    AuthMiddleware --> User 
    PermissionMiddleware --> UserPermissionService : app(UserPermissionService)
    UserPermissionService --> UserCompany : query binding status
    UserPermissionService --> User : get user info
    UserPermissionService --> Company : get company info
    User --> UserCompany : belongsToMany
    Company --> UserCompany : belongsToMany
```

### 2.3 å…¬å…±ä¸šåŠ¡ç»„ä»¶è®¾è®¡

#### 2.3.1 CompanyService

- **æ¦‚è¿°**ï¼šå…¬å¸ä¿¡æ¯ç®¡ç†æœåŠ¡ç»„ä»¶ï¼Œå¤„ç†å…¬å¸ç›¸å…³çš„ä¸šåŠ¡é€»è¾‘ï¼ŒåŒ…æ‹¬å…¬å¸ä¿¡æ¯éªŒè¯ã€æ•°æ®ç®¡ç†ã€é‡å¤æ€§æ£€æŸ¥ç­‰ã€‚
- **ä»£ç è·¯å¾„**ï¼š`app/Services/Business/CompanyService.php`
- **æ–‡ä»¶çŠ¶æ€**ï¼šæ–°å¢
- **å¤ç”¨åœºæ™¯**ï¼šå…¬å¸ä¿¡æ¯éªŒè¯ã€å…¬å¸æ•°æ®ç®¡ç†ã€ç¨ç é‡å¤æ£€æŸ¥ã€å…¬å¸æ³¨å†Œæµç¨‹
- **æ¥å£å®šä¹‰**ï¼š

  - **validateCompanyInfo($companyData)**
    - **åŠŸèƒ½æè¿°**ï¼šéªŒè¯å…¬å¸ä¿¡æ¯çš„å®Œæ•´æ€§å’Œæœ‰æ•ˆæ€§ã€‚
    - **è¯·æ±‚å‚æ•°**ï¼š

        | å‚æ•°åç§°    | ç±»å‹   | å¿…å¡« | æè¿° |
        |-------------|--------|------|------|
        | companyData | Array  | æ˜¯   | å…¬å¸ä¿¡æ¯æ•°ç»„ |

    - **å“åº”æ•°æ®**ï¼š

        | å‚æ•°åç§°   | ç±»å‹    | æè¿° |
        |------------|---------|------|
        | valid      | Boolean | éªŒè¯æ˜¯å¦é€šè¿‡ |
        | errors     | Array   | éªŒè¯é”™è¯¯ä¿¡æ¯ |
        | warnings   | Array   | è­¦å‘Šä¿¡æ¯ |

  - **checkTaxcodeExists($taxCode)**
    - **åŠŸèƒ½æè¿°**ï¼šæ£€æŸ¥ç¨å·æ˜¯å¦å·²å­˜åœ¨ã€‚
    - **è¯·æ±‚å‚æ•°**ï¼š

        | å‚æ•°åç§°         | ç±»å‹    | å¿…å¡« | æè¿° |
        |------------------|---------|------|------|
        | taxCode          | String  | æ˜¯   | ç¨å· |

    - **å“åº”æ•°æ®**ï¼š

        | å‚æ•°åç§°    | ç±»å‹    | æè¿° |
        |-------------|---------|------|
        | taxCodeExists  | Boolean | ç¨å·æ˜¯å¦å­˜åœ¨ |
        | companyId   | Integer | å­˜åœ¨çš„å…¬å¸ID |
        | companyName | String | å­˜åœ¨çš„å…¬å¸åç§° |

#### 2.3.2 SmsVerificationService

- **æ¦‚è¿°**ï¼šçŸ­ä¿¡éªŒè¯ç æœåŠ¡ç»„ä»¶ï¼Œæä¾›éªŒè¯ç å‘é€ã€éªŒè¯ã€ç®¡ç†ç­‰åŠŸèƒ½ã€‚
- **ä»£ç è·¯å¾„**ï¼š`app/Services/Common/SmsVerificationService.php`
- **æ–‡ä»¶çŠ¶æ€**ï¼šæ–°å¢
- **å¤ç”¨åœºæ™¯**ï¼šç”¨æˆ·æ³¨å†Œæ‰‹æœºå·éªŒè¯ã€æ‰‹æœºå·ç™»å½•éªŒè¯ã€ä¸ªäººä¿¡æ¯ä¿®æ”¹æ‰‹æœºå·éªŒè¯
- **æ¥å£å®šä¹‰**ï¼š

  - **sendCode($mobile, $scene)**
    - **åŠŸèƒ½æè¿°**ï¼šå‘é€çŸ­ä¿¡éªŒè¯ç åˆ°æŒ‡å®šæ‰‹æœºå·ã€‚
    - **è¯·æ±‚å‚æ•°**ï¼š

        | å‚æ•°åç§° | ç±»å‹   | å¿…å¡« | æè¿° |
        |----------|--------|------|------|
        | mobile    | String | æ˜¯   | æ‰‹æœºå·ç  |
        | scene    | String | æ˜¯   | ä½¿ç”¨åœºæ™¯ï¼šregister/login/changeMobile |

    - **å“åº”æ•°æ®**ï¼š

        | å‚æ•°åç§°       | ç±»å‹    | æè¿° |
        |----------------|---------|------|
        | success        | Boolean | å‘é€æ˜¯å¦æˆåŠŸ |
        | message        | String  | æç¤ºä¿¡æ¯ |
        | expireTime     | Integer | éªŒè¯ç æœ‰æ•ˆæœŸï¼ˆç§’ï¼‰ |
        | canResendAfter | Integer | å¯ä»¥é‡æ–°å‘é€çš„ç­‰å¾…æ—¶é—´ï¼ˆç§’ï¼‰ |

  - **verifyCode($mobile, $code, $scene)**
    - **åŠŸèƒ½æè¿°**ï¼šéªŒè¯çŸ­ä¿¡éªŒè¯ç ã€‚
    - **è¯·æ±‚å‚æ•°**ï¼š

        | å‚æ•°åç§° | ç±»å‹   | å¿…å¡« | æè¿° |
        |----------|--------|------|------|
        | mobile    | String | æ˜¯   | æ‰‹æœºå·ç  |
        | code     | String | æ˜¯   | éªŒè¯ç  |
        | scene    | String | æ˜¯   | ä½¿ç”¨åœºæ™¯ |

    - **å“åº”æ•°æ®**ï¼š

        | å‚æ•°åç§° | ç±»å‹    | æè¿° |
        |----------|---------|------|
        | valid    | Boolean | éªŒè¯ç æ˜¯å¦æ­£ç¡® |
        | message  | String  | éªŒè¯ç»“æœä¿¡æ¯ |

#### 2.3.3 æ¶‰åŠæ•°æ®è¡¨

- **sms_verifications**
  - **ç”¨é€”**ï¼šçŸ­ä¿¡éªŒè¯ç 

| å­—æ®µåç§° | ç±»å‹ | é•¿åº¦ | å¯ç©º | é»˜è®¤å€¼ | æè¿° |
|----------|------|------|------|--------|------|
| Id | INT | 20 | NO | | ä¸»é”®ID |
| Mobile | VARCHAR | 20 | NO | | æ‰‹æœºå·ç  |
| Code | VARCHAR | 10 | NO | | éªŒè¯ç  |
| Scene | VARCHAR | 50 | NO | | ä½¿ç”¨åœºæ™¯ |
| IsVerified | TINYINT | 1 | NO | 0 | æ˜¯å¦å·²éªŒè¯ï¼š1å·²éªŒè¯ 0æœªéªŒè¯ |
| ExpiresDate | DATETIME | | NO | | è¿‡æœŸæ—¶é—´ |
| CreatedDate | DATETIME | | YES | NULL | åˆ›å»ºæ—¶é—´ |
| LastModifiedDate | DATETIME | | YES | NULL | æ›´æ–°æ—¶é—´ |

### 2.4 ç³»ç»Ÿé›†æˆç»„ä»¶è®¾è®¡

#### 2.4.1 InterSystemService

- **æ¦‚è¿°**ï¼šVIEWç³»ç»Ÿé›†æˆæœåŠ¡ç»„ä»¶ï¼Œç”¨äºPortalç³»ç»Ÿä¸VIEWç³»ç»Ÿä¹‹é—´çš„æ•°æ®åŒæ­¥ã€çŠ¶æ€æ›´æ–°ã€æ•°æ®æ˜ å°„è½¬æ¢ã€‚æ‰€æœ‰åŒå‘é€šä¿¡å‡é‡‡ç”¨ç»Ÿä¸€ envelope ç»“æ„ï¼Œç¡®ä¿æ¥å£å¥‘çº¦æ¸…æ™°ã€å¯¹ç§°ã€å¯é¢„æµ‹ã€‚
- **ä»£ç è·¯å¾„**ï¼š`app/Services/Integration/InterSystemService.php`
- **æ–‡ä»¶çŠ¶æ€**ï¼šæ–°å¢
- **å¤ç”¨åœºæ™¯**ï¼šç”¨æˆ·æ¿€æ´»åæ•°æ®åŒæ­¥ã€é—®è¯¢æ•°æ®åŒæ­¥ã€é¡¹ç›®æ•°æ®åŒæ­¥ã€å…¬å¸ä¿¡æ¯åŒæ­¥ã€çŠ¶æ€å›è°ƒå¤„ç†

- **æ¥å£å®šä¹‰**ï¼š
  - **pushDataToView($syncData)**
    - **åŠŸèƒ½æè¿°**ï¼šæ¨é€æ•°æ®åˆ°VIEWç³»ç»Ÿï¼ˆç”¨æˆ·ã€å…¬å¸ã€é¡¹ç›®ç­‰ï¼‰ã€‚
    - **è¯·æ±‚å‚æ•°**ï¼š

      | å‚æ•°åç§° | ç±»å‹ | å¿…å¡« | æè¿° |
      |---------|------|------|------|
      | syncData | Array | æ˜¯ | åŒæ­¥æ•°æ®ï¼Œå¿…é¡»åŒ…å«ä»¥ä¸‹å­—æ®µï¼š<br>- `dataType`: å­—ç¬¦ä¸²ï¼Œå¦‚ `'user_registration'`<br>- `dataPayload`: ä¸šåŠ¡æ•°æ®å¯¹è±¡<br>- `sourceSystem`: å›ºå®šä¸º `"Portal"`<br>- `timestamp`: ISO8601 æ—¶é—´æˆ³ |

    - **å“åº”æ•°æ®**ï¼š

      | å‚æ•°åç§° | ç±»å‹ | æè¿° |
      |---------|------|------|
      | success | Boolean | æ¨é€æ˜¯å¦æˆåŠŸ |
      | viewId | Integer | VIEWç³»ç»Ÿç”Ÿæˆçš„ID |
      | syncTime | String | åŒæ­¥æ—¶é—´ |

  - **pullDataFromView($pullRequest)**
    - **åŠŸèƒ½æè¿°**ï¼šä»VIEWç³»ç»Ÿæ‹‰å–æ•°æ®ï¼ˆç”¨æˆ·ã€å…¬å¸ã€é¡¹ç›®ç­‰ï¼‰ã€‚
    - **è¯·æ±‚å‚æ•°**ï¼š

      | å‚æ•°åç§° | ç±»å‹ | å¿…å¡« | æè¿° |
      |---------|------|------|------|
      | pullRequest | Array | æ˜¯ | æ‹‰å–è¯·æ±‚ï¼Œå¿…é¡»åŒ…å«ä»¥ä¸‹å­—æ®µï¼š<br>- `dataType`: å­—ç¬¦ä¸²ï¼Œå¦‚ `'user_activation_status'`<br>- `conditions`: æŸ¥è¯¢æ¡ä»¶å¯¹è±¡<br>- `sourceSystem`: å›ºå®šä¸º `"Portal"`<br>- `timestamp`: ISO8601 æ—¶é—´æˆ³ |

    - **å“åº”æ•°æ®**ï¼š

      | å‚æ•°åç§° | ç±»å‹ | æè¿° |
      |---------|------|------|
      | success | Boolean | æ‹‰å–æ˜¯å¦æˆåŠŸ |
      | data | Array | VIEWç³»ç»Ÿè¿”å›çš„æ•°æ® |
      | syncTime | String | åŒæ­¥æ—¶é—´ |

- **å…·ä½“çš„åŒæ­¥åœºæ™¯æ˜ å°„**ï¼š

| ä¸šåŠ¡åœºæ™¯ | ä½¿ç”¨æ¥å£ | æ•°æ®æµå‘ | syncData / pullRequest æ ¼å¼ | è§¦å‘æ—¶æœº |
|---------|----------|----------|-----------------------------|----------|
| æ³¨å†Œç”³è¯·æäº¤ | pushDataToView | Portal â†’ VIEW | ```json<br>{<br>  "dataType": "user_registration",<br>  "dataPayload": {<br>    "portalUserId": 123,<br>    "firstName": "å¼ ",<br>    "lastName": "ä¸‰",<br>    "mobile": "13800138000",<br>    "email": "zhang@example.com",<br>    "openId": "oAbc123",<br>    "companyInfo": {<br>      "companyName": "ABCç”µæ¢¯å…¬å¸",<br>      "taxCode": "91310101MA12345678",<br>      "province": 110000,<br>      "city": 110100,<br>      "district": 110105,<br>      "mainOperatingCities": ["110000", "310000"]<br>    },<br>    "salesId": 456<br>  },<br>  "sourceSystem": "Portal",<br>  "timestamp": "2025-10-11T10:30:00Z"<br>}<br>``` | ç”¨æˆ·å®Œæˆæ³¨å†Œè¡¨å•æäº¤æ—¶ |
| æ¿€æ´»ç”¨æˆ·å†å²æ•°æ®è¿ç§» | pushDataToView | Portal â†’ VIEW | ```json<br>{<br>  "dataType": "user_activation_data",<br>  "dataPayload": {<br>    "portalUserId": 123,<br>    "portalCompanyId": 789,<br>    "inquiries": [...],<br>    "projects": [...]<br>  },<br>  "sourceSystem": "Portal",<br>  "timestamp": "2025-10-11T11:00:00Z"<br>}<br>``` | VIEWç«¯é”€å”®å®¡æ‰¹é€šè¿‡æ—¶ |
| æ¿€æ´»çŠ¶æ€å›è°ƒç¡®è®¤ | pullDataFromView | VIEW â†’ Portal | ```json<br>{<br>  "dataType": "user_activation_status",<br>  "conditions": {<br>    "portalUserId": 123,<br>    "portalCompanyId": 789,<br>    "status": "active"<br>  },<br>  "sourceSystem": "Portal",<br>  "timestamp": "2025-10-11T12:00:00Z"<br>}<br>``` | VIEWç«¯å®Œæˆç”¨æˆ·æ¿€æ´»æ“ä½œå |
| æ¿€æ´»ç”¨æˆ·é—®è¯¢æäº¤ | pushDataToView | Portal â†’ VIEW | ```json<br>{<br>  "dataType": "inquiry_create",<br>  "dataPayload": {<br>    "portalInquiryId": 456,<br>    "portalUserId": 123,<br>    "portalCompanyId": 789,<br>    "categoryId": 1,<br>    "content": "ç”µæ¢¯å™ªéŸ³è¿‡å¤§ï¼Œå¦‚ä½•è§£å†³ï¼Ÿ"<br>  },<br>  "sourceSystem": "Portal",<br>  "timestamp": "2025-10-11T13:00:00Z"<br>}<br>``` | å·²æ¿€æ´»ç”¨æˆ·å‘èµ·æ–°é—®è¯¢æ—¶ |
| æœªæ¿€æ´»ç”¨æˆ·é—®è¯¢å›å¤ | pullDataFromView | VIEW â†’ Portal | ```json<br>{<br>  "dataType": "inquiry_reply",<br>  "conditions": {<br>    "portalInquiryId": 456,<br>    "portalUserId": 123<br>  },<br>  "sourceSystem": "Portal",<br>  "timestamp": "2025-10-11T14:00:00Z"<br>}<br>``` | é”€å”®å›å¤Portalç«¯å­˜å‚¨çš„é—®è¯¢æ—¶ |
| é—®è¯¢è¯„ä»·ç»“æœåŒæ­¥ | pushDataToView | Portal â†’ VIEW | ```json<br>{<br>  "dataType": "inquiry_rating",<br>  "dataPayload": {<br>    "portalInquiryId": 456,<br>    "portalUserId": 123,<br>    "rating": 5,<br>    "ratedTime": "2025-10-11T15:00:00Z"<br>  },<br>  "sourceSystem": "Portal",<br>  "timestamp": "2025-10-11T15:00:05Z"<br>}<br>``` | ç”¨æˆ·å®Œæˆé—®è¯¢è¯„ä»·æ—¶ |
| æ¿€æ´»ç”¨æˆ·é¡¹ç›®æ“ä½œ | pushDataToView | Portal â†’ VIEW | ```json<br>{<br>  "dataType": "project_update",<br>  "dataPayload": {<br>    "portalProjectId": 1001,<br>    "portalUserId": 123,<br>    "portalCompanyId": 789,<br>    "projectName": "ä¸‡è¾¾å¹¿åœºç”µæ¢¯æ”¹é€ ",<br>    "unitsCount": 8,<br>    "contractValue": 500000.00<br>  },<br>  "sourceSystem": "Portal",<br>  "timestamp": "2025-10-11T16:00:00Z"<br>}<br>``` | å·²æ¿€æ´»ç”¨æˆ·æ–°å»º/ç¼–è¾‘é¡¹ç›®æ—¶ |
| TKEé¡¹ç›®å¤„ç†ç»“æœ | pushDataToView | Portal â†’ VIEW | ```json<br>{<br>  "dataType": "project_response",<br>  "dataPayload": {<br>    "portalProjectId": 1001,<br>    "portalUserId": 123,<br>    "action": "accept",<br>    "responseTime": "2025-10-11T17:00:00Z"<br>  },<br>  "sourceSystem": "Portal",<br>  "timestamp": "2025-10-11T17:00:05Z"<br>}<br>``` | ç”¨æˆ·æ¥å—/æ‹’ç»TKEé¡¹ç›®æ—¶ |

- **ç¤ºä¾‹1: æ¿€æ´»çŠ¶æ€å›è°ƒç¡®è®¤ (pullDataFromView å“åº”)**

  ```json
  {
      "success": true,
      "data": {
          "portalUserId": 123,
          "portalCompanyId": 789,
          "status": "active",
          "viewCustomerId": 1001,
          "viewContactId": 2001,
          "activatedDate": "2025-01-15 10:30:00",
          "lastModifiedDate": "2025-01-15 10:30:00"
      },
      "syncTime": "2025-01-15 10:30:15"
  }
  ```

- **ç¤ºä¾‹2: æœªæ¿€æ´»ç”¨æˆ·é—®è¯¢å›å¤ (pullDataFromView å“åº”)**

  ```json
  {
      "success": true,
      "data": {
          "portalInquiryId": 456,
          "portalUserId": 123,
          "portalCompanyId": 789,
          "categoryId": 1,
          "content": "ç”µæ¢¯å™ªéŸ³è¿‡å¤§ï¼Œå¦‚ä½•è§£å†³ï¼Ÿ",
          "status": "rating",
          "salesReply": "å»ºè®®æ£€æŸ¥æ›³å¼•æœºæ¶¦æ»‘æƒ…å†µï¼Œå®šæœŸç»´æŠ¤å¯æœ‰æ•ˆé™ä½å™ªéŸ³",
          "salesId": 789,
          "repliedTime": "2025-01-14 16:45:00",
          "rating": null,
          "ratedTime": null,
          "createdDate": "2025-01-14 09:20:00",
          "lastModifiedDate": "2025-01-14 16:45:00"
      },
      "syncTime": "2025-01-15 09:20:30"
  }
  ```

- **ç¤ºä¾‹3: æ¿€æ´»ç”¨æˆ·é¡¹ç›®æ•°æ®è·å– (pullDataFromView å“åº”)**

  ```json
  {
      "success": true,
      "data": [
          {
          "portalProjectId": 1001,
          "projectName": "ä¸‡è¾¾å¹¿åœºç”µæ¢¯æ”¹é€ ",
          "portalUserId": 123,
          "portalCompanyId": 789,
          "modernizationScope": "full_mod",
          "brand": 1,
          "province": 110000,
          "city": 110100,
          "district": 110105,
          "detailAddress": "ä¸‡è¾¾å¹¿åœºBåº§",
          "salesStage": "Pre-Lead",
          "unitsCount": 8,
          "contractValue": 500000.00,
          "forecastTenderDate": "2025-03-01",
          "isEditable": 1,
          "createdDate": "2025-01-10 14:20:00",
          "lastModifiedDate": "2025-01-10 14:20:00"
          }
      ],
      "syncTime": "2025-01-15 14:15:45"
  }
  ```

- **ç¤ºä¾‹4: æ³¨å†Œç”³è¯·æäº¤ (pushDataToView è¯·æ±‚)**  

  ```json
  {
    "dataType": "user_registration",
    "dataPayload": {
      "portalUserId": 123,
      "firstName": "å¼ ",
      "lastName": "ä¸‰",
      "mobile": "13800138000",
      "email": "zhang@example.com",
      "openId": "oAbc123",
      "companyName": "ABCç”µæ¢¯å…¬å¸",
      "taxCode": "91310101MA12345678",
      "province": 110000,
      "city": 110100,
      "district": 110105,
      "mainOperatingCities": ["110000", "310000"],
      "salesId": 456
    },
    "sourceSystem": "Portal",
    "timestamp": "2025-10-11T10:30:00Z"
  }
  ```

- **ç¤ºä¾‹5: æ¿€æ´»ç”¨æˆ·é—®è¯¢æäº¤ (pushDataToView è¯·æ±‚)**  

  ```json
  {
    "dataType": "inquiry_create",
    "dataPayload": {
      "portalInquiryId": 456,
      "portalUserId": 123,
      "portalCompanyId": 789,
      "categoryId": 1,
      "content": "ç”µæ¢¯å™ªéŸ³è¿‡å¤§ï¼Œå¦‚ä½•è§£å†³ï¼Ÿ"
    },
    "sourceSystem": "Portal",
    "timestamp": "2025-10-11T13:00:00Z"
  }
  ```

- **ç¤ºä¾‹6: é—®è¯¢è¯„ä»·ç»“æœåŒæ­¥ (pushDataToView è¯·æ±‚)**  

  ```json
  {
    "dataType": "inquiry_rating",
    "dataPayload": {
      "portalInquiryId": 456,
      "portalUserId": 123,
      "rating": 5,
      "ratedTime": "2025-10-11T15:00:00Z"
    },
    "sourceSystem": "Portal",
    "timestamp": "2025-10-11T15:00:05Z"
  }
  ```

- **ç¤ºä¾‹7: TKEé¡¹ç›®å¤„ç†ç»“æœ (pushDataToView è¯·æ±‚)**  

  ```json
  {
    "dataType": "project_response",
    "dataPayload": {
      "portalProjectId": 1001,
      "portalUserId": 123,
      "action": "accept",
      "responseTime": "2025-10-11T17:00:00Z"
    },
    "sourceSystem": "Portal",
    "timestamp": "2025-10-11T17:00:05Z"
  }
  ```

### 2.5 Laravelå†…ç½®åŠŸèƒ½å®ç°

#### 2.5.1 é™æµæ§åˆ¶

ä½¿ç”¨Laravelå†…ç½®çš„é™æµä¸­é—´ä»¶throttleå®ç°APIé™æµï¼š

```php
// è·¯ç”±ä¸­ä½¿ç”¨é…ç½®åŒ–é™æµ
Route::middleware(['throttle:portal-api'])->group(function () {
    Route::post('/sms/send', [SmsController::class, 'send']);
});

// è‡ªå®šä¹‰é™æµè§„åˆ™ï¼Œä»é…ç½®æ–‡ä»¶è¯»å–å‚æ•°
RateLimiter::for('portal-api', function (Request $request) {
    $config = config('business.rate_limit');
    
    return $request->user()
        ? Limit::perMinute($config['user_requests_per_minute'])->by($request->user()->id)
        : Limit::perMinute($config['guest_requests_per_minute'])->by($request->ip());
});
```

#### 2.5.2 æ—¥å¿—è®°å½•

ä½¿ç”¨Laravel Logç»„ä»¶é…ç½®å¤šä¸ªchannelå®ç°æ—¥å¿—åˆ†ç±»ç®¡ç†ï¼š

```php
// config/logging.phpé…ç½®ä¸åŒchannel
'channels' => [
    'business' => [
        'driver' => 'daily',
        'path' => storage_path('logs/business.log'),
        'level' => 'info',
        'days' => 30,
    ],
    'security' => [
        'driver' => 'daily', 
        'path' => storage_path('logs/security.log'),
        'level' => 'warning',
        'days' => 90,
    ],
    'wechat' => [
        'driver' => 'daily',
        'path' => storage_path('logs/wechat.log'), 
        'level' => 'info',
        'days' => 30,
    ]
];

// ä½¿ç”¨
Log::channel('business')->info('ç”¨æˆ·æ³¨å†Œ', ['user_id' => $userId]);
Log::channel('security')->warning('ç™»å½•å¤±è´¥', ['ip' => $request->ip()]);
Log::channel('wechat')->info('å¾®ä¿¡æ¶ˆæ¯æ¨é€', ['openid' => $openId]);
```

#### 2.5.3 ç³»ç»Ÿé…ç½®

ä½¿ç”¨Laravel Configç³»ç»Ÿç®¡ç†é…ç½®ï¼š

```php
// config/business.php
return [
    // çŸ­ä¿¡é…ç½®
    'sms' => [
        'daily_limit' => env('SMS_DAILY_LIMIT', 10), // æ¯æ—¥çŸ­ä¿¡å‘é€é™åˆ¶
        'expire_minutes' => env('SMS_EXPIRE_MINUTES', 5), // éªŒè¯ç è¿‡æœŸæ—¶é—´ï¼ˆåˆ†é’Ÿï¼‰
    ],
    
    // å¾®ä¿¡é…ç½®
    'wechat' => [
        'app_id' => env('WECHAT_APP_ID'), // å¾®ä¿¡åº”ç”¨ID
        'app_secret' => env('WECHAT_APP_SECRET'), // å¾®ä¿¡åº”ç”¨å¯†é’¥
        'enabled' => env('WECHAT_ENABLED', true), // æ˜¯å¦å¯ç”¨å¾®ä¿¡åŠŸèƒ½
    ],
    
    // APIé™æµé…ç½®
    'rate_limit' => [
        'user_requests_per_minute' => env('API_USER_RATE_LIMIT', 10), // ç™»å½•ç”¨æˆ·æ¯åˆ†é’Ÿè¯·æ±‚é™åˆ¶
        'guest_requests_per_minute' => env('API_GUEST_RATE_LIMIT', 5), // è®¿å®¢æ¯åˆ†é’Ÿè¯·æ±‚é™åˆ¶
    ],
];

// ä½¿ç”¨
$smsLimit = config('business.sms.daily_limit');
$wechatEnabled = config('business.wechat.enabled');
```

#### 2.5.4 å›½é™…åŒ–

**åç«¯å®ç°**ï¼š

```php
// AuthMiddlewareä¸­è®¾ç½®è¯­è¨€
if ($user = auth('sanctum')->user()) {
    app()->setLocale($user->language ?? 'zh');
}

// ä½¿ç”¨ç¿»è¯‘
return $this->successResponse(null, __('messages.login_success'));

// æä¾›ç¿»è¯‘API
class TranslationController extends BaseController
{
    public function getTranslations($locale = 'zh')
    {
        // è¿”å›å¯¹åº”è¯­è¨€çš„ç¿»è¯‘æ–‡ä»¶å†…å®¹
        return $this->successResponse($translations);
    }
}
```

**å‰ç«¯Vueå®ç°**ï¼š

```javascript
// ä½¿ç”¨vue-i18n
import { createI18n } from 'vue-i18n'

// é€šè¿‡APIè·å–ç¿»è¯‘æ•°æ®
const loadLocaleMessages = async (locale) => {
  const response = await request.get(`/api/translations/${locale}`)
  return response.data.data
}

// è¯­è¨€åˆ‡æ¢
const changeLanguage = async (lang) => {
  const messages = await loadLocaleMessages(lang)
  $i18n.global.setLocaleMessage(lang, messages)
  locale.value = lang
}
```

### 2.6 å¼‚å¸¸å¤„ç†ç»„ä»¶è®¾è®¡

#### 2.6.1 ç»Ÿä¸€å¼‚å¸¸å¤„ç†

ä½¿ç”¨Laravelå¼‚å¸¸å¤„ç†æœºåˆ¶ç»“åˆè‡ªå®šä¹‰çŠ¶æ€ç ä½“ç³»å®ç°æ ‡å‡†åŒ–çš„APIé”™è¯¯å“åº”ï¼š

```php
// app/Exceptions/Handler.php
public function render($request, Throwable $exception)
{
    if ($request->expectsJson()) {
        return $this->handleApiException($exception);
    }
    
    return parent::render($request, $exception);
}

private function handleApiException(Throwable $exception)
{
    $code = 9001; // é»˜è®¤ç³»ç»Ÿé”™è¯¯
    $message = __('errors.server_error');
    $errors = null;
    
    if ($exception instanceof ValidationException) {
        $code = 1001; // è¡¨å•éªŒè¯é”™è¯¯
        $message = __('errors.validation_failed');
        $errors = $exception->errors();
    } elseif ($exception instanceof AuthenticationException) {
        $code = 3001; // è®¤è¯é”™è¯¯
        $message = __('errors.authentication_failed');
    } elseif ($exception instanceof AuthorizationException) {
        $code = 3002; // æƒé™é”™è¯¯
        $message = __('errors.permission_denied');
    } elseif ($exception instanceof ModelNotFoundException) {
        $code = 4001; // ä¸šåŠ¡é€»è¾‘é”™è¯¯
        $message = __('errors.resource_not_found');
    }
    
    // è®°å½•é”™è¯¯æ—¥å¿—
    Log::channel('business')->error($exception->getMessage(), [
        'exception' => get_class($exception),
        'code' => $code,
        'user_id' => auth('sanctum')->id(),
        'ip' => request()->ip(),
        'url' => request()->url()
    ]);
    
    return response()->json([
        'success' => false,
        'code' => $code,
        'message' => $message,
        'errors' => $errors,
        'timestamp' => now()
    ], $this->getHttpStatusCode($code));
}
```

#### 2.6.2 å‰ç«¯é”™è¯¯å¤„ç†

æ ¹æ®é”™è¯¯ç èŒƒå›´åœ¨å‰ç«¯è¿›è¡Œä¸åŒçš„é”™è¯¯å¤„ç†ï¼š

```javascript
// utils/errorHandler.js
export const handleApiError = (error) => {
  const { code, message, errors } = error.response.data
  
  if (code >= 1000 && code <= 1999) {
    // è¡¨å•éªŒè¯é”™è¯¯ï¼Œåœ¨å¯¹åº”å­—æ®µæ˜¾ç¤º
    return { type: 'validation', errors }
  } else if (code >= 3000 && code <= 3999) {
    // è®¤è¯æƒé™é”™è¯¯ï¼Œå…¨å±€æç¤ºå¹¶å¯èƒ½è·³è½¬
    return { type: 'auth', message }
  } else if (code >= 4000 && code <= 5999) {
    // ä¸šåŠ¡é€»è¾‘é”™è¯¯ï¼Œå…¨å±€æç¤º
    return { type: 'business', message }
  } else if (code >= 6000 && code <= 6999) {
    // åœ°å€ç›¸å…³é”™è¯¯
    return { type: 'address', message }
  } else if (code >= 7000 && code <= 7999) {
    // AGRç›¸å…³é”™è¯¯
    return { type: 'agr', message }
  } else if (code >= 9000 && code <= 9999) {
    // ç³»ç»Ÿé”™è¯¯ï¼Œæ˜¾ç¤ºé€šç”¨é”™è¯¯ä¿¡æ¯
    return { type: 'system', message: 'ç³»ç»Ÿç¹å¿™ï¼Œè¯·ç¨åé‡è¯•' }
  }
}
```

### 2.7 å…¬å…±æ¨¡å—æ€»ç»“

#### 2.7.1 ç»„ä»¶ä¾èµ–å…³ç³»å›¾

```mermaid
graph TD
    A[HTTP Request] --> B[AuthMiddleware]
    B --> C[PermissionMiddleware]
    C --> D[Controller]
    
    C --> E[UserPermissionService]
    E --> F[User Model]
    E --> G[UserCompany Pivot]
    
    D --> H[CompanyService]
    D --> I[SmsVerificationService]
    D --> K[InterSystemService]
    
    L[WechatAuthService] --> M[WechatMessageService]
    
    N[Laravel Config] --> O[Business Logic]
    P[Laravel Log] --> O
    Q[Laravel Schedule] --> R[Console Commands]
    S[Laravel Throttle] --> A
    T[Laravel Exception Handler] --> U[API Response with Custom Code]
    
    V[Vue Frontend] --> W[Translation API]
    W --> X[Laravel Lang]
```

#### 2.7.2 æ ¸å¿ƒæ¨¡å—åˆ—è¡¨

| åŠŸèƒ½æ¨¡å— | æ ¸å¿ƒç»„ä»¶ | ä¸»è¦åŠŸèƒ½ | å®ç°æ–¹å¼ |
|----------|----------|----------|----------|
| å¾®ä¿¡æˆæƒ | WechatAuthService, WechatMessageService | å¾®ä¿¡OAuth2.0æˆæƒã€æ¨¡æ¿æ¶ˆæ¯æ¨é€ | è‡ªå®šä¹‰Service |
| è®¤è¯æˆæƒ | UserPermissionService, AuthMiddleware, PermissionMiddleware | æƒé™æ§åˆ¶ã€ä»¤ç‰Œç®¡ç† | Laravel + è‡ªå®šä¹‰Service |
| é€šä¿¡æœåŠ¡ | SmsVerificationService | çŸ­ä¿¡éªŒè¯ç ã€é‚®ä»¶é€šçŸ¥ | è‡ªå®šä¹‰Service |
| ä¸šåŠ¡é€»è¾‘ | CompanyService | å…¬å¸ä¿¡æ¯ç®¡ç† | è‡ªå®šä¹‰Service |
| ç³»ç»Ÿé›†æˆ | InterSystemService | Portal-VIEWæ•°æ®åŒæ­¥ | è‡ªå®šä¹‰Service |
| ç³»ç»Ÿé…ç½® | Laravel Config | é…ç½®ç®¡ç† | configæ–‡ä»¶ + å¯é€‰æ•°æ®åº“ |
| æ—¥å¿—å®¡è®¡ | Laravel Log | é”™è¯¯æ—¥å¿—ã€ä¸šåŠ¡æ—¥å¿— | Laravel Log Channel |
| é™æµé˜²æŠ¤ | Laravel Throttle | APIé™æµ | Laravelå†…ç½®ä¸­é—´ä»¶ |
| å¼‚å¸¸å¤„ç† | Laravel Exception Handler | ç»Ÿä¸€å¼‚å¸¸å¤„ç† | Laravelå†…ç½® + è‡ªå®šä¹‰çŠ¶æ€ç  |
| å›½é™…åŒ– | Laravel Lang + Vue i18n | å¤šè¯­è¨€æ”¯æŒ | Laravelå†…ç½® + å‰ç«¯é›†æˆ |


## 3. Portalç«¯ ä¸šåŠ¡æµç¨‹è®¾è®¡

### 3.1 æ³¨å†Œä¸šåŠ¡æ¨¡å—

#### 3.1.1 ä¸šåŠ¡æµç¨‹

- **èƒŒæ™¯**:ç”¨æˆ·é€šè¿‡æ‰«æ**å…¬å¸/é”€å”®**äºŒç»´ç è¿›è¡Œæ³¨å†Œ,æ³¨å†Œæˆä¸º Partner(æ¸ é“å•†); ç”¨æˆ·ä¿¡æ¯æœ€ç»ˆåŒæ­¥View æˆä¸ºCustomer/contract.

- **ä¸»è¦æµç¨‹**:  

  - **æ‰«æå…¬å¸/é”€å”®äºŒç»´ç  è¿›å…¥æ³¨å†Œé¡µé¢**
    1. ç”¨æˆ·æ‰«ç è¿›å…¥æ³¨å†Œæµç¨‹ï¼ˆäºŒç»´ç æºå¸¦Scene(SalesId) ä»…é”€å”®ç ï¼‰
    2. å¾®ä¿¡æˆæƒè·å–openid
    3. è§£æåœºæ™¯å‚æ•°ç­‰æ³¨å†ŒçŠ¶æ€ä¿¡æ¯

    ![alt text](<024 - Recruitment QR Code - Mobile.png>)

  - **ç”¨æˆ·ä¿¡æ¯æ ¡éªŒ-æ³¨å†Œ**
    - ç³»ç»ŸéªŒè¯æ‰‹æœºå·æ˜¯å¦å·²æ³¨å†Œè¿‡
    - å·²æ³¨å†Œ â†’ æ˜¾ç¤ºç™»å½•æç¤º
    - æœªæ³¨å†Œ â†’ ç»§ç»­æ³¨å†Œæµç¨‹
    - å¦‚æœæ‰‹æœºå·å·²ç»æ³¨å†Œ, é»˜è®¤å¡«å……å·²ç»æ³¨å†Œçš„ä¿¡æ¯, å¦‚æœé‡æ–°å¡«å†™åˆ™ç›´æ¥è¦†ç›–åŸæœ‰ä¿¡æ¯
    - å¦‚æœæ‰‹æœºå·å·²ç»æ³¨å†Œ, è¿˜åº”è¯¥éªŒè¯openid, ä¸ä¸€è‡´ å°±è¦çŸ­ä¿¡éªŒè¯ä¸€ä¸‹ï¼Œå¦‚æœéªŒè¯é€šè¿‡ ç›´æ¥æ›¿æ¢openid
    ![alt text](<026 - Recruitment - Contact - Mobile-1.png>)
    ![alt text](<027 - Recruitment - Company - Mobile â€“ 1-1.png>)

  - **å…¬å¸ä¿¡æ¯æ ¡éªŒ-æ³¨å†Œ**
    - åŸºäºtaxCode æ‹‰å–Viewç«¯å·²ç»ActiveçŠ¶æ€çš„å…¬å¸, å¦‚æœå­˜åœ¨å¡«å……Companyä¿¡æ¯(æ­¤æ—¶ä¸å¯ç¼–è¾‘)
    - éªŒè¯å½“å‰æ‰‹æœºå·æ˜¯å¦å·²ç»‘å®šè¿‡è¯¥å…¬å¸
      - æ–°å…¬å¸ â†’ åˆ›å»ºå…¬å¸è®°å½•(éœ€å®¡æ‰¹)
      - å·²å­˜åœ¨å…¬å¸ â†’ ç»‘å®šåˆ°ç°æœ‰å…¬å¸(éœ€å®¡æ‰¹)
    - æ·»åŠ å…¬å¸æ—¶è¦é‡æ–°å®¡æ‰¹
    - çœå¸‚åŒºæ•°æ®ä»VIEWç«¯è·å–
    - MainOperatingCitiesæ•°æ®ä»VIEWç«¯è·å–
    - å¦‚æœç”³è¯·ç»‘å®š  å·²å­˜åœ¨å…¬å¸:å¯¹åº”é”€å”®ç­‰ä¿¡æ¯ ç›´æ¥åŒæ­¥ä¸ºå·²å­˜åœ¨å…¬å¸çš„ è€Œä¸æ˜¯æ‰«ç çš„
    - å¦‚æœæ–°å…¬å¸æ³¨å†Œ, æœªæ‰«é”€å”®ç ï¼Œ åˆ™æŒ‰ç…§ é€‰æ‹©çš„MainOperatingCities ç¬¬ä¸€ä¸ªè¿›è¡ŒåŒ¹é… åŒ¹é…Branch manager
    ![alt text](<027 - Recruitment - Company - Mobile-1.png>)
    <mark style="background-color: #ffeb3b; color: #d32f2f;">**[å¾…å®š]** é…ä»¶é€‰é¡¹ åº”è¯¥è¦æ”¹å</mark>

  - **æ³¨å†Œåè·³è½¬**
    - æ–°ç”¨æˆ·æ³¨å†Œæ ¡éªŒæ˜¯å¦å…³æ³¨, å·²å…³æ³¨ â†’ è·³è½¬è‡³ä¸»é¡µï¼Œæœªå…³æ³¨ â†’ å¼•å¯¼å…³æ³¨æœåŠ¡å·ã€‚
    - TKEå¯¼å…¥å¹¶æ¿€æ´»çš„ç”¨æˆ·åˆ™ç›´æ¥å…³è”ä¿¡æ¯,åŒæ ·æ ¡éªŒæ˜¯å¦å…³æ³¨ï¼Œå·²å…³æ³¨ â†’ è·³è½¬è‡³ä¸»é¡µï¼Œæœªå…³æ³¨ â†’ å¼•å¯¼å…³æ³¨æœåŠ¡å·ã€‚
    - å·²æ³¨å†Œç”¨æˆ·å†æ¬¡æ‰«ç æ³¨å†Œçš„æ–°å…¬å¸, åŒæ ·æ ¡éªŒæ˜¯å¦å…³æ³¨ï¼Œå·²å…³æ³¨ â†’ è·³è½¬è‡³ä¸»é¡µï¼Œæœªå…³æ³¨ â†’ å¼•å¯¼å…³æ³¨æœåŠ¡å·ã€‚

  - **çŸ­ä¿¡éªŒè¯é˜¶æ®µ**:
    - å‘é€çŸ­ä¿¡éªŒè¯ç åˆ°ç”¨æˆ·æ‰‹æœº
    - ç”¨æˆ·è¾“å…¥éªŒè¯ç è¿›è¡ŒéªŒè¯
    - çŸ­ä¿¡ä¾›åº”å•†: <mark style="background-color: #ffeb3b; color: #d32f2f;">**[å¾…å®š]**</mark>

  - **é‚®ä»¶é€šçŸ¥é˜¶æ®µ**:
    - ä¼˜å…ˆæ ¹æ®sceneå‚æ•°æŸ¥æ‰¾ç»‘å®šçš„é”€å”®ID
    - æ— é”€å”®IDç»‘å®šæ—¶ï¼Œæ ¹æ®MainOperatingCitiesæŸ¥æ‰¾å¯¹åº”çš„Branch Manager é»˜è®¤ç¬¬ä¸€ä¸ª
    - <mark style="background-color: #ffeb3b; color: #d32f2f;">**[å¾…å®š]** å‘é€é‚®ä»¶ç»™Salesæˆ–Branch managerï¼ˆé‚®ä»¶å†…å®¹å¾…å®šï¼‰</mark>

  - **éšç§åè®®**
    - éšç§åè®®å­˜æ”¾åœ¨general_optionsä¸­, å¹¶æ ‡è®°ç‰ˆæœ¬
    - ç”¨æˆ·æ³¨å†Œ/ç™»å½•æ—¶,å¿…é¡»è¦å‹¾é€‰éšç§åè®®
    - è®°å½• éšç§åè®®ç‰ˆæœ¬ ä»¥åŠ æ˜¯å¦å‹¾é€‰
    - å¦‚æœå·²ç»å‹¾é€‰è¿‡,å†æ¬¡ç™»å½•æ—¶è‡ªåŠ¨å‹¾é€‰, å¦‚æœç‰ˆæœ¬æ›´æ–°åˆ™éœ€ç”¨æˆ·æ‰‹åŠ¨é‡æ–°å‹¾é€‰
    ![alt text](éšç§åè®®.png)

- **å¼‚å¸¸æµç¨‹**:  
  - å¾®ä¿¡æˆæƒå¤±è´¥ï¼ˆcodeæ— æ•ˆ/è¿‡æœŸï¼‰ â†’ é‡æ–°æˆæƒã€‚  
  - æ‰‹æœºå·å·²ç»‘å®šå…¶ä»– openid â†’ æ‹’ç»æ³¨å†Œã€‚  
  - çŸ­ä¿¡éªŒè¯ç é”™è¯¯/è¶…æ—¶ â†’ é‡æ–°è·å–ã€‚  

- **æµç¨‹å›¾**:

```mermaid
flowchart TD
    A[ç”¨æˆ·æ‰«ç è¿›å…¥æ³¨å†Œé¡µ] --> B{æ˜¯å¦å·²æˆæƒå¾®ä¿¡}
    B -->|å¦| C[å¼¹å‡ºå¾®ä¿¡æˆæƒ]
    B -->|æ˜¯| D[è·å–OpenID]
    C --> D
    D --> E[ç”¨æˆ·å¡«å†™æ‰‹æœºå·]
    E --> F{æ‰‹æœºå·æ˜¯å¦å·²æ³¨å†Œ}
    F -->|æ˜¯| G[æç¤ºå·²æ³¨å†Œï¼Œå¼•å¯¼ç™»å½•]
    F -->|å¦| H[å‘é€çŸ­ä¿¡éªŒè¯ç ]
    H --> I[ç”¨æˆ·å¡«å†™éªŒè¯ç ]
    I --> J{éªŒè¯ç æ˜¯å¦æ­£ç¡®}
    J -->|å¦| K[æç¤ºé”™è¯¯ï¼Œé‡è¯•]
    J -->|æ˜¯| L[å¡«å†™å…¬å¸ä¿¡æ¯]
    L --> M{æ˜¯å¦å¡«å†™ç¨å·}
    M -->|æ˜¯| N[è°ƒç”¨View APIæ£€æŸ¥ç¨å·]
    M -->|å¦| O[é”€å”®åç»­å¡«å†™ç¨å·]
    N --> P{ç¨å·æ˜¯å¦å­˜åœ¨}
    P -->|æ˜¯| Q[æç¤ºç»‘å®šå…¬å¸ï¼Œéœ€ç¡®è®¤]
    P -->|å¦| R[åˆ›å»ºæ–°å…¬å¸è®°å½•]
    Q --> S[æäº¤æ³¨å†Œç”³è¯·]
    R --> S
    O --> S
    S --> T[çŠ¶æ€è®¾ä¸ºpending]
    T --> U[å‘é€å®¡æ‰¹é€šçŸ¥ç»™é”€å”®]
    U --> V[å¼•å¯¼ç”¨æˆ·å…³æ³¨æœåŠ¡å·]
```

#### 3.1.2 å½±å“çš„æ•°æ®è¡¨

- Portalç«¯
  - **[users](#table-users)** : Portalç«¯ UseråŸºç¡€ä¿¡æ¯è¡¨
  - **[companies](#table-companies)** : Portalç«¯ Company åŸºç¡€ä¿¡æ¯è¡¨
  - **[user_company](#table-user_company)** : User&Company å…³è”è¡¨(è®°å½• Partner å½“å‰çŠ¶æ€)
  - **[registration_requests](#table-registration_requests)** : Portalç«¯ å®¡æ‰¹è®°å½•è¡¨
  - **[user_company_assignment](#table-user_company_assignment)** : Portalç«¯ Partner å…³è” é”€å”®è¡¨

- Viewç«¯ Portal->View æ ‡è®° Flag = 1 é¿å…ç»Ÿè®¡/åˆå¹¶Companyæ—¶ Portalå’ŒViewçš„æ•°æ®äº¤é›†é—®é¢˜
  - **[mod_channel_partner_companies](#table-mod_channel_partner_companies)** : Viewç«¯ Uploadæ•°æ®è¡¨/ å®¡æ‰¹Saveç•™å­˜Portalè®°å½•

#### 3.1.3 å‰ç«¯å®ç°

##### 3.1.3.1 è§†å›¾ç›®å½•ç»“æ„

```plaintext
/src/views/registration/
  RegistrationMain.vue         - æ³¨å†Œä¸»é¡µé¢
  RegistrationResult.vue       - æ³¨å†Œç»“æœé¡µé¢

/src/components/registration/
  WechatAuth.vue               - å¾®ä¿¡æˆæƒç»„ä»¶
  RegistrationFlow.vue         - æ³¨å†Œæµç¨‹æ§åˆ¶ç»„ä»¶
```

##### 3.1.3.2 å…³é”®ç»„ä»¶åŠŸèƒ½

- **WechatAuth.vue**
  - å¾®ä¿¡æˆæƒå¤„ç†

- **RegistrationFlow.vue**
  - æ³¨å†Œæµç¨‹æ§åˆ¶ï¼ˆæ‰‹æœºå·éªŒè¯â†’ä¿¡æ¯å¡«å†™â†’çŸ­ä¿¡éªŒè¯â†’æäº¤ï¼‰
  - å…¬å…±ç»„ä»¶å®Œæˆæ³¨å†Œæµç¨‹
  - æ³¨å†ŒçŠ¶æ€ç®¡ç†

##### 3.1.3.3 APIè®¾è®¡

| HTTP æ–¹æ³• | ç«¯ç‚¹                          | æè¿°                    |
|-----------|-------------------------------|-------------------------|
| POST      | `/api/registration/wechat-auth` | å¾®ä¿¡æˆæƒè·å–ç”¨æˆ·ä¿¡æ¯ |
| POST      | `/api/registration/verify-mobile` | éªŒè¯æ‰‹æœºå·æ˜¯å¦å¯æ³¨å†Œ |
| POST      | `/api/registration/send-sms` | å‘é€çŸ­ä¿¡éªŒè¯ç  |
| POST      | `/api/registration/verify-sms` | éªŒè¯çŸ­ä¿¡éªŒè¯ç  |
| POST      | `/api/registration/register`  | æäº¤æ³¨å†Œä¿¡æ¯ |

#### 3.1.4 åŠŸèƒ½å¼€å‘ä¸å®ç°

##### 3.1.4.1 ç±»å…³ç³»å›¾

```mermaid
classDiagram
    class RegistrationController {
        +wechatAuth()
        +verifyMobile()
        +sendSms()
        +verifySms()
        +register()
        -validateWechatAuth(code,state)
        -extractSceneParam(state)
    }

    class RegistrationService {
        +processWechatRegistration(openid,sceneParam)
        +validateRegistrationData(userData,companyData)
        +createUserAndCompany(userData,companyData,openid)
        +handleCompanyBinding(userId,companyData,taxCode)
        +sendNotifications(userData,companyData,sceneParam)
    }

    class WechatAuthService {
        +getAuthUrl(scope,redirectUri,state)
        +getAccessToken(code)
        +getUserInfo(openid,accessToken)
        +refreshAccessToken(refreshToken)
        +extractSceneParam(state)
    }

    class WechatMessageService {
        +sendTemplateMessage(templateData)
        +getAccessToken()
    }

    class SmsVerificationService {
        +sendCode(mobile,scene)
        +verifyCode(mobile,code,scene)
        +isRateLimited(mobile)
        +cleanExpiredCodes()
    }

    class CompanyService {
        +validateCompanyInfo(companyData)
        +checkTaxcodeExists(taxCode)
    }

    class InterSystemService {
        +pushDataToView(syncData)
    }

    class UserPermissionService {
        +checkUserCompanyBinding(userId,companyId)
        +switchUserCompany(userId,companyId)
        +syncUserCompanyStatus(userId,companyId,statusData)
    }

    class BaseController {
        +successResponse(data,message,code)
        +errorResponse(message,code,errors)
    }

    RegistrationController --> RegistrationService : ä¸šåŠ¡å¤„ç†
    RegistrationController --> WechatAuthService : å¾®ä¿¡æˆæƒ
    RegistrationController --> SmsVerificationService : çŸ­ä¿¡éªŒè¯
    RegistrationController --> BaseController : å“åº”æ ¼å¼åŒ–

    RegistrationService --> WechatMessageService : å¾®ä¿¡é€šçŸ¥
    RegistrationService --> CompanyService : å…¬å¸ç®¡ç†
    RegistrationService --> InterSystemService : æ•°æ®åŒæ­¥
    RegistrationService --> UserPermissionService : æƒé™ç®¡ç†
```

##### 3.1.4.2 ä»£ç å®ç°

- **RegistrationController.php**
  - **æ–‡ä»¶è·¯å¾„**:`packages/Registration/src/Controllers/RegistrationController.php`
  - **æ–‡ä»¶çŠ¶æ€**:æ–°å¢
  - **ä¾èµ–æœåŠ¡**:
  - **æ–¹æ³•**:
    - **wechatAuth()**  
      - **åŠŸèƒ½æè¿°**:å¾®ä¿¡æˆæƒå›è°ƒå¤„ç†ï¼Œç”¨codeæ¢å–openidã€‚é›†æˆå®Œæ•´æ—¥å¿—è®°å½•ã€‚  
      - **æ–¹æ³•çŠ¶æ€**:æ–°å¢  
      - **è°ƒç”¨é¡ºåº**:å¾®ä¿¡æˆæƒåå›è°ƒæ—¶é¦–å…ˆè°ƒç”¨  
      - **ä¾èµ–æœåŠ¡**:
        - `WechatAuthService::getAccessToken()`
        - `WechatAuthService::getUserInfo()`
        - `WechatAuthService::extractSceneParam()`
        - `Log::channel('business')`
      - **è¯·æ±‚å‚æ•°**:  

        | å‚æ•°åç§° | æ•°æ®ç±»å‹ | æ˜¯å¦å¿…å¡« | æè¿°             |
        |----------|----------|----------|------------------|
        | code     | String   | æ˜¯       | å¾®ä¿¡æˆæƒå›è°ƒcode |
        | state    | String   | å¦       | äºŒç»´ç åœºæ™¯å‚æ•°   |

      - **å“åº”æ•°æ®**:  

        | å‚æ•°åç§° | æ•°æ®ç±»å‹ | æè¿°                  |
        |----------|----------|-----------------------|
        | success       | Boolean  | æ˜¯å¦æˆæƒæˆåŠŸ              |
        | openid        | String   | ç”¨æˆ·openid                |
        | userInfo     | Object   | ç”¨æˆ·åŸºæœ¬ä¿¡æ¯ï¼ˆå¦‚æœ‰ï¼‰      |
        | sceneParam   | String   | åœºæ™¯å‚æ•°                  |
        | message       | String   | æç¤º/å¼‚å¸¸ä¿¡æ¯             |

    - **verifyMobile()**
      - **åŠŸèƒ½æè¿°**:éªŒè¯æ‰‹æœºå·æ˜¯å¦å·²æ³¨å†Œï¼Œå†³å®šæ˜¯å¦å¯ç»§ç»­æ³¨å†Œæµç¨‹ã€‚é›†æˆå®Œæ•´æ—¥å¿—è®°å½•ã€‚  
      - **æ–¹æ³•çŠ¶æ€**:æ–°å¢  
      - **è°ƒç”¨é¡ºåº**:ç”¨æˆ·è¾“å…¥æ‰‹æœºå·ç‚¹å‡»Nextæ—¶è°ƒç”¨  
      - **ä¾èµ–æœåŠ¡**:
        - `User::where('mobile')->exists()`
        - `Laravel Validation`
        - `Log::channel('business')`
      - **è¯·æ±‚å‚æ•°**:  

        | å‚æ•°åç§°     | æ•°æ®ç±»å‹ | æ˜¯å¦å¿…å¡« | æè¿°             |
        |--------------|----------|----------|------------------|
        | mobile        | String   | æ˜¯       | æ‰‹æœºå·           |

      - **å“åº”æ•°æ®**:  

        | å‚æ•°åç§° | æ•°æ®ç±»å‹ | æè¿°                  |
        |----------|----------|-----------------------|
        | canProceed  | Boolean  | æ˜¯å¦å¯ç»§ç»­æ³¨å†Œ          |
        | isRegistered | Boolean | æ‰‹æœºå·æ˜¯å¦å·²æ³¨å†Œ        |
        | validFormat | Boolean | æ‰‹æœºå·æ ¼å¼æ˜¯å¦æ­£ç¡®      |
        | message     | String   | æç¤ºä¿¡æ¯                |

    - **sendSms()**
      - **åŠŸèƒ½æè¿°**:å‘é€çŸ­ä¿¡éªŒè¯ç ã€‚  
      - **æ–¹æ³•çŠ¶æ€**:æ–°å¢  
      - **è°ƒç”¨é¡ºåº**:ç”¨æˆ·å¡«å†™å®Œä¿¡æ¯åè°ƒç”¨  
      - **ä¾èµ–æœåŠ¡**:
        - `SmsVerificationService::sendCode()`
      - **è¯·æ±‚å‚æ•°**:  

        | å‚æ•°åç§°     | æ•°æ®ç±»å‹ | æ˜¯å¦å¿…å¡« | æè¿°             |
        |--------------|----------|----------|------------------|
        | mobile        | String   | æ˜¯       | æ‰‹æœºå·           |

      - **å“åº”æ•°æ®**:  

        | å‚æ•°åç§° | æ•°æ®ç±»å‹ | æè¿°                  |
        |----------|----------|-----------------------|
        | success      | Boolean  | æ˜¯å¦å‘é€æˆåŠŸ            |
        | expireTime   | Integer  | éªŒè¯ç æœ‰æ•ˆæœŸï¼ˆç§’ï¼‰      |
        | canResendAfter | Integer | å¯ä»¥é‡æ–°å‘é€çš„ç­‰å¾…æ—¶é—´ï¼ˆç§’ï¼‰ |
        | message      | String   | æç¤ºä¿¡æ¯                |

    - **verifySms()**
      - **åŠŸèƒ½æè¿°**:éªŒè¯çŸ­ä¿¡éªŒè¯ç ã€‚
      - **æ–¹æ³•çŠ¶æ€**:æ–°å¢  
      - **è°ƒç”¨é¡ºåº**:ç”¨æˆ·è¾“å…¥éªŒè¯ç æ—¶è°ƒç”¨  
      - **ä¾èµ–æœåŠ¡**:
        - `SmsVerificationService::verifyCode()`
      - **è¯·æ±‚å‚æ•°**:  

          | å‚æ•°åç§°     | æ•°æ®ç±»å‹ | æ˜¯å¦å¿…å¡« | æè¿°             |
          |--------------|----------|----------|------------------|
          | mobile        | String   | æ˜¯       | æ‰‹æœºå·           |
          | code         | String   | æ˜¯       | çŸ­ä¿¡éªŒè¯ç        |
          | scene        | String   | æ˜¯       | éªŒè¯åœºæ™¯(register) |

      - **å“åº”æ•°æ®**:  

          | å‚æ•°åç§° | æ•°æ®ç±»å‹ | æè¿°                  |
          |----------|----------|-----------------------|
          | valid       | Boolean  | éªŒè¯ç æ˜¯å¦æ­£ç¡®           |
          | message     | String   | éªŒè¯ç»“æœä¿¡æ¯             |

    - **register()**
      - **åŠŸèƒ½æè¿°**:ç”¨æˆ·å¡«å†™æ³¨å†Œä¿¡æ¯æ—¶è°ƒç”¨ï¼Œåˆ›å»ºç”¨æˆ·å’Œå…¬å¸è®°å½•ã€‚é›†æˆå…¨é¢æ—¥å¿—è®°å½•å’Œä¿¡æ¯ä¿®æ”¹å†å²è®°å½•ã€‚  
      - **æ–¹æ³•çŠ¶æ€**:æ–°å¢  
      - **è°ƒç”¨é¡ºåº**:çŸ­ä¿¡éªŒè¯é€šè¿‡åæäº¤æ³¨å†Œæ—¶è°ƒç”¨  
      - **ä¾èµ–æœåŠ¡**:
        - `RegistrationService::validateRegistrationData()`
        - `RegistrationService::createUserAndCompany()`
        - `RegistrationService::sendNotifications()`
      - **è¯·æ±‚å‚æ•°**:  

        | å‚æ•°åç§°     | æ•°æ®ç±»å‹ | æ˜¯å¦å¿…å¡« | æè¿°             |
        |--------------|----------|----------|------------------|
        | openid       | String   | æ˜¯       | å¾®ä¿¡openid       |
        | sceneParam   | String   | å¦       | åœºæ™¯å‚æ•°         |
        | firstName        | String   | æ˜¯       | ç”¨æˆ·å                             |
        | lastName         | String   | æ˜¯       | ç”¨æˆ·å§“æ°                           |
        | role             | String   | æ˜¯       | ç”¨æˆ·è§’è‰²é€‰æ‹©                        |
        | mobile            | String   | æ˜¯       | æ‰‹æœºå·                             |
        | email            | String   | å¦       | é‚®ç®±ï¼ˆéå¿…å¡«ï¼‰                     |
        | taxCode          | String   | å¦       | ç¨å·ï¼ˆéå¿…å¡«ï¼‰                     |
        | companyName      | String   | æ˜¯       | å…¬å¸å                             |
        | province         | String   | æ˜¯       | å…¬å¸çœä»½                           |
        | city             | String   | æ˜¯       | å…¬å¸åŸå¸‚                           |
        | district         | String   | æ˜¯       | å…¬å¸åŒºå¿                           |
        | address          | String   | å¦       | å…¬å¸è¯¦ç»†åœ°å€ï¼ˆéå¿…å¡«ï¼‰             |
        | niSales          | TINYINT(1) | å¦    | ä¸»è¥ä¸šåŠ¡ - æ–°æ¢¯é”€å”® (0/1)ï¼ˆéå¿…å¡«ï¼‰ |
        | installation     | TINYINT(1) | å¦    | ä¸»è¥ä¸šåŠ¡ - å®‰è£… (0/1)ï¼ˆéå¿…å¡«ï¼‰     |
        | maintenance      | TINYINT(1) | å¦    | ä¸»è¥ä¸šåŠ¡ - ç»´ä¿ (0/1)ï¼ˆéå¿…å¡«ï¼‰     |
        | fullMod          | TINYINT(1) | å¦    | ä¸»è¥ä¸šåŠ¡ - å…¨æ”¹é€   (0/1)ï¼ˆéå¿…å¡«ï¼‰   |
        | partialMod       | TINYINT(1) | å¦    | ä¸»è¥ä¸šåŠ¡ - éƒ¨åˆ†æ”¹é€   (0/1)ï¼ˆéå¿…å¡«ï¼‰ |
        | NoOfMaintenanceUnits        | Int      | æ¡ä»¶å¿…å¡« | å½“ç»´ä¿=1 æ—¶å¿…å¡«è®¾å¤‡æ•°é‡            |
        | MainOperatingCities        | Array    | æ˜¯       | ä¸»è¥ä¸šåŠ¡è¦†ç›–åŸå¸‚ï¼ˆå¤šé€‰ï¼‰           |

      - **å“åº”æ•°æ®**:  

        | å‚æ•°åç§° | æ•°æ®ç±»å‹ | æè¿°                  |
        |----------|----------|-----------------------|
        | success    | Boolean  | æ˜¯å¦æ³¨å†ŒæˆåŠŸ            |
        | userId     | Integer  | ç³»ç»Ÿå†…éƒ¨ç”¨æˆ·ID          |
        | companyId  | Integer  | ç³»ç»Ÿå†…éƒ¨å…¬å¸ID          |
        | requestId  | Integer  | æ³¨å†Œç”³è¯·è®°å½•IDï¼ˆå¦‚æœ‰ï¼‰  |

- **RegistrationService.php**
  - **æ–‡ä»¶è·¯å¾„**:`packages/Registration/src/Services/RegistrationService.php`
  - **æ–‡ä»¶çŠ¶æ€**:æ–°å¢
  - **ä¾èµ–æœåŠ¡**:WechatMessageService, CompanyService, InterSystemService, UserPermissionService
  - **æ–¹æ³•**:
    - **processWechatRegistration($openid, $sceneParam)**
      - **åŠŸèƒ½æè¿°**:å¤„ç†å¾®ä¿¡æˆæƒæ³¨å†Œçš„å®Œæ•´ä¸šåŠ¡æµç¨‹ï¼ŒåŒ…æ‹¬ç”¨æˆ·ä¿¡æ¯è·å–ã€åœºæ™¯å‚æ•°è§£æã€åˆæ­¥éªŒè¯ç­‰
      - **æ–¹æ³•çŠ¶æ€**:æ–°å¢
      - **è¿”å›æ•°æ®**:æ³¨å†Œä¸Šä¸‹æ–‡ä¿¡æ¯å’Œç”¨æˆ·åŸºç¡€æ•°æ®

    - **validateRegistrationData($userData, $companyData)**
      - **åŠŸèƒ½æè¿°**:éªŒè¯æ³¨å†Œæ•°æ®çš„å®Œæ•´æ€§å’Œåˆæ³•æ€§ï¼ŒåŒ…æ‹¬ç”¨æˆ·ä¿¡æ¯éªŒè¯ã€å…¬å¸ä¿¡æ¯éªŒè¯ã€é‡å¤æ€§æ£€æŸ¥ç­‰
      - **æ–¹æ³•çŠ¶æ€**:æ–°å¢
      - **è¿”å›æ•°æ®**:éªŒè¯ç»“æœå’Œé”™è¯¯ä¿¡æ¯

    - **createUserAndCompany($userData, $companyData, $openid)**
      - **åŠŸèƒ½æè¿°**:åˆ›å»ºç”¨æˆ·å’Œå…¬å¸è®°å½•ï¼Œå¤„ç†å…¬å¸ç»‘å®šå…³ç³»ï¼Œç”Ÿæˆå®¡æ‰¹ç”³è¯·è®°å½•
      - **æ–¹æ³•çŠ¶æ€**:æ–°å¢
      - **è¿”å›æ•°æ®**:åˆ›å»ºçš„ç”¨æˆ·IDå’Œå…¬å¸ID

    - **handleCompanyBinding($userId, $companyData, $taxCode)**
      - **åŠŸèƒ½æè¿°**:å¤„ç†å…¬å¸ç»‘å®šé€»è¾‘ï¼ŒåŒ…æ‹¬æ–°å…¬å¸åˆ›å»ºã€ç°æœ‰å…¬å¸ç»‘å®šã€é‡å¤æ£€æŸ¥ç­‰
      - **æ–¹æ³•çŠ¶æ€**:æ–°å¢
      - **è¿”å›æ•°æ®**:ç»‘å®šç»“æœå’Œå…¬å¸ä¿¡æ¯

    - **sendNotifications($userData, $companyData, $sceneParam)**
      - **åŠŸèƒ½æè¿°**:å‘é€æ³¨å†Œç›¸å…³é€šçŸ¥ï¼ŒåŒ…æ‹¬é‚®ä»¶é€šçŸ¥é”€å”®ã€å¾®ä¿¡æ¶ˆæ¯æ¨é€ç­‰
      - **æ–¹æ³•çŠ¶æ€**:æ–°å¢
      - **è¿”å›æ•°æ®**:é€šçŸ¥å‘é€ç»“æœ

### 3.2 ç™»å½•ä¸šåŠ¡æ¨¡å—

#### 3.2.1 ä¸šåŠ¡æµç¨‹

##### 3.2.1.1 ä¸šåŠ¡èƒŒæ™¯

- **èƒŒæ™¯**:ç”¨æˆ·æœ‰2ç§ç™»å½•æ–¹å¼ 1.æ‰‹æœºå·+éªŒè¯ç ç™»å½•; 2. wechat æŒä¹…åŒ–è‡ªåŠ¨ç™»å½•, ç™»å½•åæ ¹æ®å½“å‰PartnerçŠ¶æ€ ç»™äºˆä¸åŒçš„æ“ä½œæƒé™ï¼Œç³»ç»Ÿæ”¯æŒç”¨æˆ·åœ¨å¤šä¸ªå…¬å¸ä¹‹é—´åˆ‡æ¢ï¼Œæ¯æ¬¡ç™»å½•è®°å½•æœ€åç™»å½•æ—¶é—´å’Œæœ€åæ“ä½œçš„å…¬å¸ã€‚

- **ç™»å½•æµç¨‹**:  
  - **wechatç™»å½•**
    1. ç”¨æˆ·æˆæƒ(æ£€æµ‹tokenæ˜¯å¦è¿‡æœŸ è¿‡æœŸé‡æ–°æˆæƒ)
    2. æ ¡éªŒopenid æ˜¯å¦ç»‘å®šPortalç«¯ User
    3. æ ¡éªŒé€šè¿‡ -> æ£€æµ‹å…¬å¸ é»˜è®¤ ç™»å½•æœ€åä¸€æ¬¡é€‰æ‹©çš„å…¬å¸, å¦‚æœæ²¡æœ‰åˆ™ è·å–ç¬¬ä¸€ä¸ªå…³è”çš„å…¬å¸
    4. æ ¡éªŒå¤±è´¥ -> ç¦æ­¢ç™»å½•/è·³è½¬æ³¨å†Œ
  - **æ‰‹æœºå·ç™»å½•** :
    - **ç™»å½•é¡µ**
      - ç”¨æˆ·è¾“å…¥æ‰‹æœºå·å‘é€çŸ­ä¿¡éªŒè¯ç 
      - éªŒè¯éªŒè¯ç æ˜¯å¦æ­£ç¡®
      ![alt text](<029 - Login - Mobile.png>)
      ![alt text](<029 - Login - Mobile-1.png>)
    - **å…¬å¸é€‰æ‹©å™¨**
      - ç»‘å®š1ä¸ªå…¬å¸ â†’ ç›´æ¥ç™»å½•è¿›å…¥ä¸»é¡µ
      - ç»‘å®šå¤šä¸ªå…¬å¸ â†’ æ˜¾ç¤ºå…¬å¸é€‰æ‹©é¡µé¢
      ![alt text](<030 - Select Company - Mobile.png>)

- **ç™»å½•æ ¡éªŒ**
  - ç”¨æˆ·ä¸å­˜åœ¨ â†’ è·³è½¬æ³¨å†Œé¡µé¢
  - ç”¨æˆ·å­˜åœ¨ä½†æœªç»‘å®šå…¬å¸ â†’ **å…è®¸ç™»å½•ï¼Œåªèƒ½æŸ¥çœ‹ä¸ªäººä¿¡æ¯å’Œç”³è¯·æ·»åŠ å…¬å¸**
  - å¦‚æœæ›´æ¢è®¾å¤‡, éªŒè¯ç é€šè¿‡æ ¡éªŒåˆ™ç›´æ¥æ›¿æ¢openid

- **éšç§åè®®**:
  - éšç§åè®®å­˜æ”¾åœ¨general_optionsä¸­, å¹¶æ ‡è®°ç‰ˆæœ¬
  - ç”¨æˆ·æ³¨å†Œ/ç™»å½•æ—¶,å¿…é¡»è¦å‹¾é€‰éšç§åè®®
  - è®°å½• éšç§åè®®ç‰ˆæœ¬ ä»¥åŠ æ˜¯å¦å‹¾é€‰
  - å¦‚æœå·²ç»å‹¾é€‰è¿‡,å†æ¬¡ç™»å½•æ—¶è‡ªåŠ¨å‹¾é€‰, å¦‚æœç‰ˆæœ¬æ›´æ–°åˆ™éœ€ç”¨æˆ·æ‰‹åŠ¨é‡æ–°å‹¾
  ![alt text](éšç§åè®®.png)

- **æƒé™æ§åˆ¶é˜¶æ®µ**:
  - æ ¡éªŒå½“å‰User é€‰æ‹©çš„Company æ ¡éªŒ PartnerçŠ¶æ€
    - pending:å…è®¸ç™»å½•, ç¼–è¾‘ ç”¨æˆ·/å…¬å¸ä¿¡æ¯, åˆ›å»ºInquiry,Porject, æŸ¥çœ‹èµ„æ–™
    - active: å…è®¸ç™»å½•, ç¼–è¾‘ç”¨æˆ·ä¿¡æ¯ å…¬å¸ä¿¡æ¯ä¸å¯ç¼–è¾‘, åˆ›å»ºInquiry,Porject, æ¥å—/æ‹’ç» åˆ†é…çš„é¡¹ç›®, æŸ¥çœ‹èµ„æ–™
    - decline: å…è®¸ç™»å½•, æ— å…³è”å…¬å¸, éœ€é‡æ–°ç”³è¯·, ç¼–è¾‘ç”¨æˆ·ä¿¡æ¯, æ— å…¶å®ƒæ“ä½œ
    - signed: å…è®¸ç™»å½•, è·³è½¬ View - Agr Home-Page
  - **æ— å…¬å¸å…³è”ç”¨æˆ·:åªèƒ½æŸ¥çœ‹ä¸ªäººä¿¡æ¯ï¼Œç”³è¯·æ·»åŠ å…¬å¸ï¼Œè¿›è¡Œé‡æ–°ç»‘å®šæµç¨‹**

- **weclomeé¡µé¢**
  - ç”¨æˆ·ç™»å½•æˆåŠŸåè·³è½¬åˆ°Welcome Page
  - æ£€æŸ¥ç”¨æˆ·æƒé™çŠ¶æ€å’Œå…¬å¸ç»‘å®šæƒ…å†µ,å¼€æ”¾ä¸åŒåŠŸèƒ½
  - ç»Ÿè®¡å¾…å›å¤é—®è¯¢æ•°é‡ï¼ˆRatingçŠ¶æ€ï¼‰ - pendingæ—¶ ä»…ç»Ÿè®¡è‡ªå·±; activeæ—¶ ç»Ÿè®¡Companyä¸‹æ‰€æœ‰
  - ç»Ÿè®¡å¾…å¤„ç†TKEé¡¹ç›®æ•°é‡ - activeçŠ¶æ€æ—¶ç»Ÿè®¡, ç»Ÿè®¡è¯¥Companyä¸‹æ‰€æœ‰å¾…å¤„ç†
  ![alt text](<031 - Welcome Page - Mobile.png>)

- **å¼‚å¸¸æµç¨‹**:
  - æ‰‹æœºå·éªŒè¯ç é”™è¯¯/è¿‡æœŸ â†’ é‡æ–°è·å–éªŒè¯ç 
  - æ‰‹æœºå·ç è¢«å ç”¨
  - PartnerçŠ¶æ€è¢« Decline/è§£ç»‘/æ‹‰é»‘
  - æ•°æ®åŠ è½½å¤±è´¥ â†’ æ˜¾ç¤ºé»˜è®¤å€¼å¹¶è®°å½•é”™è¯¯

- **æµç¨‹å›¾**:

```mermaid
flowchart TD
    A[ç”¨æˆ·è¿›å…¥ç™»å½•é¡µ] --> B{é€‰æ‹©ç™»å½•æ–¹å¼}
    B -->|å¾®ä¿¡ç™»å½•| C[å¾®ä¿¡æˆæƒè·å–OpenID]
    B -->|æ‰‹æœºå·ç™»å½•| D[è¾“å…¥æ‰‹æœºå·]
    D --> E[å‘é€éªŒè¯ç ]
    E --> F[è¾“å…¥éªŒè¯ç ]
    F --> G{éªŒè¯æ˜¯å¦é€šè¿‡}
    G -->|å¦| H[æç¤ºé”™è¯¯ï¼Œé‡è¯•]
    G -->|æ˜¯| I[æŸ¥æ‰¾ç”¨æˆ·]
    C --> I
    I --> J{æ˜¯å¦å­˜åœ¨ç”¨æˆ·}
    J -->|å¦| K[å¼•å¯¼æ³¨å†Œ]
    J -->|æ˜¯| L{æ˜¯å¦ç»‘å®šå…¬å¸}
    L -->|å¦| M[è¿›å…¥ä¸ªäººæ¨¡å¼ï¼Œä»…å¯ç¼–è¾‘ä¿¡æ¯]
    L -->|æ˜¯| N{æ˜¯å¦å¤šå…¬å¸}
    N -->|æ˜¯| O[å±•ç¤ºå…¬å¸åˆ—è¡¨]
    N -->|å¦| P[ç›´æ¥è¿›å…¥å…¬å¸]
    O --> Q[ç”¨æˆ·é€‰æ‹©å…¬å¸]
    Q --> R[è®°å½•LastVisitCompanyId]
    P --> R
    R --> S[è·³è½¬Welcomeé¡µ]
    S --> T{æ ¹æ®PartnerçŠ¶æ€å±•ç¤ºåŠŸèƒ½}
    T --> U[pending: å¯ç¼–è¾‘+åˆ›å»ºé¡¹ç›®/å’¨è¯¢]
    T --> V[active: å¯æ¥å—é¡¹ç›®+æŸ¥çœ‹å…¬å¸æ•°æ®]
    T --> W[declined: ä»…å¯ç¼–è¾‘ä¸ªäººä¿¡æ¯]
    T --> X[signed: è·³è½¬AGR Homepage]
```

#### 3.2.2 å½±å“çš„æ•°æ®è¡¨

- **[users](#table-users)** : Portalç«¯ UseråŸºç¡€ä¿¡æ¯è¡¨ - æ ¡éªŒæ‰‹æœºå·
- **[companies](#table-companies)** : Portalç«¯ Company åŸºç¡€ä¿¡æ¯è¡¨
- **[user_company](#table-user_company)** : User&Company å…³è”è¡¨(è®°å½• Partner å½“å‰çŠ¶æ€)
- **[user_company_assignment](#table-user_company_assignment)** : Portalç«¯ Partner å…³è” é”€å”®è¡¨

#### 3.2.3 å‰ç«¯å®ç°

##### 3.2.3.1 è§†å›¾ç›®å½•ç»“æ„

```plaintext
/src/views/login/
  LoginMain.vue                - ç™»å½•ä¸»é¡µé¢
  CompanySelection.vue         - å¤šå…¬å¸é€‰æ‹©é¡µé¢

/src/components/login/
  LoginFlow.vue                - ç™»å½•æµç¨‹æ§åˆ¶ç»„ä»¶
  CompanySelector.vue          - å…¬å¸é€‰æ‹©å™¨ç»„ä»¶
```

##### 3.2.3.2 å…³é”®ç»„ä»¶åŠŸèƒ½

- **LoginFlow.vue**
  - ç™»å½•æµç¨‹æ§åˆ¶ï¼ˆæ‰‹æœºå·éªŒè¯â†’å¤šå…¬å¸é€‰æ‹©â†’çŠ¶æ€è·å–ï¼‰
  - é›†æˆå…¬å…±çŸ­ä¿¡éªŒè¯ç»„ä»¶(SmsVerificationService)
  - ç™»å½•çŠ¶æ€ç®¡ç†

- **CompanySelector.vue**
  - ç”¨æˆ·ç»‘å®šå…¬å¸åˆ—è¡¨å±•ç¤º
  - å…¬å¸é€‰æ‹©å’Œç¡®è®¤é€»è¾‘
  - æ— å…¬å¸å…³è”çŠ¶æ€å¤„ç†

##### 3.2.3.3 APIè®¾è®¡

| HTTP æ–¹æ³• | ç«¯ç‚¹                          | æè¿°                    |
|-----------|-------------------------------|-------------------------|
| POST      | `/api/auth/send-sms`          | å‘é€ç™»å½•çŸ­ä¿¡éªŒè¯ç  |
| POST      | `/api/auth/verify-code`       | éªŒè¯éªŒè¯ç å¹¶æŸ¥æ‰¾ç”¨æˆ· |
| POST      | `/api/auth/select-company`    | é€‰æ‹©å…¬å¸å®Œæˆç™»å½• |
| GET       | `/api/user/company`           | è·å–ç”¨æˆ·ç»‘å®šå…¬å¸åˆ—è¡¨ |
| GET       | `/api/user/switch-company`    | åˆ‡æ¢å…¬å¸ç»„ä»¶ - é€šç”¨ |
| GET       | `/api/welcome/stats`          | è·å–ç»Ÿè®¡æ•°æ® å¾…è¯„ä»·/å¾…æ“ä½œ Inquiry/Project |

#### 3.2.4 åŠŸèƒ½å¼€å‘ä¸å®ç°

##### 3.2.4.1 ç±»å…³ç³»å›¾

```mermaid
classDiagram
    class LoginController {
        +sendSmsVerificationCode()
        +verifyCodeAndLogin()
        +selectCompany()
        +logout()
        +refreshToken()
        +switchCompany()
        +getUserPermissions()
        +getUsercompany()
    }

    class LoginService {
        +processMobileLogin(mobile,code)
        +handleMultiCompanySelection(userId)
        +switchUserCompany(userId,newCompanyId)
        +validateUserStatus(userId)
    }

    class UserPermissionService {
        +checkUserCompanyBinding(userId,companyId)
        +getUserCompanyStatus(userId,companyId)
        +switchUserCompany(userId,companyId)
        +syncUserCompanyStatus(userId,companyId,statusData)
    }

    class SmsVerificationService {
        +sendCode(mobile,scene)
        +verifyCode(mobile,code,scene)
        +isRateLimited(mobile)
        +cleanExpiredCodes()
    }

    class BaseController {
        +successResponse(data,message,code)
        +errorResponse(message,code,errors)
    }

    class User {
        +id
        +mobile
        +status
        +LastLoginTime
        +LastVisitCompanyId
        +company()
        +createToken()
    }

    class Company {
        +id
        +company_name
        +users()
    }

    class UserCompany {
        +user_id
        +company_id
        +Status
        +accountStatus
    }

    LoginController --> LoginService : ä¸šåŠ¡å¤„ç†
    LoginController --> SmsVerificationService : çŸ­ä¿¡éªŒè¯
    LoginController --> BaseController : å“åº”æ ¼å¼åŒ–

    LoginService --> UserPermissionService : æƒé™æ£€æŸ¥
    LoginService --> User : ç”¨æˆ·æ“ä½œ
    LoginService --> Company : å…¬å¸ä¿¡æ¯

    UserPermissionService --> UserCompany : æƒé™æŸ¥è¯¢
    User --> UserCompany : belongsToMany
    Company --> UserCompany : belongsToMany
```

##### 3.2.4.2 ä»£ç å®ç°

- **WelcomeController.php**
  - **æ–‡ä»¶è·¯å¾„**:`app/Http/Controllers/WelcomeController.php`
  - **æ–‡ä»¶çŠ¶æ€**:æ–°å¢
  - **æ–¹æ³•**:
    - **getDashboard()**  
      - **åŠŸèƒ½æè¿°**:è·å–Welcome Pageä¸»é¡µæ‰€æœ‰æ•°æ®ï¼ŒåŒ…æ‹¬ç”¨æˆ·ä¿¡æ¯ã€ç»Ÿè®¡æ•°æ®ã€æƒé™çŠ¶æ€å’Œé€šçŸ¥æé†’ã€‚é›†æˆæ—¥å¿—è®°å½•ã€‚  
      - **æ–¹æ³•çŠ¶æ€**:æ–°å¢  
      - **è°ƒç”¨é¡ºåº**:ç”¨æˆ·ç™»å½•æˆåŠŸè·³è½¬åˆ°ä¸»é¡µæ—¶è°ƒç”¨  
      - **ä¾èµ–æœåŠ¡**:
        - `WelcomeService::getDashboardData()`
        - `auth('sanctum')->user()`
        - `UserPermissionService::getUserCompanyStatus()`
        - `Log::channel('business')->info()`
      - **è¯·æ±‚å‚æ•°**:æ— 

      - **å“åº”æ•°æ®**:  

        | å‚æ•°åç§° | æ•°æ®ç±»å‹ | æè¿°                  |
        |----------|----------|-----------------------|
        | success  | Boolean  | æ˜¯å¦è·å–æˆåŠŸ           |
        | userInfo | Object   | ç”¨æˆ·åŸºæœ¬ä¿¡æ¯           |
        | companyInfo | Object | å…¬å¸ä¿¡æ¯ï¼ˆå¦‚æœ‰ï¼‰       |
        | userPermission | String | ç”¨æˆ·æƒé™çº§åˆ«(active/inactive/agr/none) |
        | stats    | Object   | ç»Ÿè®¡æ•°æ®æ±‡æ€»           |
        | notifications | Object | é€šçŸ¥æé†’æ•°é‡         |
        | quickNav | Array    | å¿«é€Ÿå¯¼èˆªèœå•           |
        | isPersonalMode | Boolean | æ˜¯å¦ä¸ªäººæ¨¡å¼        |
        | availableCompanies | Array | å¯åˆ‡æ¢çš„å…¬å¸åˆ—è¡¨   |

    - **getStats()**
      - **åŠŸèƒ½æè¿°**:è·å–å¾…å¤„ç†äº‹é¡¹ç»Ÿè®¡æ•°æ®ï¼ŒåŒ…æ‹¬å¾…å›å¤é—®è¯¢æ•°é‡å’Œå¾…å¤„ç†TKEé¡¹ç›®æ•°é‡ï¼Œæ ¹æ®ç”¨æˆ·æƒé™è¿‡æ»¤æ•°æ®èŒƒå›´ã€‚é›†æˆæ—¥å¿—è®°å½•ã€‚  
      - **æ–¹æ³•çŠ¶æ€**:æ–°å¢  
      - **è°ƒç”¨é¡ºåº**:ä¸»é¡µåŠ è½½æˆ–ç”¨æˆ·æ‰‹åŠ¨åˆ·æ–°ç»Ÿè®¡æ•°æ®æ—¶è°ƒç”¨  
      - **ä¾èµ–æœåŠ¡**:
        - `WelcomeService::getStatsSummary()`
        - `WelcomeService::calculateNotificationBadges()`
        - `auth('sanctum')->user()`
        - `UserPermissionService::getUserCompanyStatus()`
        - `Log::channel('business')->info()`
      - **è¯·æ±‚å‚æ•°**:æ— 

      - **å“åº”æ•°æ®**:  

        | å‚æ•°åç§° | æ•°æ®ç±»å‹ | æè¿°                  |
        |----------|----------|-----------------------|
        | success  | Boolean  | æ˜¯å¦è·å–æˆåŠŸ           |
        | pendingInquiries | Integer | å¾…å¤„ç†é—®è¯¢æ•°é‡      |
        | pendingProjects | Integer | å¾…å¤„ç†é¡¹ç›®æ•°é‡       |
        | inquiryBadge | Integer | é—®è¯¢æ¨¡å—å°çº¢ç‚¹æ•°å­—    |
        | projectBadge | Integer | é¡¹ç›®æ¨¡å—å°çº¢ç‚¹æ•°å­—    |
        | lastUpdate | DateTime | ç»Ÿè®¡æ•°æ®æ›´æ–°æ—¶é—´      |
        | dataScope | String  | æ•°æ®èŒƒå›´(personal/company) |
        | permissionLevel | String | ç”¨æˆ·æƒé™çº§åˆ«        |

    - **switchCompany()**
      - **åŠŸèƒ½æè¿°**:ç”¨æˆ·åœ¨Welcome Pageåˆ‡æ¢å½“å‰æ“ä½œå…¬å¸
      - **æ–¹æ³•çŠ¶æ€**:æ–°å¢  
      - **è°ƒç”¨é¡ºåº**:ç”¨æˆ·ä»å…¬å¸åˆ‡æ¢å™¨ä¸­é€‰æ‹©æ–°å…¬å¸æ—¶è°ƒç”¨  
      - **ä¾èµ–æœåŠ¡**:
        - `UserPermissionService::switchUserCompany()`
        - `auth('sanctum')->user()->currentAccessToken()->delete()`
        - `auth('sanctum')->user()->createToken('auth-token', ['company:' . $companyId])`
        - `User::update(['last_company_id' => $companyId])`
        - `Log::channel('business')->info()`
      - **è¯·æ±‚å‚æ•°**:  

        | å‚æ•°åç§°  | æ•°æ®ç±»å‹ | æ˜¯å¦å¿…å¡« | æè¿°             |
        |-----------|----------|----------|------------------|
        | companyId | Integer  | æ˜¯       | ç›®æ ‡å…¬å¸ID       |

      - **å“åº”æ•°æ®**:  

        | å‚æ•°åç§° | æ•°æ®ç±»å‹ | æè¿°                  |
        |----------|----------|-----------------------|
        | success  | Boolean  | åˆ‡æ¢æ˜¯å¦æˆåŠŸ           |
        | token    | String   | æ–°çš„Tokenä»¤ç‰Œ       |
        | userInfo | Object   | ç”¨æˆ·ä¿¡æ¯               |
        | companyInfo | Object | æ–°å…¬å¸ä¿¡æ¯           |
        | permissions | Object | æ–°çš„æƒé™ä¿¡æ¯         |
        | stats    | Object   | æ–°å…¬å¸çš„ç»Ÿè®¡æ•°æ®       |
        | redirectUrl | String | åˆ‡æ¢åè·³è½¬åœ°å€       |

- **LoginController.php**
  - **æ–‡ä»¶è·¯å¾„**:`packages/Login/src/Controllers/LoginController.php`
  - **æ–‡ä»¶çŠ¶æ€**:æ–°å¢
  - **æ–¹æ³•**:
    - **sendSmsVerificationCode()**  
      - **åŠŸèƒ½æè¿°**:å‘é€ç™»å½•çŸ­ä¿¡éªŒè¯ç ï¼ŒåŒ…å«é¢‘ç‡é™åˆ¶æ£€æŸ¥ã€‚
      - **æ–¹æ³•çŠ¶æ€**:æ–°å¢  
      - **è°ƒç”¨é¡ºåº**:ç”¨æˆ·è¾“å…¥æ‰‹æœºå·ç‚¹å‡»å‘é€éªŒè¯ç æ—¶è°ƒç”¨  
      - **ä¾èµ–æœåŠ¡**:
        - `SmsVerificationService::sendCode($mobile, 'login')`
        - `SmsVerificationService::isRateLimited($mobile)`
        - `Log::channel('business')->info()`
        - `Log::channel('security')->warning()`
      - **è¯·æ±‚å‚æ•°**:  

        | å‚æ•°åç§° | æ•°æ®ç±»å‹ | æ˜¯å¦å¿…å¡« | æè¿°             |
        |----------|----------|----------|------------------|
        | mobile    | String   | æ˜¯       | æ‰‹æœºå·           |

      - **å“åº”æ•°æ®**:  

        | å‚æ•°åç§° | æ•°æ®ç±»å‹ | æè¿°                  |
        |----------|----------|-----------------------|
        | success  | Boolean  | æ˜¯å¦å‘é€æˆåŠŸ           |
        | message  | String   | æç¤ºä¿¡æ¯               |
        | expireTime | Integer | éªŒè¯ç æœ‰æ•ˆæœŸ(ç§’)       |
        | canResendAfter | Integer | å¯é‡æ–°å‘é€ç­‰å¾…æ—¶é—´(ç§’) |

    - **verifyCodeAndLogin()**
      - **åŠŸèƒ½æè¿°**:éªŒè¯çŸ­ä¿¡éªŒè¯ç å¹¶å¤„ç†ç™»å½•é€»è¾‘ï¼Œè¿”å›ç”¨æˆ·ç»‘å®šçš„å…¬å¸åˆ—è¡¨ï¼Œæ›´æ–°æœ€åç™»å½•æ—¥æœŸã€‚
      - **æ–¹æ³•çŠ¶æ€**:æ–°å¢  
      - **è°ƒç”¨é¡ºåº**:ç”¨æˆ·è¾“å…¥éªŒè¯ç ç‚¹å‡»ç™»å½•æ—¶è°ƒç”¨  
      - **ä¾èµ–æœåŠ¡**:
        - `SmsVerificationService::verifyCode($mobile, $code, 'login')`
        - `LoginService::processMobileLogin($mobile, $code)`
        - `LoginService::handleMultiCompanySelection($userId)`
        - `User::where('mobile', $mobile)->first()`
        - `Log::channel('business')->info()`
        - `Log::channel('security')->warning()`
      - **è¯·æ±‚å‚æ•°**:  

        | å‚æ•°åç§° | æ•°æ®ç±»å‹ | æ˜¯å¦å¿…å¡« | æè¿°             |
        |----------|----------|----------|------------------|
        | mobile    | String   | æ˜¯       | æ‰‹æœºå·           |
        | code     | String   | æ˜¯       | çŸ­ä¿¡éªŒè¯ç        |

      - **å“åº”æ•°æ®**:  

        | å‚æ•°åç§° | æ•°æ®ç±»å‹ | æè¿°                  |
        |----------|----------|-----------------------|
        | success  | Boolean  | éªŒè¯æ˜¯å¦é€šè¿‡           |
        | userId   | Integer  | ç”¨æˆ·ID                 |
        | userInfo | Object   | ç”¨æˆ·åŸºæœ¬ä¿¡æ¯           |
        | company | Array   | ç”¨æˆ·ç»‘å®šçš„å…¬å¸åˆ—è¡¨     |
        | needCompanySelection | Boolean | æ˜¯å¦éœ€è¦é€‰æ‹©å…¬å¸ |
        | hasNoCompany | Boolean | æ˜¯å¦æ— å…¬å¸å…³è” |
        | message  | String   | æç¤ºä¿¡æ¯               |

    - **selectCompany()**
      - **åŠŸèƒ½æè¿°**:ç”¨æˆ·é€‰æ‹©å…¬å¸åï¼Œè®°å½•æœ€åæ“ä½œçš„å…¬å¸ã€‚
      - **æ–¹æ³•çŠ¶æ€**:æ–°å¢  
      - **è°ƒç”¨é¡ºåº**:ç”¨æˆ·ä»å…¬å¸åˆ—è¡¨ä¸­é€‰æ‹©å…¬å¸æ—¶è°ƒç”¨  
      - **ä¾èµ–æœåŠ¡**:
        - `LoginService::validateUserStatus($userId)`
        - `UserPermissionService::checkUserCompanyBinding($userId, $companyId)`
        - `UserPermissionService::getUserCompanyStatus($userId, $companyId)`
        - `User::find($userId)->createToken('auth-token', ['company:' . $companyId])`
        - `User::find($userId)->update(['last_company_id' => $companyId])`
        - `Log::channel('business')->info()`
      - **è¯·æ±‚å‚æ•°**:  

        | å‚æ•°åç§°  | æ•°æ®ç±»å‹ | æ˜¯å¦å¿…å¡« | æè¿°             |
        |-----------|----------|----------|------------------|
        | userId    | Integer  | æ˜¯       | ç”¨æˆ·ID           |
        | companyId | Integer  | æ˜¯       | é€‰æ‹©çš„å…¬å¸ID     |

      - **å“åº”æ•°æ®**:  

        | å‚æ•°åç§° | æ•°æ®ç±»å‹ | æè¿°                  |
        |----------|----------|-----------------------|
        | success  | Boolean  | ç™»å½•æ˜¯å¦æˆåŠŸ           |
        | token | String | Tokenä»¤ç‰Œ             |
        | userInfo | Object   | ç”¨æˆ·ä¿¡æ¯               |
        | companyInfo | Object | å…¬å¸ä¿¡æ¯             |
        | permissions | Object | ç”¨æˆ·æƒé™ä¿¡æ¯         |
        | redirectUrl | String | ç™»å½•åè·³è½¬åœ°å€       |

    - **logout()**
      - **åŠŸèƒ½æè¿°**:ç”¨æˆ·é€€å‡ºç™»å½•ï¼Œåˆ é™¤å½“å‰ç”¨æˆ·Tokenã€‚
      - **æ–¹æ³•çŠ¶æ€**:æ–°å¢  
      - **è°ƒç”¨é¡ºåº**:ç”¨æˆ·ç‚¹å‡»é€€å‡ºç™»å½•æ—¶è°ƒç”¨  
      - **ä¾èµ–æœåŠ¡**:
        - `auth('sanctum')->user()->currentAccessToken()->delete()`
        - `Log::channel('security')->info()`
      - **è¯·æ±‚å‚æ•°**:æ— ï¼ˆä»Authorization headerè·å–tokenï¼‰

      - **å“åº”æ•°æ®**:  

        | å‚æ•°åç§° | æ•°æ®ç±»å‹ | æè¿°                  |
        |----------|----------|-----------------------|
        | success  | Boolean  | æ˜¯å¦é€€å‡ºæˆåŠŸ           |
        | message  | String   | æç¤ºä¿¡æ¯               |

    - **refreshToken()**
      - **åŠŸèƒ½æè¿°**:åˆ·æ–°ç”¨æˆ·Tokenå»¶é•¿è®¤è¯çŠ¶æ€ã€‚
      - **æ–¹æ³•çŠ¶æ€**:æ–°å¢  
      - **è°ƒç”¨é¡ºåº**:tokenå³å°†è¿‡æœŸæ—¶è‡ªåŠ¨è°ƒç”¨æˆ–ç”¨æˆ·ä¸»åŠ¨åˆ·æ–°  
      - **ä¾èµ–æœåŠ¡**:
        - `auth('sanctum')->user()->currentAccessToken()->delete()`
        - `auth('sanctum')->user()->createToken()`
        - `Log::channel('business')->info()`
      - **è¯·æ±‚å‚æ•°**:æ— ï¼ˆä»Authorization headerè·å–å½“å‰tokenï¼‰

      - **å“åº”æ•°æ®**:  

        | å‚æ•°åç§° | æ•°æ®ç±»å‹ | æè¿°                  |
        |----------|----------|-----------------------|
        | success  | Boolean  | æ˜¯å¦åˆ·æ–°æˆåŠŸ           |
        | token | String | æ–°çš„Tokenä»¤ç‰Œ         |
        | expiresAt | DateTime | æ–°çš„è¿‡æœŸæ—¶é—´         |
        | message  | String   | æç¤ºä¿¡æ¯               |

    - **switchCompany()**
      - **åŠŸèƒ½æè¿°**:ç”¨æˆ·åœ¨å¤šä¸ªå…¬å¸é—´åˆ‡æ¢å½“å‰æ“ä½œå…¬å¸ã€‚
      - **æ–¹æ³•çŠ¶æ€**:æ–°å¢  
      - **è°ƒç”¨é¡ºåº**:ç”¨æˆ·åœ¨ç³»ç»Ÿä¸­é€‰æ‹©åˆ‡æ¢åˆ°å…¶ä»–å…¬å¸æ—¶è°ƒç”¨  
      - **ä¾èµ–æœåŠ¡**:
        - `UserPermissionService::switchUserCompany($userId, $companyId)`
        - `User::find($userId)->update(['last_company_id' => $companyId])`
        - `auth('sanctum')->user()->currentAccessToken()->delete()`
        - `auth('sanctum')->user()->createToken('auth-token', ['company:' . $companyId])`
        - `Log::channel('business')->info()`
      - **è¯·æ±‚å‚æ•°**:  

        | å‚æ•°åç§°  | æ•°æ®ç±»å‹ | æ˜¯å¦å¿…å¡« | æè¿°             |
        |-----------|----------|----------|------------------|
        | companyId | Integer  | æ˜¯       | ç›®æ ‡å…¬å¸ID       |

      - **å“åº”æ•°æ®**:  

        | å‚æ•°åç§° | æ•°æ®ç±»å‹ | æè¿°                  |
        |----------|----------|-----------------------|
        | success  | Boolean  | æ˜¯å¦åˆ‡æ¢æˆåŠŸ           |
        | token | String | æ–°çš„Tokenä»¤ç‰Œ         |
        | companyInfo | Object | æ–°å…¬å¸ä¿¡æ¯           |
        | permissions | Object | æ–°çš„æƒé™ä¿¡æ¯         |
        | redirectUrl | String | åˆ‡æ¢åè·³è½¬åœ°å€       |

    - **getUserPermissions()**
      - **åŠŸèƒ½æè¿°**:è·å–å½“å‰ç”¨æˆ·åœ¨æŒ‡å®šå…¬å¸çš„æƒé™ä¿¡æ¯ã€‚
      - **æ–¹æ³•çŠ¶æ€**:æ–°å¢  
      - **è°ƒç”¨é¡ºåº**:å‰ç«¯éœ€è¦æ£€æŸ¥ç”¨æˆ·æƒé™æ—¶è°ƒç”¨  
      - **ä¾èµ–æœåŠ¡**:
        - `UserPermissionService::getUserCompanyStatus($userId, $companyId)`
        - `auth('sanctum')->user()`
        - `auth('sanctum')->user()->tokenCan('company:' . $companyId)`
      - **è¯·æ±‚å‚æ•°**:æ— ï¼ˆä»tokenä¸­è·å–ç”¨æˆ·å’Œå…¬å¸ä¿¡æ¯ï¼‰

      - **å“åº”æ•°æ®**:  

        | å‚æ•°åç§° | æ•°æ®ç±»å‹ | æè¿°                  |
        |----------|----------|-----------------------|
        | success  | Boolean  | æ˜¯å¦è·å–æˆåŠŸ           |
        | permissions | Object | ç”¨æˆ·æƒé™è¯¦æƒ…         |
        | Status | String | è”ç³»äººçŠ¶æ€           |
        | companyInfo | Object | å½“å‰å…¬å¸ä¿¡æ¯         |
        | isPersonalMode | Boolean | æ˜¯å¦ä¸ªäººæ¨¡å¼       |

    - **getUserCompany()**
      - **åŠŸèƒ½æè¿°**:è·å–ç”¨æˆ·ç»‘å®šçš„æ‰€æœ‰å…¬å¸åˆ—è¡¨ã€‚
      - **æ–¹æ³•çŠ¶æ€**:æ–°å¢  
      - **è°ƒç”¨é¡ºåº**:ç”¨æˆ·éœ€è¦æŸ¥çœ‹æˆ–åˆ‡æ¢å…¬å¸æ—¶è°ƒç”¨  
      - **ä¾èµ–æœåŠ¡**:
        - `auth('sanctum')->user()->company()->withPivot(['contract_status', 'account_status'])->get()`
        - `UserPermissionService::checkUserCompanyBinding($userId, $companyId)`
      - **è¯·æ±‚å‚æ•°**:æ— ï¼ˆä»tokenä¸­è·å–ç”¨æˆ·ä¿¡æ¯ï¼‰

      - **å“åº”æ•°æ®**:  

        | å‚æ•°åç§° | æ•°æ®ç±»å‹ | æè¿°                  |
        |----------|----------|-----------------------|
        | success  | Boolean  | æ˜¯å¦è·å–æˆåŠŸ           |
        | company | Array   | ç”¨æˆ·ç»‘å®šå…¬å¸åˆ—è¡¨       |
        | currentCompany | Object | å½“å‰æ“ä½œå…¬å¸ä¿¡æ¯     |
        | totalCount | Integer | ç»‘å®šå…¬å¸æ€»æ•°         |

- **LoginService.php**
  - **æ–‡ä»¶è·¯å¾„**:`packages/Login/src/Services/LoginService.php`
  - **æ–‡ä»¶çŠ¶æ€**:æ–°å¢
  - **æ–¹æ³•**:
    - **processMobileLogin($mobile, $code)**
      - **åŠŸèƒ½æè¿°**:å¤„ç†æ‰‹æœºå·éªŒè¯ç ç™»å½•çš„å®Œæ•´ä¸šåŠ¡é€»è¾‘ï¼ŒåŒ…æ‹¬éªŒè¯ç éªŒè¯ã€ç”¨æˆ·æŸ¥æ‰¾ã€çŠ¶æ€æ£€æŸ¥ç­‰
      - **æ–¹æ³•çŠ¶æ€**:æ–°å¢
      - **è¿”å›æ•°æ®**:ç™»å½•ç»“æœå’Œç”¨æˆ·ä¿¡æ¯

    - **handleMultiCompanySelection($userId)**
      - **åŠŸèƒ½æè¿°**:å¤„ç†å¤šå…¬å¸é€‰æ‹©é€»è¾‘ï¼Œè·å–ç”¨æˆ·ç»‘å®šçš„å…¬å¸åˆ—è¡¨åŠå…¶æƒé™çŠ¶æ€ï¼Œä¸ºå…¬å¸é€‰æ‹©æä¾›æ•°æ®æ”¯æŒ
      - **æ–¹æ³•çŠ¶æ€**:æ–°å¢
      - **è¿”å›æ•°æ®**:å¯é€‰å…¬å¸åˆ—è¡¨å’Œé€‰æ‹©å»ºè®®

    - **switchUserCompany($userId, $newCompanyId)**
      - **åŠŸèƒ½æè¿°**:å¤„ç†ç”¨æˆ·å…¬å¸åˆ‡æ¢é€»è¾‘ï¼ŒéªŒè¯åˆ‡æ¢æƒé™ï¼Œæ›´æ–°ä¼šè¯çŠ¶æ€ï¼Œé‡æ–°è·å–æƒé™ä¿¡æ¯
      - **æ–¹æ³•çŠ¶æ€**:æ–°å¢
      - **è¿”å›æ•°æ®**:åˆ‡æ¢ç»“æœå’Œæ–°æƒé™ä¿¡æ¯

    - **validateUserStatus($userId)**
      - **åŠŸèƒ½æè¿°**:éªŒè¯ç”¨æˆ·ç™»å½•çŠ¶æ€å’Œè´¦å·çŠ¶æ€ï¼Œæ£€æŸ¥æ˜¯å¦è¢«åˆ é™¤ã€æš‚åœç­‰ï¼Œç¡®ä¿ç”¨æˆ·å¯ä»¥æ­£å¸¸ç™»å½•
      - **æ–¹æ³•çŠ¶æ€**:æ–°å¢
      - **è¿”å›æ•°æ®**:ç”¨æˆ·çŠ¶æ€éªŒè¯ç»“æœ

### 3.3 MyInfo æ¨¡å—

#### 3.3.1 ä¸šåŠ¡æµç¨‹

##### 3.3.1.1 ä¸šåŠ¡èƒŒæ™¯

- **èƒŒæ™¯**:Portalç«¯ç”¨æˆ·å¯ä»¥è‡ªè¡Œç¼–è¾‘ Userä¿¡æ¯ å’Œæ ¹æ®PartnerçŠ¶æ€ç¼–è¾‘Companyä¿¡æ¯ 

- **ä¸»è¦æµç¨‹**:  
  - **ä¸ªäººä¿¡æ¯**
    1. **ä¸ªäººä¿¡æ¯**:å§‹ç»ˆå¯ç¼–è¾‘ï¼ˆfirstName, lastName, role, email, mobile)
    2. **æ‰‹æœºå·**:å˜æ›´æ‰‹æœºå·éœ€è¦çŸ­ä¿¡éªŒè¯
    3. å½“Partnerå˜æ›´è‡³ activeæ—¶, å˜æ›´ç”¨æˆ·ä¿¡æ¯éœ€åŒæ­¥Viewç«¯ contract
    ![alt text](<046 - My Info â€“ contract.png>)

  - **å…¬å¸ä¿¡æ¯**
    - Useræ— å…¬å¸ç»‘å®š â†’ ä¸å¯ç¼–è¾‘å…¬å¸ä¿¡æ¯
    - PartnerçŠ¶æ€ä¸ºpending â†’ å¯ç¼–è¾‘
    - PartnerçŠ¶æ€ä¸ºactive â†’ ä¸å¯ç¼–è¾‘ï¼Œæ˜¾ç¤ºåªè¯»ä¿¡æ¯
      ![alt text](<046 - My Info.png>)

  - **ç¼–è¾‘ä¿¡æ¯é˜¶æ®µ**
    - æ‰‹æœºå·éœ€è¦é‡å¤æ ¡éªŒ å¹¶æé†’
    - ç¼–è¾‘Companyä¿¡æ¯æ—¶, å¦‚ç¨å·å˜æ›´ ä¸”æ—¶Active Companyåˆ™ä¸æ³¨å†Œæ—¶ä¸€è‡´ åŒæ­¥å‡ºå…¬å¸ä¿¡æ¯ ä¸”ä¸å¯ç¼–è¾‘

  - **æ³¨é”€è´¦å·**
    - Userä¸»åŠ¨å‘èµ·æ³¨é”€è´¦å·æµç¨‹, æ³¨é”€æ—¶éœ€è¦äºŒæ¬¡ç¡®è®¤
    - æ³¨é”€å,è§£ç»‘ Userä¸Companyå…³è”å…³ç³», åŒæ—¶è§£ç»‘ Viewç«¯ contractå’Œ Portal Userå…³è”, ä½†æ˜¯ä¿ç•™Viewç«¯å…³è”ä¿¡æ¯,ä»…è§£ç»‘
    - æ³¨é”€å30å¤©åå¯ä»¥æ‰å¯ä»¥é‡æ–°å‘èµ·ç”³è¯·
    ![alt text](<033 - Menu - Mobile-1.png>)
    ![alt text](<033 - Menu - Mobile â€“ 1-1.png>)
    - ä»…å…³è”1å®¶å…¬å¸æ—¶
    ![alt text](<033 - Menu - Mobile â€“ 3-1.png>)
    - å…³è”å¤šå®¶å…¬å¸æ—¶
    ![alt text](<033 - Menu - Mobile â€“ 4-1.png>)
    ![alt text](<033 - Menu - Mobile â€“ 4-2.png>)

- **å¼‚å¸¸æµç¨‹**:  
  - å…¬å¸ä¿¡æ¯å†²çªï¼ˆç¨å·é‡å¤ç­‰ï¼‰â†’ æç¤ºå†²çªä¿¡æ¯
  - æ‰‹æœºå·éªŒè¯ç é”™è¯¯/è¿‡æœŸ â†’ é‡æ–°è·å–éªŒè¯ç 
  - æ–°æ‰‹æœºå·å·²è¢«å…¶ä»–ç”¨æˆ·ä½¿ç”¨ â†’ æ‹’ç»ä¿®æ”¹å¹¶æç¤º

- **æµç¨‹å›¾**:

```mermaid
flowchart TD
    A[ç”¨æˆ·è¿›å…¥MyInfoé¡µ] --> B{æ˜¯å¦æœ‰å…¬å¸ç»‘å®š}
    B -->|å¦| C[ä»…å±•ç¤ºä¸ªäººä¿¡æ¯ï¼Œä¸å¯ç¼–è¾‘å…¬å¸]
    B -->|æ˜¯| D{PartnerçŠ¶æ€}
    D -->|pending| E[å¯ç¼–è¾‘ä¸ªäººä¿¡æ¯ + å…¬å¸ä¿¡æ¯]
    D -->|active| F[å¯ç¼–è¾‘ä¸ªäººä¿¡æ¯ï¼Œå…¬å¸ä¿¡æ¯åªè¯»]
    D -->|declined| G[ä»…å¯ç¼–è¾‘ä¸ªäººä¿¡æ¯]
    E --> H[ç”¨æˆ·æäº¤ä¿®æ”¹]
    F --> H
    G --> H
    H --> I{æ˜¯å¦ä¿®æ”¹æ‰‹æœºå·}
    I -->|æ˜¯| J[å‘é€éªŒè¯ç ]
    J --> K{éªŒè¯æ˜¯å¦é€šè¿‡}
    K -->|å¦| L[æç¤ºé”™è¯¯]
    K -->|æ˜¯| M[æ›´æ–°æ‰‹æœºå·]
    I -->|å¦| N[æ£€æŸ¥å…¶ä»–å­—æ®µ]
    M --> N
    N --> O[æ›´æ–°ç”¨æˆ·ä¿¡æ¯]
    O --> P{æ˜¯å¦ä¿®æ”¹å…¬å¸ç¨å·}
    P -->|æ˜¯| Q{æ˜¯å¦ä¸ºactiveå…¬å¸}
    Q -->|æ˜¯| R[æç¤ºä¸å¯ä¿®æ”¹ç¨å·]
    Q -->|å¦| S[å…è®¸ä¿®æ”¹ç¨å·]
    P -->|å¦| T[å®Œæˆæ›´æ–°]
    S --> T
    R --> T
    T --> U[åŒæ­¥æ›´æ–°è‡³Viewç«¯ï¼ˆå¦‚æ¿€æ´»ï¼‰]
```

#### 3.3.2 å½±å“çš„æ•°æ®è¡¨

- Portalç«¯
  - **[users](#table-users)** : Portalç«¯ UseråŸºç¡€ä¿¡æ¯è¡¨ - æ ¡éªŒæ‰‹æœºå·
  - **[companies](#table-companies)** : Portalç«¯ Company åŸºç¡€ä¿¡æ¯è¡¨
  - **[user_company](#table-user_company)** : User&Company å…³è”è¡¨(è®°å½• Partner å½“å‰çŠ¶æ€)
  - **[audit_log](#table-audit_log)** : è®°å½•ç”¨æˆ·ç¼–è¾‘ä¿¡æ¯Log

- Viewç«¯  Portal->View åŒæ­¥è”ç³»å˜æ›´ä¿¡æ¯,  PendingçŠ¶æ€å˜æ›´ Taxcodeæ—¶ åŒæ­¥Flag = 0/1
  - **[mod_channel_partner_companies](#table-mod_channel_partner_companies)** :Viewç«¯ å…¬å¸åŸºç¡€ä¿¡æ¯è¡¨ åŒæ­¥flag
  - **[mod_channel_contract_bindings](#table-mod_channel_contract_bindings)** :Viewç«¯ è”ç³»äººè¡¨ä¸PortalUserå…³è”è¡¨
  - **[contract](#table-contract)** :Viewç«¯ è”ç³»äººè¡¨ä¿¡æ¯è¡¨

#### 3.3.3 å‰ç«¯å®ç°

##### 3.3.3.1 è§†å›¾ç›®å½•ç»“æ„

```plaintext
/src/views/myinfo/
  MyInfoMain.vue               - ä¸ªäººä¿¡æ¯ä¸»é¡µé¢
  
/src/components/myinfo/
  PersonalInfoCard.vue         - ä¸ªäººä¿¡æ¯å¡ç‰‡ç»„ä»¶
  CompanyInfoCard.vue          - å…¬å¸ä¿¡æ¯å¡ç‰‡ç»„ä»¶
```

##### 3.3.3.2 å…³é”®ç»„ä»¶åŠŸèƒ½

- **PersonalInfoCard.vue**
  - ä¸ªäººä¿¡æ¯å±•ç¤ºå’Œç¼–è¾‘å…¥å£
  - å§‹ç»ˆå¯ç¼–è¾‘æ¨¡å¼

- **CompanyInfoCard.vue**
  - å…¬å¸ä¿¡æ¯å±•ç¤º
  - æ ¹æ®ç»‘å®šçŠ¶æ€æ§åˆ¶ç¼–è¾‘æƒé™
  - é›†æˆåªè¯»æ¨¡å¼å±•ç¤º

##### 3.3.3.3 APIè®¾è®¡

| HTTP æ–¹æ³• | ç«¯ç‚¹                          | æè¿°                    |
|-----------|-------------------------------|-------------------------|
| GET       | `/api/myinfo/profile`         | è·å–ç”¨æˆ·å®Œæ•´ä¿¡æ¯ |
| PUT       | `/api/myinfo/update`          | æ›´æ–°ä¸ªäººå’Œå…¬å¸ä¿¡æ¯ |
| GET       | `/api/myinfo/edit-permissions`| è·å–ä¿¡æ¯ç¼–è¾‘æƒé™ |
| POST      | `/api/account/delete`         | ç”¨æˆ·æ³¨é”€è´¦æˆ· |

#### 3.3.4 åŠŸèƒ½å¼€å‘ä¸å®ç°

##### 3.3.4.1 ç±»å…³ç³»å›¾

```mermaid
classDiagram
    class MyInfoController {
        +getUserProfile()
        +updateUserInfo()
        +sendMobileVerificationCode()
    }

    class MyInfoService {
        +getUserProfile(userId)
        +updateUserInfo(userId,personalData,companyData)
        +checkCompanyEditPermission(userId,companyId)
    }

    class UserPermissionService {
        +checkUserCompanyBinding(userId,companyId)
        +getUserCompanyStatus(userId,companyId)
        +switchUserCompany(userId,companyId)
    }

    class SmsVerificationService {
        +sendCode(mobile,scene)
        +verifyCode(mobile,code,scene)
        +isRateLimited(mobile)
    }

    class CompanyService {
        +validateCompanyInfo(companyData)
        +checkTaxcodeExists(taxCode)
    }

    class InterSystemService {
        +pushDataToView(syncData)
        +pullDataFromView(pullRequest)
    }

    class BaseController {
        +successResponse(data,message,code)
        +errorResponse(message,code,errors)
    }

    MyInfoController --> MyInfoService : ä¸šåŠ¡å¤„ç†
    MyInfoController --> SmsVerificationService : çŸ­ä¿¡éªŒè¯
    MyInfoController --> BaseController : å“åº”æ ¼å¼åŒ–

    MyInfoService --> UserPermissionService : æƒé™æ£€æŸ¥
    MyInfoService --> CompanyService : å…¬å¸éªŒè¯
    MyInfoService --> InterSystemService : æ•°æ®åŒæ­¥
```

##### 3.3.4.2 ä»£ç å®ç°

- **MyInfoController.php**
  - **æ–‡ä»¶è·¯å¾„**:`packages/MyInfo/src/Controllers/MyInfoController.php`
  - **æ–‡ä»¶çŠ¶æ€**:æ–°å¢
  - **æ–¹æ³•**:
    - **getUserProfile()**  
      - **åŠŸèƒ½æè¿°**:è·å–å½“å‰ç™»å½•ç”¨æˆ·çš„å®Œæ•´ä¸ªäººä¿¡æ¯å’Œå…¬å¸ä¿¡æ¯ï¼ŒåŒ…å«ç¼–è¾‘æƒé™çŠ¶æ€ã€‚
      - **æ–¹æ³•çŠ¶æ€**:æ–°å¢  
      - **è°ƒç”¨é¡ºåº**:ç”¨æˆ·è¿›å…¥ä¸ªäººä¿¡æ¯é¡µé¢æ—¶è°ƒç”¨  
      - **ä¾èµ–æœåŠ¡**:
        - `MyInfoService::getUserProfile($userId)`
        - `auth('sanctum')->user()`
        - `Log::channel('business')->info()`
      - **è¯·æ±‚å‚æ•°**:æ— 
      - **å“åº”æ•°æ®**:  

        | å‚æ•°åç§° | æ•°æ®ç±»å‹ | æè¿°                  |
        |----------|----------|-----------------------|
        | success  | Boolean  | æ˜¯å¦è·å–æˆåŠŸ           |
        | userInfo | Object   | ç”¨æˆ·ä¸ªäººä¿¡æ¯           |
        | companyInfo | Object | å…³è”å…¬å¸ä¿¡æ¯ï¼ˆå¦‚æœ‰ï¼‰   |
        | editPermissions | Object | å­—æ®µç¼–è¾‘æƒé™       |
        | bindingStatus | String | å…¬å¸ç»‘å®šçŠ¶æ€ï¼ˆactive/inactive/noneï¼‰|
        | canEditCompany | Boolean | æ˜¯å¦å¯ç¼–è¾‘å…¬å¸ä¿¡æ¯   |

    - **updateUserInfo(UpdateUserInfoRequest $request)**
      - **åŠŸèƒ½æè¿°**:ç»Ÿä¸€æ›´æ–°ç”¨æˆ·ä¸ªäººä¿¡æ¯å’Œå…¬å¸ä¿¡æ¯ï¼Œæ‰‹æœºå·ä¿®æ”¹éœ€è¦éªŒè¯ç ç¡®è®¤ï¼Œæ ¹æ®ç»‘å®šçŠ¶æ€æ§åˆ¶å…¬å¸ä¿¡æ¯çš„ä¿®æ”¹ã€‚
      - **æ–¹æ³•çŠ¶æ€**:æ–°å¢  
      - **è°ƒç”¨é¡ºåº**:ç”¨æˆ·æäº¤ä¿¡æ¯ä¿®æ”¹æ—¶è°ƒç”¨  
      - **ä¾èµ–æœåŠ¡**:
        - `MyInfoService::updateUserInfo($userId, $personalData, $companyData)`
        - `SmsVerificationService::verifyCode($mobile, $code, 'change_mobile')`
        - `auth('sanctum')->user()`
        - `Log::channel('business')->info()`
      - **è¯·æ±‚å‚æ•°**:ä½¿ç”¨UpdateUserInfoRequestè¿›è¡ŒéªŒè¯

      - **å“åº”æ•°æ®**:  

        | å‚æ•°åç§° | æ•°æ®ç±»å‹ | æè¿°                  |
        |----------|----------|-----------------------|
        | success  | Boolean  | æ˜¯å¦æ›´æ–°æˆåŠŸ           |
        | updatedPersonalFields | Array | å®é™…æ›´æ–°çš„ä¸ªäººå­—æ®µ |
        | updatedCompanyFields | Array | å®é™…æ›´æ–°çš„å…¬å¸å­—æ®µ   |
        | userInfo | Object   | æ›´æ–°åçš„ç”¨æˆ·ä¿¡æ¯       |
        | companyInfo | Object | æ›´æ–°åçš„å…¬å¸ä¿¡æ¯     |
        | message  | String   | æ“ä½œç»“æœæç¤º           |

    - **sendMobileVerificationCode()**
      - **åŠŸèƒ½æè¿°**:å‘é€æ‰‹æœºå·ä¿®æ”¹éªŒè¯ç åˆ°æ–°æ‰‹æœºå·ã€‚
      - **æ–¹æ³•çŠ¶æ€**:æ–°å¢  
      - **è°ƒç”¨é¡ºåº**:ç”¨æˆ·è¾“å…¥æ–°æ‰‹æœºå·å¹¶ç”³è¯·ä¿®æ”¹æ—¶è°ƒç”¨  
      - **ä¾èµ–æœåŠ¡**:
        - `SmsVerificationService::sendCode($newmMobile, 'change_mobile')`
        - `SmsVerificationService::isRateLimited($newmMobile)`
        - `User::where('mobile', $newmMobile)->exists()`
        - `Log::channel('business')->info()`
      - **è¯·æ±‚å‚æ•°**:  

        | å‚æ•°åç§°  | æ•°æ®ç±»å‹ | æ˜¯å¦å¿…å¡« | æè¿°             |
        |-----------|----------|----------|------------------|
        | newmMobile  | String   | æ˜¯       | æ–°æ‰‹æœºå·         |

      - **å“åº”æ•°æ®**:  

        | å‚æ•°åç§° | æ•°æ®ç±»å‹ | æè¿°                  |
        |----------|----------|-----------------------|
        | success  | Boolean  | æ˜¯å¦å‘é€æˆåŠŸ           |
        | message  | String   | æç¤ºä¿¡æ¯               |
        | expireTime | Integer | éªŒè¯ç æœ‰æ•ˆæœŸ(ç§’)       |
        | maskedMobile | String | è„±æ•åçš„æ‰‹æœºå·       |

- **MyInfoService.php**
  - **æ–‡ä»¶è·¯å¾„**:`packages/MyInfo/src/Services/MyInfoService.php`
  - **æ–‡ä»¶çŠ¶æ€**:æ–°å¢
  - **æ–¹æ³•**:

    - **getUserProfile($userId)**
      - **åŠŸèƒ½æè¿°**:è·å–ç”¨æˆ·å®Œæ•´æ¡£æ¡ˆä¿¡æ¯ï¼ŒåŒ…æ‹¬ä¸ªäººä¿¡æ¯ã€å…¬å¸ä¿¡æ¯å’Œç¼–è¾‘æƒé™
      - **æ–¹æ³•çŠ¶æ€**:æ–°å¢
      - **è¿”å›æ•°æ®**:ç”¨æˆ·æ¡£æ¡ˆå¯¹è±¡å’Œæƒé™ä¿¡æ¯

    - **updateUserInfo($userId, $personalData, $companyData)**
      - **åŠŸèƒ½æè¿°**:ç»Ÿä¸€å¤„ç†ç”¨æˆ·ä¸ªäººä¿¡æ¯å’Œå…¬å¸ä¿¡æ¯æ›´æ–°ï¼Œæƒé™éªŒè¯å’Œå†å²è®°å½•
      - **æ–¹æ³•çŠ¶æ€**:æ–°å¢
      - **è¿”å›æ•°æ®**:æ›´æ–°ç»“æœå’Œå˜æ›´è¯¦æƒ…

    - **checkCompanyEditPermission($userId, $companyId)**
      - **åŠŸèƒ½æè¿°**:æ£€æŸ¥ç”¨æˆ·æ˜¯å¦æœ‰æƒé™ç¼–è¾‘ç‰¹å®šå…¬å¸ä¿¡æ¯
      - **æ–¹æ³•çŠ¶æ€**:æ–°å¢
      - **è¿”å›æ•°æ®**:Booleanæƒé™ç»“æœ

- **AccountManageService.php**
  - **æ–‡ä»¶è·¯å¾„**:`packages/MyInfo/src/Services/AccountManageService.php`
  - **æ–‡ä»¶çŠ¶æ€**:æ–°å¢
  - **æ–¹æ³•**:

    - **deleteAccount($userId, $reason)**
      - **åŠŸèƒ½æè¿°**:å¤„ç†ç”¨æˆ·è´¦æˆ·æ³¨é”€çš„ä¸šåŠ¡é€»è¾‘ï¼Œæ‰§è¡Œè½¯åˆ é™¤å¹¶è®°å½•å®Œæ•´å˜æ›´å†å²
      - **æ–¹æ³•çŠ¶æ€**:æ–°å¢
      - **è¿”å›æ•°æ®**:æ³¨é”€ç»“æœå’Œå†å²è®°å½•ä¿¡æ¯

    - **unbindAllCompanies($userId)**
      - **åŠŸèƒ½æè¿°**:è§£ç»‘ç”¨æˆ·æ‰€æœ‰å…¬å¸å…³è”å…³ç³»ï¼Œæ›´æ–°user_companyè¡¨çŠ¶æ€
      - **æ–¹æ³•çŠ¶æ€**:æ–°å¢
      - **è¿”å›æ•°æ®**:è§£ç»‘çš„å…¬å¸åˆ—è¡¨å’Œæ•°é‡

    - **validateDeletePermission($userId)**
      - **åŠŸèƒ½æè¿°**:éªŒè¯ç”¨æˆ·æ³¨é”€ï¼Œæ£€æŸ¥è´¦æˆ·çŠ¶æ€å’Œèº«ä»½éªŒè¯
      - **æ–¹æ³•çŠ¶æ€**:æ–°å¢
      - **è¿”å›æ•°æ®**:Booleanæƒé™ç»“æœ

### 3.4 Inquiry æ¨¡å—

#### 3.4.1 ä¸šåŠ¡æµç¨‹

##### 3.4.1.1 ä¸šåŠ¡èƒŒæ™¯

- **èƒŒæ™¯**:Partnerå¯ä»¥å‘èµ·æŠ€æœ¯å’¨è¯¢, å¡«å†™å’¨è¯¢åç”±é”€å”®è¿›è¡Œå›å¤, é”€å”®å›å¤åå¯ä»¥è¿›è¡Œè¯„ä»·ã€‚

- **ä¸»è¦æµç¨‹**:

  - **é—®è¯¢åˆ—è¡¨ æ•°æ®å±•ç¤ºé€»è¾‘**
    - **Partner(active)**:å¯æŸ¥çœ‹å…¬å¸å†…æ‰€æœ‰é—®è¯¢è®°å½•
    - **Partner(pending)**:åªèƒ½æŸ¥çœ‹ä¸ªäººåˆ›å»ºçš„é—®è¯¢ï¼Œactiveæ—¶, æ•°æ®æ¥æºéƒ½æ˜¯ VIEW,ä¸ä¼šå†ä»Portalç«¯è·å–æ•°æ®
    - æ•°æ®å­˜å‚¨ç­–ç•¥:æœªæ¿€æ´»å­˜Portalç«¯ï¼Œæ¿€æ´»ååŒæ­¥/åç»­å­˜å‚¨éƒ½åœ¨VIEWç«¯ï¼ŒPortalç«¯æ•°æ®å®šæ—¶è„šæœ¬æ¸…ç†
    - æ˜¾ç¤ºèŒƒå›´:è¿‡å»12ä¸ªæœˆè®°å½•ï¼ŒæŒ‰æ—¶é—´é™åº
    - å¯ä»¥ç­›é€‰ å¹¶æŸ¥çœ‹åŒå…¬å¸ä¸‹å…¶å®ƒè”ç³»äººçš„ é—®è¯¢,ä½†æ˜¯ä¸èƒ½è¯„ä»·

  - **å‘èµ·é—®è¯¢**
    - ç”¨æˆ·é€‰æ‹©é—®é¢˜åˆ†ç±»ï¼ˆåå°é…ç½®çš„åˆ†ç±»åˆ—è¡¨ï¼‰
    - å¡«å†™å…·ä½“é—®é¢˜å†…å®¹å’Œæè¿°
    - ç³»ç»Ÿåˆ›å»ºé—®è¯¢è®°å½•ï¼ŒçŠ¶æ€ä¸ºOpen
    ![alt text](<035 - Inquiry - New  - Mobile.png>)

  - **Openåˆ—è¡¨**:å·²æé—®ä½†æœªå›å¤
    ![alt text](<036 - Inquiry - Open  - Mobile.png>)

  - **Ratingåˆ—è¡¨**:é”€å”®å·²å›å¤å¾…è¯„ä»·ï¼ˆé»˜è®¤è¿›å…¥ï¼‰
    - é”€å”®äººå‘˜å›å¤é—®é¢˜ï¼ŒçŠ¶æ€å˜æ›´ä¸ºRating
    - ç”¨æˆ·æ”¶åˆ°å›å¤é€šçŸ¥ï¼Œè¿›è¡Œ1-5æ˜Ÿè¯„ä»·
    - è¯„ä»·å®ŒæˆåçŠ¶æ€å˜æ›´ä¸ºClosed(æˆ–è€…30å¤©æœªå¤„ç† è‡ªåŠ¨å…³é—­)
    ![alt text](<034 - Inquiry - Rating  - Mobile.png>)

  - **Closedåˆ—è¡¨**:å·²è¯„ä»·å®Œæˆæˆ–è‡ªåŠ¨å…³é—­(åŒ…å« 30å¤©æœªè¯„ä»·)
    ![alt text](<037 - Inquiry - Closed  - Mobile.png>)

  - **é‚®ä»¶é€šçŸ¥é˜¶æ®µ**:
    - ä¼˜å…ˆæ ¹æ®sceneå‚æ•°æŸ¥æ‰¾ç»‘å®šçš„é”€å”®ID
    - æ— é”€å”®IDç»‘å®šæ—¶ï¼Œæ ¹æ®MainOperatingCitiesæŸ¥æ‰¾å¯¹åº”çš„Branch Manager é»˜è®¤ç¬¬ä¸€ä¸ª
    - <mark style="background-color: #ffeb3b; color: #d32f2f;">**[å¾…å®š]** å‘é€é‚®ä»¶ç»™Salesæˆ–Branch managerï¼ˆé‚®ä»¶å†…å®¹å¾…å®šï¼‰</mark>

- **å¼‚å¸¸æµç¨‹**:  
  - åˆ›å»ºé—®è¯¢å¤±è´¥ â†’ å…è®¸é‡æ–°åˆ›å»º
  - è¯„ä»·æäº¤å¤±è´¥ â†’ å…è®¸é‡æ–°è¯„ä»·

- **æµç¨‹å›¾**:

```mermaid
flowchart TD
    A[ç”¨æˆ·å‘èµ·å’¨è¯¢] --> B{ç”¨æˆ·çŠ¶æ€}
    B -->|active| C[æ¨é€è‡³Viewç«¯inquiriesè¡¨]
    B -->|pending| D[å­˜å‚¨åœ¨Portalç«¯æœ¬åœ°]
    C --> E[é€šçŸ¥é”€å”®ï¼ˆé‚®ä»¶ï¼‰]
    D --> E
    E --> F[é”€å”®æŸ¥çœ‹å’¨è¯¢]
    F --> G{æ˜¯å¦å›å¤}
    G -->|æ˜¯| H[é”€å”®è¾“å…¥å›å¤å†…å®¹]
    H --> I{ç”¨æˆ·æ˜¯å¦ä¸ºactive}
    I -->|æ˜¯| J[æ›´æ–°Viewç«¯inquiriesè¡¨]
    I -->|å¦| K[è°ƒç”¨Portal APIå›å¤]
    J --> L[çŠ¶æ€å˜ä¸ºratingï¼Œè®¾ç½®30å¤©æœŸé™]
    K --> L
    L --> M[ç”¨æˆ·æ”¶åˆ°å¾®ä¿¡é€šçŸ¥]
    M --> N{ç”¨æˆ·æ˜¯å¦è¯„ä»·}
    N -->|æ˜¯| O[ç”¨æˆ·æäº¤1-5æ˜Ÿè¯„ä»·]
    O --> P[æ›´æ–°Viewç«¯Ratingå­—æ®µ]
    N -->|å¦| Q{æ˜¯å¦è¶…è¿‡30å¤©}
    Q -->|æ˜¯| R[è‡ªåŠ¨å…³é—­ï¼ŒçŠ¶æ€å˜ä¸ºclosed]
    Q -->|å¦| S[ä¿æŒratingçŠ¶æ€]
```

#### 3.4.2 å½±å“çš„æ•°æ®è¡¨

- Portaç«¯
  - **[users](#table-users)** : Portalç«¯ UseråŸºç¡€ä¿¡æ¯è¡¨
  - **[companies](#table-companies)** : Portalç«¯ Company åŸºç¡€ä¿¡æ¯è¡¨
  - **[user_company](#table-user_company)** : User&Company å…³è”è¡¨(è®°å½• Partner å½“å‰çŠ¶æ€)
  - **[inquiries](#table-inquiries)** : å­˜å‚¨é—®è¯¢è®°å½•
  - **[inquiry_ratings](#table-inquiry_ratings)** : å­˜å‚¨é—®è¯¢è¯„åˆ†è¯¦æƒ…
  - **[user_company_assignment](#table-user_company_assignment)** : Portalç«¯ Partner å…³è” é”€å”®è¡¨
  - **[general_options](#table-general_options)** : åŸºç¡€é…ç½®è¡¨

- Viewç«¯
  - **[mod_channel_inquiries](#table-mod_channel_inquiries)** : Viewç«¯ è®°å½•å’¨è¯¢ä¿¡æ¯
  - **[mod_channel_inquiry_ratings](#table-inquiry_ratings)** : Viewç«¯ è®°å½•å’¨è¯¢è¯„ä»·
  - **[customer_employee](#table-customer_employee)** :Viewç«¯Customer å…³è”é”€å”®è¡¨

#### 3.4.3 å‰ç«¯å®ç°

##### 3.4.3.1 è§†å›¾ç›®å½•ç»“æ„

```plaintext
/src/views/inquiry/
  InquiryMain.vue              - é—®è¯¢ä¸»é¡µé¢
  CreateInquiry.vue            - å‘èµ·é—®è¯¢é¡µé¢

/src/components/inquiry/
  InquiryList.vue              - é—®è¯¢åˆ—è¡¨ç»„ä»¶
  InquiryCard.vue              - é—®è¯¢å¡ç‰‡ç»„ä»¶
  RatingModal.vue              - è¯„ä»·ç»„ä»¶
```

##### 3.4.3.2 å…³é”®ç»„ä»¶åŠŸèƒ½

- **InquiryMain.vue**
  - 4ä¸ªçŠ¶æ€æ ‡ç­¾é¡µ:Rating(é»˜è®¤)ã€Openã€Closedã€All
  - é›†æˆé—®è¯¢åˆ—è¡¨å’Œåˆ›å»ºå…¥å£
  - æƒé™çŠ¶æ€æ£€æŸ¥å’Œæ•°æ®è¿‡æ»¤

- **InquiryList.vue**
  - é—®è¯¢åˆ—è¡¨å±•ç¤ºï¼Œæ”¯æŒåˆ†é¡µåŠ è½½
  - æ ¹æ®ç”¨æˆ·æƒé™è¿‡æ»¤æ•°æ®ï¼ˆä¸ªäºº/å…¬å¸ï¼‰
  - è¿‡å»12ä¸ªæœˆæ•°æ®ï¼ŒæŒ‰æ—¶é—´é™åº

- **RatingModal.vue**
  - 1-5æ˜Ÿè¯„ä»·ç»„ä»¶
  - è¯„ä»·æäº¤å’ŒçŠ¶æ€æ›´æ–°

##### 3.4.3.3 APIè®¾è®¡

| HTTP æ–¹æ³• | ç«¯ç‚¹                          | æè¿°                    |
|-----------|-------------------------------|-------------------------|
| GET       | `/api/inquiry`                | è·å–é—®è¯¢åˆ—è¡¨(æ”¯æŒçŠ¶æ€ç­›é€‰) |
| POST      | `/api/inquiry`                | å‘èµ·æ–°é—®è¯¢ |
| POST      | `/api/inquiry/{id}/rating`    | æäº¤è¯„ä»· |
| GET       | `/api/inquiry/categories`     | è·å–é—®é¢˜åˆ†ç±» |

#### 3.4.4 åŠŸèƒ½å¼€å‘ä¸å®ç°

##### 3.4.4.1 ç±»å…³ç³»å›¾

##### 3.4.4.2 ä»£ç å®ç°

- **InquiryController.php**
  - **æ–‡ä»¶è·¯å¾„**:`packages/Inquiry/src/Controllers/InquiryController.php`
  - **æ–‡ä»¶çŠ¶æ€**:æ–°å¢
  - **æ–¹æ³•**:
    - **index()**
      - **åŠŸèƒ½æè¿°**:æ˜¾ç¤ºå’¨è¯¢åˆ—è¡¨é¡µé¢ï¼Œæ ¹æ®ç”¨æˆ·æƒé™è¿‡æ»¤æ•°æ®ã€‚Activeç”¨æˆ·å’¨è¯¢ä»Viewç«¯inquiriesè¡¨æŸ¥è¯¢ï¼Œinactiveç”¨æˆ·å’¨è¯¢é€šè¿‡Portal APIè·å–ï¼Œæœ€ååˆå¹¶å±•ç¤ºã€‚ä»…æ˜¾ç¤ºæœ€è¿‘12ä¸ªæœˆæ•°æ®ï¼Œé»˜è®¤æ˜¾ç¤ºOpençŠ¶æ€ã€‚
      - **æ–¹æ³•çŠ¶æ€**:æ–°å¢
      - **ä¾èµ–æœåŠ¡**:InquiryService, InquiryStatsService
      - **è¯·æ±‚å‚æ•°**:

        | å‚æ•°åç§° | æ•°æ®ç±»å‹ | æ˜¯å¦å¿…å¡« | æè¿° |
        |----------|----------|----------|------|
        | status | String | å¦ | çŠ¶æ€ç­›é€‰(open/rating/closed/all)ï¼Œé»˜è®¤open |
        | sales | String | å¦ | é”€å”®äººå‘˜ç­›é€‰ |
        | partner | String | å¦ | æ¸ é“å•†ç­›é€‰ |
        | category | String | å¦ | åˆ†ç±»ç­›é€‰ |
        | createDate | String | å¦ | åˆ›å»ºæ—¥æœŸç­›é€‰ |
        | page | Integer | å¦ | é¡µç ï¼Œé»˜è®¤1 |
        | perPage | Integer | å¦ | æ¯é¡µæ¡æ•°ï¼Œé»˜è®¤15 |

      - **å“åº”æ•°æ®**:

        | å‚æ•°åç§° | æ•°æ®ç±»å‹ | æè¿° |
        |----------|----------|------|
        | inquiries | Array | å’¨è¯¢åˆ—è¡¨ï¼ˆåˆå¹¶Activeå’ŒInactiveæ•°æ®ï¼‰ |
        | pagination | Object | åˆ†é¡µä¿¡æ¯ {current_page, total_pages, total_count} |
        | filterOptions | Object | ç­›é€‰æ¡ä»¶é€‰é¡¹ {sales_list, category_list} |
        | statusCounts | Object | å„çŠ¶æ€å’¨è¯¢æ•°é‡ {open, rating, closed, all} |
        | defaultStatus | String | é»˜è®¤çŠ¶æ€ï¼ˆopenï¼‰ |
        | portalDataStatus | String | Portalæ•°æ®è·å–çŠ¶æ€ (success/failed/partial) |

    - **reply()**
      - **åŠŸèƒ½æè¿°**:å¤„ç†å’¨è¯¢å›å¤ï¼Œå®ç°ç‹¬å æœºåˆ¶ã€‚Activeç”¨æˆ·å’¨è¯¢å­˜å‚¨å›å¤åˆ°Viewç«¯inquiriesè¡¨çš„SalesReplyå­—æ®µï¼Œinactiveç”¨æˆ·å’¨è¯¢é€šè¿‡APIæ“ä½œPortalç«¯ã€‚å›å¤åå…¶ä»–é”€å”®æ— æ³•æŸ¥çœ‹ï¼ŒçŠ¶æ€å˜ä¸ºRatingï¼Œè®¾ç½®RatingDeadlineä¸º30å¤©åã€‚
      - **æ–¹æ³•çŠ¶æ€**:æ–°å¢
      - **ä¾èµ–æœåŠ¡**:InquiryService
      - **è¯·æ±‚å‚æ•°**:

        | å‚æ•°åç§° | æ•°æ®ç±»å‹ | æ˜¯å¦å¿…å¡« | æè¿° |
        |----------|----------|----------|------|
        | inquiryId | Integer | æ˜¯ | å’¨è¯¢ID |
        | replyContent | String | æ˜¯ | å›å¤å†…å®¹ |
        | registerChannel | Boolean | å¦ | æ˜¯å¦ä¸ºPortalç«¯æ•°æ® |
        | portalInquiryId | Integer | å¦ | Portalç«¯å’¨è¯¢ID |

      - **å“åº”æ•°æ®**:

        | å‚æ•°åç§° | æ•°æ®ç±»å‹ | æè¿° |
        |----------|----------|------|
        | success | Boolean | å›å¤æ˜¯å¦æˆåŠŸ |
        | inquiryStatus | String | æ›´æ–°åå’¨è¯¢çŠ¶æ€ï¼ˆratingï¼‰ |
        | exclusiveLocked | Boolean | æ˜¯å¦è·å¾—ç‹¬å é” |
        | ratingDeadline | String | è¯„ä»·æˆªæ­¢æ—¶é—´ |
        | message | String | æ“ä½œç»“æœä¿¡æ¯ |
        | registerChannel | String | æ•°æ®æ¥æº(view/portal) |

    - **getStats()**
      - **åŠŸèƒ½æè¿°**:è·å–å’¨è¯¢ç»Ÿè®¡æ•°æ®ï¼Œæ ¹æ®æƒé™è¿”å›ä¸åŒè¯¦ç»†ç¨‹åº¦çš„ç»Ÿè®¡ä¿¡æ¯ã€‚ä»…ç»Ÿè®¡Viewç«¯inquiriesè¡¨ä¸­çš„Activeç”¨æˆ·æ•°æ®ã€‚
      - **æ–¹æ³•çŠ¶æ€**:æ–°å¢
      - **ä¾èµ–æœåŠ¡**:InquiryStatsService
      - **è¯·æ±‚å‚æ•°**:

        | å‚æ•°åç§° | æ•°æ®ç±»å‹ | æ˜¯å¦å¿…å¡« | æè¿° |
        |----------|----------|----------|------|
        | statsType | String | å¦ | ç»Ÿè®¡ç±»å‹(country/branch/sales)ï¼Œé»˜è®¤sales |
        | dateRange | String | å¦ | æ—¥æœŸèŒƒå›´(last_year) |
        | salesFilter | String | å¦ | é”€å”®äººå‘˜ç­›é€‰ |

      - **å“åº”æ•°æ®**:

        | å‚æ•°åç§° | æ•°æ®ç±»å‹ | æè¿° |
        |----------|----------|------|
        | stats | Object | ç»Ÿè®¡æ•°æ® |
        | averages | Object | å¹³å‡è¯„åˆ† {professional, timeliness, satisfaction, overall}ï¼ˆä»…æŸ¥çœ‹å…¨éƒ¨æƒé™ï¼‰ |
        | showRatings | Boolean | æ˜¯å¦æ˜¾ç¤ºè¯„åˆ†ï¼ˆåŸºäºæƒé™ï¼‰ |
        | permissionLevel | String | ç”¨æˆ·æƒé™çº§åˆ«(view/view_all) |
        | totalInquiries | Integer | æ€»å’¨è¯¢æ•° |
        | ratingDistribution | Object | è¯„åˆ†åˆ†å¸ƒï¼ˆä»…æŸ¥çœ‹å…¨éƒ¨æƒé™ï¼‰ |

- **InquiryService.php**
  - **æ–‡ä»¶è·¯å¾„**:`packages/Inquiry/src/Services/InquiryService.php`
  - **æ–‡ä»¶çŠ¶æ€**:æ–°å¢
  - **æ–¹æ³•**:
    - **getInquiriesWithPermission($userId, $filters, $pagination)**
      - **åŠŸèƒ½æè¿°**:æ ¹æ®ç”¨æˆ·æƒé™è·å–å’¨è¯¢åˆ—è¡¨ã€‚æŸ¥è¯¢Viewç«¯inquiriesè¡¨è·å–Activeç”¨æˆ·å’¨è¯¢ï¼Œè°ƒç”¨Portal APIè·å–inactiveç”¨æˆ·å’¨è¯¢ï¼Œæœ€ååˆå¹¶è¿”å›ã€‚Salesåªèƒ½çœ‹è‡ªå·±çš„ï¼ŒSalesManagerèƒ½çœ‹æ‰€æœ‰ã€‚è§£æJSONå­—æ®µç”¨äºå±•ç¤ºã€‚
      - **æ–¹æ³•çŠ¶æ€**:æ–°å¢
      - **å¤„ç†æµç¨‹**:
            1. æ£€æŸ¥ç”¨æˆ·æƒé™ï¼ˆview/view_allï¼‰
            2. æŸ¥è¯¢inquiriesè¡¨ï¼Œè¿‡æ»¤æœ€è¿‘12ä¸ªæœˆæ•°æ®
            3. è§£æAssignedSales
            4. è°ƒç”¨Portal APIè·å–inactiveç”¨æˆ·æ•°æ®
            5. åˆå¹¶ä¸¤éƒ¨åˆ†æ•°æ®å¹¶åˆ†é¡µ
            6. è§£æRatingç”¨äºåˆ—è¡¨å±•ç¤º
      - **è¿”å›æ•°æ®**:æƒé™è¿‡æ»¤åçš„å’¨è¯¢åˆ—è¡¨ï¼ˆåˆå¹¶æ•°æ®ï¼‰

    - **getActiveUserInquiries($userId, $filters)**
      - **åŠŸèƒ½æè¿°**:ä»Viewç«¯inquiriesè¡¨æŸ¥è¯¢Activeç”¨æˆ·çš„å’¨è¯¢æ•°æ®ï¼Œè§£æJSONå­—æ®µ
      - **æ–¹æ³•çŠ¶æ€**:æ–°å¢
      - **è¿”å›æ•°æ®**:Activeç”¨æˆ·å’¨è¯¢åˆ—è¡¨

    - **getInactiveUserInquiries($userId)**
      - **åŠŸèƒ½æè¿°**:è°ƒç”¨Portal APIè·å–inactiveç”¨æˆ·çš„å’¨è¯¢æ•°æ®
      - **æ–¹æ³•çŠ¶æ€**:æ–°å¢
      - **è¿”å›æ•°æ®**:Inactiveç”¨æˆ·å’¨è¯¢åˆ—è¡¨

    - **replyToActiveInquiry($inquiryId, $userId, $replyContent)**
      - **åŠŸèƒ½æè¿°**:å›å¤Activeç”¨æˆ·å’¨è¯¢ï¼Œå­˜å‚¨å›å¤åˆ°Viewç«¯inquiriesè¡¨çš„SalesReplyå­—æ®µï¼Œå®ç°ç‹¬å æœºåˆ¶ï¼Œæ›´æ–°çŠ¶æ€ä¸ºRatingï¼Œè®¾ç½®RatingDeadlineä¸º30å¤©å
      - **æ–¹æ³•çŠ¶æ€**:æ–°å¢
      - **å¤„ç†æµç¨‹**:
          1. æ£€æŸ¥å’¨è¯¢æ˜¯å¦ä»ä¸ºOpençŠ¶æ€
          2. è®¾ç½®ç‹¬å é”ï¼Œæ›´æ–°RepliedByå’ŒRepliedNameå­—æ®µ
          3. æ›´æ–°SalesReplyå­—æ®µå­˜å‚¨å›å¤å†…å®¹
          4. æ›´æ–°Statusä¸º'rating'ï¼Œè®¾ç½®RatingDeadlineï¼ˆå½“å‰æ—¶é—´+30å¤©ï¼‰
          5. æ›´æ–°LastModifiedDate
          6. å¯¹å…¶ä»–é”€å”®éšè—è¯¥å’¨è¯¢
          7. è°ƒç”¨Portal APIé€šçŸ¥ç”¨æˆ·ï¼ˆå‘é€å¾®ä¿¡æ¶ˆæ¯ï¼‰
      - **è¿”å›æ•°æ®**:å›å¤ç»“æœå’ŒçŠ¶æ€

    - **replyToInactiveInquiry($userId, $replyContent)**
      - **åŠŸèƒ½æè¿°**:å›å¤Inactiveç”¨æˆ·å’¨è¯¢ï¼Œé€šè¿‡Portal APIæ“ä½œPortalç«¯æ•°æ®ï¼Œè®¾ç½®è¯„ä»·æˆªæ­¢æ—¶é—´
      - **æ–¹æ³•çŠ¶æ€**:æ–°å¢
      - **å¤„ç†æµç¨‹**:
          1. è°ƒç”¨Portal APIå‘é€å›å¤
          2. Portalç«¯æ›´æ–°çŠ¶æ€ä¸ºRating
          3. Portalç«¯è®¾ç½®30å¤©è¯„ä»·æœŸé™
          4. Portalç«¯è§¦å‘å¾®ä¿¡é€šçŸ¥
      - **è¿”å›æ•°æ®**:å›å¤ç»“æœ

    - **processAutoClose()**
      - **åŠŸèƒ½æè¿°**:å®šæ—¶ä»»åŠ¡å¤„ç†å’¨è¯¢è‡ªåŠ¨å…³é—­ï¼Œä»…å¤„ç†Viewç«¯inquiriesè¡¨ä¸­çš„æ•°æ®
      - **æ–¹æ³•çŠ¶æ€**:æ–°å¢
      - **å¤„ç†æµç¨‹**:
          1. æ‰«æç”¨æˆ·30å¤©æœªè¯„ä»·çš„RatingçŠ¶æ€å’¨è¯¢ï¼ˆRatingDeadline < NOW()ï¼‰
          2. æ‰¹é‡æ›´æ–°Statusä¸º'closed'ï¼Œè®¾ç½®AutoClosed=1
          3. è®¾ç½®ClosedDateä¸ºå½“å‰æ—¶é—´
          4. è®°å½•è‡ªåŠ¨å…³é—­æ—¥å¿—
      - **è¿”å›æ•°æ®**:å¤„ç†çš„å’¨è¯¢æ•°é‡ç»Ÿè®¡

    - **syncInquiriesFromPortal($userId, $portalData)**
      - **åŠŸèƒ½æè¿°**:ç”¨æˆ·æ¿€æ´»æ—¶å°†Portalç«¯æ‰€æœ‰å’¨è¯¢æ•°æ®åŒæ­¥åˆ°Viewç«¯inquiriesè¡¨å­˜å‚¨ï¼Œå°†Portalç«¯çš„æ•°ç»„æ•°æ®è½¬æ¢ä¸ºJSONæ ¼å¼
      - **æ–¹æ³•çŠ¶æ€**:æ–°å¢
      - **å¤„ç†æµç¨‹**:
          1. éªŒè¯Portalå’¨è¯¢æ•°æ®å®Œæ•´æ€§
          2. è½¬æ¢AssignedSales é€—å·åˆ†å‰²
          3. å¤„ç†å¤±è´¥é¡¹è®°å½•é”™è¯¯æ—¥å¿—
      - **è¿”å›æ•°æ®**:åŒæ­¥ç»“æœç»Ÿè®¡

### 3.5 Projectæ¨¡å—

#### 3.5.1 ä¸šåŠ¡æµç¨‹

##### 3.5.1.1 ä¸šåŠ¡èƒŒæ™¯

- **èƒŒæ™¯**:Partnerå¯ä»¥è‡ªè¡Œåˆ›å»ºé¡¹ç›®,ä¹Ÿå¯ä»¥æ¥å—æ‹’ç»ç”±ç³»ç»Ÿåˆ†é…çš„é¡¹ç›®ã€‚

- **ä¸»è¦æµç¨‹**:

  - **æ·»åŠ /ç¼–è¾‘é¡¹ç›®**
    - ç”¨æˆ·è‡ªä¸»åˆ›å»ºé¡¹ç›®ï¼Œå¡«å†™é¡¹ç›®åŸºæœ¬ä¿¡æ¯
    - ç³»ç»ŸéªŒè¯é¡¹ç›®åç§°é‡å¤æ€§
    - é¡¹ç›®é»˜è®¤çŠ¶æ€ä¸ºPre-Lead
    - é¡¹ç›®çŠ¶æ€ä¸å¯ç¼–è¾‘
    ![alt text](<042 - Project List - New Project  - Mobile.png>)
    ![alt text](<043 - Project List - Edit Project  - Mobile.png>)

  - **ongoingåˆ—è¡¨**
    - Partnerè‡ªå·±åˆ›å»ºçš„é¡¹ç›® Pendingæ—¶ ä»…èƒ½çœ‹åˆ°è‡ªå·±, Activeåå¯ä»¥çœ‹åˆ° Companyä¸‹æ‰€æœ‰
    ![alt text](<040 - Project List - Ongoing  - Mobile â€“ 1.png>)

  - **tkeåˆ†é…é¡¹ç›®åˆ—è¡¨**
    - Partner çŠ¶æ€ Activeå, å¯ä»¥æ“ä½œViewç«¯ åˆ†é…çš„é¡¹ç›® æ¥å—/æ‹’ç»
    - å¯ä»¥æŸ¥çœ‹è¯¦æƒ… ä½†æ˜¯ä¸èƒ½ç¼–è¾‘, æ¥æ”¶å è¿›å…¥ongoingåˆ—è¡¨
    - 24å°æ—¶å†…ä¸å¤„ç†, åˆ™æ ‡è®°å–æ¶ˆçŠ¶æ€
    ![alt text](<038 - Project List - TKE  - Mobile-1.png>)
    ![alt text](<039 - Project List - Edit Project  - Mobile.png>)

  - **All**
    ![alt text](<041 - Project List - Transferred  - Mobile-1.png>)

  - **é¡¹ç›®åˆ†é…é€»è¾‘**
    - é¡¹ç›®åˆ†é…åŸºäº**Companyç»´åº¦**, ä¸ä¼šç›´æ¥ç»‘å®šPortal User
    - é¡¹ç›®åˆ†é…ç»™Companyå, active Portal User ç«‹å³å¯è§ å¹¶æ“ä½œ
    - åˆ†é…é¡¹ç›®å, æ¨é€ wechatæ¶ˆæ¯
    - æ¥å—/æ‹’ç»/24å°æ—¶è¿‡æœŸ å éƒ½ä¼šç»™ Viewç«¯é”€å”® æ¨é€é‚®ä»¶
    - 24å°æ—¶è¿‡æœŸé¡¹ç›®, ä¸ä¼šåœ¨åˆ—è¡¨ä¸­å±•ç¤º

- **å¼‚å¸¸æµç¨‹**:
  - é¡¹ç›®åé‡å¤ â†’ æ ¹æ®Viewç«¯Project æ ¡éªŒ
  - å·²è¿‡æœŸé¡¹ç›®,ç”¨æˆ·ç»§ç»­æ“ä½œ â†’ ç³»ç»Ÿæ‹’ç»
  - æ•°æ®åŒæ­¥å¼‚å¸¸ â†’ è®°å½•é”™è¯¯æ—¥å¿—

- **æµç¨‹å›¾**:

```mermaid
flowchart TD
    A[ç”¨æˆ·åˆ›å»ºé¡¹ç›®] --> B{ç”¨æˆ·çŠ¶æ€}
    B -->|active| C[æ¨é€è‡³Viewç«¯projectè¡¨]
    B -->|pending| D[å­˜å‚¨åœ¨Portalç«¯æœ¬åœ°]
    C --> E[é¡¹ç›®çŠ¶æ€ä¸ºPre-Lead]
    D --> E
    E --> F{TKEæ˜¯å¦åˆ†é…é¡¹ç›®}
    F -->|æ˜¯| G[è®¾ç½®24å°æ—¶å“åº”æœŸé™]
    G --> H[å‘é€å¾®ä¿¡é€šçŸ¥ç»™ç”¨æˆ·]
    H --> I{ç”¨æˆ·æ˜¯å¦å“åº”}
    I -->|æ¥å—| J[çŠ¶æ€å˜ä¸ºacceptedï¼Œè¿›å…¥Ongoing]
    I -->|æ‹’ç»| K[çŠ¶æ€å˜ä¸ºrejectedï¼Œè®°å½•åŸå› ]
    I -->|è¶…æ—¶| L[çŠ¶æ€å˜ä¸ºcancelledï¼Œä»åˆ—è¡¨ç§»é™¤]
    J --> M[é€šçŸ¥TKEé”€å”®]
    K --> M
    L --> M
    M --> N[é¡¹ç›®ç»§ç»­è·Ÿè¿›]
```

#### 3.5.2 å½±å“çš„æ•°æ®è¡¨

- Portalç«¯
  - **[user_company](#table-companies)** : User&Company å…³è”è¡¨(è®°å½• Partner å½“å‰çŠ¶æ€)
  - **[leads](#table-leads)** : Portalç«¯ Project åŸºç¡€ä¿¡æ¯è¡¨
- Viewç«¯
  - **[project](#table-project)** : Viewç«¯ Project ä¿¡æ¯è¡¨
  - **[project_customer](#table-project)** : Viewç«¯ Project ä¿¡æ¯è¡¨
  - **[projectbank](#table-projectbank)** : Viewç«¯ Project ä¿¡æ¯è¡¨
  - **[projectbank_unitdetails](#table-projectbank_unitdetails)** : Viewç«¯ Project ä¿¡æ¯è¡¨

#### 3.5.3 å‰ç«¯å®ç°

##### 3.5.3.1 è§†å›¾ç›®å½•ç»“æ„

```plaintext
/src/views/project/
  ProjectMain.vue              - é¡¹ç›®ä¸»é¡µé¢
  CreateProject.vue            - åˆ›å»ºé¡¹ç›®é¡µé¢

/src/components/project/
  ProjectList.vue              - é¡¹ç›®åˆ—è¡¨ç»„ä»¶
  ProjectForm.vue              - é¡¹ç›®è¡¨å•ç»„ä»¶
  ProjectActions.vue           - é¡¹ç›®æ“ä½œç»„ä»¶
```

##### 3.5.3.2 å…³é”®ç»„ä»¶åŠŸèƒ½

- **ProjectMain.vue**
  - 3ä¸ªçŠ¶æ€æ ‡ç­¾é¡µ:TKE(é»˜è®¤)ã€Ongoingã€All
  - é›†æˆé¡¹ç›®åˆ—è¡¨å’Œåˆ›å»ºå…¥å£
  - æƒé™çŠ¶æ€æ£€æŸ¥å’Œæ•°æ®è¿‡æ»¤

- **ProjectList.vue**
  - é¡¹ç›®åˆ—è¡¨å±•ç¤ºï¼Œæ”¯æŒæœç´¢
  - æ ¹æ®ç”¨æˆ·æƒé™è¿‡æ»¤æ•°æ®ï¼ˆä¸ªäºº/å…¬å¸ï¼‰
  - TKEé¡¹ç›®æ˜¾ç¤ºæ¥å—/æ‹’ç»æ“ä½œ

- **ProjectActions.vue**
  - TKEé¡¹ç›®:æ¥å—/æ‹’ç»æ“ä½œ
  - Ongoingé¡¹ç›®:ç¼–è¾‘æ“ä½œ
  - æƒé™æ§åˆ¶çš„æ“ä½œæŒ‰é’®æ˜¾ç¤º

##### 3.5.3.3 APIè®¾è®¡

| HTTP æ–¹æ³• | ç«¯ç‚¹                          | æè¿°                    |
|-----------|-------------------------------|-------------------------|
| GET       | `/api/project`                | è·å–é¡¹ç›®åˆ—è¡¨(æ”¯æŒçŠ¶æ€ç­›é€‰) |
| POST      | `/api/project`                | åˆ›å»ºæ–°é¡¹ç›® |
| PUT       | `/api/project/{id}`           | æ›´æ–°é¡¹ç›®ä¿¡æ¯ |
| POST      | `/api/project/{id}/accept`    | æ¥å—TKEé¡¹ç›® |
| POST      | `/api/project/{id}/reject`    | æ‹’ç»TKEé¡¹ç›® |

#### 3.5.4 åŠŸèƒ½å¼€å‘ä¸å®ç°

##### 3.5.4.1 ç±»å…³ç³»å›¾

```mermaid
classDiagram
    class ProjectController {
        +getProjectList()
        +createProject()
        +updateProject()
        +acceptProject()
        +rejectProject()
        +validateProjectName()
        +getProjectStats()
    }

    class ProjectService {
        +getProjectList(userId,companyId,status,searchKeyword)
        +createProject(userId,companyId,projectData)
        +updateProject(projectId,userId,projectData)
        +acceptTkeProject(projectId,userId)
        +rejectTkeProject(projectId,userId)
        +validateProjectName(projectName,companyId)
        +autoExpireProjects()
    }

    class UserPermissionService {
        +checkUserCompanyPermission(userId,companyId,permission)
        +getUserCompanyStatus(userId,companyId)
        +checkUserCompanyBinding(userId,companyId)
    }

    class InterSystemService {
        +pushDataToView(syncData)
        +pullDataFromView(pullRequest)
    }

    class BaseController {
        +successResponse(data,message,code)
        +errorResponse(message,code,errors)
    }

    ProjectController --> ProjectService : ä¸šåŠ¡å¤„ç†
    ProjectController --> BaseController : å“åº”æ ¼å¼åŒ–

    ProjectService --> UserPermissionService : æƒé™æ£€æŸ¥
    ProjectService --> InterSystemService : æ•°æ®åŒæ­¥
```

##### 3.5.4.2 ä»£ç å®ç°

- **ProjectController.php**
  - **æ–‡ä»¶è·¯å¾„**:`packages/ProjectManagement/src/Controllers/ProjectController.php`
  - **æ–‡ä»¶çŠ¶æ€**:æ–°å¢
  - **æ–¹æ³•**:
    - **getProjectList()**  
      - **åŠŸèƒ½æè¿°**:è·å–é¡¹ç›®åˆ—è¡¨ï¼Œæ ¹æ®ç”¨æˆ·æƒé™è¿‡æ»¤æ•°æ®ï¼Œæ”¯æŒçŠ¶æ€ç­›é€‰å’Œæœç´¢ï¼Œæ˜¾ç¤ºä¸åŒç±»å‹é¡¹ç›®åˆ†ç±»ã€‚é›†æˆæ—¥å¿—è®°å½•ã€‚  
      - **æ–¹æ³•çŠ¶æ€**:æ–°å¢  
      - **è°ƒç”¨é¡ºåº**:ç”¨æˆ·è¿›å…¥é¡¹ç›®é¡µé¢æˆ–åˆ‡æ¢çŠ¶æ€æ ‡ç­¾æ—¶è°ƒç”¨  
      - **ä¾èµ–æœåŠ¡**:
        - `ProjectService::getProjectList()`
        - `auth('sanctum')->user()`
        - `Log::channel('business')->info()`
      - **è¯·æ±‚å‚æ•°**:  

        | å‚æ•°åç§° | æ•°æ®ç±»å‹ | æ˜¯å¦å¿…å¡« | æè¿°             |
        |----------|----------|----------|------------------|
        | status   | String   | å¦       | çŠ¶æ€ç­›é€‰(tke/ongoing/all) |
        | userId   | Integer   | å¦       | ç”¨æˆ·IDï¼ˆé»˜è®¤è‡ªå·±ï¼‰ |
        | search   | String   | å¦       | é¡¹ç›®åç§°æœç´¢å…³é”®è¯ |
        | page     | Integer  | å¦       | é¡µç (é»˜è®¤1) |
        | pageSize | Integer  | å¦       | æ¯é¡µæ¡æ•°(é»˜è®¤20) |

      - **å“åº”æ•°æ®**:  

        | å‚æ•°åç§° | æ•°æ®ç±»å‹ | æè¿°                  |
        |----------|----------|-----------------------|
        | success  | Boolean  | æ˜¯å¦è·å–æˆåŠŸ           |
        | projects | Array    | é¡¹ç›®åˆ—è¡¨æ•°æ®           |
        | total    | Integer  | æ€»è®°å½•æ•°               |
        | stats    | Object   | å„çŠ¶æ€ç»Ÿè®¡æ•°é‡         |
        | hasMore  | Boolean  | æ˜¯å¦æœ‰æ›´å¤šæ•°æ®         |
        | userPermission | String | ç”¨æˆ·æƒé™çº§åˆ«(personal/company) |

    - **createProject()**
      - **åŠŸèƒ½æè¿°**:åˆ›å»ºæ–°é¡¹ç›®ï¼ŒéªŒè¯é¡¹ç›®åé‡å¤æ€§ï¼ˆæ ¹æ®é…ç½®ï¼‰ï¼Œè®¾ç½®é»˜è®¤çŠ¶æ€ä¸ºPre-Leadï¼Œæ ¹æ®ç”¨æˆ·çŠ¶æ€é€‰æ‹©å­˜å‚¨ä½ç½®ã€‚é›†æˆå®Œæ•´æ—¥å¿—è®°å½•ã€‚  
      - **æ–¹æ³•çŠ¶æ€**:æ–°å¢  
      - **è°ƒç”¨é¡ºåº**:ç”¨æˆ·æäº¤é¡¹ç›®åˆ›å»ºè¡¨å•æ—¶è°ƒç”¨  
      - **ä¾èµ–æœåŠ¡**:
        - `ProjectService::createProject()`
        - `auth('sanctum')->user()`
        - `Log::channel('business')->info()`
      - **è¯·æ±‚å‚æ•°**:  

        | å‚æ•°åç§°   | æ•°æ®ç±»å‹ | æ˜¯å¦å¿…å¡« | æè¿°             |
        |------------|----------|----------|------------------|
        | projectName | String  | æ˜¯       | é¡¹ç›®åç§°(æœ€å¤§40å­—ç¬¦) |
        | modernizationScope | String | æ˜¯ | æ”¹é€ èŒƒå›´(full_mod/partial_mod) |
        | brand      | String   | æ˜¯       | å“ç‰Œ(tke/sanfte) |
        | province   | String   | æ˜¯       | çœä»½ |
        | city       | String   | æ˜¯       | åŸå¸‚ |
        | district   | String   | æ˜¯       | åŒºå¿ |
        | detailAddress | String | å¦     | è¯¦ç»†åœ°å€ |
        | unitsCount | Integer  | æ˜¯       | æ¢¯å°æ•° |
        | contractValue | Decimal | æ˜¯     | åˆåŒé‡‘é¢ |
        | forecastTenderDate | Date | æ˜¯   | é¢„è®¡æŠ¥ä»·æ—¥æœŸ |

      - **å“åº”æ•°æ®**:  

        | å‚æ•°åç§° | æ•°æ®ç±»å‹ | æè¿°                  |
        |----------|----------|-----------------------|
        | success  | Boolean  | æ˜¯å¦åˆ›å»ºæˆåŠŸ           |
        | projectId | Integer | é¡¹ç›®ID                 |
        | status   | String   | é¡¹ç›®çŠ¶æ€               |
        | message  | String   | æç¤ºä¿¡æ¯               |

    - **acceptProject()**
      - **åŠŸèƒ½æè¿°**:æ¥å—TKEåˆ†é…é¡¹ç›®ï¼ŒéªŒè¯é¡¹ç›®ç±»å‹å’Œç”¨æˆ·æƒé™ï¼Œæ›´æ–°é¡¹ç›®çŠ¶æ€ä¸ºacceptedï¼Œè®°å½•æ¥å—æ—¶é—´ã€‚é›†æˆæ—¥å¿—è®°å½•ã€‚  
      - **æ–¹æ³•çŠ¶æ€**:æ–°å¢  
      - **è°ƒç”¨é¡ºåº**:ç”¨æˆ·ç‚¹å‡»æ¥å—TKEé¡¹ç›®æ—¶è°ƒç”¨  
      - **ä¾èµ–æœåŠ¡**:
        - `ProjectService::acceptTkeProject()`
        - `Log::channel('business')->info()`
      - **è¯·æ±‚å‚æ•°**:  

        | å‚æ•°åç§° | æ•°æ®ç±»å‹ | æ˜¯å¦å¿…å¡« | æè¿°             |
        |----------|----------|----------|------------------|
        | projectId | Integer | æ˜¯       | é¡¹ç›®ID           |

      - **å“åº”æ•°æ®**:  

        | å‚æ•°åç§° | æ•°æ®ç±»å‹ | æè¿°                  |
        |----------|----------|-----------------------|
        | success  | Boolean  | æ˜¯å¦æ¥å—æˆåŠŸ           |
        | projectStatus | String | æ›´æ–°åé¡¹ç›®çŠ¶æ€       |
        | acceptedAt | DateTime | æ¥å—æ—¶é—´             |
        | message  | String   | æç¤ºä¿¡æ¯               |

    - **rejectProject()**
      - **åŠŸèƒ½æè¿°**:æ‹’ç»TKEåˆ†é…é¡¹ç›®ï¼ŒéªŒè¯é¡¹ç›®ç±»å‹å’Œç”¨æˆ·æƒé™ï¼Œæ›´æ–°é¡¹ç›®çŠ¶æ€ä¸ºrejectedï¼Œè®°å½•æ‹’ç»æ—¶é—´å’ŒåŸå› ã€‚é›†æˆæ—¥å¿—è®°å½•ã€‚  
      - **æ–¹æ³•çŠ¶æ€**:æ–°å¢  
      - **è°ƒç”¨é¡ºåº**:ç”¨æˆ·ç‚¹å‡»æ‹’ç»TKEé¡¹ç›®æ—¶è°ƒç”¨  
      - **ä¾èµ–æœåŠ¡**:
        - `ProjectService::rejectTkeProject()`
        - `Log::channel('business')->info()`
      - **è¯·æ±‚å‚æ•°**:  

        | å‚æ•°åç§° | æ•°æ®ç±»å‹ | æ˜¯å¦å¿…å¡« | æè¿°             |
        |----------|----------|----------|------------------|
        | projectId | Integer | æ˜¯       | é¡¹ç›®ID           |
        | comments | String   | å¦       | æ‹’ç»åŸå›          |

      - **å“åº”æ•°æ®**:  

        | å‚æ•°åç§° | æ•°æ®ç±»å‹ | æè¿°                  |
        |----------|----------|-----------------------|
        | success  | Boolean  | æ˜¯å¦æ‹’ç»æˆåŠŸ           |
        | projectStatus | String | æ›´æ–°åé¡¹ç›®çŠ¶æ€       |
        | rejectedAt | DateTime | æ‹’ç»æ—¶é—´             |
        | message  | String   | æç¤ºä¿¡æ¯               |

    - **updateProject()**
      - **åŠŸèƒ½æè¿°**:æ›´æ–°é¡¹ç›®ä¿¡æ¯ï¼Œæ£€æŸ¥ç¼–è¾‘æƒé™ï¼ˆé”å®šçŠ¶æ€/åˆ›å»ºè€…ï¼‰ï¼ŒéªŒè¯å­—æ®µåˆæ³•æ€§ï¼Œè®°å½•å˜æ›´å†å²ã€‚é›†æˆæ—¥å¿—è®°å½•ã€‚  
      - **æ–¹æ³•çŠ¶æ€**:æ–°å¢  
      - **è°ƒç”¨é¡ºåº**:ç”¨æˆ·æäº¤é¡¹ç›®ç¼–è¾‘è¡¨å•æ—¶è°ƒç”¨  
      - **ä¾èµ–æœåŠ¡**:
        - `ProjectService::updateProject()`
        - `Log::channel('business')->info()`
      - **è¯·æ±‚å‚æ•°**:  

        | å‚æ•°åç§° | æ•°æ®ç±»å‹ | æ˜¯å¦å¿…å¡« | æè¿°             |
        |----------|----------|----------|------------------|
        | projectId | Integer | æ˜¯       | é¡¹ç›®ID           |
        | projectName | String | æ˜¯      | é¡¹ç›®åç§°         |
        | modernizationScope | String | æ˜¯ | æ”¹é€ èŒƒå›´       |
        | brand    | String   | æ˜¯       | å“ç‰Œé€‰æ‹©         |
        | province | String   | æ˜¯       | çœä»½             |
        | city     | String   | æ˜¯       | åŸå¸‚             |
        | district | String   | æ˜¯       | åŒºå¿             |
        | detailAddress | String | å¦   | è¯¦ç»†åœ°å€         |
        | unitsCount | Integer | æ˜¯     | æ¢¯å°æ•°           |
        | contractValue | Decimal | æ˜¯   | åˆåŒé‡‘é¢         |
        | forecastTenderDate | Date | æ˜¯ | é¢„è®¡æŠ¥ä»·æ—¥æœŸ |

      - **å“åº”æ•°æ®**:  

        | å‚æ•°åç§° | æ•°æ®ç±»å‹ | æè¿°                  |
        |----------|----------|-----------------------|
        | success  | Boolean  | æ˜¯å¦æ›´æ–°æˆåŠŸ           |
        | projectStatus | String | é¡¹ç›®çŠ¶æ€             |
        | isEditable | Boolean | æ˜¯å¦ä»å¯ç¼–è¾‘         |
        | lastModified | DateTime | æœ€åä¿®æ”¹æ—¶é—´       |
        | message  | String   | æç¤ºä¿¡æ¯               |

    - **validateProjectName()**
      - **åŠŸèƒ½æè¿°**:éªŒè¯é¡¹ç›®åç§°é‡å¤æ€§ï¼Œæ ¹æ®é…ç½®å¼€å…³å†³å®šæ˜¯å¦æ£€æŸ¥ï¼Œæ”¯æŒåŒå…¬å¸å†…é¡¹ç›®åå”¯ä¸€æ€§éªŒè¯ã€‚é›†æˆæ—¥å¿—è®°å½•ã€‚  
      - **æ–¹æ³•çŠ¶æ€**:æ–°å¢  
      - **è°ƒç”¨é¡ºåº**:é¡¹ç›®åˆ›å»º/ç¼–è¾‘æ—¶å®æ—¶éªŒè¯æˆ–è¡¨å•æäº¤å‰è°ƒç”¨  
      - **ä¾èµ–æœåŠ¡**:
        - `ProjectService::validateProjectName()`
      - **è¯·æ±‚å‚æ•°**:  

        | å‚æ•°åç§° | æ•°æ®ç±»å‹ | æ˜¯å¦å¿…å¡« | æè¿°             |
        |----------|----------|----------|------------------|
        | projectName | String | æ˜¯      | é¡¹ç›®åç§°         |
        | companyId | Integer | æ˜¯       | å…¬å¸ID           |
        | excludeId | Integer | å¦       | æ’é™¤çš„é¡¹ç›®ID(ç¼–è¾‘æ—¶) |

      - **å“åº”æ•°æ®**:  

        | å‚æ•°åç§° | æ•°æ®ç±»å‹ | æè¿°                  |
        |----------|----------|-----------------------|
        | success  | Boolean  | éªŒè¯æ˜¯å¦é€šè¿‡           |
        | isUnique | Boolean  | åç§°æ˜¯å¦å”¯ä¸€           |
        | duplicateId | Integer | é‡å¤é¡¹ç›®ID(å¦‚æœæœ‰)    |
        | message  | String   | éªŒè¯ç»“æœä¿¡æ¯           |

- **ProjectService.php**
  - **æ–‡ä»¶è·¯å¾„**:`packages/ProjectManagement/src/Services/ProjectService.php`
  - **æ–‡ä»¶çŠ¶æ€**:æ–°å¢
  - **æ–¹æ³•**:
    - **getProjectList($userId, $companyId, $status, $searchKeyword)**
      - **åŠŸèƒ½æè¿°**:è·å–ç”¨æˆ·å¯è®¿é—®çš„é¡¹ç›®åˆ—è¡¨ï¼Œæ ¹æ®æƒé™è¿‡æ»¤æ•°æ®ï¼Œæ”¯æŒçŠ¶æ€ç­›é€‰å’Œæœç´¢
      - **æ–¹æ³•çŠ¶æ€**:æ–°å¢
      - **è¿”å›æ•°æ®**:é¡¹ç›®åˆ—è¡¨æ•°ç»„å’Œç»Ÿè®¡ä¿¡æ¯

    - **createProject($userId, $companyId, $projectData)**
      - **åŠŸèƒ½æè¿°**:åˆ›å»ºæ–°é¡¹ç›®è®°å½•ï¼ŒéªŒè¯é¡¹ç›®åé‡å¤æ€§ï¼Œè®¾ç½®é»˜è®¤çŠ¶æ€ï¼Œæ ¹æ®ç”¨æˆ·çŠ¶æ€é€‰æ‹©å­˜å‚¨ä½ç½®
      - **æ–¹æ³•çŠ¶æ€**:æ–°å¢
      - **è¿”å›æ•°æ®**:é¡¹ç›®IDå’Œå­˜å‚¨ä½ç½®ä¿¡æ¯

    - **updateProject($projectId, $userId, $projectData)**
      - **åŠŸèƒ½æè¿°**:æ›´æ–°é¡¹ç›®ä¿¡æ¯ï¼Œè®°å½•å˜æ›´å†å²ï¼Œå¿…è¦æ—¶åŒæ­¥åˆ°VIEW
      - **æ–¹æ³•çŠ¶æ€**:æ–°å¢
      - **è¿”å›æ•°æ®**:æ›´æ–°ç»“æœå’Œé¡¹ç›®çŠ¶æ€

    - **acceptTkeProject($projectId, $userId)**
      - **åŠŸèƒ½æè¿°**:æ¥å—TKEåˆ†é…é¡¹ç›®ï¼Œæ›´æ–°çŠ¶æ€ä¸ºaccepted
      - **æ–¹æ³•çŠ¶æ€**:æ–°å¢
      - **è¿”å›æ•°æ®**:æ¥å—ç»“æœå’Œé¡¹ç›®çŠ¶æ€

    - **rejectTkeProject($projectId, $userId)**
      - **åŠŸèƒ½æè¿°**:æ‹’ç»TKEåˆ†é…é¡¹ç›®ï¼Œæ›´æ–°çŠ¶æ€ä¸ºrejectedï¼Œè®°å½•æ‹’ç»åŸå› 
      - **æ–¹æ³•çŠ¶æ€**:æ–°å¢
      - **è¿”å›æ•°æ®**:æ‹’ç»ç»“æœå’Œé¡¹ç›®çŠ¶æ€

    - **validateProjectName($projectName, $companyId)**
      - **åŠŸèƒ½æè¿°**:éªŒè¯é¡¹ç›®åç§°åœ¨åŒå…¬å¸å†…çš„å”¯ä¸€æ€§ï¼Œæ ¹æ®é…ç½®å¼€å…³å†³å®šæ˜¯å¦æ£€æŸ¥
      - **æ–¹æ³•çŠ¶æ€**:æ–°å¢
      - **è¿”å›æ•°æ®**:éªŒè¯ç»“æœå’Œé‡å¤ä¿¡æ¯

    - **autoExpireProjects()**
      - **åŠŸèƒ½æè¿°**:è‡ªåŠ¨å¤„ç†è¶…è¿‡24å°æ—¶æœªå¤„ç†çš„TKEé¡¹ç›®ï¼Œæ‰¹é‡æ›´æ–°ä¸ºè¿‡æœŸçŠ¶æ€
      - **æ–¹æ³•çŠ¶æ€**:æ–°å¢
      - **è¿”å›æ•°æ®**:è¿‡æœŸé¡¹ç›®æ•°é‡

### 3.6 TKE Libraryæ¨¡å—

#### 3.6.1 ä¸šåŠ¡æµç¨‹

##### 3.6.1.1 ä¸šåŠ¡èƒŒæ™¯

- **èƒŒæ™¯**:TKE Libraryæ¨¡å—æä¾›æ–‡ä»¶ç®¡ç†å’Œå±•ç¤ºåŠŸèƒ½ã€‚æ ¹æ®ç”¨æˆ·çŠ¶æ€æ§åˆ¶æ–‡ä»¶è®¿é—®æƒé™:Inactiveç”¨æˆ·åªèƒ½è®¿é—®inactive levelçš„æ–‡ä»¶ï¼ŒActiveç”¨æˆ·å¯ä»¥è®¿é—®inactiveå’Œactive levelæ–‡ä»¶ï¼ŒAGRç”¨æˆ·å¯ä»¥è®¿é—®æ‰€æœ‰ç±»åˆ«çš„æ–‡ä»¶ï¼Œå…¶ä»–ç”¨æˆ·æ— æƒè®¿é—®ã€‚

- **ä¸»è¦æµç¨‹**

  - **æ–‡ä»¶åˆ—è¡¨**
    - Portalç«¯ä¿å­˜æ–‡ä»¶å…³è”å…³ç³»å’Œåˆ†ç»„ä¿¡æ¯
    - è®¾ç½®æ–‡ä»¶åˆ†ç±»å’Œç›®å½•ç»“æ„
    - æ”¯æŒæ–‡ä»¶é¢„è§ˆ
    - æä¾›æ–‡ä»¶ä¸‹è½½åŠŸèƒ½
    ![alt text](<044 - TKE Library-1.png>)
    ![alt text](<045 - TKE Library - Report Two-1.png>)

- **å¼‚å¸¸æµç¨‹**:
  - æ–‡ä»¶ä¸å­˜åœ¨ â†’ æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯å¹¶è®°å½•æ—¥å¿—
  - ä¸‹è½½å¤±è´¥ â†’ é‡è¯•æœºåˆ¶å’Œé”™è¯¯æç¤º
  - é¢„è§ˆä¸æ”¯æŒ â†’ æä¾›ä¸‹è½½é€‰é¡¹

- **æµç¨‹å›¾**:

```mermaid
flowchart TD
    A[TKEç”¨æˆ·ä¸Šä¼ æ–‡ä»¶] --> B[é€‰æ‹©è®¿é—®çº§åˆ«]
    B --> C{çº§åˆ«é€‰æ‹©}
    C -->|inactive| D[ä»…inactiveç”¨æˆ·å¯è§]
    C -->|active| E[activeç”¨æˆ·å¯è§]
    C -->|signed| F[AGRç”¨æˆ·å¯è§]
    D --> G[æ–‡ä»¶å­˜å‚¨è‡³NAS]
    E --> G
    F --> G
    G --> H[è®°å½•å…ƒæ•°æ®åˆ°Libraryè¡¨]
    H --> I[Portalç”¨æˆ·è¿›å…¥TKE Library]
    I --> J{ç”¨æˆ·çŠ¶æ€}
    J -->|inactive| K[ä»…å±•ç¤ºinactiveçº§åˆ«æ–‡ä»¶]
    J -->|active| L[å±•ç¤ºinactive+activeæ–‡ä»¶]
    J -->|signed| M[å±•ç¤ºæ‰€æœ‰æ–‡ä»¶]
    K --> N[ç”¨æˆ·ç‚¹å‡»ä¸‹è½½/é¢„è§ˆ]
    L --> N
    M --> N
    N --> O[ç”Ÿæˆä¸´æ—¶ä¸‹è½½é“¾æ¥]
    O --> P[è®°å½•ä¸‹è½½ç»Ÿè®¡]
```

#### 3.6.2 å½±å“çš„æ•°æ®è¡¨

- **[user_company](#table-user_company)** : User&Company å…³è”è¡¨(è®°å½• Partner å½“å‰çŠ¶æ€)
- **[librarys](#table-librarys)** : Portalç«¯ æ–‡ä»¶å…³ç³» æ–‡ä»¶ä¿¡æ¯è¡¨

#### 3.6.3 å‰ç«¯å®ç°

##### 3.6.3.1 è§†å›¾ç›®å½•ç»“æ„

```plaintext
/src/views/Library/
  LibraryMain.vue              - TKE Libraryä¸»é¡µé¢

/src/components/Library/
  LibraryFileList.vue          - æ–‡ä»¶åˆ—è¡¨ç»„ä»¶
  LibraryPreviewModal.vue      - é¢„è§ˆå¼¹çª—ç»„ä»¶
```

##### 3.6.3.2 å…³é”®ç»„ä»¶åŠŸèƒ½

- **LibraryMain.vue**
  - æ–‡ä»¶ç›®å½•æµè§ˆ
  - æƒé™çŠ¶æ€æ£€æŸ¥(active/inactive/agrçŠ¶æ€ä¸¥æ ¼åŒ¹é…)
  - æ–‡ä»¶é¢„è§ˆå’Œä¸‹è½½åŠŸèƒ½

- **LibraryFileList.vue**
  - æ–‡ä»¶åˆ—è¡¨å±•ç¤º
  - æ ¹æ®ç”¨æˆ·çŠ¶æ€è¿‡æ»¤æ–‡ä»¶
  - æ”¯æŒæ–‡ä»¶å›¾æ ‡å’Œç¼©ç•¥å›¾

##### 3.6.3.3 TKE Library APIè®¾è®¡

| HTTP æ–¹æ³• | ç«¯ç‚¹                          | æè¿°                    |
|-----------|-------------------------------|-------------------------|
| GET       | `/api/Library/files`             | è·å–æ–‡ä»¶åˆ—è¡¨(æŒ‰æƒé™è¿‡æ»¤) |
| GET       | `/api/Library/download/{id}`     | ä¸‹è½½æ–‡ä»¶ |
| GET       | `/api/Library/preview/{id}`      | é¢„è§ˆæ–‡ä»¶ |

#### 3.6.4 åŠŸèƒ½å¼€å‘ä¸å®ç°

##### 3.6.4.1 ç±»å…³ç³»å›¾

```mermaid
classDiagram
    class LibraryController {
        +getFileList()
        +downloadFile()
        +previewFile()
        +getDirectories()
    }

    class LibraryService {
        +getFileList(userId,category,directoryId,page,pageSize)
        +downloadFile(fileId,userId)
        +previewFile(fileId,userId)
        +getDirectoryTree(userId)
        +checkFilePermission(userId,fileId)
        +getUserAccessLevel(userId)
    }

    class UserPermissionService {
        +checkUserCompanyBinding(userId,companyId)
        +getUserCompanyStatus(userId,companyId)
    }

    class BaseController {
        +successResponse(data,message,code)
        +errorResponse(message,code,errors)
    }

    LibraryController --> LibraryService : ä¸šåŠ¡å¤„ç†
    LibraryController --> BaseController : å“åº”æ ¼å¼åŒ–

    LibraryService --> UserPermissionService : æƒé™æ£€æŸ¥
```

##### 3.6.4.2 ä»£ç å®ç°

- **LibraryController.php**
  - **æ–‡ä»¶è·¯å¾„**:`packages/TkeLibrary/src/Controllers/LibraryController.php`
  - **æ–‡ä»¶çŠ¶æ€**:æ–°å¢
  - **æ–¹æ³•**:
    - **getFileList()**  
      - **åŠŸèƒ½æè¿°**:è·å–TKE Libraryæ–‡ä»¶åˆ—è¡¨ï¼Œæ ¹æ®ç”¨æˆ·çŠ¶æ€ä¸¥æ ¼åŒ¹é…æ–‡ä»¶çŠ¶æ€(activeç”¨æˆ·åªèƒ½çœ‹activeæ–‡ä»¶ï¼Œinactiveç”¨æˆ·åªèƒ½çœ‹inactiveæ–‡ä»¶ï¼Œagrç”¨æˆ·åªèƒ½çœ‹agræ–‡ä»¶)ï¼Œæ”¯æŒç›®å½•æµè§ˆå’Œåˆ†ç±»ç­›é€‰ã€‚  
      - **æ–¹æ³•çŠ¶æ€**:æ–°å¢  
      - **è°ƒç”¨é¡ºåº**:ç”¨æˆ·è¿›å…¥TKE Libraryé¡µé¢æˆ–åˆ‡æ¢ç›®å½•æ—¶è°ƒç”¨  
      - **ä¾èµ–æœåŠ¡**:
        - `LibraryService::getFileList()`
        - `auth('sanctum')->user()`
        - `Log::channel('business')->info()`
      - **è¯·æ±‚å‚æ•°**:  

        | å‚æ•°åç§° | æ•°æ®ç±»å‹ | æ˜¯å¦å¿…å¡« | æè¿°             |
        |----------|----------|----------|------------------|
        | category | String   | å¦       | æ–‡ä»¶åˆ†ç±»(files/report_two) |
        | directoryId | Integer | å¦     | ç›®å½•ID(æµè§ˆå­ç›®å½•) |
        | page     | Integer  | å¦       | é¡µç (é»˜è®¤1) |
        | pageSize | Integer  | å¦       | æ¯é¡µæ¡æ•°(é»˜è®¤20) |

      - **å“åº”æ•°æ®**:  

        | å‚æ•°åç§° | æ•°æ®ç±»å‹ | æè¿°                  |
        |----------|----------|-----------------------|
        | success  | Boolean  | æ˜¯å¦è·å–æˆåŠŸ           |
        | files    | Array    | æ–‡ä»¶åˆ—è¡¨æ•°æ®           |
        | directories | Array | ç›®å½•åˆ—è¡¨æ•°æ®           |
        | total    | Integer  | æ€»è®°å½•æ•°               |
        | userStatus | String | ç”¨æˆ·çŠ¶æ€çº§åˆ«(active/inactive/agr) |
        | hasMore  | Boolean  | æ˜¯å¦æœ‰æ›´å¤šæ•°æ®         |

    - **downloadFile()**
      - **åŠŸèƒ½æè¿°**:ä¸‹è½½æŒ‡å®šæ–‡ä»¶ï¼ŒéªŒè¯ç”¨æˆ·çŠ¶æ€å±•ç¤ºå¯¹åº”æ–‡ä»¶ï¼Œç”Ÿæˆå®‰å…¨ä¸‹è½½é“¾æ¥ã€‚æ”¯æŒæ–­ç‚¹ç»­ä¼ ã€‚  
      - **æ–¹æ³•çŠ¶æ€**:æ–°å¢  
      - **è°ƒç”¨é¡ºåº**:ç”¨æˆ·ç‚¹å‡»ä¸‹è½½æŒ‰é’®æ—¶è°ƒç”¨  
      - **ä¾èµ–æœåŠ¡**:
        - `LibraryService::downloadFile()`
        - `LibraryService::checkFilePermission()`
        - `Log::channel('business')->info()`
      - **è¯·æ±‚å‚æ•°**:  

        | å‚æ•°åç§° | æ•°æ®ç±»å‹ | æ˜¯å¦å¿…å¡« | æè¿°             |
        |----------|----------|----------|------------------|
        | fileId   | Integer  | æ˜¯       | æ–‡ä»¶ID           |
        | range    | String   | å¦       | æ–­ç‚¹ç»­ä¼ èŒƒå›´     |

      - **å“åº”æ•°æ®**:  

        | å‚æ•°åç§° | æ•°æ®ç±»å‹ | æè¿°                  |
        |----------|----------|-----------------------|
        | success  | Boolean  | æ˜¯å¦ä¸‹è½½æˆåŠŸ           |
        | downloadUrl | String | å®‰å…¨ä¸‹è½½é“¾æ¥(ä¸´æ—¶)     |
        | fileName | String   | æ–‡ä»¶åç§°               |
        | fileSize | Integer  | æ–‡ä»¶å¤§å°               |
        | mimeType | String   | æ–‡ä»¶ç±»å‹               |

    - **previewFile()**
      - **åŠŸèƒ½æè¿°**:é¢„è§ˆæŒ‡å®šæ–‡ä»¶ï¼ŒéªŒè¯ç”¨æˆ·çŠ¶æ€å±•ç¤ºå¯¹åº”æ–‡ä»¶ï¼Œæ”¯æŒå›¾ç‰‡ã€PDFç­‰æ ¼å¼åœ¨çº¿é¢„è§ˆï¼Œç”Ÿæˆé¢„è§ˆé“¾æ¥ã€‚  
      - **æ–¹æ³•çŠ¶æ€**:æ–°å¢  
      - **è°ƒç”¨é¡ºåº**:ç”¨æˆ·ç‚¹å‡»é¢„è§ˆæŒ‰é’®æˆ–æ–‡ä»¶å¡ç‰‡æ—¶è°ƒç”¨  
      - **ä¾èµ–æœåŠ¡**:
        - `LibraryService::previewFile()`
        - `LibraryService::checkFilePermission()`
        - `Log::channel('business')->info()`
      - **è¯·æ±‚å‚æ•°**:  

        | å‚æ•°åç§° | æ•°æ®ç±»å‹ | æ˜¯å¦å¿…å¡« | æè¿°             |
        |----------|----------|----------|------------------|
        | fileId   | Integer  | æ˜¯       | æ–‡ä»¶ID           |
        | quality  | String   | å¦       | é¢„è§ˆè´¨é‡(high/medium/low) |

      - **å“åº”æ•°æ®**:  

        | å‚æ•°åç§° | æ•°æ®ç±»å‹ | æè¿°                  |
        |----------|----------|-----------------------|
        | success  | Boolean  | æ˜¯å¦é¢„è§ˆæˆåŠŸ           |
        | previewUrl | String | é¢„è§ˆé“¾æ¥               |
        | previewType | String | é¢„è§ˆç±»å‹(image/pdf/unsupported) |
        | fileName | String   | æ–‡ä»¶åç§°               |
        | canDownload | Boolean | æ˜¯å¦å…è®¸ä¸‹è½½         |

- **LibraryService.php**
  - **æ–‡ä»¶è·¯å¾„**:`packages/TkeLibrary/src/Services/LibraryService.php`
  - **æ–‡ä»¶çŠ¶æ€**:æ–°å¢
  - **æ–¹æ³•**:
    - **getFileList($userId, $category, $directoryId, $page, $pageSize)**
      - **åŠŸèƒ½æè¿°**:è·å–ç”¨æˆ·å¯è®¿é—®çš„æ–‡ä»¶åˆ—è¡¨ï¼Œä¸¥æ ¼æŒ‰ç”¨æˆ·çŠ¶æ€è¿‡æ»¤å¯¹åº”çŠ¶æ€çš„æ–‡ä»¶ï¼Œæ”¯æŒåˆ†é¡µå’Œç›®å½•ç­›é€‰
      - **æ–¹æ³•çŠ¶æ€**:æ–°å¢
      - **è¿”å›æ•°æ®**:æ–‡ä»¶åˆ—è¡¨æ•°ç»„å’Œåˆ†é¡µä¿¡æ¯

    - **downloadFile($fileId, $userId)**
      - **åŠŸèƒ½æè¿°**:å¤„ç†æ–‡ä»¶ä¸‹è½½é€»è¾‘ï¼ŒéªŒè¯ç”¨æˆ·çŠ¶æ€è·å–å¯¹åº”æ–‡ä»¶ç”Ÿæˆä¸‹è½½é“¾æ¥
      - **æ–¹æ³•çŠ¶æ€**:æ–°å¢
      - **è¿”å›æ•°æ®**:ä¸‹è½½URLå’Œæ–‡ä»¶ä¿¡æ¯

    - **previewFile($fileId, $userId)**
      - **åŠŸèƒ½æè¿°**:å¤„ç†æ–‡ä»¶é¢„è§ˆé€»è¾‘ï¼ŒéªŒè¯çŠ¶æ€åŒ¹é…åç”Ÿæˆé¢„è§ˆé“¾æ¥ï¼Œæ”¯æŒå¤šç§æ–‡ä»¶æ ¼å¼
      - **æ–¹æ³•çŠ¶æ€**:æ–°å¢
      - **è¿”å›æ•°æ®**:é¢„è§ˆURLå’Œæ–‡ä»¶ç±»å‹

    - **getDirectoryTree($userId)**
      - **åŠŸèƒ½æè¿°**:è·å–ç”¨æˆ·å¯è®¿é—®çš„ç›®å½•æ ‘ç»“æ„ï¼Œæ”¯æŒå±‚çº§å¯¼èˆª
      - **æ–¹æ³•çŠ¶æ€**:æ–°å¢
      - **è¿”å›æ•°æ®**:ç›®å½•æ ‘æ•°æ®å’Œå¯¼èˆªä¿¡æ¯

    - **getUserAccessLevel($userId)**
      - **åŠŸèƒ½æè¿°**:è·å–ç”¨æˆ·çš„è®¿é—®çº§åˆ«ï¼Œç¡®å®šå¯è®¿é—®çš„æ–‡ä»¶çŠ¶æ€
      - **æ–¹æ³•çŠ¶æ€**:æ–°å¢
      - **è¿”å›æ•°æ®**:ç”¨æˆ·çŠ¶æ€çº§åˆ«(active/inactive/agr)

### 3.7 AGR Homepage

#### 3.7.1 ä¸šåŠ¡æµç¨‹

##### 3.7.1.1 ä¸šåŠ¡èƒŒæ™¯

- **èƒŒæ™¯**:å½“ç”¨æˆ·é€‰æ‹©AGRç±»å‹å…¬å¸æ—¶ï¼Œç³»ç»Ÿè·³è½¬åˆ°VIEWçš„AGR Homepageã€‚

- **ä¸»è¦æµç¨‹**:

  1. **AGRè¯†åˆ«**:æ£€æŸ¥companies.CompanyStatus = '1'
  2. **è·³è½¬å¤„ç†**:é‡å®šå‘åˆ°VIEWç³»ç»Ÿçš„AGR Homepage
  3. **è¿”å›å¤„ç†**:ä»VIEWè¿”å›åˆ°Portalä¸»ç•Œé¢

- **æµç¨‹å›¾**:

```mermaid
flowchart TD
    START[ç”¨æˆ·é€‰æ‹©å…¬å¸] --> AUTH[éªŒè¯ç”¨æˆ·ç™»å½•]
    AUTH --> CHECK[æ£€æŸ¥CompanyStatus]
    CHECK --> IS_AGR{æ˜¯å¦AGRå…¬å¸}

    IS_AGR -->|å¦| NORMAL[è¿›å…¥Portalæ­£å¸¸æµç¨‹]
    IS_AGR -->|æ˜¯| JUMP[è·³è½¬è‡³VIEWçš„AGR Homepage]

    subgraph PORTAL["Portalç«¯"]
        NORMAL --> BACK_PORTAL[Portalä¸»ç•Œé¢]
        BACK_PORTAL --> SELECT[é‡æ–°é€‰æ‹©å…¬å¸]
    end

    subgraph VIEW["VIEWç³»ç»Ÿ"]
        JUMP --> AGR_MODULE[AGR Homepage]
        AGR_MODULE --> AGR_WORK[ä¸šåŠ¡æ“ä½œ]
        AGR_WORK --> RETURN[è¿”å›Portal]
    end

    RETURN --> SELECT
    SELECT --> END[æµç¨‹ç»“æŸ]
```

#### 3.7.2 æ•°æ®è¡¨è®¾è®¡

- **[user_company](#table-user_company)** : User&Company å…³è”è¡¨(è®°å½• Partner å½“å‰çŠ¶æ€)

#### 3.7.3 åŠŸèƒ½å¼€å‘ä¸å®ç°

##### 3.7.3.1 ç±»å…³ç³»å›¾

```mermaid
classDiagram
    class AgrController {
        +checkAndJump()
    }

    class AgrService {
        +isAgrCompany(companyId)
        +prepareJump(userId,companyId)
        +buildJumpUrl(companyId,userId)
    }

    %% å…¬å…±æ¨¡å—ç»„ä»¶
    class UserPermissionService {
        +checkUserCompanyBinding(userId,companyId)
    }

    class BaseController {
        +successResponse(data,message)
        +errorResponse(code,message,errors)
    }

    %% ä¸­é—´ä»¶
    class AuthMiddleware {
        +handle(request,next)
    }

    %% ä¾èµ–å…³ç³»
    AgrController --|> BaseController : ç»§æ‰¿
    AgrController --> AgrService : ä¸šåŠ¡å¤„ç†

    AgrService --> UserPermissionService : æƒé™æ£€æŸ¥

    AuthMiddleware --> UserPermissionService : ç”¨æˆ·éªŒè¯

    %% ä¸­é—´ä»¶é“¾
    Request --> AuthMiddleware
    AuthMiddleware --> AgrController
```

##### 3.7.3.2 APIè®¾è®¡

| HTTP æ–¹æ³• | ç«¯ç‚¹                      | æè¿°                    | ä¸­é—´ä»¶ |
|-----------|---------------------------|-------------------------|--------|
| POST      | `/api/agr/check-and-jump` | æ£€æŸ¥AGRå¹¶å¤„ç†è·³è½¬       | auth:sanctum |

##### 3.7.3.3 ä»£ç å®ç°

- **AgrController.php**

  - **æ–‡ä»¶è·¯å¾„**:`app/Http/Controllers/AgrController.php`
  - **æ–‡ä»¶çŠ¶æ€**:æ–°
  - **æ–¹æ³•**:

    - **checkAndJump()**  
      - **åŠŸèƒ½æè¿°**:æ£€æŸ¥å…¬å¸ç±»å‹ï¼Œå¦‚æœæ˜¯AGRåˆ™è·³è½¬åˆ°VIEW/AGR Homepageï¼Œå¦åˆ™è¿”å›æ­£å¸¸æµç¨‹æ ‡è¯†ã€‚  
      - **æ–¹æ³•çŠ¶æ€**:æ–°å¢  
      - **è°ƒç”¨é¡ºåº**:ç”¨æˆ·é€‰æ‹©å…¬å¸æ—¶è°ƒç”¨  
      - **ä¾èµ–æœåŠ¡**:
        - `AgrService::isAgrCompany()`
        - `AgrService::prepareJump()`
        - `UserPermissionService::checkUserCompanyBinding()`
        - `auth('sanctum')->user()`
      - **è¯·æ±‚å‚æ•°**:  

        | å‚æ•°åç§° | æ•°æ®ç±»å‹ | æ˜¯å¦å¿…å¡« | æè¿°             |
        |----------|----------|----------|------------------|
        | companyId | Integer | æ˜¯       | å…¬å¸ID           |

      - **å“åº”æ•°æ®**:ä½¿ç”¨ `successResponse()` è¿”å›

        | å‚æ•°åç§° | æ•°æ®ç±»å‹ | æè¿°                  |
        |----------|----------|-----------------------|
        | success  | Boolean  | å›ºå®štrue              |
        | code     | Integer  | æˆåŠŸçŠ¶æ€ç (2000)      |
        | data     | Object   | åŒ…å«ä»¥ä¸‹å­—æ®µ          |
        | - isAgr    | Boolean  | æ˜¯å¦ä¸ºAGRå…¬å¸          |
        | - jumpUrl  | String   | è·³è½¬URLï¼ˆå¦‚æœæ˜¯AGRï¼‰   |
        | - action   | String   | æ“ä½œç±»å‹:'jump'æˆ–'normal' |
        | message  | String   | å¤„ç†ç»“æœä¿¡æ¯           |

- **AgrService.php**
  - **æ–‡ä»¶è·¯å¾„**:`app/Services/Agr/AgrService.php`
  - **æ–‡ä»¶çŠ¶æ€**:æ–°å¢
  - **æ–¹æ³•**:

    - **isAgrCompany($companyId)**
      - **åŠŸèƒ½æè¿°**:æ£€æŸ¥å…¬å¸æ˜¯å¦ä¸ºAGRç±»å‹ï¼ŒæŸ¥è¯¢companiesè¡¨çš„CompanyStatuså­—æ®µ
      - **æ–¹æ³•çŠ¶æ€**:æ–°å¢
      - **å‚æ•°**:å…¬å¸ID
      - **è¿”å›æ•°æ®**:Booleanç»“æœ

    - **prepareJump($userId, $companyId)**
      - **åŠŸèƒ½æè¿°**:å‡†å¤‡è·³è½¬AGR Homepageï¼Œæ„å»ºè·³è½¬URL
      - **æ–¹æ³•çŠ¶æ€**:æ–°å¢
      - **å‚æ•°**:ç”¨æˆ·IDã€å…¬å¸ID
      - **ä¸šåŠ¡é€»è¾‘**:
        1. éªŒè¯ç”¨æˆ·å¯¹AGRå…¬å¸çš„è®¿é—®æƒé™
        2. æ„é€ VIEW/AGR Homepageçš„è·³è½¬URL
        3. è®°å½•è·³è½¬æ—¥å¿—
      - **è¿”å›æ•°æ®**:è·³è½¬URLå’Œæ“ä½œç±»å‹

    - **buildJumpUrl($companyId, $userId)**
      - **åŠŸèƒ½æè¿°**:æ„å»ºVIEW/AGR Homepageçš„è·³è½¬URL
      - **æ–¹æ³•çŠ¶æ€**:æ–°å¢
      - **å‚æ•°**:å…¬å¸IDã€ç”¨æˆ·ID
      - **ä¸šåŠ¡é€»è¾‘**:
        1. ä»é…ç½®æ–‡ä»¶è¯»å–VIEWåŸºç¡€URL
        2. æ„é€ AGR Homepageè·¯å¾„
        3. æ·»åŠ å¿…è¦çš„è·³è½¬å‚æ•°
      - **è¿”å›æ•°æ®**:å®Œæ•´çš„è·³è½¬URL

## 4. Portalç«¯ Testing Strategy

### 4.1 PHPUnit å•å…ƒæµ‹è¯•è®¾è®¡

#### 4.1.1 æœåŠ¡å±‚æµ‹è¯•è®¾è®¡

##### 4.1.1.1 Registration æ¨¡å—æœåŠ¡æµ‹è¯•

**RegistrationServiceTest.php**

```php
class RegistrationServiceTest extends TestCase
{
    public function testProcessWechatRegistrationWithValidOpenid() { /* å¯¹åº” 3.1.4.2 RegistrationService::processWechatRegistration */ }
    public function testValidateRegistrationDataCorrectly() { /* å¯¹åº” validateRegistrationData */ }
    public function testCreateUserAndCompanyHandlesNewAndExistingCompany() { /* å¯¹åº” createUserAndCompany */ }
    public function testHandleCompanyBindingAssignsBranchManagerWhenNoSales() { /* å¯¹åº” handleCompanyBinding */ }
    public function testSendNotificationsFindsSalesFromSceneOrBranchManager() { /* å¯¹åº” sendNotifications */ }
}
```

##### 4.1.1.2 Login æ¨¡å—æœåŠ¡æµ‹è¯•

**LoginServiceTest.php**

```php
class LoginServiceTest extends TestCase
{
    public function testProcessMobileLoginWithValidCodeReturnsUserAndCompanies() { /* å¯¹åº” 3.2.4.2 LoginService::processMobileLogin */ }
    public function testHandleMultiCompanySelectionReturnsAllBindings() { /* å¯¹åº” handleMultiCompanySelection */ }
    public function testSwitchUserCompanyUpdatesLastVisitCompanyId() { /* å¯¹åº” switchUserCompany */ }
    public function testValidateUserStatusChecksAccountStatus() { /* å¯¹åº” validateUserStatus */ }
}
```

##### 4.1.1.3 MyInfo æ¨¡å—æœåŠ¡æµ‹è¯•

**MyInfoServiceTest.php**

```php
class MyInfoServiceTest extends TestCase
{
    public function testGetUserProfileReturnsUserInfoAndEditPermissions() { /* å¯¹åº” 3.3.4.2 MyInfoService::getUserProfile */ }
    public function testUpdateUserInfoAllowsPersonalInfoEditAlways() { /* å¯¹åº” updateUserInfo */ }
    public function testUpdateUserInfoAllowsCompanyEditOnlyWhenPending() { /* åŒä¸Šï¼ŒéªŒè¯ pending å¯ç¼–è¾‘ */ }
    public function testCheckCompanyEditPermissionReturnsFalseForActiveCompany() { /* å¯¹åº” checkCompanyEditPermission */ }
}

class AccountManageServiceTest extends TestCase
{
    public function testDeleteAccountUnbindsUserCompanyAndContractBindings() { /* å¯¹åº” AccountManageService::deleteAccount */ }
    public function testUnbindAllCompaniesRemovesAllUserCompanyRecords() { /* å¯¹åº” unbindAllCompanies */ }
    public function testValidateDeletePermissionChecksUserStatus() { /* å¯¹åº” validateDeletePermission */ }
}
```

##### 4.1.1.4 Inquiry æ¨¡å—æœåŠ¡æµ‹è¯•

**InquiryServiceTest.php**

```php
class InquiryServiceTest extends TestCase
{
    public function testGetInquiriesWithPermissionMergesActiveAndInactiveData() { /* å¯¹åº” 3.4.4.2 InquiryService::getInquiriesWithPermission */ }
    public function testGetActiveUserInquiriesQueriesViewInquiriesTable() { /* å¯¹åº” getActiveUserInquiries */ }
    public function testGetInactiveUserInquiriesCallsPortalApi() { /* å¯¹åº” getInactiveUserInquiries */ }
    public function testReplyToActiveInquirySetsRatingDeadlineAndExclusiveLock() { /* å¯¹åº” replyToActiveInquiry */ }
    public function testReplyToInactiveInquiryCallsPortalApiForReply() { /* å¯¹åº” replyToInactiveInquiry */ }
    public function testProcessAutoCloseMarksExpiredInquiriesAsClosed() { /* å¯¹åº” processAutoClose */ }
    public function testSyncInquiriesFromPortalConvertsArrayToViewJson() { /* å¯¹åº” syncInquiriesFromPortal */ }
}
```

##### 4.1.1.5 Project æ¨¡å—æœåŠ¡æµ‹è¯•

**ProjectServiceTest.php**

```php
class ProjectServiceTest extends TestCase
{
    public function testGetProjectListFiltersByUserPermission() { /* å¯¹åº” 3.5.4.2 ProjectService::getProjectList */ }
    public function testCreateProjectSetsDefaultStatusToPreLead() { /* å¯¹åº” createProject */ }
    public function testUpdateProjectChecksEditPermissionAndLogsChanges() { /* å¯¹åº” updateProject */ }
    public function testAcceptTkeProjectUpdatesStatusToAccepted() { /* å¯¹åº” acceptTkeProject */ }
    public function testRejectTkeProjectUpdatesStatusToRejected() { /* å¯¹åº” rejectTkeProject */ }
    public function testValidateProjectNameChecksUniquenessInCompany() { /* å¯¹åº” validateProjectName */ }
    public function testAutoExpireProjectsMarksUnrespondedTkeProjectsAsCancelled() { /* å¯¹åº” autoExpireProjects */ }
}
```

##### 4.1.1.6 TKE Library æ¨¡å—æœåŠ¡æµ‹è¯•

**LibraryServiceTest.php**

```php
class LibraryServiceTest extends TestCase
{
    public function testGetFileListFiltersByUserStatusStrictly() { /* å¯¹åº” 3.6.4.2 LibraryService::getFileList */ }
    public function testDownloadFileRequiresPermissionAndGeneratesSecureUrl() { /* å¯¹åº” downloadFile */ }
    public function testPreviewFileSupportsPdfAndImageFormats() { /* å¯¹åº” previewFile */ }
    public function testGetDirectoryTreeReturnsAccessibleStructure() { /* å¯¹åº” getDirectoryTree */ }
    public function testGetUserAccessLevelReturnsInactiveForPending() { /* å¯¹åº” getUserAccessLevel */ }
    public function testGetUserAccessLevelReturnsActiveForActive() { /* åŒä¸Š */ }
    public function testGetUserAccessLevelReturnsSignedForCompanyStatus1() { /* åŒä¸Šï¼ŒAGR */ }
}
```

##### 4.1.1.7 AGR Homepage æ¨¡å—æœåŠ¡æµ‹è¯•

**AgrServiceTest.php**

```php
class AgrServiceTest extends TestCase
{
    public function testIsAgrCompanyReturnsTrueWhenCompanyStatusEquals1() { /* å¯¹åº” 3.7.3.3 AgrService::isAgrCompany */ }
    public function testPrepareJumpBuildsValidJumpUrlAndLogs() { /* å¯¹åº” prepareJump */ }
    public function testBuildJumpUrlConstructsViewAgrHomepageUrl() { /* å¯¹åº” buildJumpUrl */ }
}
```

### 4.2 BDDæµ‹è¯•æ¡†æ¶ï¼ˆCucumberï¼‰

#### 4.2 BDD æµ‹è¯•æ¡†æ¶ï¼ˆCucumberï¼‰

##### 4.2.1.1 æ³¨å†Œå…¨æµç¨‹

**features/registration.feature**

```gherkin
Feature: æ‰«ç æ³¨å†Œæˆä¸º Partner
  ä½œä¸ºæ–°ç”¨æˆ·ï¼Œæˆ‘å¸Œæœ›é€šè¿‡æ‰«æé”€å”®æˆ–å…¬å¸äºŒç»´ç å®Œæˆæ³¨å†Œ

  Scenario: æ‰«æé”€å”®äºŒç»´ç æ³¨å†Œæ–°å…¬å¸
    Given æˆ‘æ‰«æäº†é”€å”®IDä¸º123çš„äºŒç»´ç 
    When æˆ‘æˆæƒå¾®ä¿¡è·å–openid
    And æˆ‘è¾“å…¥æ‰‹æœºå·"13800138000"
    And æˆ‘å¡«å†™ä¸ªäººä¿¡æ¯å’Œæ–°å…¬å¸ä¿¡æ¯
    And æˆ‘å‹¾é€‰éšç§åè®®ï¼ˆç‰ˆæœ¬v1.0ï¼‰
    And æˆ‘æäº¤æ³¨å†Œ
    Then ç³»ç»Ÿåˆ›å»ºæ–°å…¬å¸è®°å½•ï¼ŒçŠ¶æ€ä¸ºpending
    And é”€å”®123æ”¶åˆ°æ³¨å†Œé€šçŸ¥é‚®ä»¶
    And æˆ‘çœ‹åˆ°â€œæ³¨å†Œç”³è¯·å·²æäº¤â€æç¤º

  Scenario: æ‰«æå…¬å¸äºŒç»´ç æ³¨å†Œï¼Œæ— é”€å”®ç 
    Given æˆ‘æ‰«æäº†å…¬å¸äºŒç»´ç ï¼ˆæ— sceneå‚æ•°ï¼‰
    When æˆ‘å¡«å†™å…¬å¸ä¸»è¥ä¸šåŠ¡åŸå¸‚ä¸º["ä¸Šæµ·å¸‚"]
    And æˆ‘å®Œæˆæ³¨å†Œ
    Then ç³»ç»Ÿæ ¹æ®MainOperatingCitiesç¬¬ä¸€ä¸ªåŸå¸‚åŒ¹é…Branch Manager
    And Branch Manageræ”¶åˆ°é€šçŸ¥
```

##### 4.2.1.2 ç™»å½•ä¸å…¬å¸åˆ‡æ¢

**features/login.feature**

```gherkin
Feature: æ‰‹æœºå·ç™»å½•ä¸å…¬å¸åˆ‡æ¢
  ä½œä¸ºå·²æ³¨å†Œç”¨æˆ·ï¼Œæˆ‘å¸Œæœ›é€šè¿‡æ‰‹æœºå·ç™»å½•å¹¶åˆ‡æ¢å…¬å¸

  Scenario: ç»‘å®šå¤šä¸ªå…¬å¸ï¼Œéœ€é€‰æ‹©
    Given æˆ‘ç»‘å®šäº†å…¬å¸Aï¼ˆactiveï¼‰å’Œå…¬å¸Bï¼ˆpendingï¼‰
    When æˆ‘è¾“å…¥æ‰‹æœºå·å¹¶éªŒè¯éªŒè¯ç 
    Then æˆ‘çœ‹åˆ°å…¬å¸é€‰æ‹©é¡µé¢
    When æˆ‘é€‰æ‹©å…¬å¸A
    Then æˆ‘è¿›å…¥ä¸»é¡µï¼Œæƒé™ä¸ºactive

  Scenario: æ›´æ¢è®¾å¤‡ç™»å½•ï¼Œæ›¿æ¢openid
    Given æˆ‘åœ¨è®¾å¤‡1ç™»å½•è¿‡
    When æˆ‘åœ¨è®¾å¤‡2è¾“å…¥æ‰‹æœºå·å¹¶éªŒè¯éªŒè¯ç 
    Then ç³»ç»Ÿæ›´æ–°æˆ‘çš„openidä¸ºè®¾å¤‡2çš„å€¼
```

##### 4.2.1.3 MyInfo ä¿¡æ¯ç»´æŠ¤

**features/myinfo.feature**

```gherkin
Feature: ç¼–è¾‘ä¸ªäººä¿¡æ¯ä¸å…¬å¸ä¿¡æ¯
  ä½œä¸ºç”¨æˆ·ï¼Œæˆ‘å¸Œæœ›å®‰å…¨åœ°æ›´æ–°æˆ‘çš„ä¿¡æ¯

  Scenario: pendingçŠ¶æ€ä¸‹ç¼–è¾‘å…¬å¸ä¿¡æ¯
    Given æˆ‘çš„PartnerçŠ¶æ€ä¸ºpending
    When æˆ‘è¿›å…¥å…¬å¸ä¿¡æ¯é¡µ
    Then æ‰€æœ‰å­—æ®µå¯ç¼–è¾‘

  Scenario: activeçŠ¶æ€ä¸‹å…¬å¸ä¿¡æ¯åªè¯»
    Given æˆ‘çš„PartnerçŠ¶æ€ä¸ºactive
    When æˆ‘è¿›å…¥å…¬å¸ä¿¡æ¯é¡µ
    Then å…¬å¸å­—æ®µä¸ºåªè¯»

  Scenario: ä¿®æ”¹æ‰‹æœºå·éœ€çŸ­ä¿¡éªŒè¯
    Given æˆ‘å½“å‰æ‰‹æœºå·ä¸º"13800138000"
    When æˆ‘è¾“å…¥æ–°æ‰‹æœºå·"13900139000"
    And æˆ‘è¾“å…¥éªŒè¯ç 
    Then æ‰‹æœºå·æ›´æ–°æˆåŠŸ
```

##### 4.2.1.4 Inquiry é—®è¯¢æµç¨‹

**features/inquiry.feature**

```gherkin
Feature: å‘èµ·é—®è¯¢ä¸è¯„ä»·
  ä½œä¸ºPartnerï¼Œæˆ‘å¸Œæœ›æäº¤æŠ€æœ¯é—®é¢˜å¹¶è¯„ä»·å›å¤

  Scenario: pendingç”¨æˆ·åªèƒ½çœ‹åˆ°è‡ªå·±åˆ›å»ºçš„é—®è¯¢
    Given æˆ‘çš„çŠ¶æ€ä¸ºpending
    When æˆ‘è¿›å…¥é—®è¯¢é¡µé¢
    Then æˆ‘åªèƒ½çœ‹åˆ°è‡ªå·±åˆ›å»ºçš„è®°å½•

  Scenario: é”€å”®å›å¤åè¿›å…¥RatingçŠ¶æ€
    Given æˆ‘æœ‰ä¸€æ¡OpençŠ¶æ€é—®è¯¢
    When é”€å”®å›å¤æˆ‘çš„é—®é¢˜
    Then æˆ‘æ”¶åˆ°å¾®ä¿¡é€šçŸ¥
    And é—®è¯¢å‡ºç°åœ¨Ratingåˆ—è¡¨ï¼Œ30å¤©å†…éœ€è¯„ä»·

  Scenario: 30å¤©æœªè¯„ä»·è‡ªåŠ¨å…³é—­
    Given æˆ‘æœ‰ä¸€æ¡RatingçŠ¶æ€é—®è¯¢ï¼ŒRatingDeadlineå·²è¿‡
    When æˆ‘åˆ·æ–°é¡µé¢
    Then é—®è¯¢çŠ¶æ€å˜ä¸ºClosed
```

##### 4.2.1.5 Project é¡¹ç›®ç®¡ç†

**features/project.feature**

```gherkin
Feature: åˆ›å»ºé¡¹ç›®ä¸å¤„ç†TKEåˆ†é…

  Scenario: åˆ›å»ºæ–°é¡¹ç›®ï¼Œé»˜è®¤Pre-Lead
    Given æˆ‘å¤„äºactiveçŠ¶æ€
    When æˆ‘åˆ›å»ºé¡¹ç›®"ä¸‡è¾¾æ”¹é€ "
    Then é¡¹ç›®çŠ¶æ€ä¸ºPre-Lead
    And é¡¹ç›®å‡ºç°åœ¨Ongoingåˆ—è¡¨

  Scenario: TKEé¡¹ç›®24å°æ—¶æœªå¤„ç†è‡ªåŠ¨å–æ¶ˆ
    Given æˆ‘æ”¶åˆ°TKEé¡¹ç›®"å›½è´¸ä¸‰æœŸ"
    When 24å°æ—¶å†…æœªæ“ä½œ
    Then é¡¹ç›®ä¸å†æ˜¾ç¤º
    And é”€å”®æ”¶åˆ°å–æ¶ˆé€šçŸ¥

  Scenario: æ¥å—TKEé¡¹ç›®åè¿›å…¥Ongoing
    Given æˆ‘æ”¶åˆ°TKEé¡¹ç›®
    When æˆ‘ç‚¹å‡»"æ¥å—"
    Then é¡¹ç›®ç§»å…¥Ongoingåˆ—è¡¨
```

##### 4.2.1.6 TKE Library æ–‡ä»¶è®¿é—®

**features/Library.feature**

```gherkin
Feature: TKE Libraryæ–‡ä»¶æƒé™æ§åˆ¶

  Scenario: pendingç”¨æˆ·åªèƒ½è®¿é—®pending_partnerçº§åˆ«æ–‡ä»¶
    Given æˆ‘çš„çŠ¶æ€ä¸ºpending
    When æˆ‘è¿›å…¥TKE Library
    Then æˆ‘åªèƒ½çœ‹åˆ°Visiability=pending_partnerçš„æ–‡ä»¶

  Scenario: AGRç”¨æˆ·è®¿é—®signed_partneræ–‡ä»¶
    Given æˆ‘ç»‘å®šçš„å…¬å¸CompanyStatus=1
    When æˆ‘è¿›å…¥TKE Library
    Then æˆ‘å¯ä»¥çœ‹åˆ°Visiability=signed_partnerçš„æ–‡ä»¶
```

##### 4.2.1.7 AGR è·³è½¬æµç¨‹

**features/agr.feature**

```gherkin
Feature: AGRå…¬å¸è‡ªåŠ¨è·³è½¬

  Scenario: é€‰æ‹©AGRå…¬å¸åè·³è½¬View
    Given æˆ‘ç»‘å®šäº†CompanyStatus=1çš„å…¬å¸
    When æˆ‘åœ¨ç™»å½•åé€‰æ‹©è¯¥å…¬å¸
    Then ç³»ç»Ÿè¿”å› action='jump' å’Œ jumpUrl
    And å‰ç«¯è·³è½¬è‡³View AGR Homepage

  Scenario: éAGRå…¬å¸æ­£å¸¸è¿›å…¥Portal
    Given æˆ‘é€‰æ‹©çš„å…¬å¸CompanyStatusâ‰ 1
    When æˆ‘å®Œæˆç™»å½•
    Then ç³»ç»Ÿè¿”å› action='normal'
    And è¿›å…¥Portalä¸»é¡µ
```

## 5. Viewç«¯å…¬å…±ç»„ä»¶è®¾è®¡

### 5.1 æ•°æ®æ¥æ”¶è·¯ç”±ç»„ä»¶

#### 5.1.1 ModChannelDataReceiver

- **æ¦‚è¿°**:CNViewç«¯æ¸ é“æ•°æ®æ¥æ”¶è·¯ç”±ç»„ä»¶ï¼Œä½œä¸ºPortalç«¯æ•°æ®åŒæ­¥çš„ç»Ÿä¸€å…¥å£ï¼Œè´Ÿè´£æ¥æ”¶ã€è§£æã€éªŒè¯å’Œåˆ†å‘æ¥è‡ªPortalç«¯çš„å„ç±»æ•°æ®è¯·æ±‚ã€‚
- **ä»£ç è·¯å¾„**:`vivid\app\Http\Controllers\ModChannelDataReceiver.php`
- **æ–‡ä»¶çŠ¶æ€**:æ–°å¢
- **æ ¸å¿ƒèŒè´£**:æ¥æ”¶Portalæ•°æ® â†’ éªŒè¯æ•°æ®å®Œæ•´æ€§ â†’ åˆ†å‘ç»™å¯¹åº”ä¸šåŠ¡æœåŠ¡
- **æ¥å£å®šä¹‰**:
  - **receive(Request $request)**
    - **åŠŸèƒ½æè¿°**:ç»Ÿä¸€æ•°æ®æ¥æ”¶å…¥å£ï¼Œæ ¹æ®æ•°æ®ç±»å‹åˆ†å‘ç»™å¯¹åº”å¤„ç†æœåŠ¡
    - **è¯·æ±‚å‚æ•°**:

      | å‚æ•°åç§° | ç±»å‹ | å¿…å¡« | æè¿° |
      |----------|------|------|------|
      | dataType | String | æ˜¯ | æ•°æ®ç±»å‹ï¼ˆ`userRegistration`/`inquiryCreate`/`projectCreate`/`inquiryRating`/`projectResponse`/`userUpdate`/`userDeactivation`ï¼‰ |
      | dataPayload | Object | æ˜¯ | å…·ä½“æ•°æ®å†…å®¹ |
      | sourceSystem | String | æ˜¯ | å›ºå®šä¸º "Portal" |
      | timestamp | String | æ˜¯ | ISO8601 æ—¶é—´æˆ³ |

    - **å“åº”æ•°æ®**:

      | å‚æ•°åç§° | ç±»å‹ | æè¿° |
      |----------|------|------|
      | success | Boolean | å¤„ç†æ˜¯å¦æˆåŠŸ |
      | message | String | å¤„ç†ç»“æœä¿¡æ¯ |

#### 5.1.2 æ•°æ®åˆ†å‘è·¯ç”±é€»è¾‘

åœ¨ `receive` æ–¹æ³•ä¸­ï¼Œæ ¹æ® `dataType` å°†è¯·æ±‚è·¯ç”±è‡³å¯¹åº” Handler:

```php
switch ($dataType) {
    // === Portal â†’ CNView:æ¨é€ï¼ˆè¢«åŠ¨æ¥æ”¶ï¼‰===
    case 'userRegistration':
        return app(UserRegistrationHandler::class)->handle($dataPayload);
    case 'userUpdate':
        return app(UserRegistrationHandler::class)->handleUpdate($dataPayload);
    case 'userDeactivation':
        return app(UserRegistrationHandler::class)->handleDeactivation($dataPayload);
    case 'inquiryCreate':
        return app(InquiryHandler::class)->handleCreate($dataPayload);
    case 'inquiryRating':
        return app(InquiryHandler::class)->handleRating($dataPayload);
    case 'projectCreate':
        return app(ProjectHandler::class)->handleCreate($dataPayload);
    case 'projectResponse':
        return app(ProjectHandler::class)->handleResponse($dataPayload);

    // === CNView â†’ Portal:æ‹‰å–ï¼ˆä¸»åŠ¨è¯·æ±‚ï¼‰===
    case 'pullUserData':
        return app(UserDataPullHandler::class)->handlePullUser($dataPayload);
    case 'pullInquiryList':
        return app(InquiryHandler::class)->handlePullList($dataPayload);
    case 'pullProjectList':
        return app(ProjectHandler::class)->handlePullList($dataPayload);

    default:
        throw new \Exception("Unsupported dataType: {$dataType}");
}
```

### 5.2 ä¸šåŠ¡æ•°æ®å¤„ç†æœåŠ¡ï¼ˆHandlerï¼‰

#### 5.2.1 UserRegistrationHandler

- **æ¦‚è¿°**:å¤„ç†Portalç«¯æ¨é€çš„ç”¨æˆ·æ³¨å†Œã€ä¿¡æ¯å˜æ›´åŠè´¦å·æ³¨é”€äº‹ä»¶ï¼Œç»´æŠ¤CNViewç«¯æ¸ é“ç”¨æˆ·ä¸»æ•°æ®ã€‚
- **ä»£ç è·¯å¾„**:`vivid\app\Services\ModChannelHandlers\UserRegistrationHandler.php`
- **æ–‡ä»¶çŠ¶æ€**:æ–°å¢
- **æ–¹æ³•**:
  - **handle($registrationData)**
    - **åŠŸèƒ½æè¿°**:å¤„ç†Portalç”¨æˆ·é¦–æ¬¡æ³¨å†Œäº‹ä»¶ï¼Œåˆ›å»ºCNViewç”¨æˆ·åŠå…³è”å…¬å¸æ¡£æ¡ˆ
    - **è¯·æ±‚å‚æ•°**:

      | å‚æ•°åç§° | ç±»å‹ | å¿…å¡« | æè¿° |
      |----------|------|------|------|
      | portalUserId | Integer | æ˜¯ | Portalç”¨æˆ·å”¯ä¸€ID |
      | firstName | String | æ˜¯ | ç”¨æˆ·å§“æ° |
      | lastName | String | æ˜¯ | ç”¨æˆ·åå­— |
      | mobile | String | æ˜¯ | æ‰‹æœºå· |
      | email | String | æ˜¯ | é‚®ç®± |
      | openId | String | æ˜¯ | å¾®ä¿¡OpenID |
      | companyInfo | Object | æ˜¯ | å…¬å¸ä¿¡æ¯å¯¹è±¡ |
      | companyInfo.companyName | String | æ˜¯ | å…¬å¸å…¨ç§° |
      | companyInfo.taxCode | String | æ˜¯ | ç»Ÿä¸€ç¤¾ä¼šä¿¡ç”¨ä»£ç  |
      | companyInfo.province | Integer | æ˜¯ | çœä»½ç¼–ç  |
      | companyInfo.city | Integer | æ˜¯ | åŸå¸‚ç¼–ç  |
      | companyInfo.district | Integer | æ˜¯ | åŒºå¿ç¼–ç  |
      | companyInfo.mainOperatingCities | Array | æ˜¯ | ä¸»è¥åŸå¸‚åˆ—è¡¨ï¼ˆåŸå¸‚ç¼–ç æ•°ç»„ï¼‰ |

    - **ä¸šåŠ¡é€»è¾‘**:
      1. æ ¡éªŒ `portalUserId` æ˜¯å¦å·²å­˜åœ¨ï¼Œè‹¥å­˜åœ¨åˆ™æ‹’ç»é‡å¤æ³¨å†Œï¼›
      2. åˆ›å»º CNView æ¸ é“ç”¨æˆ·è®°å½•ï¼ŒçŠ¶æ€ä¸º â€œinactiveâ€ï¼ˆç­‰å¾…å®¡æ‰¹ï¼‰ï¼›
      3. åˆ›å»ºæˆ–å…³è”å…¬å¸ä¸»æ•°æ®ï¼ˆé€šè¿‡ `taxCode` å”¯ä¸€æ€§åˆ¤æ–­ï¼‰ï¼›
      4. è®°å½•æ³¨å†Œæ—¶é—´ã€æ¥æºæ¸ é“ï¼ˆ`DataSource = 'portal'`ï¼‰ï¼›
      5. è§¦å‘å®¡æ‰¹æµç¨‹ï¼ˆè‡ªåŠ¨è¿›å…¥ Channel Partner Approval æ¨¡å—ï¼‰ï¼›
      6. è¿”å›å¤„ç†æˆåŠŸç»“æœã€‚

  - **handleUpdate($updateData)**
    - **åŠŸèƒ½æè¿°**:å¤„ç†Portalç”¨æˆ·æˆ–å…¬å¸ä¿¡æ¯å˜æ›´äº‹ä»¶
    - **è¯·æ±‚å‚æ•°**:

      | å‚æ•°åç§° | ç±»å‹ | å¿…å¡« | æè¿° |
      |----------|------|------|------|
      | portalUserId | Integer | æ˜¯ | Portalç”¨æˆ·å”¯ä¸€ID |
      | firstName | String | å¦ | å§“æ°ï¼ˆå˜æ›´æ—¶æä¾›ï¼‰ |
      | lastName | String | å¦ | åå­—ï¼ˆå˜æ›´æ—¶æä¾›ï¼‰ |
      | email | String | å¦ | é‚®ç®±ï¼ˆå˜æ›´æ—¶æä¾›ï¼‰ |
      | mobile | String | å¦ | æ‰‹æœºå·ï¼ˆå˜æ›´æ—¶æä¾›ï¼‰ |
      | companyInfo | Object | å¦ | å…¬å¸ä¿¡æ¯å˜æ›´éƒ¨åˆ† |

    - **ä¸šåŠ¡é€»è¾‘**:
      1. æ ¹æ® `portalUserId` æŸ¥æ‰¾æœ¬åœ°ç”¨æˆ·è®°å½•ï¼›
      2. æ›´æ–°ç”¨æˆ·å­—æ®µï¼ˆä»…æ›´æ–°éç©ºå­—æ®µï¼‰ï¼›
      3. åŒæ­¥æ›´æ–°å…³è”å…¬å¸ä¿¡æ¯ï¼ˆå¦‚ä¸»è¥ä¸šåŠ¡ã€ä¸»è¥åŸå¸‚ï¼‰ï¼›
      4. è®°å½•å˜æ›´æ—¥å¿—åˆ° `audit_log` è¡¨ï¼ˆå«å˜æ›´å‰/åå€¼ï¼‰ï¼›
      5. è§¦å‘æ•°æ®ä¸€è‡´æ€§æ ¡éªŒä»»åŠ¡ï¼ˆç¡®ä¿ä¸ Portal ç«¯åŒæ­¥ï¼‰ã€‚

  - **handleDeactivation($deactivationData)**
    - **åŠŸèƒ½æè¿°**:å¤„ç†Portalç”¨æˆ·è´¦å·æ³¨é”€æˆ–åœç”¨äº‹ä»¶
    - **è¯·æ±‚å‚æ•°**:

      | å‚æ•°åç§° | ç±»å‹ | å¿…å¡« | æè¿° |
      |----------|------|------|------|
      | portalUserId | Integer | æ˜¯ | Portalç”¨æˆ·å”¯ä¸€ID |
      | deactivationReason | String | æ˜¯ | æ³¨é”€åŸå› ï¼ˆå¦‚â€œä¸»åŠ¨æ³¨é”€â€ã€â€œè¿è§„å°ç¦â€ï¼‰ |
      | deactivationTime | String | æ˜¯ | æ³¨é”€æ—¶é—´ï¼ˆISO8601æ ¼å¼ï¼‰ |

    - **ä¸šåŠ¡é€»è¾‘**:
      1. æŸ¥æ‰¾æœ¬åœ°ç”¨æˆ·è®°å½•ï¼›
      2. å°†ç”¨æˆ·çŠ¶æ€æ›´æ–°ä¸º â€œinactiveâ€ï¼›
      3. å†»ç»“è¯¥ç”¨æˆ·åˆ›å»ºçš„æ‰€æœ‰é—®è¯¢ã€é¡¹ç›®æ“ä½œæƒé™ï¼›
      4. è®°å½•æ³¨é”€æ—¶é—´ä¸åŸå› ï¼›
      5. é€šçŸ¥é£æ§ç³»ç»Ÿè¿›è¡Œåç»­å¤„ç†ã€‚

#### 5.2.2 InquiryHandler

- **æ¦‚è¿°**:å¤„ç†Portalç«¯æ¨é€çš„é—®è¯¢åˆ›å»ºã€è¯„ä»·äº‹ä»¶ï¼Œä»¥åŠCNViewç«¯ä¸»åŠ¨æ‹‰å–é—®è¯¢åˆ—è¡¨è¯·æ±‚ã€‚
- **ä»£ç è·¯å¾„**:`vivid\app\Services\ModChannelHandlers\InquiryHandler.php`
- **æ–‡ä»¶çŠ¶æ€**:æ–°å¢
- **æ–¹æ³•**:
  - **handleCreate($inquiryData)**
    - **åŠŸèƒ½æè¿°**:å¤„ç†Portalç”¨æˆ·åˆ›å»ºæ–°é—®è¯¢äº‹ä»¶
    - **è¯·æ±‚å‚æ•°**:

      | å‚æ•°åç§° | ç±»å‹ | å¿…å¡« | æè¿° |
      |----------|------|------|------|
      | portalInquiryId | Integer | æ˜¯ | Portalé—®è¯¢å”¯ä¸€ID |
      | portalUserId | Integer | æ˜¯ | åˆ›å»ºç”¨æˆ·ID |
      | portalCompanyId | Integer | æ˜¯ | æ‰€å±å…¬å¸ID |
      | title | String | æ˜¯ | é—®è¯¢æ ‡é¢˜ |
      | content | String | æ˜¯ | é—®è¯¢å†…å®¹ |
      | categoryId | Integer | æ˜¯ | åˆ†ç±»ID |
      | createdDate | String | æ˜¯ | åˆ›å»ºæ—¶é—´ï¼ˆISO8601ï¼‰ |

    - **ä¸šåŠ¡é€»è¾‘**:
      1. æ ¡éªŒ `portalInquiryId` æ˜¯å¦é‡å¤ï¼›
      2. åˆ›å»º CNView é—®è¯¢å·¥å•ï¼ŒçŠ¶æ€ä¸º â€œå¾…åˆ†é…â€ï¼›
      3. å…³è”ç”¨æˆ·ä¸å…¬å¸ä¿¡æ¯ï¼›
      4. è§¦å‘é”€å”®åˆ†é…è§„åˆ™ï¼ˆè‡ªåŠ¨åˆ†é…æˆ–è¿›å…¥å¾…åˆ†é…æ± ï¼‰ï¼›
      5. è¿”å›åˆ›å»ºæˆåŠŸç»“æœã€‚

  - **handleRating($ratingData)**
    - **åŠŸèƒ½æè¿°**:å¤„ç†Portalç”¨æˆ·å¯¹å·²å¤„ç†é—®è¯¢çš„è¯„åˆ†ä¸åé¦ˆ
    - **è¯·æ±‚å‚æ•°**:

      | å‚æ•°åç§° | ç±»å‹ | å¿…å¡« | æè¿° |
      |----------|------|------|------|
      | portalInquiryId | Integer | æ˜¯ | Portalé—®è¯¢ID |
      | ratingScore | Integer | æ˜¯ | è¯„åˆ†ï¼ˆ1-5åˆ†ï¼‰ |
      | feedbackComment | String | å¦ | æ–‡å­—åé¦ˆ |
      | ratedAt | String | æ˜¯ | è¯„åˆ†æ—¶é—´ï¼ˆISO8601ï¼‰ |

    - **ä¸šåŠ¡é€»è¾‘**:
      1. æ ¹æ® `portalInquiryId` æŸ¥æ‰¾æœ¬åœ°é—®è¯¢ï¼›
      2. æ›´æ–°é—®è¯¢çŠ¶æ€ä¸º â€œå·²è¯„ä»·â€ï¼›
      3. è®°å½•è¯„åˆ†ä¸åé¦ˆå†…å®¹åˆ° `inquiry_ratings` è¡¨ï¼›
      4. æ›´æ–°å…³è”é”€å”®ç»©æ•ˆæ•°æ®ï¼›
      5. è§¦å‘æ»¡æ„åº¦åˆ†æä»»åŠ¡ï¼ˆç”¨äºæœˆåº¦æŠ¥å‘Šï¼‰ã€‚

  - **handlePullList($pullRequest)**
    - **åŠŸèƒ½æè¿°**:CNViewä¸»åŠ¨æ‹‰å–Portalç«¯æŒ‡å®šç”¨æˆ·æˆ–å…¬å¸çš„é—®è¯¢åˆ—è¡¨
    - **è¯·æ±‚å‚æ•°**:

      | å‚æ•°åç§° | ç±»å‹ | å¿…å¡« | æè¿° |
      |----------|------|------|------|
      | portalUserId | Integer | å¦ | Portalç”¨æˆ·IDï¼ˆä¸companyIdäºŒé€‰ä¸€ï¼‰ |
      | portalCompanyId | Integer | å¦ | Portalå…¬å¸ID |
      | statusFilter | String | å¦ | çŠ¶æ€è¿‡æ»¤ï¼ˆopen/rating/closedï¼‰ |
      | page | Integer | å¦ | é¡µç ï¼Œé»˜è®¤1 |
      | pageSize | Integer | å¦ | æ¯é¡µæ•°é‡ï¼Œé»˜è®¤100 |

    - **ä¸šåŠ¡é€»è¾‘**:
      1. è°ƒç”¨ Portal API `/api/intersystem/inquiries`ï¼›
      2. ä¼ å…¥ç”¨æˆ·/å…¬å¸ ID åŠè¿‡æ»¤æ¡ä»¶ï¼›
      3. è§£æè¿”å›çš„é—®è¯¢åˆ—è¡¨ï¼›
      4. æ ‡å‡†åŒ–å­—æ®µåè¿”å›ç»™ CNView è°ƒç”¨æ–¹ï¼›
      5. è®°å½•æ‹‰å–æ“ä½œæ—¥å¿—ï¼ˆå«è°ƒç”¨æ–¹ã€æ—¶é—´ã€è®°å½•æ•°ï¼‰ã€‚

#### 5.2.3 ProjectHandler

- **æ¦‚è¿°**:å¤„ç†Portalç«¯æ¨é€çš„é¡¹ç›®åˆ›å»ºã€æ›´æ–°ã€å“åº”äº‹ä»¶ï¼Œä»¥åŠCNViewç«¯ä¸»åŠ¨æ‹‰å–é¡¹ç›®åˆ—è¡¨è¯·æ±‚ã€‚
- **ä»£ç è·¯å¾„**:`vivid\app\Services\ModChannelHandlers\ProjectHandler.php`
- **æ–‡ä»¶çŠ¶æ€**:æ–°å¢
- **æ–¹æ³•**:
  - **handleCreate($projectData)**
    - **åŠŸèƒ½æè¿°**:å¤„ç†Portalç”¨æˆ·åˆ›å»ºæ–°é¡¹ç›®äº‹ä»¶
    - **è¯·æ±‚å‚æ•°**:

      | å‚æ•°åç§° | ç±»å‹ | å¿…å¡« | æè¿° |
      |----------|------|------|------|
      | portalProjectId | Integer | æ˜¯ | Portalé¡¹ç›®å”¯ä¸€ID |
      | portalUserId | Integer | æ˜¯ | åˆ›å»ºç”¨æˆ·ID |
      | portalCompanyId | Integer | æ˜¯ | æ‰€å±å…¬å¸ID |
      | projectName | String | æ˜¯ | é¡¹ç›®åç§° |
      | contractValue | Decimal | æ˜¯ | åˆåŒé‡‘é¢ |
      | currency | String | æ˜¯ | å¸ç§ |
      | forecastTenderDate | String | æ˜¯ | é¢„è®¡æŠ¥ä»·æ—¥æœŸï¼ˆYYYY-MM-DDï¼‰ |
      | unitsCount | Integer | æ˜¯ | æ¢¯å°æ•° |

    - **ä¸šåŠ¡é€»è¾‘**:
      1. æ ¡éªŒ `portalProjectId` æ˜¯å¦é‡å¤ï¼›
      2. åˆ›å»ºé¡¹ç›®è®°å½•ï¼ŒçŠ¶æ€ä¸º â€œPre-Leadâ€ï¼›
      3. å…³è”ç”¨æˆ·ä¸å…¬å¸ä¿¡æ¯ï¼›
      4. è®°å½•åˆ›å»ºæ—¶é—´ã€æ•°æ®æ¥æºï¼ˆ`DataSource = 'portal'`ï¼‰ï¼›
      5. è¿”å›åˆ›å»ºæˆåŠŸç»“æœã€‚

  - **handleResponse($responseData)**
    - **åŠŸèƒ½æè¿°**:å¤„ç†Portalç”¨æˆ·å¯¹TKEé¡¹ç›®çš„æ¥å—/æ‹’ç»
    - **è¯·æ±‚å‚æ•°**:

      | å‚æ•°åç§° | ç±»å‹ | å¿…å¡« | æè¿° |
      |----------|------|------|------|
      | portalProjectId | Integer | æ˜¯ | Portalé¡¹ç›®ID |
      | action | String | æ˜¯ | æ“ä½œï¼ˆ`accept`/`reject`ï¼‰ |
      | responseTime | String | æ˜¯ | å“åº”æ—¶é—´ï¼ˆISO8601ï¼‰ |

    - **ä¸šåŠ¡é€»è¾‘**:
      1. æ ¹æ® `portalProjectId` æŸ¥æ‰¾é¡¹ç›®ï¼›
      2. æ›´æ–° `AcceptanceStatus`ï¼ˆaccepted/rejectedï¼‰ï¼›
      3. è‹¥ä¸º â€œacceptedâ€ï¼Œè®¾ç½®é¡¹ç›®ä¸º â€œOngoingâ€ï¼›
      4. è‹¥ä¸º â€œrejectedâ€ï¼Œè®°å½•æ‹’ç»åŸå› ï¼›
      5. é€šçŸ¥é”€å”®æŸ¥çœ‹å“åº”ç»“æœï¼›
      6. è®°å½•å“åº”æ—¶é—´ç”¨äº SLA ç»Ÿè®¡ã€‚

  - **handlePullList($pullRequest)**
    - **åŠŸèƒ½æè¿°**:CNViewä¸»åŠ¨æ‹‰å–Portalç«¯æŒ‡å®šç”¨æˆ·æˆ–å…¬å¸çš„é¡¹ç›®åˆ—è¡¨
    - **è¯·æ±‚å‚æ•°**:

      | å‚æ•°åç§° | ç±»å‹ | å¿…å¡« | æè¿° |
      |----------|------|------|------|
      | portalUserId | Integer | å¦ | Portalç”¨æˆ·ID |
      | portalCompanyId | Integer | å¦ | Portalå…¬å¸ID |
      | statusFilter | String | å¦ | é¡¹ç›®çŠ¶æ€è¿‡æ»¤ |
      | includeArchived | Boolean | å¦ | æ˜¯å¦åŒ…å«å½’æ¡£é¡¹ç›® |
      | page | Integer | å¦ | é¡µç  |
      | pageSize | Integer | å¦ | æ¯é¡µæ•°é‡ |

    - **ä¸šåŠ¡é€»è¾‘**:
      1. è°ƒç”¨ Portal é¡¹ç›®åˆ—è¡¨ APIï¼›
      2. æ”¯æŒå¤šç»´åº¦è¿‡æ»¤ï¼ˆçŠ¶æ€ã€æ—¶é—´ã€å…¬å¸ï¼‰ï¼›
      3. è¿”å›ç»“æ„åŒ–é¡¹ç›®æ•°æ®ï¼›
      4. è®°å½•æ‹‰å–æ—¥å¿—ï¼ˆç”¨äºå®¡è®¡ï¼‰ã€‚

#### 5.2.4 UserDataPullHandler

- **æ¦‚è¿°**:å¤„ç†CNViewç«¯ä¸»åŠ¨æ‹‰å–Portalç”¨æˆ·å®Œæ•´æ¡£æ¡ˆçš„è¯·æ±‚ï¼Œè¿”å›ç”¨æˆ·+å…¬å¸ä¸€ä½“åŒ–æ•°æ®ã€‚
- **ä»£ç è·¯å¾„**:`vivid\app\Services\ModChannelHandlers\UserDataPullHandler.php`
- **æ–‡ä»¶çŠ¶æ€**:æ–°å¢
- **æ–¹æ³•**:
  - **handlePullUser($pullRequest)**
    - **åŠŸèƒ½æè¿°**:æ‹‰å–Portalä¸ŠæŸç”¨æˆ·çš„æœ€æ–°å®Œæ•´æ¡£æ¡ˆï¼ŒåŒ…å«ç”¨æˆ·ä¿¡æ¯ä¸å…¬å¸ä¿¡æ¯ï¼Œç»“æ„ä¸userRegistrationæ¨é€å®Œå…¨ä¸€è‡´
    - **è¯·æ±‚å‚æ•°**:

      | å‚æ•°åç§° | ç±»å‹ | å¿…å¡« | æè¿° |
      |----------|------|------|------|
      | portalUserId | Integer | æ˜¯ | Portalç”¨æˆ·å”¯ä¸€ID |
      | purpose | String | æ˜¯ | æ‹‰å–ç›®çš„ï¼ˆ`approval`/`validation`/`statistics`ï¼‰ |

    - **ä¸šåŠ¡é€»è¾‘**:
      1. è°ƒç”¨ Portal æ¥å£ `/api/intersystem/user-profile/{portalUserId}`ï¼›
      2. éªŒè¯æ¥å£è¿”å›çŠ¶æ€ï¼ˆ404/500 éœ€é‡è¯•ï¼‰ï¼›
      3. è§£æå¹¶æ ‡å‡†åŒ–ç”¨æˆ·ä¸å…¬å¸æ•°æ®ï¼›
      4. è¿”å›ä¸æ³¨å†Œæ¨é€å®Œå…¨ä¸€è‡´çš„ç»“æ„ï¼›
      5. è®°å½•æ‹‰å–æ“ä½œæ—¥å¿—ï¼ˆå« `purpose`:approval/validation/statisticsï¼‰ã€‚

---

### 5.3 æ•°æ®æ¨é€ç»„ä»¶

#### 5.3.1 ModChannelDataSender

- **æ¦‚è¿°**:CNViewç«¯å‘Portalç«¯æ¨é€æ•°æ®çš„ç»Ÿä¸€ç»„ä»¶ã€‚
- **ä»£ç è·¯å¾„**:`vivid\app\Services\ModChannelDataSender.php`
- **æ–‡ä»¶çŠ¶æ€**:æ–°å¢
- **æ ¸å¿ƒèŒè´£**:æ ¼å¼åŒ–æ•°æ® â†’ è°ƒç”¨Portalç«¯API â†’ å¤„ç†æ¨é€ç»“æœ
- **æ¥å£å®šä¹‰**:
  - **sendToPortal($dataType, $payload)**
    - **åŠŸèƒ½æè¿°**:é€šç”¨æ¨é€æ–¹æ³•ï¼Œæ‰€æœ‰ CNView â†’ Portal çš„æ•°æ®åŒæ­¥å‡é€šè¿‡æ­¤æ–¹æ³•å‘é€
    - **è¯·æ±‚å‚æ•°**:

      | å‚æ•°åç§° | ç±»å‹ | å¿…å¡« | æè¿° |
      |----------|------|------|------|
      | dataType | String | æ˜¯ | æ•°æ®ç±»å‹æ ‡è¯† |
      | payload | Array | æ˜¯ | ä¸šåŠ¡æ•°æ®å†…å®¹ |

    - **è°ƒç”¨æ–¹å¼**:ç»Ÿä¸€è°ƒç”¨ Portal ç«¯ `InterSystemService` çš„ `/api/intersystem/push-from-cnview` æ¥å£

  - **sendApprovalResult($approvalData)**
    - **åŠŸèƒ½æè¿°**:å‘é€å®¡æ‰¹ç»“æœåˆ°Portalç«¯
    - **è¯·æ±‚å‚æ•°**:

      | å‚æ•°åç§° | ç±»å‹ | å¿…å¡« | æè¿° |
      |----------|------|------|------|
      | approvalAction | String | æ˜¯ | å®¡æ‰¹åŠ¨ä½œï¼ˆ`approved`/`rejected`ï¼‰ |
      | portalUserId | Integer | æ˜¯ | Portalç«¯ç”¨æˆ·ID |
      | portalCompanyId | Integer | æ˜¯ | Portalç«¯å…¬å¸ID |
      | approvalReason | String | å¦ | å®¡æ‰¹åŸå›  |
      | approvalDate | String | æ˜¯ | å®¡æ‰¹æ—¶é—´ï¼ˆISO8601ï¼‰ |

    - **æ¨é€ç¤ºä¾‹**:

      ```json
      {
        "dataType": "approvalResult",
        "dataPayload": {
          "approvalAction": "approved",
          "portalUserId": 101,
          "portalCompanyId": 201,
          "approvalReason": "èµ„è´¨ç¬¦åˆè¦æ±‚",
          "approvalDate": "2025-10-11T12:00:00Z"
        },
        "sourceSystem": "CNView",
        "timestamp": "2025-10-11T12:00:05Z"
      }
      ```

  - **sendInquiryReply($replyData)**
    - **åŠŸèƒ½æè¿°**:å‘é€é—®è¯¢å›å¤åˆ°Portalç«¯
    - **è¯·æ±‚å‚æ•°**:

      | å‚æ•°åç§° | ç±»å‹ | å¿…å¡« | æè¿° |
      |----------|------|------|------|
      | portalInquiryId | Integer | æ˜¯ | Portalç«¯é—®è¯¢ID |
      | replyContent | String | æ˜¯ | å›å¤å†…å®¹ |
      | repliedBy | Integer | æ˜¯ | å›å¤é”€å”®ID |
      | repliedName | String | æ˜¯ | å›å¤é”€å”®å§“å |
      | repliedDate | String | æ˜¯ | å›å¤æ—¶é—´ï¼ˆISO8601ï¼‰ |

    - **æ¨é€ç¤ºä¾‹**:

      ```json
      {
        "dataType": "inquiryReply",
        "dataPayload": {
          "portalInquiryId": 501,
          "replyContent": "å»ºè®®æ£€æŸ¥æ›³å¼•æœºæ¶¦æ»‘æƒ…å†µ",
          "repliedBy": 301,
          "repliedName": "å¼ é”€å”®",
          "repliedDate": "2025-10-11T14:30:00Z"
        },
        "sourceSystem": "CNView",
        "timestamp": "2025-10-11T14:30:05Z"
      }
      ```

  - **sendUserStatusUpdate($statusData)**
    - **åŠŸèƒ½æè¿°**:å‘é€ç”¨æˆ·çŠ¶æ€å˜æ›´åˆ°Portalç«¯
    - **è¯·æ±‚å‚æ•°**:

      | å‚æ•°åç§° | ç±»å‹ | å¿…å¡« | æè¿° |
      |----------|------|------|------|
      | portalUserId | Integer | æ˜¯ | Portalç«¯ç”¨æˆ·ID |
      | portalCompanyId | Integer | æ˜¯ | Portalç«¯å…¬å¸ID |
      | newContactStatus | String | æ˜¯ | æ–°è”ç³»äººçŠ¶æ€ï¼ˆ`active`/`inactive`ï¼‰ |
      | effectiveDate | String | æ˜¯ | ç”Ÿæ•ˆæ—¶é—´ï¼ˆISO8601ï¼‰ |
      | changedBy | Integer | æ˜¯ | å˜æ›´æ“ä½œäººID |

    - **æ¨é€ç¤ºä¾‹**:

      ```json
      {
        "dataType": "userStatusUpdate",
        "dataPayload": {
          "portalUserId": 101,
          "portalCompanyId": 201,
          "newContactStatus": "active",
          "effectiveDate": "2025-10-11T10:00:00Z",
          "changedBy": 301
        },
        "sourceSystem": "CNView",
        "timestamp": "2025-10-11T10:00:05Z"
      }
      ```

  - **sendUserDeactivation($deactivationData)**
    - **åŠŸèƒ½æè¿°**:å½“ CNView ä¸»åŠ¨åœç”¨æˆ–è§£ç»‘ç”¨æˆ·æ—¶ï¼Œé€šçŸ¥ Portal ç«¯åŒæ­¥ç¦ç”¨å…¶æ¸ é“æƒé™
    - **è¯·æ±‚å‚æ•°**:

      | å‚æ•°åç§° | ç±»å‹ | å¿…å¡« | æè¿° |
      |----------|------|------|------|
      | portalUserId | Integer | æ˜¯ | Portalç«¯ç”¨æˆ·ID |
      | portalCompanyId | Integer | æ˜¯ | Portalç«¯å…¬å¸ID |
      | deactivationReason | String | æ˜¯ | åœç”¨åŸå› ï¼ˆå¦‚ "manual_unbind", "violation", "client_request"ï¼‰ |
      | deactivatedBy | Integer | æ˜¯ | CNViewæ“ä½œäººID |

    - **æ¨é€ç¤ºä¾‹**:

      ```json
      {
        "dataType": "userDeactivation",
        "dataPayload": {
          "portalUserId": 101,
          "portalCompanyId": 201,
          "deactivationReason": "manual_unbind",
          "deactivatedBy": 301
        },
        "sourceSystem": "CNView",
        "timestamp": "2025-10-11T16:00:05Z"
      }
      ```

### 5.4 é€šçŸ¥æœåŠ¡ç»„ä»¶

#### 5.4.1 ModChannelNotificationService

- **æ¦‚è¿°**:CNViewç«¯é€šçŸ¥æœåŠ¡ï¼Œå¤ç”¨Portalç«¯çš„é€šçŸ¥èƒ½åŠ›
- **ä»£ç è·¯å¾„**:`vivid\app\Services\ModChannelNotificationService.php`
- **æ–‡ä»¶çŠ¶æ€**:æ–°å¢
- **æ ¸å¿ƒèŒè´£**:è°ƒç”¨Portalç«¯çš„é€šçŸ¥æœåŠ¡ï¼Œé¿å…é‡å¤å®ç°

**æ¥å£å®šä¹‰**:

- **sendWechatNotification($notificationData)**
  - **åŠŸèƒ½æè¿°**:å‘é€å¾®ä¿¡é€šçŸ¥
  - **è¯·æ±‚å‚æ•°**:

    | å‚æ•°åç§° | ç±»å‹ | å¿…å¡« | æè¿° |
    |----------|------|------|------|
    | openId | String | æ˜¯ | å¾®ä¿¡OpenID |
    | templateType | String | æ˜¯ | æ¨¡æ¿ç±»å‹(approval_result/project_assignment/inquiry_reply) |
    | templateData | Object | æ˜¯ | æ¨¡æ¿æ•°æ®å¯¹è±¡ |
    | templateData.companyName | String | æ˜¯ | å…¬å¸åç§° |
    | templateData.result | String | å¦ | ç»“æœæè¿° |
    | templateData.date | String | æ˜¯ | æ—¥æœŸ |

  - **å®ç°æ–¹å¼**:è°ƒç”¨Portalç«¯WechatMessageServiceçš„API
  
- **sendEmailNotification($emailData)**
  - **åŠŸèƒ½æè¿°**:å‘é€é‚®ä»¶é€šçŸ¥ç»™TKEé”€å”®
  - **è¯·æ±‚å‚æ•°**:

    | å‚æ•°åç§° | ç±»å‹ | å¿…å¡« | æè¿° |
    |----------|------|------|------|
    | toEmail | String | æ˜¯ | æ”¶ä»¶äººé‚®ç®± |
    | subject | String | æ˜¯ | é‚®ä»¶ä¸»é¢˜ |
    | content | String | æ˜¯ | é‚®ä»¶å†…å®¹ |
    | projectId | Integer | å¦ | é¡¹ç›®ID |
    | partnerName | String | å¦ | æ¸ é“å•†åç§° |

  - **å®ç°æ–¹å¼**:ä½¿ç”¨CNViewç«¯ç°æœ‰é‚®ä»¶æœåŠ¡

**å®ç°ç¤ºä¾‹**:

```php
public function sendWechatNotification($notificationData)
{
    $portalApiUrl = config('modchannel.portalBaseUrl') . '/api/wechat/send-template-message';
    
    $response = Http::timeout(30)->post($portalApiUrl, [
        'openId' => $notificationData['openId'],
        'templateType' => $notificationData['templateType'],
        'templateData' => $notificationData['templateData'],
    ]);
    
    // è®°å½•æ—¥å¿—
    $logger = DynamicLoggerFactory::getLogger("mod-channel", "notification");
    $logger->info(json_encode([
        'templateType' => $notificationData['templateType'],
        'success' => $response->successful()
    ]), 'å‘é€å¾®ä¿¡é€šçŸ¥');
    
    return $response->successful();
}
```

### 5.5 ModChannelé›†æˆé…ç½®ç®¡ç†

#### 5.5.1 é™æµæ§åˆ¶

ä½¿ç”¨Laravelå†…ç½®çš„é™æµä¸­é—´ä»¶throttleå®ç°APIé™æµ:

```php
// è·¯ç”±ä¸­ç›´æ¥ä½¿ç”¨Laravelé™æµ
Route::middleware(['throttle:60,1'])->group(function () {
    Route::post('/modchannel/receive', [ModChannelDataController::class, 'receive']);
});

// è‡ªå®šä¹‰é™æµè§„åˆ™
RateLimiter::for('modchannel-api', function (Request $request) {
    $config = config('modchannel.rate_limit');
    
    return $request->user()
        ? Limit::perMinute($config['user_requests_per_minute'])->by($request->user()->id)
        : Limit::perMinute($config['guest_requests_per_minute'])->by($request->ip());
});
```

#### 5.5.2 ç³»ç»Ÿé…ç½®

ä½¿ç”¨Laravel Configç³»ç»Ÿç®¡ç†é…ç½®:

```php
// config/modchannel.php
return [
    'portal' => [
        'base_url' => env('PORTAL_BASE_URL', 'https://portal.example.com'),
        'api_key' => env('PORTAL_API_KEY'),
        'timeout' => env('PORTAL_TIMEOUT', 30),
    ],
    'rate_limit' => [
        'api_requests_per_minute' => env('MODCHANNEL_API_RATE_LIMIT', 60),
        'user_requests_per_minute' => env('MODCHANNEL_USER_RATE_LIMIT', 10),
        'guest_requests_per_minute' => env('MODCHANNEL_GUEST_RATE_LIMIT', 5),
    ],
];

// ä½¿ç”¨
$portalUrl = config('modchannel.portal.base_url');
```

## 6. CNViewç«¯ ä¸šåŠ¡æµç¨‹è®¾è®¡

- **Viewç«¯æ–°å¢æƒé™**
![alt text](<026 - Permission-1.png>)

- **Viewç«¯æ–°å¢Menu**
![alt text](image-10.png)

### 6.1 Channel Partner Uploadæ¨¡å—

#### 6.1.1 ä¸šåŠ¡æµç¨‹

##### 6.1.1.1 ä¸šåŠ¡èƒŒæ™¯

- **èƒŒæ™¯**:æ½œåœ¨æ¸ é“æ¸ é“å•†æ‰¹é‡ä¸Šä¼ åŠŸèƒ½ï¼Œæ”¯æŒé€šè¿‡Excelæ¨¡æ¿æ‰¹é‡å¯¼å…¥æ¸ é“å•†ä¿¡æ¯ã€‚ç³»ç»Ÿæä¾›å®Œæ•´çš„ä¸Šä¼ ç”Ÿå‘½å‘¨æœŸç®¡ç†ï¼ŒåŒ…æ‹¬æ¨¡æ¿ä¸‹è½½ã€æ•°æ®éªŒè¯ã€é‡å¤æ£€æŸ¥ã€å¤±è´¥å¤„ç†å’Œå†å²è®°å½•ç®¡ç†ã€‚ä¸Šä¼ çš„æ¸ é“å•†åˆå§‹çŠ¶æ€ä¸ºéæ´»åŠ¨çŠ¶æ€ï¼Œéœ€è¦é€šè¿‡æ¸ é“æ¸ é“å•†ä»ªè¡¨æ¿è¿›è¡Œæ¿€æ´»ç®¡ç†ã€‚

- **ä¸»è¦æµç¨‹**
  - **æ¨¡æ¿ä¸‹è½½**
    - ç”¨æˆ·ä¸‹è½½æ ‡å‡†Excelä¸Šä¼ æ¨¡æ¿
    - æ¨¡æ¿åŒ…å«20ä¸ªå­—æ®µ:å…¬å¸åç§°ã€æ³•å®šä»£è¡¨äººã€æ³¨å†Œèµ„æœ¬ã€æˆç«‹æ—¥æœŸã€æ‰€å±çœä»½ã€æ‰€å±åŸå¸‚ã€æ‰€å±åŒºå¿ã€çº³ç¨äººè¯†åˆ«å·ã€æœ€æ–°å¹´æŠ¥åœ°å€ã€ç½‘å€ã€é‚®ç®±ã€æ–°æ¢¯é”€å”®ã€å®‰è£…ã€ç»´ä¿ã€å…¨æ”¹é€ ã€éƒ¨åˆ†æ”¹é€ ã€ç»´ä¿è®¾å¤‡æ•°é‡ã€è”ç³»äººå§“åã€è”ç³»äººæ‰‹æœºå·ã€è”ç³»äººé‚®ç®±ã€å…¶ä»–è”ç³»æ–¹å¼
    [Agent&Distributor_upload_tmplate](Agent&Distributor_upload_tmplate.xls)

  - **Partneræ•°æ®ä¸Šä¼ ** 
    - ç”¨æˆ·å¡«å†™æ¨¡æ¿å¹¶ä¸Šä¼ Excelæ–‡ä»¶
    - ç³»ç»Ÿè§£ææ–‡ä»¶å†…å®¹å¹¶è¿›è¡Œæ ¼å¼éªŒè¯
    - å•æ¬¡ä¸Šä¼ æœ€å¤šæ”¯æŒ1000æ¡è®°å½•
    ![alt text](<001 - Potential Channel Partner Upload-2.png>)
  
  - **æ•°æ®æ ¡éªŒ**
    - çº³ç¨äººè¯†åˆ«å·é‡å¤æ€§æ£€æŸ¥
    - **é‡å¤è®°å½•æ›¿æ¢è§„åˆ™**:
    - **ActiveçŠ¶æ€è®°å½•**:ç›´æ¥è·³è¿‡ï¼Œä¸å…è®¸æ›¿æ¢ï¼Œæ ‡è®°ä¸ºå¤±è´¥
    - **Inactive/DeclinedçŠ¶æ€è®°å½•**:å¼¹çª—æç¤ºç”¨æˆ·ç¡®è®¤æ˜¯å¦æ›¿æ¢
    - æ•°æ®å®Œæ•´æ€§å’Œæ ¼å¼éªŒè¯ï¼ˆå¿…å¡«å­—æ®µ:å…¬å¸åç§°ã€æ³•å®šä»£è¡¨äººã€æ‰€å±çœå¸‚åŒºã€è”ç³»äººå§“åã€è”ç³»äººæ‰‹æœºå·ï¼‰
    - ç”Ÿæˆæ ¡éªŒç»“æœå’Œé”™è¯¯æŠ¥å‘Š
    ![alt text](<002 - Potential Channel Partner Upload - Upload-2.png>)

  - **æ•°æ®ç»“æœå¤„ç†**
    - æˆåŠŸè®°å½•å¯¼å…¥ç³»ç»Ÿï¼ŒçŠ¶æ€è®¾ä¸ºéæ´»åŠ¨ï¼ˆinactiveï¼‰
    - å¤±è´¥è®°å½•ç”Ÿæˆé”™è¯¯Excelæ–‡ä»¶
    - æä¾›å¤±è´¥ç»“æœæ–‡ä»¶ä¸‹è½½
    - failå¤±è´¥çš„ Excel å­˜å‚¨åœ¨NAS

- **å¼‚å¸¸æµç¨‹**:
  - æ–‡ä»¶æ ¼å¼é”™è¯¯ â†’ æç¤ºæ ¼å¼è¦æ±‚å¹¶æ‹’ç»ä¸Šä¼ 
  - è¶…è¿‡1000æ¡è®°å½• â†’ æç¤ºè®°å½•æ•°é‡é™åˆ¶
  - çº³ç¨äººè¯†åˆ«å·é‡å¤å†²çª â†’
    - ActiveçŠ¶æ€:ç›´æ¥è·³è¿‡å¹¶æ ‡è®°å¤±è´¥ï¼Œä¸å¼¹çª—
    - Inactive/DeclinedçŠ¶æ€:å¼¹çª—ç¡®è®¤æ˜¯å¦æ›¿æ¢
  - éƒ¨åˆ†æˆåŠŸä¸Šä¼  â†’ ç”ŸæˆåŒ…å«å¤±è´¥è®°å½•çš„ç»“æœæ–‡ä»¶

- **æµç¨‹å›¾**:

```mermaid
flowchart TD
    START[è¿›å…¥ä¸Šä¼ é¡µé¢] --> DOWNLOAD[ä¸‹è½½Excelæ¨¡æ¿]
    DOWNLOAD --> FILL[å¡«å†™æ¸ é“å•†æ•°æ®]
    FILL --> UPLOAD[ä¸Šä¼ Excelæ–‡ä»¶]
    
    UPLOAD --> VALIDATE[æ–‡ä»¶æ ¼å¼éªŒè¯]
    VALIDATE --> COUNT{è®°å½•æ•°é‡æ£€æŸ¥}
    COUNT -->|è¶…è¿‡1000| ERROR1[æç¤ºè®°å½•æ•°é‡é™åˆ¶]
    COUNT -->|â‰¤1000| PARSE[è§£æExcelå†…å®¹]
    
    PARSE --> CHECK[æ•°æ®æ ¡éªŒ]
    CHECK --> DUPLICATE{TaxCodeé‡å¤æ£€æŸ¥}
    DUPLICATE -->|TaxCodeé‡å¤-Active| SKIP_ACTIVE[ç›´æ¥è·³è¿‡Activeè®°å½•å¹¶æ ‡è®°å¤±è´¥]
    DUPLICATE -->|TaxCodeé‡å¤-Inactive/Declined| CONFIRM[å¼¹çª—ç¡®è®¤æ›¿æ¢]
    DUPLICATE -->|æ— é‡å¤| IMPORT[å¯¼å…¥æ•°æ®]
    
    SKIP_ACTIVE --> IMPORT
    CONFIRM -->|ç¡®è®¤| REPLACE[æ›¿æ¢ç°æœ‰è®°å½•]
    CONFIRM -->|å–æ¶ˆ| SKIP[è·³è¿‡é‡å¤è®°å½•]
    
    REPLACE --> IMPORT
    SKIP --> IMPORT
    
    IMPORT --> RESULT[ç”Ÿæˆå¤„ç†ç»“æœ]
    RESULT --> SUCCESS{å¤„ç†ç»“æœ}
    SUCCESS -->|å…¨éƒ¨æˆåŠŸ| SUCCESS_FILE[ç”ŸæˆæˆåŠŸæŠ¥å‘Š]
    SUCCESS -->|éƒ¨åˆ†å¤±è´¥| ERROR_FILE[ç”Ÿæˆé”™è¯¯Excelæ–‡ä»¶]
    SUCCESS -->|å…¨éƒ¨å¤±è´¥| FAIL_FILE[ç”Ÿæˆå¤±è´¥æŠ¥å‘Š]
    
    SUCCESS_FILE --> HISTORY[è®°å½•ä¸Šä¼ å†å²å’Œé”™è¯¯æ±‡æ€»]
    ERROR_FILE --> HISTORY
    FAIL_FILE --> HISTORY
    
    HISTORY --> LIST[æ˜¾ç¤ºä¸Šä¼ åˆ—è¡¨]
    LIST --> DETAIL{æŸ¥çœ‹è¯¦æƒ…}
    DETAIL --> DOWNLOAD_ORIG[ä¸‹è½½åŸå§‹æ–‡ä»¶]
    DETAIL --> DOWNLOAD_RESULT[ä¸‹è½½ç»“æœæ–‡ä»¶]
    DETAIL --> VIEW_ERRORS[æŸ¥çœ‹é”™è¯¯æ±‡æ€»]
```

#### 6.1.2 å½±å“çš„æ•°æ®è¡¨

- Viewç«¯
  - **[mod_channel_partner_uploads](#table-mod_channel_partner_uploads)** : Viewç«¯ Uploadè®°å½•
  - **[mod_channel_partner_companies](#table-mod_channel_partner_companies)** : Viewç«¯ Upload CompanyåŸºç¡€ä¿¡æ¯è¡¨
  - **[mod_channel_partner_user](#table-mod_channel_partner_user)** : Viewç«¯ Upload UseråŸºç¡€ä¿¡æ¯è¡¨

#### 6.1.3 å‰ç«¯å®ç°

##### 6.1.3.1 è§†å›¾ç›®å½•ç»“æ„

```plaintext
/resources/views/partner-upload/
  index.blade.php              - ä¸Šä¼ ä¸»é¡µé¢ï¼ˆåŒ…å«ä¸Šä¼ åŒºåŸŸã€è¿›åº¦æ˜¾ç¤ºã€å†å²åˆ—è¡¨ï¼‰
  detail.blade.php             - ä¸Šä¼ è¯¦æƒ…é¡µé¢ï¼ˆæŸ¥çœ‹å…·ä½“ä¸Šä¼ è®°å½•è¯¦æƒ…ï¼‰
```

##### 6.1.3.2 å…³é”®è§†å›¾åŠŸèƒ½

- **index.blade.php** åŒ…å«:
  - æ¨¡æ¿ä¸‹è½½æŒ‰é’®
  - æ–‡ä»¶ä¸Šä¼ åŒºåŸŸï¼ˆæ‹–æ‹½/ç‚¹å‡»ä¸Šä¼ ï¼‰
  - ä¸Šä¼ è¿›åº¦æ¡
  - é‡å¤è®°å½•ç¡®è®¤å¼¹çª—ï¼ˆBootstrap Modalï¼‰
    - TaxCodeé‡å¤ç¡®è®¤å¼¹çª—
  - ä¸Šä¼ å†å²åˆ—è¡¨ï¼ˆåˆ†é¡µæ˜¾ç¤ºï¼‰
  - é”™è¯¯æ±‡æ€»å±•ç¤º

- **detail.blade.php** åŒ…å«:
  - ä¸Šä¼ è®°å½•åŸºæœ¬ä¿¡æ¯
  - å¤„ç†ç»“æœç»Ÿè®¡
  - é”™è¯¯è¯¦æƒ…åˆ—è¡¨
  - æ–‡ä»¶ä¸‹è½½é“¾æ¥

##### 6.1.3.3 è·¯ç”±è®¾è®¡

| HTTPæ–¹æ³• | ç«¯ç‚¹ | æè¿° |
|----------|------|------|
| GET | `/partner-upload` | ä¸Šä¼ ä¸»é¡µé¢ |
| GET | `/partner-upload/template` | ä¸‹è½½æ¨¡æ¿ |
| POST | `/partner-upload/upload` | æ–‡ä»¶ä¸Šä¼  |
| POST | `/partner-upload/confirm-duplicates` | ç¡®è®¤é‡å¤è®°å½•å¤„ç† |
| GET | `/partner-upload/history` | ä¸Šä¼ å†å²åˆ—è¡¨ |
| GET | `/partner-upload/{id}` | ä¸Šä¼ è¯¦æƒ…é¡µé¢ |
| GET | `/partner-upload/{id}/download/{type}` | ä¸‹è½½æ–‡ä»¶ |

##### 6.1.3.4 æ—¥å¿—è®°å½•

ä½¿ç”¨DynamicLoggerFactoryè¿›è¡Œæ¨¡å—åŒ–æ—¥å¿—è®°å½•:

```php
use VIEW\Util\Logger\DynamicLoggerFactory;

$logger = DynamicLoggerFactory::getLogger("sys", "partner-upload");
```

- **ç³»ç»Ÿé”™è¯¯æ—¥å¿—è®°å½•åœºæ™¯**:

  | æ“ä½œç±»å‹ | è®°å½•æ—¶æœº |
  |----------|----------|
  | file_parse_failed | Excelæ–‡ä»¶è§£æå¤±è´¥ |
  | validation_failed | æ•°æ®éªŒè¯å¤±è´¥ |
  | duplicate_check_failed | é‡å¤æ£€æŸ¥å¤±è´¥ |
  | import_failed | æ•°æ®å¯¼å…¥å¤±è´¥ |
  | result_generation_failed | ç»“æœæ–‡ä»¶ç”Ÿæˆå¤±è´¥ |
  | phone_parsing_failed | å¤šæ‰‹æœºå·è§£æå¤±è´¥ |

#### 6.1.5 åŠŸèƒ½å¼€å‘ä¸å®ç°

##### 6.1.5.1 ç±»å…³ç³»å›¾

```mermaid
classDiagram
    class PartnerUploadController {
        +index()
        +downloadTemplate()
        +uploadFile()
        +confirmDuplicates()
        +history()
        +getUploadDetail()
        +downloadOriginalFile()
        +downloadResultFile()
    }

    class PartnerUploadService {
        +processUploadFile(file, userId)
        +parseExcel(filePath)
        +validateData(data)
        +checkDuplicates(partners)
        +importPartners(partners, uploadId)
        +generateResultFile(uploadId)
        +getUploadHistory(userId)
        +getUploadDetail(uploadId)
        +downloadTemplate()
    }

    class DynamicLoggerFactory {
        +getLogger(system, module)
    }

    PartnerUploadController --> PartnerUploadService : ä¸šåŠ¡å¤„ç†
    PartnerUploadService --> DynamicLoggerFactory : æ—¥å¿—è®°å½•
```

##### 6.1.5.2 ä»£ç å®ç°

- **PartnerUploadController.php**
  - **æ–‡ä»¶è·¯å¾„**:`app/Http/Controllers/ModChannelPlatform/PartnerUploadController.php`
  - **æ–‡ä»¶çŠ¶æ€**:æ–°å¢
  - **æ–¹æ³•**:
    - **index()**
      - **åŠŸèƒ½æè¿°**:æ˜¾ç¤ºæ¸ é“å•†ä¸Šä¼ ä¸»é¡µé¢ï¼ŒåŒ…å«ä¸Šä¼ åŒºåŸŸå’Œæ¨¡æ¿ä¸‹è½½ã€‚
      - **æ–¹æ³•çŠ¶æ€**:æ–°å¢
      - **è°ƒç”¨é¡ºåº**:ç”¨æˆ·è®¿é—®ä¸Šä¼ é¡µé¢æ—¶è°ƒç”¨
      - **è¯·æ±‚å‚æ•°**:æ— 

      - **å“åº”æ•°æ®**:

        | å‚æ•°åç§° | æ•°æ®ç±»å‹ | æè¿° |
        |----------|----------|------|
        | view | Blade | index.blade.phpè§†å›¾ |

    - **downloadTemplate()**
      - **åŠŸèƒ½æè¿°**:ä¸‹è½½æ ‡å‡†Excelä¸Šä¼ æ¨¡æ¿ï¼ŒåŒ…å«20ä¸ªå­—æ®µï¼ˆåŒ…å«ä¸šåŠ¡ä¿¡æ¯å’Œè”ç³»äººç›¸å…³å­—æ®µï¼‰å’Œå­—æ®µè¯´æ˜ã€‚
      - **æ–¹æ³•çŠ¶æ€**:æ–°å¢
      - **è°ƒç”¨é¡ºåº**:ç”¨æˆ·ç‚¹å‡»ä¸‹è½½æ¨¡æ¿æŒ‰é’®æ—¶è°ƒç”¨
      - **ä¾èµ–æœåŠ¡**:PartnerUploadService
      - **è¯·æ±‚å‚æ•°**:æ— 

      - **å“åº”æ•°æ®**:

        | å‚æ•°åç§° | æ•°æ®ç±»å‹ | æè¿° |
        |----------|----------|------|
        | file | File | Excelæ¨¡æ¿æ–‡ä»¶æµ |
        | filename | String | æ¸ é“å•†ä¸Šä¼ æ¨¡æ¿.xlsx |
        | contentType | String | application/vnd.openxmlformats-officedocument.spreadsheetml.sheet |

    - **uploadFile()**
      - **åŠŸèƒ½æè¿°**:å¤„ç†Excelæ–‡ä»¶ä¸Šä¼ ï¼Œè§£ææ•°æ®å¹¶è¿›è¡Œæ ¡éªŒï¼Œå¤„ç†TaxCodeå’ŒContactPhoneé‡å¤è®°å½•ç¡®è®¤ï¼Œç”Ÿæˆå¤„ç†ç»“æœå’Œé”™è¯¯æ±‡æ€»ã€‚é›†æˆå®Œæ•´æ—¥å¿—è®°å½•ã€‚
      - **æ–¹æ³•çŠ¶æ€**:æ–°å¢
      - **è°ƒç”¨é¡ºåº**:ç”¨æˆ·ä¸Šä¼ Excelæ–‡ä»¶æ—¶è°ƒç”¨
      - **ä¾èµ–æœåŠ¡**:PartnerUploadService
      - **è¯·æ±‚å‚æ•°**:

        | å‚æ•°åç§° | æ•°æ®ç±»å‹ | æ˜¯å¦å¿…å¡« | æè¿° |
        |----------|----------|----------|------|
        | file | File | æ˜¯ | Excelæ–‡ä»¶ |

      - **å“åº”æ•°æ®**:

        | å‚æ•°åç§° | æ•°æ®ç±»å‹ | æè¿° |
        |----------|----------|------|
        | success | Boolean | æ˜¯å¦ä¸Šä¼ æˆåŠŸ |
        | uploadId | Integer | ä¸Šä¼ è®°å½•ID |
        | totalRecords | Integer | æ€»è®°å½•æ•° |
        | successRecords | Integer | æˆåŠŸè®°å½•æ•° |
        | failedRecords | Integer | å¤±è´¥è®°å½•æ•° |
        | duplicateRecords | Integer | é‡å¤è®°å½•æ•° |
        | taxcodeDuplicates | Array | TaxCodeé‡å¤è®°å½•è¯¦æƒ…ï¼ˆä»…Inactive/Declinedï¼‰ |
        | autoSkippedActiveRecords | Integer | è‡ªåŠ¨è·³è¿‡çš„Activeé‡å¤è®°å½•æ•° |
        | needConfirmation | Boolean | æ˜¯å¦éœ€è¦ç¡®è®¤é‡å¤å¤„ç† |
        | resultFileUrl | String | ç»“æœæ–‡ä»¶ä¸‹è½½é“¾æ¥ |
        | message | String | å¤„ç†ç»“æœä¿¡æ¯ |

    - **confirmDuplicates()**
      - **åŠŸèƒ½æè¿°**:å¤„ç†é‡å¤è®°å½•ç¡®è®¤ï¼Œæ ¹æ®ç”¨æˆ·é€‰æ‹©æ›¿æ¢æˆ–è·³è¿‡TaxCodeé‡å¤è®°å½•ï¼Œå®Œæˆæœ€ç»ˆå¯¼å…¥ã€‚
      - **æ–¹æ³•çŠ¶æ€**:æ–°å¢
      - **è°ƒç”¨é¡ºåº**:ç”¨æˆ·ç¡®è®¤é‡å¤å¤„ç†æ–¹å¼åè°ƒç”¨
      - **ä¾èµ–æœåŠ¡**:PartnerUploadService
      - **è¯·æ±‚å‚æ•°**:

        | å‚æ•°åç§° | æ•°æ®ç±»å‹ | æ˜¯å¦å¿…å¡« | æè¿° |
        |----------|----------|----------|------|
        | uploadId | Integer | æ˜¯ | ä¸Šä¼ è®°å½•ID |
        | taxcodeConfirmations | Array | æ˜¯ | TaxCodeé‡å¤è®°å½•å¤„ç†ç¡®è®¤åˆ—è¡¨ |

      - **å“åº”æ•°æ®**:

        | å‚æ•°åç§° | æ•°æ®ç±»å‹ | æè¿° |
        |----------|----------|------|
        | success | Boolean | æ˜¯å¦å¤„ç†æˆåŠŸ |
        | processedRecords | Integer | æœ€ç»ˆå¤„ç†è®°å½•æ•° |
        | replacedRecords | Integer | æ›¿æ¢è®°å½•æ•° |
        | skippedRecords | Integer | è·³è¿‡è®°å½•æ•° |
        | resultFileUrl | String | æœ€ç»ˆç»“æœæ–‡ä»¶é“¾æ¥ |

    - **history()**
      - **åŠŸèƒ½æè¿°**:æ˜¾ç¤ºä¸Šä¼ å†å²é¡µé¢ï¼ŒåŒ…å«å†å²è®°å½•åˆ—è¡¨å’Œæœç´¢ç­›é€‰åŠŸèƒ½ã€‚
      - **æ–¹æ³•çŠ¶æ€**:æ–°å¢
      - **è°ƒç”¨é¡ºåº**:ç”¨æˆ·è®¿é—®å†å²é¡µé¢æ—¶è°ƒç”¨
      - **ä¾èµ–æœåŠ¡**:PartnerUploadService
      - **è¯·æ±‚å‚æ•°**:

        | å‚æ•°åç§° | æ•°æ®ç±»å‹ | æ˜¯å¦å¿…å¡« | æè¿° |
        |----------|----------|----------|------|
        | page | Integer | å¦ | é¡µç (é»˜è®¤1) |
        | pageSize | Integer | å¦ | æ¯é¡µæ¡æ•°(é»˜è®¤20) |
        | status | String | å¦ | çŠ¶æ€ç­›é€‰ |

      - **å“åº”æ•°æ®**:

        | å‚æ•°åç§° | æ•°æ®ç±»å‹ | æè¿° |
        |----------|----------|------|
        | view | Blade | history.blade.phpè§†å›¾ |
        | uploads | Array | ä¸Šä¼ è®°å½•åˆ—è¡¨ |
        | total | Integer | æ€»è®°å½•æ•° |
        | hasMore | Boolean | æ˜¯å¦æœ‰æ›´å¤šæ•°æ® |

    - **getUploadDetail()**
      - **åŠŸèƒ½æè¿°**:è·å–æŒ‡å®šä¸Šä¼ è®°å½•çš„è¯¦ç»†ä¿¡æ¯ï¼ŒåŒ…æ‹¬å¤„ç†ç»Ÿè®¡å’Œé”™è¯¯è®°å½•æ‘˜è¦ã€‚
      - **æ–¹æ³•çŠ¶æ€**:æ–°å¢
      - **è°ƒç”¨é¡ºåº**:ç”¨æˆ·ç‚¹å‡»ä¸Šä¼ è®°å½•æŸ¥çœ‹è¯¦æƒ…æ—¶è°ƒç”¨
      - **ä¾èµ–æœåŠ¡**:PartnerUploadService
      - **è¯·æ±‚å‚æ•°**:

        | å‚æ•°åç§° | æ•°æ®ç±»å‹ | æ˜¯å¦å¿…å¡« | æè¿° |
        |----------|----------|----------|------|
        | uploadId | Integer | æ˜¯ | ä¸Šä¼ è®°å½•ID |

      - **å“åº”æ•°æ®**:

        | å‚æ•°åç§° | æ•°æ®ç±»å‹ | æè¿° |
        |----------|----------|------|
        | success | Boolean | æ˜¯å¦è·å–æˆåŠŸ |
        | upload | Object | ä¸Šä¼ è®°å½•è¯¦æƒ… |
        | hasOriginalFile | Boolean | æ˜¯å¦æœ‰åŸå§‹æ–‡ä»¶ |
        | hasResultFile | Boolean | æ˜¯å¦æœ‰ç»“æœæ–‡ä»¶ |

    - **downloadOriginalFile()**
      - **åŠŸèƒ½æè¿°**:ä¸‹è½½åŸå§‹ä¸Šä¼ çš„Excelæ–‡ä»¶ã€‚
      - **æ–¹æ³•çŠ¶æ€**:æ–°å¢
      - **è°ƒç”¨é¡ºåº**:ç”¨æˆ·ç‚¹å‡»ä¸‹è½½åŸå§‹æ–‡ä»¶æ—¶è°ƒç”¨
      - **ä¾èµ–æœåŠ¡**:PartnerUploadService
      - **è¯·æ±‚å‚æ•°**:

        | å‚æ•°åç§° | æ•°æ®ç±»å‹ | æ˜¯å¦å¿…å¡« | æè¿° |
        |----------|----------|----------|------|
        | uploadId | Integer | æ˜¯ | ä¸Šä¼ è®°å½•ID |

      - **å“åº”æ•°æ®**:

        | å‚æ•°åç§° | æ•°æ®ç±»å‹ | æè¿° |
        |----------|----------|------|
        | file | File | åŸå§‹Excelæ–‡ä»¶æµ |
        | filename | String | åŸå§‹æ–‡ä»¶å |
        | contentType | String | æ–‡ä»¶ç±»å‹ |

    - **downloadResultFile()**
      - **åŠŸèƒ½æè¿°**:ä¸‹è½½å¤„ç†ç»“æœExcelæ–‡ä»¶ï¼ŒåŒ…å«å¤±è´¥è®°å½•å’Œé”™è¯¯ä¿¡æ¯ã€‚
      - **æ–¹æ³•çŠ¶æ€**:æ–°å¢
      - **è°ƒç”¨é¡ºåº**:ç”¨æˆ·ç‚¹å‡»ä¸‹è½½ç»“æœæ–‡ä»¶æ—¶è°ƒç”¨
      - **ä¾èµ–æœåŠ¡**:PartnerUploadService
      - **è¯·æ±‚å‚æ•°**:

        | å‚æ•°åç§° | æ•°æ®ç±»å‹ | æ˜¯å¦å¿…å¡« | æè¿° |
        |----------|----------|----------|------|
        | uploadId | Integer | æ˜¯ | ä¸Šä¼ è®°å½•ID |

      - **å“åº”æ•°æ®**:

        | å‚æ•°åç§° | æ•°æ®ç±»å‹ | æè¿° |
        |----------|----------|------|
        | file | File | ç»“æœExcelæ–‡ä»¶æµ |
        | filename | String | ç»“æœæ–‡ä»¶å |
        | contentType | String | æ–‡ä»¶ç±»å‹ |

- **PartnerUploadService.php**
  - **æ–‡ä»¶è·¯å¾„**:`app/Services/ModChannelPlatform/PartnerUploadService.php`
  - **æ–‡ä»¶çŠ¶æ€**:æ–°å¢
  - **æ–¹æ³•**:
    - **processUploadFile($file, $userId)**
      - **åŠŸèƒ½æè¿°**:å¤„ç†ä¸Šä¼ æ–‡ä»¶çš„å®Œæ•´æµç¨‹ï¼ŒåŒ…æ‹¬è§£æã€éªŒè¯ã€å¯¼å…¥å’Œç»“æœç”Ÿæˆ
      - **æ–¹æ³•çŠ¶æ€**:æ–°å¢
      - **è¿”å›æ•°æ®**:ä¸Šä¼ ç»“æœå¯¹è±¡å’Œå¤„ç†ç»Ÿè®¡

    - **parseExcel($filePath)**
      - **åŠŸèƒ½æè¿°**:è§£æExcelæ–‡ä»¶ï¼Œæ”¯æŒå¤šç§æ ¼å¼ï¼ˆ.xlsx, .xlsï¼‰ï¼Œå¤„ç†20ä¸ªå­—æ®µï¼ˆåŒ…å«ä¸šåŠ¡ä¿¡æ¯å’Œè”ç³»äººä¿¡æ¯ï¼‰
      - **æ–¹æ³•çŠ¶æ€**:æ–°å¢
      - **è¿”å›æ•°æ®**:è§£æåçš„æ•°æ®æ•°ç»„

    - **validateData($data)**
      - **åŠŸèƒ½æè¿°**:éªŒè¯æ•°æ®å®Œæ•´æ€§å’Œæ ¼å¼ï¼ŒåŒ…æ‹¬å¿…å¡«å­—æ®µã€æ‰‹æœºå·æ ¼å¼ã€é‚®ç®±æ ¼å¼ç­‰
      - **æ–¹æ³•çŠ¶æ€**:æ–°å¢
      - **è¿”å›æ•°æ®**:éªŒè¯ç»“æœå’Œé”™è¯¯åˆ—è¡¨

    - **checkDuplicates($partners)**
      - **åŠŸèƒ½æè¿°**:æ£€æŸ¥TaxCodeé‡å¤æ€§ï¼Œè¯†åˆ«ä¸ç°æœ‰è®°å½•çš„å†²çªï¼ŒåŒºåˆ†Activeå’ŒInactive/DeclinedçŠ¶æ€
      - **æ–¹æ³•çŠ¶æ€**:æ–°å¢
      - **é‡å¤å¤„ç†é€»è¾‘**:
        - ActiveçŠ¶æ€è®°å½•:è‡ªåŠ¨æ ‡è®°ä¸ºè·³è¿‡ï¼Œä¸éœ€è¦ç”¨æˆ·ç¡®è®¤
        - Inactive/DeclinedçŠ¶æ€è®°å½•:è¿”å›ç»™ç”¨æˆ·ç¡®è®¤æ˜¯å¦æ›¿æ¢
      - **è¿”å›æ•°æ®**:TaxCodeé‡å¤è®°å½•åˆ—è¡¨ï¼ˆä»…Inactive/Declinedï¼‰å’Œå†²çªè¯¦æƒ…

    - **importPartners($partners, $uploadId)**
      - **åŠŸèƒ½æè¿°**:æ‰¹é‡å¯¼å…¥æ¸ é“å•†æ•°æ®ï¼Œå¤„ç†æˆåŠŸå’Œå¤±è´¥è®°å½•
      - **æ–¹æ³•çŠ¶æ€**:æ–°å¢
      - **è¿”å›æ•°æ®**:å¯¼å…¥ç»“æœç»Ÿè®¡

    - **generateResultFile($uploadId)**
      - **åŠŸèƒ½æè¿°**:ç”ŸæˆåŒ…å«å¤±è´¥è®°å½•çš„Excelç»“æœæ–‡ä»¶
      - **æ–¹æ³•çŠ¶æ€**:æ–°å¢
      - **è¿”å›æ•°æ®**:ç»“æœæ–‡ä»¶è·¯å¾„å’Œä¸‹è½½é“¾æ¥

    - **getUploadHistory($userId)**
      - **åŠŸèƒ½æè¿°**:è·å–ç”¨æˆ·ä¸Šä¼ å†å²åˆ—è¡¨ï¼Œæ”¯æŒåˆ†é¡µå’ŒçŠ¶æ€ç­›é€‰
      - **æ–¹æ³•çŠ¶æ€**:æ–°å¢
      - **è¿”å›æ•°æ®**:åˆ†é¡µåçš„ä¸Šä¼ è®°å½•åˆ—è¡¨

    - **getUploadDetail($uploadId)**
      - **åŠŸèƒ½æè¿°**:è·å–ä¸Šä¼ è®°å½•è¯¦ç»†ä¿¡æ¯å’Œå…³è”æ•°æ®
      - **æ–¹æ³•çŠ¶æ€**:æ–°å¢
      - **è¿”å›æ•°æ®**:å®Œæ•´çš„ä¸Šä¼ è®°å½•è¯¦æƒ…

    - **downloadTemplate()**
      - **åŠŸèƒ½æè¿°**:ç”Ÿæˆå¹¶è¿”å›ä¸Šä¼ æ¨¡æ¿æ–‡ä»¶ï¼ŒåŒ…å«å­—æ®µè¯´æ˜å’Œç¤ºä¾‹æ•°æ®ï¼ˆåŒ…å«å®Œæ•´çš„20ä¸ªå­—æ®µï¼‰
      - **æ–¹æ³•çŠ¶æ€**:æ–°å¢
      - **è¿”å›æ•°æ®**:æ¨¡æ¿æ–‡ä»¶æµ

### 6.2 Channel Partner Dashboardæ¨¡å—

#### 6.2.1 ä¸šåŠ¡æµç¨‹

##### 6.2.1.1 ä¸šåŠ¡èƒŒæ™¯

- **èƒŒæ™¯**:Channel Partner Dashboardæ˜¯æ¸ é“å•†ç®¡ç†çš„æ ¸å¿ƒç•Œé¢ï¼Œç”¨äºå±•ç¤ºå’Œç®¡ç†æ‰€æœ‰æ¸ é“å•†ä¿¡æ¯ï¼ŒåŒ…æ‹¬é€šè¿‡Excelå¯¼å…¥å’ŒPortalç«¯æ³¨å†Œç”³è¯·çš„å…¬å¸æ•°æ®ã€‚ç³»ç»Ÿæä¾›å¤šç»´åº¦æœç´¢å’Œæ‰¹é‡åˆ†é…ç»™é”€å”®åŠŸèƒ½ã€‚

- **ä¸»è¦æµç¨‹**

  - **Dashboard List**
    - å±•ç¤ºæ‰€æœ‰æ¸ é“å•†ä¿¡æ¯ï¼ˆExcelå¯¼å…¥ + Portalç”³è¯·ï¼‰
    - æ”¯æŒå¤šå­—æ®µæœç´¢ç­›é€‰
    - åˆ—è¡¨æ ¹æ® TaxCode å°†å¤šä¸ªæ³¨å†Œç”³è¯·åˆå¹¶æˆ1æ¡æ•°æ®å±•ç¤º(Portalç«¯ä¸ºä¸»)
    ![alt text](<005 - Channel Partner Dashboard-1.png>)

  - **åˆ†é…é”€å”®**:
    - å¯æ‰¹é‡ç»™Partner PendingçŠ¶æ€çš„åˆ†é… é”€å”®(Partner Onwer)
    - åˆ†é…é”€å”®å, æ‰¹é‡æ›¿æ¢å½“å‰ Company ä¸‹æ‰€æœ‰ Userçš„ å¯¹åº”é”€å”®
    - å¯åˆ†é…å¤šä¸ªé”€å”®, å¯é‡æ–°åˆ†é…é”€å”®
    ![alt text](image-2.png)

- **å¼‚å¸¸æµç¨‹**:
  - æœç´¢æ¡ä»¶æ— ç»“æœ â†’ æ˜¾ç¤ºæ— æ•°æ®æç¤º
  - æŸ¥è¯¢PortalApiæ— åé¦ˆ

- **æµç¨‹å›¾**:

```mermaid
flowchart TD
    START[Dashboardåˆ—è¡¨] --> SEARCH[æœç´¢ç­›é€‰]
    START --> SELECT[å¤šé€‰åˆ†é…]
    
    SELECT --> ASSIGN[æ‰¹é‡åˆ†é…ç»™é”€å”®]
```

#### 6.2.2 å½±å“çš„æ•°æ®è¡¨

- Viewç«¯
  - **[mod_channel_partner_companies](#table-mod_channel_partner_companies)** : Viewç«¯ Upload CompanyåŸºç¡€ä¿¡æ¯è¡¨
  - **[mod_channel_partner_user](#table-mod_channel_partner_user)** : Viewç«¯ Upload UseråŸºç¡€ä¿¡æ¯è¡¨
  - **[mod_channel_assignment_history](#table-mod_channel_assignment_history)** : Viewç«¯ Partner(éActiceçš„) å…³è” é”€å”®è¡¨

- Portalç«¯
  - **[users](#table-users)** : Portalç«¯ UseråŸºç¡€ä¿¡æ¯è¡¨
  - **[companies](#table-companies)** : Portalç«¯ Company åŸºç¡€ä¿¡æ¯è¡¨
  - **[user_company](#table-user_company)** : User&Company å…³è”è¡¨(è®°å½• Partner å½“å‰çŠ¶æ€)
  - **[user_company_assignment](#table-user_company_assignment)** : Portalç«¯ Partner å…³è” é”€å”®è¡¨

#### 6.2.3 å‰ç«¯å®ç°

##### 6.2.3.1 è§†å›¾ç›®å½•ç»“æ„

```plaintext
/resources/views/partner-dashboard/
  index.blade.php              - Dashboardä¸»é¡µé¢
```

##### 6.2.3.2 å…³é”®è§†å›¾åŠŸèƒ½

- **index.blade.php** åŒ…å«:
  - æœç´¢ç­›é€‰è¡¨å•ï¼ˆ9ä¸ªç­›é€‰å­—æ®µï¼‰
  - æ‰¹é‡æ“ä½œå·¥å…·æ ï¼ˆåˆ†é…æŒ‰é’®ã€é€‰æ‹©ç»Ÿè®¡ï¼‰
  - æ¸ é“å•†åˆ—è¡¨è¡¨æ ¼ï¼ˆåˆ†é¡µã€æ’åºï¼‰
  - æ‰¹é‡åˆ†é…ç»™é”€å”®Modalå¼¹çª—

#### 6.2.4 è·¯ç”±è®¾è®¡

| HTTPæ–¹æ³• | ç«¯ç‚¹ | æè¿° |
|----------|------|------|
| GET | `/partner-dashboard` | Dashboardä¸»é¡µé¢ |
| GET | `/partner-dashboard/search` | æœç´¢æ¸ é“å•† |
| POST | `/partner-dashboard/assign` | æ‰¹é‡åˆ†é…ç»™é”€å”® |

#### 6.2.5 é”™è¯¯å¤„ç†å’Œæ—¥å¿—è®°å½•

##### 6.2.5.1 æ—¥å¿—è®°å½•

ä½¿ç”¨DynamicLoggerFactoryè¿›è¡Œæ¨¡å—åŒ–æ—¥å¿—è®°å½•:

- **ç³»ç»Ÿé”™è¯¯æ—¥å¿—è®°å½•åœºæ™¯**:

  | æ“ä½œç±»å‹ | è®°å½•æ—¶æœº |
  |----------|----------|
  | searchFailed | æœç´¢æŸ¥è¯¢å¤±è´¥ |
  | assignmentFailed | åˆ†é…æ“ä½œå¤±è´¥ |

#### 6.2.6 åŠŸèƒ½å¼€å‘ä¸å®ç°

##### 6.2.6.1 ç±»å…³ç³»å›¾

```mermaid
classDiagram
    class PartnerDashboardController {
        +index()
        +search()
        +assign()
        +getSalesList()
    }

    class PartnerDashboardService {
        +getPartnerList(filters, page, pageSize)
        +searchPartners(searchParams)
        +batchAssign(partnerIds, salesIds, assignedBy)
        +validateAssignment(partnerIds)
        +getSalesOptions()
        +recordAssignmentHistory(companyId, salesIds, assignedBy)
    }

    PartnerDashboardController --> PartnerDashboardService : ä¸šåŠ¡å¤„ç†
```

##### 6.2.6.2 ä»£ç å®ç°

- **PartnerDashboardController.php**
  - **æ–‡ä»¶è·¯å¾„**:`app/Http/Controllers/ModChannelPlatform/PartnerDashboardController.php`
  - **æ–‡ä»¶çŠ¶æ€**:æ–°å¢
  - **æ–¹æ³•**:
    - **index()**
      - **åŠŸèƒ½æè¿°**:æ˜¾ç¤ºDashboardä¸»é¡µé¢ï¼ŒåŠ è½½é»˜è®¤åˆ—è¡¨æ•°æ®å’Œç­›é€‰é€‰é¡¹
      - **æ–¹æ³•çŠ¶æ€**:æ–°å¢
      - **ä¾èµ–æœåŠ¡**:PartnerDashboardService
      - **è¯·æ±‚å‚æ•°**:æ— 
      - **å“åº”æ•°æ®**:

        | å‚æ•°åç§° | æ•°æ®ç±»å‹ | æè¿° |
        |----------|----------|------|
        | view | Blade | index.blade.phpè§†å›¾ |
        | partners | Array | æ¸ é“å•†åˆ—è¡¨ï¼ˆå‰50æ¡ï¼‰ |
        | total | Integer | æ€»è®°å½•æ•° |
        | salesList | Array | é”€å”®äººå‘˜åˆ—è¡¨ |

    - **search()**
      - **åŠŸèƒ½æè¿°**:æ ¹æ®æœç´¢æ¡ä»¶ç­›é€‰æ¸ é“å•†åˆ—è¡¨ï¼Œæ”¯æŒ9ä¸ªç­›é€‰å­—æ®µï¼Œåˆ†é¡µæ˜¾ç¤ºï¼Œé»˜è®¤50æ¡/é¡µ
      - **æ–¹æ³•çŠ¶æ€**:æ–°å¢
      - **ä¾èµ–æœåŠ¡**:PartnerDashboardService
      - **è¯·æ±‚å‚æ•°**:

        | å‚æ•°åç§° | æ•°æ®ç±»å‹ | æ˜¯å¦å¿…å¡« | æè¿° |
        |----------|----------|----------|------|
        | region | String | å¦ | åŒºåŸŸç­›é€‰ |
        | branch | String | å¦ | åˆ†å…¬å¸ç­›é€‰ |
        | province | String | å¦ | çœä»½ç­›é€‰ |
        | city | String | å¦ | åŸå¸‚ç­›é€‰ |
        | district | String | å¦ | åŒºå¿ç­›é€‰ |
        | taxcode | String | å¦ | ç¨å·æœç´¢ |
        | partner | String | å¦ | Partneråç§°æœç´¢ |
        | partnerowner | String | å¦ | è´Ÿè´£äººç­›é€‰ |
        | datasource | String | å¦ | æ•°æ®æ¥æºç­›é€‰ |
        | partnerstatus | String | å¦ | PartnerçŠ¶æ€ç­›é€‰ |
        | requeststatus | String | å¦ | ç”³è¯·çŠ¶æ€ç­›é€‰ |
        | page | Integer | å¦ | é¡µç (é»˜è®¤1) |
        | pageSize | Integer | å¦ | æ¯é¡µæ¡æ•°(é»˜è®¤50) |

      - **å“åº”æ•°æ®**:

        | å‚æ•°åç§° | æ•°æ®ç±»å‹ | æè¿° |
        |----------|----------|------|
        | success | Boolean | æ˜¯å¦æœç´¢æˆåŠŸ |
        | partners | Array | æ¸ é“å•†åˆ—è¡¨ |
        | total | Integer | æ€»è®°å½•æ•° |
        | hasMore | Boolean | æ˜¯å¦æœ‰æ›´å¤šæ•°æ® |
        | assignableCount | Integer | å¯åˆ†é…è®°å½•æ•° |

    - **assign()**
      - **åŠŸèƒ½æè¿°**:æ‰¹é‡åˆ†é…æ¸ é“å•†ç»™æŒ‡å®šé”€å”®äººå‘˜ï¼ŒéªŒè¯åˆ†é…æƒé™ï¼Œè®°å½•åˆ†é…å†å²
      - **æ–¹æ³•çŠ¶æ€**:æ–°å¢
      - **ä¾èµ–æœåŠ¡**:PartnerDashboardService
      - **è¯·æ±‚å‚æ•°**:

        | å‚æ•°åç§° | æ•°æ®ç±»å‹ | æ˜¯å¦å¿…å¡« | æè¿° |
        |----------|----------|----------|------|
        | partnerIds | Array | æ˜¯ | æ¸ é“å•†IDåˆ—è¡¨ |
        | salesIids | Array | æ˜¯ | é”€å”®äººå‘˜IDæ•°ç»„ |

      - **å“åº”æ•°æ®**:

        | å‚æ•°åç§° | æ•°æ®ç±»å‹ | æè¿° |
        |----------|----------|------|
        | success | Boolean | æ˜¯å¦åˆ†é…æˆåŠŸ |
        | assigneCount | Integer | æˆåŠŸåˆ†é…æ•°é‡ |
        | skippedount | Integer | è·³è¿‡æ•°é‡ |
        | salesNames | Array | é”€å”®äººå‘˜å§“åæ•°ç»„ |
        | message | String | ç»“æœä¿¡æ¯ |

- **PartnerDashboardService.php**
  - **æ–‡ä»¶è·¯å¾„**:`app/Services/ModChannelPlatform/PartnerDashboardService.php`
  - **æ–‡ä»¶çŠ¶æ€**:æ–°å¢
  - **æ–¹æ³•**:
    - **getPartnerList($filters, $page, $pageSize)**
      - **åŠŸèƒ½æè¿°**:è·å–æ¸ é“å•†åˆ—è¡¨ï¼Œæ”¯æŒå¤šæ¡ä»¶ç­›é€‰å’Œåˆ†é¡µï¼Œæ ‡è¯†å¯åˆ†é…çŠ¶æ€
      - **æ–¹æ³•çŠ¶æ€**:æ–°å¢
      - **è¿”å›æ•°æ®**:åˆ†é¡µåˆ—è¡¨å’Œç»Ÿè®¡ä¿¡æ¯

    - **searchPartners($searchParams)**
      - **åŠŸèƒ½æè¿°**:æ‰§è¡Œå¤šå­—æ®µæœç´¢ï¼Œæ„å»ºå¤æ‚æŸ¥è¯¢æ¡ä»¶ï¼Œæ”¯æŒæ¨¡ç³Šæœç´¢å’Œç²¾ç¡®åŒ¹é…
      - **æ–¹æ³•çŠ¶æ€**:æ–°å¢
      - **è¿”å›æ•°æ®**:æœç´¢ç»“æœåˆ—è¡¨

    - **batchAssign($partnerIds, $salesIds, $assignedBy)**
      - **åŠŸèƒ½æè¿°**:æ‰¹é‡åˆ†é…å¤„ç†ï¼ŒéªŒè¯æƒé™ã€æ›´æ–°è´Ÿè´£äººã€è®°å½•å†å²
      - **æ–¹æ³•çŠ¶æ€**:æ–°å¢
      - **è¿”å›æ•°æ®**:åˆ†é…ç»“æœç»Ÿè®¡

    - **validateAssignment($partnerIds)**
      - **åŠŸèƒ½æè¿°**:éªŒè¯å“ªäº›è®°å½•å¯ä»¥è¢«åˆ†é…ï¼ˆæœªåˆ†é…ä¸”æ— å…³è”é”€å”®çš„è®°å½•ï¼‰
      - **æ–¹æ³•çŠ¶æ€**:æ–°å¢
      - **è¿”å›æ•°æ®**:å¯åˆ†é…è®°å½•åˆ—è¡¨å’Œä¸å¯åˆ†é…åŸå› 

    - **recordAssignmentHistory($companyId, $salesIds, $assignedBy)**
      - **åŠŸèƒ½æè¿°**:è®°å½•åˆ†é…å†å²åˆ°mod_channel_assignment_historyè¡¨
      - **æ–¹æ³•çŠ¶æ€**:æ–°å¢
      - **è¿”å›æ•°æ®**:å†å²è®°å½•ID

    - **getSalesOptions()**
      - **åŠŸèƒ½æè¿°**:è·å–é”€å”®äººå‘˜åˆ—è¡¨ç”¨äºåˆ†é…é€‰æ‹©
      - **æ–¹æ³•çŠ¶æ€**:æ–°å¢
      - **è¿”å›æ•°æ®**:é”€å”®äººå‘˜é€‰é¡¹æ•°ç»„

### 6.3 Channel Partner Approvalæ¨¡å—

#### 6.3.1 ä¸šåŠ¡æµç¨‹

##### 6.3.1.1 ä¸šåŠ¡èƒŒæ™¯

- **èƒŒæ™¯**:Channel Partner Approvalè´Ÿè´£å¤„ç†å¯¼å…¥æ•°æ®æ¿€æ´»å’ŒPortalç«¯æ‰«ç ç”³è¯·çš„å®¡æ‰¹æµç¨‹ã€‚Portalæ•°æ®é€šè¿‡APIæ¥å£å®æ—¶æ‹‰å–ï¼Œä¸å­˜å‚¨åœ¨æœ¬åœ°è¡¨ä¸­ã€‚å®¡æ‰¹é€šè¿‡æ—¶ç›´æ¥åŒæ­¥åˆ°Viewç³»ç»Ÿï¼Œå®¡æ‰¹æ‹’ç»æ—¶åœ¨Viewç«¯åˆ›å»ºdeclineè®°å½•ã€‚

- **ä¸»è¦æµç¨‹**

  - **æ–°Partner ç”³è¯·å®¡æ‰¹**
    - **å®¡æ‰¹é¡µé¢**: æ–°å¢ Manages Customersé¡µé¢
    - **åŒ…å«æ“ä½œ**: æ¥å—/æ‹’ç»/ä¿å­˜/é‡æ–°æ¿€æ´»Declineçš„ Company&Userä¿¡æ¯, å›å¤Inquiryä¿¡æ¯
    ![alt text](<012 - Manage Customers.png>)
    ![alt text](image-3.png)

  - **æ–°User ç”³è¯·å®¡æ‰¹**
    - **å®¡æ‰¹é¡µé¢**: æ–°å¢Partner Info Tab
    - **åŒ…å«æ“ä½œ**: æ–°å¢/æ¥å—/æ‹’ç» è”ç³»äººç”³è¯·, å›å¤Inquiryä¿¡æ¯
    ![alt text](<013 - Manage Customers - Partner Info.png>)

  - **ManageCustomer æ–°å¢ä¸šåŠ¡**  
    - æ–°å¢å­—æ®µå±•ç¤º å¦‚ ä¸»è¥ä¸šåŠ¡ç­‰
    ![alt text](<008 - Manage Customers - Customer Master.png>)
    - æ–°å¢ Portal Accounté€‰é¡¹
      1. å‹¾é€‰Portal Account åœ¨Portalç«¯åˆ›å»ºè´¦å·,å¹¶æ³¨å†ŒCompany&Userå…³è”å…³ç³» ä¸”æ ‡è®°ä¸ºActiveçŠ¶æ€
      2. ä»…æœ‰æƒé™é”€å”®å¯ç¼–è¾‘å‹¾é€‰Portal Accountçš„ Contract æ•æ„Ÿä¿¡æ¯ å¦‚æ‰‹æœºå·
      3. å˜æ›´ Portal Contact ä¿¡æ¯æ—¶ï¼Œå…ˆæ ¹æ®æ‰‹æœºå· åŒæ—¶å˜æ›´å…¶ä½™æ‰€æœ‰å‹¾é€‰PortalAccountçš„ Contactä¿¡æ¯(æ‰€æœ‰å˜æ›´çš„Customeréƒ½è¦è®°å½•Log), åœ¨åŒæ­¥Portalç«¯
      4. åˆ é™¤å‹¾é€‰Portal Accountçš„ Contract åˆ™è§£ç»‘ Portalç«¯ Company&Userå…³è” å¹¶äº¤é›†decline
    ![alt text](<009 - Manage Customers - Customer Master.png>)
    - æ–°å¢ Partner Info å±•ç¤ºå½“å‰Customer å…³è”çš„Querstion List(åªè¯»), Inquiry(å¯å›å¤), åˆ†é…/åˆ›å»º é¡¹ç›®æŒ‰é’®è·³è½¬
    ![alt text](<010 - Manage Customers - Partner Info.png>)

    - å¦‚æœæ¶‰åŠåˆ°Portalç«¯æ•°æ® è¢«ä¿å­˜ï¼Œéœ€è¦å°†Company&Useræ•°æ®åŒæ­¥ mod_channel_partner_compines/userè¡¨è®°å½•
    - å¦‚æœè¯¥æ¡ç”³è¯·æ²¡æœ‰ç¨å·ï¼Œå®¡æ‰¹é”€å”® å¿…é¡»å¡«å†™ç¨å·, å¦‚æœè¯¥ç¨å·å…³è”äº†Customer åˆ™å°†å¯¹åº”ä¿¡æ¯å¡«å…… ä½œä¸ºä¸»æ•°æ® ç”¨æˆ·ç”³è¯·æ•°æ®ä½œä¸ºæé†’ åœ¨INPUTæ¡†ä¸‹æç¤º
    - æ¶‰åŠåˆ°Save Companyä¿¡æ¯ åŒä¸Š æœ‰æé†’
    - ä¸èƒ½ä¿®æ”¹Portal ç”³è¯·çš„Userä¿¡æ¯
    - Portal Accountå‹¾é€‰ååœ¨Activeå éœ€è¦ä¸»åŠ¨ç»™åˆ›å»ºPortalåˆ›å»ºè´¦å·, Portalç«¯ç”³è¯· é»˜è®¤å‹¾é€‰(ä¸å¯ç¼–è¾‘)
    - éœ€è¦å±•ç¤ºç”³è¯·User åœ¨Pendingæ—¶ åœ¨å½“å‰å®¡æ‰¹çš„Companyä¸‹ åˆ›å»ºçš„é¡¹ç›® ä»¥åŠ Inquiry(é”€å”®å¯å›å¤)
    - å®¡æ‰¹çš„Userä¸å‹¾é€‰ PortalAccount ä»…åˆ›å»ºContactä¿¡æ¯ ä¸åˆ›å»ºPortalè´¦å·
    - å®¡æ‰¹æ—¶ ä¸è®º é‚£ç§æ“ä½œ åˆ é™¤äº†å®¡æ‰¹çš„ Useræ—¶ï¼Œéƒ½é»˜è®¤æ‹’ç»
    - å®¡æ‰¹æ—¶ é”€å”®éœ€å¡«å†™ Querstion Listä¿¡æ¯(å¿…å¡«), åˆä½œæ„å‘(éå¿…å¡«),å¤‡æ³¨(éå¿…å¡«)
    - æ‹’ç»å®¡æ‰¹æ—¶ï¼Œéœ€é€‰æ‹©æ‹’ç»åŸå› 
    - å®¡æ‰¹é€šè¿‡å éœ€åˆ›å»º Customer&Contact ä»¥åŠ Contactå’ŒPortal Userä¿¡æ¯

  - **Question Listé…ç½®**:
    - å¤ç”¨ç°æœ‰ç»„ä»¶(ç›®å‰åœ¨æœ¬åœ°)

  - **å®¡æ‰¹è¿‡ç¨‹**:
    - Companyä¿¡æ¯å±•ç¤º:
      1. å¤šä¸ªUserç”³è¯·, Companyä¿¡æ¯ä»¥ ç¬¬ä¸€ä¸ªç”³è¯·/Portalç«¯ç”³è¯· ä¸ºå±•ç¤º
      2. å¦‚æœ Companyæœªå¡«å†™ Taxcode æ£€æŸ¥æ˜¯å¦æœ‰Customerä¿¡æ¯, æœ‰åˆ™å…³è”å±•ç¤º,Userå¡«å†™ä¿¡æ¯ä½œä¸º æç¤ºåœ¨Inputä¸‹å±•ç¤º
      3. å¦‚æœ Saveçš„ä¿¡æ¯ ä¹Ÿå°†æœ‰æé†’åœ¨Inputä¸‹ å¹¶æç¤ºå·²æœ‰é”€å”®Save
    - User ä¿¡æ¯å±•ç¤º:
      1. Portalç«¯ ç”³è¯·çš„User ä¸èƒ½ç¼–è¾‘ä¿¡æ¯
      2. å‹¾é€‰PortalAccountåï¼Œåœ¨å®¡æ‰¹é€šè¿‡å è‡ªåŠ¨åˆ›å»ºPortalè´¦å·
      3. Uploadå¯¼å…¥çš„User å¤šæ‰‹æœºå· éœ€è¦é”€å”®ç¡®è®¤ä»…ä¿ç•™ä¸€ä¸ª, å¦‚æœå·²å­˜åœ¨éœ€æé†’
      4. åœ¨å®¡æ‰¹é¡µé¢åˆ é™¤User ä¿¡æ¯, åˆ™ä¸è®ºæ˜¯ æ¥å—/æ‹’ç»/ä¿å­˜ éƒ½é»˜è®¤è¯¥User å®¡æ‰¹è¢«æ‹’ç»
    - Project List:Portalç«¯Partner Pendingæ—¶ åˆ›å»ºçš„é¡¹ç›®
    - Inquiry List:Portalç«¯Partner Pendingæ—¶ å‘èµ·çš„é—®è¯¢
    - Quertiosn List:æ ¹æ®åˆ›å»ºçš„æ¨¡æ¿å†…å®¹ å±•ç¤º,éœ€è¦é”€å”®å¡«å†™ (å®¡æ‰¹æ–°Useræ—¶, ä¸éœ€è¦é‡æ–°å¡«å†™)
    - åˆä½œæ„è§ , å¤‡æ³¨ éœ€é”€å”®å¡«å†™

  - **å®¡æ‰¹ä¿å­˜æµç¨‹**:
    1. é”€å”®å¯ä»¥ç¼–è¾‘ Company& Uploadçš„Userä¿¡æ¯ å¹¶ä¿å­˜
    2. Portalç«¯æ•°æ® è¢«ä¿å­˜å åœ¨Viewç«¯ä¿ç•™è®°å½•
    3. ä¿å­˜æ—¶ä»…é¡µé¢åŒ…å«çš„ Userä¿¡æ¯ä¿ç•™ å…¶ä½™è¢«åˆ é™¤çš„è‡ªåŠ¨Decline 

  - **å®¡æ‰¹é€šè¿‡æµç¨‹**:
    1. æ‰¹é‡æ ‡è®°å®¡æ‰¹çŠ¶æ€ï¼Œç”Ÿæˆæ–°çš„Customer&Contactè®°å½•
    2. ç›´æ¥åŒæ­¥æ•°æ®åˆ°Viewç³»ç»Ÿcustomerè¡¨å’Œcontactsè¡¨ï¼Œå¹¶æ ‡è®°æ¥æº
    3. å‘é€å®¡æ‰¹é€šè¿‡ç»“æœè‡³Portalç«¯ï¼ŒåŒæ—¶åŒæ­¥ customerIdå’Œ contactId
    4. åŒæ—¶æ›´æ–° Portal . companiesè¡¨ä¿¡æ¯ ä¸ Viewç«¯ä¸€è‡´, åŒæ—¶ å¦‚æœä¸portalç«¯companiesè¡¨ç¨å·ä¸€è‡´ ä»…ä¿ç•™ä¸€æ¡ companiesä¿¡æ¯
    5. å‘é€æ¿€æ´»é€šçŸ¥ï¼Œæ¨é€æ¿€æ´»wechatæ¶ˆæ¯ï¼ˆä»…é€šè¿‡çš„è”ç³»äººï¼‰
    6. Dashboardä¸­Request Statusæ˜¾ç¤ºä¸ºdone

  - **å®¡æ‰¹æ‹’ç»æµç¨‹**:

    1. è®°å½•æ‹’ç»åŸå› ï¼Œä¸ç”ŸæˆCustomerè®°å½•
    2. å‘é€å®¡æ‰¹æ‹’ç»ç»“æœï¼Œè§£ç»‘Portalç«¯ Companyå’ŒUserå…³ç³»ï¼ŒåŒæ—¶æ ‡è®°ä¸ºDeclineï¼Œç”¨æˆ·å¯ä»¥é‡æ–°å‘èµ·æ³¨å†Œç”³è¯·
    3. Portalç«¯Declineå¾—æ•°æ® ä¼šå­˜å‚¨åˆ°Viewå¾— Channel_Partnerè¡¨ä¸­,ä»¥ç”¨äºé‡æ–°æ¿€æ´»
    4. é”€å”®å¯ä»¥é‡æ–°æ¿€æ´»è¢«Declineæ•°æ®
    5. Dashboardä¸­Request Statusæ˜¾ç¤ºä¸ºdone
    6. è§£ç»‘ Portalç«¯ user_company  userå’Œcompanyè¡¨ å…³è”è®°å½•
    7. **ä¸å‘é€å¾®ä¿¡æ¨é€é€šçŸ¥**

  - **é‡æ–°æ¿€æ´»æµç¨‹**
    - **Portalæ•°æ®é‡æ–°æ¿€æ´»**:
      1. Dashboardåˆ—è¡¨ç‚¹å‡»è¢«Declineæ•°æ®è¿›å…¥ç¼–è¾‘é¡µé¢ï¼Œé‡æ–°æ¿€æ´»è¢«Declineçš„æ•°æ®
      2. æ¿€æ´»æ•°æ®å…³è”å…³ç³»ä» registration_requests è¡¨è·å–
      3. æ£€æŸ¥Partneræ˜¯å¦å·²å­˜åœ¨ï¼Œå¦‚æœä¸å­˜åœ¨ç”Ÿæˆæ–°çš„Customer&Contactè®°å½•ï¼Œå¦‚æœå·²å­˜åœ¨ä»…ç”Ÿæˆæ–°çš„Contactè®°å½•
      4. å‘é€é‡æ–°æ¿€æ´»é€šçŸ¥ï¼Œé‡æ–°ç»‘å®šç”¨æˆ·å’Œå…¬å¸ï¼Œæ›´æ–°çŠ¶æ€ä¸ºactive
      5. å‘é€æ¿€æ´»é€šçŸ¥ï¼Œæ¨é€æ¿€æ´»wechatæ¶ˆæ¯

    - **Viewå¯¼å…¥æ•°æ®é‡æ–°æ¿€æ´»**:
      1. Dashboardåˆ—è¡¨ç‚¹å‡»è¢«Declineæ•°æ®è¿›å…¥ç¼–è¾‘é¡µé¢ï¼Œé‡æ–°æ¿€æ´»è¢«Declineçš„æ•°æ®
      2. æ£€æŸ¥Partneræ˜¯å¦å·²å­˜åœ¨ï¼Œå¦‚æœä¸å­˜åœ¨ç”Ÿæˆæ–°çš„Customer&Contactè®°å½•çŠ¶æ€ä¸ºactiveï¼Œå¦‚æœå·²å­˜åœ¨ä»…ç”Ÿæˆæ–°çš„Contactè®°å½•çŠ¶æ€ä¸ºactive
      3. å¦‚æœå‹¾é€‰Portal Accountåˆ™åˆ›å»ºPortal ç«¯ç™»å½•è´¦å· å¦åˆ™ ä»…åˆ›å»ºContact

  - **é¡¹ç›®åˆ†é…ç®¡ç†**
    - **Partner Infoé¡¹ç›®åˆ†é…åŠŸèƒ½**:
      - activeçŠ¶æ€Partneræ˜¾ç¤º"æ–°å¢é¡¹ç›®"å’Œ"åˆ†é…é¡¹ç›®"æŒ‰é’®
      - ç‚¹å‡»"åˆ†é…é¡¹ç›®"è·³è½¬åˆ°é¡¹ç›®åˆ†é…åˆ—è¡¨é¡µé¢
      - æ˜¾ç¤ºæ‰€æœ‰å¯åˆ†é…é¡¹ç›®ï¼ˆåŒ…æ‹¬è¢«æ‹’ç»çš„é¡¹ç›®ï¼Œå…è®¸é‡æ–°åˆ†é…ï¼‰
      - å¯æ‰¹é‡åˆ†é…è‡³å¯¹åº”çš„Customerï¼Œåˆ†é…æ—¶éœ€é€‰æ‹©åˆ†é…åŸå› 
      - æœªé€‰æ‹©æ˜¯Agent/Distributor é»˜è®¤æ ‡è®°ä¸ºAgent
      - åˆ—è¡¨ä»…å±•ç¤º Pre-LeadçŠ¶æ€çš„é¡¹ç›® å…¶ä½™é¡¹ç›®ä¸å±•ç¤º
      - åˆ†é…é¡¹ç›®å æ¨é€wechatæ¶ˆæ¯ç»™ å½“å‰Companyä¸‹æ‰€æœ‰ActiveçŠ¶æ€çš„User
      - è®°å½•åˆ†é…æ—¥å¿—
    ![alt text](<011 - Window Popup.png>)

- **æµç¨‹å›¾**:

```mermaid
flowchart TD
    START[Channel Partner Approval] --> IMPORT[Viewå¯¼å…¥æ•°æ®æ¿€æ´»æµç¨‹]
    START --> PORTAL_PARTNER[Portalæ–°Partnerå®¡æ‰¹æµç¨‹]
    START --> PORTAL_CONTRACT[Portalæ–°Contractå®¡æ‰¹æµç¨‹]
    START --> REACTIVATE[è¢«Declineæ•°æ®é‡æ–°æ¿€æ´»æµç¨‹]
    
    IMPORT --> IMPORT_REVIEW[é”€å”®å®¡æ‰¹é¡µé¢]
    IMPORT_REVIEW --> IMPORT_SAVE[ä¿å­˜è‰ç¨¿]
    IMPORT_REVIEW --> IMPORT_APPROVE[å®¡æ‰¹é€šè¿‡]
    IMPORT_REVIEW --> IMPORT_REJECT[å®¡æ‰¹æ‹’ç»]
    
    IMPORT_APPROVE --> SYNC_LEGACY[åŒæ­¥Viewç³»ç»Ÿ]
    IMPORT_APPROVE --> UPDATE_STATUS[æ›´æ–°çŠ¶æ€ä¸ºactive]
    IMPORT_REJECT --> CREATE_DECLINE[åˆ›å»ºdeclineè®°å½•]
    
    PORTAL_PARTNER --> PORTAL_API[è°ƒç”¨Portal APIè·å–æ•°æ®]
    PORTAL_API --> TAXCODE_CHECK{æ£€æŸ¥TaxCode}
    TAXCODE_CHECK -->|å·²å¡«å†™| TAXCODE_EXISTS[æ˜¾ç¤ºå®¡æ‰¹é¡µé¢]
    TAXCODE_CHECK -->|æœªå¡«å†™| TAXCODE_REQUIRED[é”€å”®å¡«å†™TaxCode]
    
    TAXCODE_EXISTS --> PORTAL_APPROVE[å®¡æ‰¹é€šè¿‡]
    TAXCODE_EXISTS --> PORTAL_REJECT[å®¡æ‰¹æ‹’ç»]
    TAXCODE_REQUIRED --> PORTAL_APPROVE
    TAXCODE_REQUIRED --> PORTAL_REJECT
    
    PORTAL_APPROVE --> SYNC_PORTAL[åŒæ­¥Viewç³»ç»Ÿ]
    PORTAL_APPROVE --> WECHAT_PUSH[å‘é€å¾®ä¿¡æ¨é€]
    PORTAL_REJECT --> UNBIND_USER[è§£ç»‘Portalç”¨æˆ·]
    PORTAL_REJECT --> NO_WECHAT[ä¸å‘é€æ¨é€]
    
    PORTAL_CONTRACT --> EXISTING_COMPANY[æ˜¾ç¤ºç°æœ‰å…¬å¸ä¿¡æ¯]
    EXISTING_COMPANY --> NEW_CONTACT[æ–°ç”³è¯·è”ç³»äºº]
    NEW_CONTACT --> CONTRACT_APPROVE[å®¡æ‰¹é€šè¿‡]
    NEW_CONTACT --> CONTRACT_REJECT[å®¡æ‰¹æ‹’ç»]
    
    CONTRACT_APPROVE --> SYNC_CONTACT[åŒæ­¥è”ç³»äºº]
    CONTRACT_APPROVE --> WECHAT_CONTACT[å‘é€å¾®ä¿¡æ¨é€]
    CONTRACT_REJECT --> UNBIND_CONTACT[è§£ç»‘è”ç³»äºº]
    
    REACTIVATE --> CHECK_EXISTS{æ£€æŸ¥Partneræ˜¯å¦å­˜åœ¨}
    CHECK_EXISTS -->|ä¸å­˜åœ¨| CREATE_NEW[ç”Ÿæˆæ–°Customer&Contact]
    CHECK_EXISTS -->|å·²å­˜åœ¨| CREATE_CONTACT[ä»…ç”ŸæˆContact]
    CREATE_NEW --> REACTIVATE_NOTIFY[å‘é€æ¿€æ´»é€šçŸ¥]
    CREATE_CONTACT --> REACTIVATE_NOTIFY
    
    SYNC_LEGACY --> PROJECT_ASSIGN[é¡¹ç›®åˆ†é…ç®¡ç†]
    SYNC_PORTAL --> PROJECT_ASSIGN
    SYNC_CONTACT --> PROJECT_ASSIGN
    REACTIVATE_NOTIFY --> PROJECT_ASSIGN
    
    PROJECT_ASSIGN --> ASSIGN_LIST[é¡¹ç›®åˆ†é…åˆ—è¡¨]
    ASSIGN_LIST --> BATCH_ASSIGN[æ‰¹é‡åˆ†é…]
    BATCH_ASSIGN --> PROJECT_WECHAT[å‘é€é¡¹ç›®é€šçŸ¥]
```

**å®¡æ‰¹å†³ç­–æµç¨‹å›¾**:

```mermaid
flowchart TD
    DATA_SOURCE{æ•°æ®æ¥æºåˆ¤æ–­} --> VIEW_IMPORT[Viewå¯¼å…¥æ•°æ®]
    DATA_SOURCE --> PORTAL_NEW[Portalæ–°å…¬å¸ç”³è¯·]
    DATA_SOURCE --> PORTAL_EXISTING[Portalç°æœ‰å…¬å¸æ–°è”ç³»äºº]
    
    VIEW_IMPORT --> QUESTION_LIST[Question Listå¡«å†™]
    PORTAL_NEW --> API_FETCH[APIè·å–Portalæ•°æ®]
    PORTAL_EXISTING --> PARTNER_INFO[è¿›å…¥Partner Info Tab]
    
    QUESTION_LIST --> CONTACT_EDIT[è”ç³»äººæ–°å¢/ç¼–è¾‘/åˆ é™¤]
    API_FETCH --> TAXCODE_HANDLE[TaxCodeå¤„ç†]
    PARTNER_INFO --> EXISTING_INFO[æ˜¾ç¤ºç°æœ‰ä¿¡æ¯]
    
    CONTACT_EDIT --> PORTAL_ACCOUNT[Portal Accountè®¾ç½®]
    TAXCODE_HANDLE --> INQUIRY_REPLY[ç”¨æˆ·å’¨è¯¢å¤„ç†]
    EXISTING_INFO --> NEW_APPLY[æ–°ç”³è¯·ä¿¡æ¯å¯¹æ¯”]
    
    PORTAL_ACCOUNT --> SAVE_DRAFT[ä¿å­˜è‰ç¨¿]
    INQUIRY_REPLY --> SAVE_DRAFT
    NEW_APPLY --> SAVE_DRAFT
    
    SAVE_DRAFT --> APPROVE_REJECT{å®¡æ‰¹å†³ç­–}
    APPROVE_REJECT -->|é€šè¿‡| APPROVAL_SUCCESS[å®¡æ‰¹é€šè¿‡æµç¨‹]
    APPROVE_REJECT -->|æ‹’ç»| APPROVAL_REJECT[å®¡æ‰¹æ‹’ç»æµç¨‹]
    
    APPROVAL_SUCCESS --> SYNC_CHECK{éœ€è¦åŒæ­¥?}
    SYNC_CHECK -->|æ˜¯| LEGACY_SYNC[Viewç³»ç»ŸåŒæ­¥]
    SYNC_CHECK -->|å¦| WECHAT_CHECK{éœ€è¦æ¨é€?}
    LEGACY_SYNC --> WECHAT_CHECK
    
    WECHAT_CHECK -->|Portalæ•°æ®| SEND_WECHAT[å‘é€å¾®ä¿¡æ¨é€]
    WECHAT_CHECK -->|Viewæ•°æ®| NO_PUSH[ä¸å‘é€æ¨é€]
    SEND_WECHAT --> DONE[å®Œæˆ]
    NO_PUSH --> DONE
    
    APPROVAL_REJECT --> DECLINE_RECORD[åˆ›å»ºdeclineè®°å½•]
    DECLINE_RECORD --> UNBIND_API[è°ƒç”¨è§£ç»‘API]
    UNBIND_API --> REJECT_DONE[å®Œæˆ]
```

#### 6.3.2 å½±å“çš„æ•°æ®è¡¨

- Viewç«¯
  - **[mod_channel_partner_companies](#table-mod_channel_partner_companies)** : Viewç«¯ Upload CompanyåŸºç¡€ä¿¡æ¯è¡¨
  - **[mod_channel_partner_user](#table-mod_channel_partner_user)** : Viewç«¯ Upload UseråŸºç¡€ä¿¡æ¯è¡¨
  - **[customer_employee](#table-customer_employee)** : Viewç«¯ Customerå…³è”çš„é”€å”®
  - **[customer](#table-customer)** : Viewç«¯ Customerå…³è”çš„é”€å”®
  - **[contact](#table-contact)** : Viewç«¯ Customerå…³è”çš„é”€å”®
  - **[project](#table-project)** : Viewç«¯ Customerå…³è”çš„é”€å”®
  - **[mod_channel_question_answers](#table-mod_channel_question_answers)** : Viewç«¯ Customerå…³è”çš„é”€å”®
  - **[mod_channel_project_assignments](#table-mod_channel_project_assignments)** : Viewç«¯ Customerå…³è”çš„é”€å”®
  - **[mod_channel_inquiries](#table-mod_channel_inquiries)** : Viewç«¯ Customerå…³è”çš„é”€å”®
  - **[mod_channel_inquiry_rating](#table-mod_channel_inquiry_rating)** : Viewç«¯ Customerå…³è”çš„é”€å”®
  - **[mod_channel_registration_requests](#table-mod_channel_registration_requests)** : Viewç«¯ Customerå…³è”çš„é”€å”®

- Portalç«¯
  - **[users](#table-users)** : Portalç«¯ UseråŸºç¡€ä¿¡æ¯è¡¨
  - **[companies](#table-companies)** : Portalç«¯ Company åŸºç¡€ä¿¡æ¯è¡¨
  - **[user_company](#table-user_company)** : User&Company å…³è”è¡¨(è®°å½• Partner å½“å‰çŠ¶æ€)
  - **[user_company_assignment](#table-user_company_assignment)** : Portalç«¯ Partner å…³è” é”€å”®è¡¨
  - **[registration_requests](#table-registration_requests)** : Portalç«¯ Partner å…³è” é”€å”®è¡¨
  - **[leads](#table-leads)** : Portalç«¯ Partner å…³è” é”€å”®è¡¨
  - **[inquiries](#table-inquiries)** : Portalç«¯ Partner å…³è” é”€å”®è¡¨
  - **[inquiry_rating](#table-inquiry_rating)** : Portalç«¯ Partner å…³è” é”€å”®è¡¨

#### 6.3.3 å‰ç«¯å®ç°

##### 6.3.3.1 è§†å›¾ç›®å½•ç»“æ„

```plaintext
/resources/views/channel-partner-approval/
  import-approval.blade.php        - Viewå¯¼å…¥æ•°æ®å®¡æ‰¹é¡µé¢
  portal-partner-approval.blade.php - Portalæ–°å…¬å¸ç”³è¯·å®¡æ‰¹é¡µé¢
  portal-contract-approval.blade.php - Portalæ–°è”ç³»äººç”³è¯·å®¡æ‰¹é¡µé¢
  reactivate-declined.blade.php    - é‡æ–°æ¿€æ´»é¡µé¢

/resources/views/project-assignment/
  assignment-list.blade.php        - é¡¹ç›®åˆ†é…åˆ—è¡¨é¡µé¢

/public/partner-info/
  partnerinfo.phtml                 - Partner Infoé¡µé¢ï¼ˆå¯„å­˜ManageCustomerçš„æ–°å¢tabï¼‰
```

##### 6.3.3.2 å…³é”®è§†å›¾åŠŸèƒ½

- **import-approval.blade.php** åŒ…å«:
  - æ¸ é“å•†åŸºæœ¬ä¿¡æ¯å±•ç¤ºï¼ˆViewæœ¬åœ°æ•°æ®ï¼‰
  - è”ç³»äººä¿¡æ¯å±•ç¤ºå’Œç¼–è¾‘ï¼ˆæ”¯æŒå¤šè”ç³»äººæ˜¾ç¤ºå’Œæ“ä½œï¼‰
  - **Question Listç»„ä»¶é›†æˆ**:å¯é€‰å¡«å†™ï¼Œæ”¯æŒå›å¤åŠŸèƒ½ï¼Œæ ‡è®°æ–°æ—§
  - Portal Accountè®¾ç½®é€‰é¡¹
  - ä¿å­˜è‰ç¨¿ã€å®¡æ‰¹é€šè¿‡ã€å®¡æ‰¹æ‹’ç»æŒ‰é’®
  - æ•°æ®æ¥æºæ ‡è¯†æ˜¾ç¤º

- **portal-partner-approval.blade.php** åŒ…å«:
  - æ¸ é“å•†åŸºæœ¬ä¿¡æ¯å±•ç¤ºï¼ˆPortal APIå®æ—¶æ‹‰å–æ•°æ®ï¼‰
  - è”ç³»äººä¿¡æ¯å±•ç¤ºå’Œç¼–è¾‘
  - TaxCodeå¤„ç†é€»è¾‘ï¼ˆè‡ªåŠ¨æ£€æŸ¥å’Œæ‰‹åŠ¨å¡«å†™ï¼‰
  - ChannelProjectListï¼ˆä»…Portalç”³è¯·æ˜¾ç¤ºï¼Œé€šè¿‡APIå®æ—¶æ‹‰å–ï¼‰
  - Inquiryç®¡ç†ï¼ˆä»…Portalç”³è¯·æ˜¾ç¤ºï¼Œé€šè¿‡APIå®æ—¶æ‹‰å–ï¼‰
  - **Question Listç»„ä»¶**:å¯é€‰å¡«å†™ï¼Œæ”¯æŒå›å¤åŠŸèƒ½ï¼Œæ ‡è®°æ–°æ—§
  - ä¿å­˜è‰ç¨¿ã€å®¡æ‰¹é€šè¿‡ã€å®¡æ‰¹æ‹’ç»æŒ‰é’®
  - æ•°æ®æ¥æºæ ‡è¯†æ˜¾ç¤º

- **portal-contract-approval.blade.php** åŒ…å«:
  - **å®¡æ‰¹ä¸­çŠ¶æ€**:æ–°è”ç³»äººç”³è¯·å®¡æ‰¹åŠŸèƒ½ï¼Œæ˜¾ç¤ºåŸæœ‰å…¬å¸ä¿¡æ¯ä¸æ–°ç”³è¯·ä¿¡æ¯çš„å¯¹æ¯”
  - ç°æœ‰å…¬å¸ä¿¡æ¯å±•ç¤ºï¼ˆViewç³»ç»Ÿæ•°æ®ï¼‰
  - æ–°ç”³è¯·å…¬å¸ä¿¡æ¯å¯¹æ¯”å±•ç¤º
  - ç°æœ‰è”ç³»äººä¿¡æ¯ï¼ˆåªè¯»ï¼‰å’Œæ–°ç”³è¯·è”ç³»äººä¿¡æ¯ï¼ˆå¯ç¼–è¾‘ï¼‰
  - é¡¹ç›®åˆ—è¡¨å¯¹æ¯”ï¼ˆç°æœ‰é¡¹ç›® vs æ–°ç”³è¯·é¡¹ç›®ï¼‰
  - å’¨è¯¢è®°å½•å¯¹æ¯”ï¼ˆç°æœ‰å’¨è¯¢ vs æ–°ç”³è¯·å’¨è¯¢ï¼‰
  - **Question Listç»„ä»¶**:å¯é€‰å¡«å†™ï¼Œæ”¯æŒå›å¤åŠŸèƒ½
  - ä¿å­˜è‰ç¨¿ã€å®¡æ‰¹é€šè¿‡ã€å®¡æ‰¹æ‹’ç»æŒ‰é’®

- **assignment-list.blade.php** åŒ…å«:
  - å¤šæ¡ä»¶æœç´¢ç­›é€‰è¡¨å•
  - é¡¹ç›®åˆ—è¡¨è¡¨æ ¼ï¼ˆæ”¯æŒæ’åºå’Œåˆ†é¡µï¼‰
  - å¤šé€‰checkboxè¿›è¡Œæ‰¹é‡åˆ†é…
  - æ‰¹é‡åˆ†é…æ“ä½œåŒºåŸŸ

- **partnerinfo.phtml** åŒ…å«:
  - **å®¡æ‰¹ä¸­çŠ¶æ€**:æ–°è”ç³»äººç”³è¯·å®¡æ‰¹åŠŸèƒ½ï¼Œæ˜¾ç¤ºåŸæœ‰å…¬å¸ä¿¡æ¯ä¸æ–°ç”³è¯·ä¿¡æ¯çš„å¯¹æ¯”ï¼ŒQuestion Listç»„ä»¶
  - **å®¡æ‰¹é€šè¿‡çŠ¶æ€**:ä»…æŸ¥çœ‹æ¨¡å¼ï¼Œactiveæ¸ é“å•†æ˜¾ç¤º"æ–°å¢é¡¹ç›®"å’Œ"åˆ†é…é¡¹ç›®"æŒ‰é’®

#### 6.3.4 è·¯ç”±è®¾è®¡

| HTTPæ–¹æ³• | ç«¯ç‚¹ | æè¿° |
|----------|------|------|
| GET | `/modchannel-approval/import/{id}` | Viewå¯¼å…¥æ•°æ®å®¡æ‰¹é¡µé¢ |
| GET | `/modchannel-approval/portal/partner/{portalId}` | Portalæ–°å…¬å¸ç”³è¯·å®¡æ‰¹é¡µé¢ |
| GET | `/modchannel-approval/portal/contract/{portalId}` | Portalæ–°è”ç³»äººç”³è¯·å®¡æ‰¹é¡µé¢ |
| POST | `/modchannel-approval/save` | ä¿å­˜å®¡æ‰¹è‰ç¨¿ |
| POST | `/modchannel-approval/import/{id}/approve` | é€šè¿‡Viewå¯¼å…¥æ•°æ®å®¡æ‰¹ |
| POST | `/modchannel-approval/import/{id}/reject` | æ‹’ç»Viewå¯¼å…¥æ•°æ®å®¡æ‰¹ |
| POST | `/modchannel-approval/portal/partner/{portalId}/approve` | é€šè¿‡Portalæ–°å…¬å¸ç”³è¯·å®¡æ‰¹ |
| POST | `/modchannel-approval/portal/partner/{portalId}/reject` | æ‹’ç»Portalæ–°å…¬å¸ç”³è¯·å®¡æ‰¹ |
| POST | `/modchannel-approval/portal/contract/{portalId}/approve` | é€šè¿‡Portalæ–°è”ç³»äººç”³è¯·å®¡æ‰¹ |
| POST | `/modchannel-approval/portal/contract/{portalId}/reject` | æ‹’ç»Portalæ–°è”ç³»äººç”³è¯·å®¡æ‰¹ |
| POST | `/modchannel-approval/reactivate` | é‡æ–°æ¿€æ´»è¢«declineçš„æ•°æ® |
| GET | `/project-assignment/list` | é¡¹ç›®åˆ†é…åˆ—è¡¨é¡µé¢ |
| GET | `/project-assignment/available-projects` | è·å–å¯åˆ†é…é¡¹ç›®åˆ—è¡¨API |
| POST | `/project-assignment/assign` | æ‰§è¡Œæ‰¹é‡é¡¹ç›®åˆ†é… |
| GET | `/partner-info/{companyId}` | Partner Info HTMLé¡µé¢ |
| POST | `/partner-info/{companyId}/approve-contact` | é€šè¿‡æ–°è”ç³»äººå®¡æ‰¹ |
| POST | `/partner-info/{companyId}/reject-contact` | æ‹’ç»æ–°è”ç³»äººå®¡æ‰¹ |

#### 6.3.5 é”™è¯¯å¤„ç†å’Œæ—¥å¿—è®°å½•

##### 6.3.5.1 æ—¥å¿—è®°å½•

ä½¿ç”¨DynamicLoggerFactoryè¿›è¡Œæ¨¡å—åŒ–æ—¥å¿—è®°å½•:

| æ“ä½œç±»å‹ | è®°å½•æ—¶æœº |
|----------|----------|
| portal_api_failed | Portal APIè°ƒç”¨å¤±è´¥ |
| approval_failed | å®¡æ‰¹æ“ä½œå¤±è´¥ |
| legacy_sync_failed | Viewç³»ç»ŸåŒæ­¥å¤±è´¥ |
| wechat_push_failed | å¾®ä¿¡æ¨é€å¤±è´¥ |
| project_assignment_failed | é¡¹ç›®åˆ†é…å¤±è´¥ |
| user_unbind_failed | Portalç”¨æˆ·è§£ç»‘å¤±è´¥ |

#### 6.3.6 åŠŸèƒ½å¼€å‘ä¸å®ç°

##### 6.3.6.1 ç±»å…³ç³»å›¾

```mermaid
classDiagram
    class ModChannelPartnerApprovalController {
        +showImportApproval(id)
        +showPortalPartnerApproval(portalId)
        +showPortalContractApproval(portalId)
        +saveApprovalData(Request)
        +approveImportData(id, Request)
        +rejectImportData(id, Request)
        +approvePortalPartner(portalId, Request)
        +rejectPortalPartner(portalId, Request)
        +approvePortalContract(portalId, Request)
        +rejectPortalContract(portalId, Request)
        +reactivateDeclinedData(Request)
    }

    class ModChannelProjectAssignmentController {
        +showAssignmentList(Request)
        +getAvailableProjects(Request)
        +batchAssignProjects(Request)
    }

    class LegacyCustomerController {
        +showManageCustomer(customerId)
        +approveNewContact(Request)
        +rejectNewContact(Request)
    }

    class ModChannelPartnerApprovalService {
        +getApprovalData(id, source)
        +getPortalUserAndCompanyData(portalId)
        +saveApprovalDraft(data)
        +processImportApproval(data)
        +processPortalPartnerApproval(data)
        +processPortalContractApproval(data)
        +reactivateDeclinedPartner(data)
        +validateApprovalData(data)
        +handleContactOperations(contacts)
        +processQuestionList(questions)
    }

    class ModChannelDataSyncService {
        +syncToLegacySystem(customerData)
        +createCustomerRecord(companyData)
        +createContactRecords(contactsData)
        +updatePartnerStatus(partnerId, status)
        +callPortalApprovalAPI(approvalResult)
        +callPortalUserUnbindAPI(unbindData)
        +validateSyncData(data)
        +handleSyncErrors(error)
    }

    class ModChannelNotificationService {
        +callWechatPushAPI(notificationData)
        +sendApprovalNotification(userIds, result)
        +sendProjectAssignmentNotification(assignment)
        +sendReactivationNotification(userIds)
        +validateNotificationData(data)
        +handlePushErrors(error)
    }

    class ModChannelProjectAssignmentService {
        +getAvailableProjects(filters)
        +validateProjectAssignment(projectIds, partnerId)
        +batchAssignProjects(assignmentData)
        +updateProjectDistributor(projectId, partnerId, status)
        +recordAssignmentHistory(assignment)
        +getPartnerProjects(partnerId)
    }

    class LegacyAccountService {
        +getPartnerAccountInfo(customerId)
        +processPartnerContactApproval(approvalData)
        +getCustomerPartnerInfo(customerId)
        +validatePartnerContact(contactData)
        +updateContactStatus(contactId, status)
    }

    class DynamicLoggerFactory {
        +createLogger(module)
        +logApprovalOperation(operation, result)
        +logSyncOperation(operation, result)
        +logNotificationOperation(operation, result)
        +logError(module, error)
    }

    ModChannelPartnerApprovalController --> ModChannelPartnerApprovalService : ä¸šåŠ¡å¤„ç†
    ModChannelPartnerApprovalController --> ModChannelDataSyncService : æ•°æ®åŒæ­¥
    ModChannelPartnerApprovalController --> ModChannelNotificationService : é€šçŸ¥æœåŠ¡
    ModChannelPartnerApprovalController --> DynamicLoggerFactory : æ—¥å¿—è®°å½•

    ModChannelProjectAssignmentController --> ModChannelProjectAssignmentService : é¡¹ç›®åˆ†é…
    ModChannelProjectAssignmentController --> ModChannelNotificationService : é€šçŸ¥æœåŠ¡
    ModChannelProjectAssignmentController --> DynamicLoggerFactory : æ—¥å¿—è®°å½•

    LegacyCustomerController --> LegacyAccountService : è´¦æˆ·æœåŠ¡
    LegacyCustomerController --> ModChannelNotificationService : é€šçŸ¥æœåŠ¡

    ModChannelPartnerApprovalService --> ModChannelDataSyncService : è°ƒç”¨åŒæ­¥
    ModChannelPartnerApprovalService --> DynamicLoggerFactory : æ—¥å¿—è®°å½•

    ModChannelDataSyncService --> DynamicLoggerFactory : æ—¥å¿—è®°å½•
    ModChannelNotificationService --> DynamicLoggerFactory : æ—¥å¿—è®°å½•
    ModChannelProjectAssignmentService --> DynamicLoggerFactory : æ—¥å¿—è®°å½•
    LegacyAccountService --> DynamicLoggerFactory : æ—¥å¿—è®°å½•
```

##### 6.3.6.2 æ§åˆ¶å™¨å®ç°

- **ModChannelPartnerApprovalController.php**

- **æ–‡ä»¶è·¯å¾„**:`app/Http/Controllers/ModChannelPlatform/ModChannelPartnerApprovalController.php`
- **æ–‡ä»¶çŠ¶æ€**:æ–°å¢
- **ä¾èµ–æœåŠ¡**:ModChannelPartnerApprovalService, ModChannelDataSyncService, ModChannelNotificationService
- **æ—¥å¿—è®°å½•**:DynamicLoggerFactory
- **æ–¹æ³•**:

  - **showImportApproval($id)**
    - **åŠŸèƒ½æè¿°**:æ˜¾ç¤ºViewå¯¼å…¥æ•°æ®å®¡æ‰¹é¡µé¢ï¼Œè·å–æœ¬åœ°mod_channel_partnersè¡¨æ•°æ®
    - **æ–¹æ³•çŠ¶æ€**:æ–°å¢
    - **è°ƒç”¨é¡ºåº**:é”€å”®ç‚¹å‡»å¯¼å…¥æ•°æ®å®¡æ‰¹æ—¶è°ƒç”¨
    - **ä¾èµ–æœåŠ¡**:ModChannelPartnerApprovalService
    - **è¯·æ±‚å‚æ•°**:

      | å‚æ•°åç§° | æ•°æ®ç±»å‹ | æ˜¯å¦å¿…å¡« | æè¿° |
      |----------|----------|----------|------|
      | id | Integer | æ˜¯ | æ¸ é“å•†è®°å½•ID |

    - **å“åº”æ•°æ®**:

      | å‚æ•°åç§° | æ•°æ®ç±»å‹ | æè¿° |
      |----------|----------|------|
      | view | Blade | import-approval.blade.phpè§†å›¾ |
      | approvalData | Array | å®¡æ‰¹æ•°æ®å¯¹è±¡ |

  - **showPortalPartnerApproval($portalId)**
    - **åŠŸèƒ½æè¿°**:æ˜¾ç¤ºPortalæ–°å…¬å¸ç”³è¯·å®¡æ‰¹é¡µé¢ï¼Œè°ƒç”¨Portal APIè·å–ç”¨æˆ·å’Œå…¬å¸æ•°æ®
    - **æ–¹æ³•çŠ¶æ€**:æ–°å¢
    - **è°ƒç”¨é¡ºåº**:é”€å”®ç‚¹å‡»Portalå…¬å¸ç”³è¯·å®¡æ‰¹æ—¶è°ƒç”¨
    - **ä¾èµ–æœåŠ¡**:ModChannelPartnerApprovalService
    - **è¯·æ±‚å‚æ•°**:

      | å‚æ•°åç§° | æ•°æ®ç±»å‹ | æ˜¯å¦å¿…å¡« | æè¿° |
      |----------|----------|----------|------|
      | portalId | Integer | æ˜¯ | Portalç«¯ç”³è¯·ID |

    - **å“åº”æ•°æ®**:

      | å‚æ•°åç§° | æ•°æ®ç±»å‹ | æè¿° |
      |----------|----------|------|
      | view | Blade | portal-partner-approval.blade.phpè§†å›¾ |
      | approvalData | Array | Portalæ•°æ®å¯¹è±¡ |

  - **showPortalContractApproval($portalId)**
    - **åŠŸèƒ½æè¿°**:æ˜¾ç¤ºPortalæ–°è”ç³»äººç”³è¯·å®¡æ‰¹é¡µé¢ï¼Œè°ƒç”¨Portal APIè·å–ç”¨æˆ·æ•°æ®å’Œç°æœ‰å…¬å¸ä¿¡æ¯
    - **æ–¹æ³•çŠ¶æ€**:æ–°å¢
    - **è°ƒç”¨é¡ºåº**:é”€å”®ç‚¹å‡»Portalè”ç³»äººç”³è¯·å®¡æ‰¹æ—¶è°ƒç”¨
    - **ä¾èµ–æœåŠ¡**:ModChannelPartnerApprovalService
    - **è¯·æ±‚å‚æ•°**:

      | å‚æ•°åç§° | æ•°æ®ç±»å‹ | æ˜¯å¦å¿…å¡« | æè¿° |
      |----------|----------|----------|------|
      | portalId | Integer | æ˜¯ | Portalç«¯ç”³è¯·ID |

    - **å“åº”æ•°æ®**:

      | å‚æ•°åç§° | æ•°æ®ç±»å‹ | æè¿° |
      |----------|----------|------|
      | view | Blade | portal-contract-approval.blade.phpè§†å›¾ |
      | approvalData | Array | Portalæ•°æ®å¯¹è±¡ |

  - **saveApprovalData(Request $request)**
    - **åŠŸèƒ½æè¿°**:ä¿å­˜å®¡æ‰¹è‰ç¨¿ï¼Œä¸æ”¹å˜å®¡æ‰¹çŠ¶æ€ï¼Œè¢«åˆ é™¤è”ç³»äººé»˜è®¤æ ‡è®°ä¸ºæ‹’ç»
    - **æ–¹æ³•çŠ¶æ€**:æ–°å¢
    - **è°ƒç”¨é¡ºåº**:é”€å”®ç‚¹å‡»ä¿å­˜æŒ‰é’®æ—¶è°ƒç”¨
    - **ä¾èµ–æœåŠ¡**:ModChannelPartnerApprovalService
    - **è¯·æ±‚å‚æ•°**:

      | å‚æ•°åç§° | æ•°æ®ç±»å‹ | æ˜¯å¦å¿…å¡« | æè¿° |
      |----------|----------|----------|------|
      | approvalType | String | æ˜¯ | å®¡æ‰¹ç±»å‹(import/portal_partner/portal_contract) |
      | companyData | Array | æ˜¯ | å…¬å¸æ•°æ®å¯¹è±¡ |
      | contactsData | Array | æ˜¯ | è”ç³»äººæ•°æ®æ•°ç»„ |
      | questionListData | Array | å¦ | é—®é¢˜åˆ—è¡¨æ•°æ® |
      | deletedContacts | Array | å¦ | è¢«åˆ é™¤çš„è”ç³»äººIDæ•°ç»„ |

    - **å“åº”æ•°æ®**:

      | å‚æ•°åç§° | æ•°æ®ç±»å‹ | æè¿° |
      |----------|----------|------|
      | success | Boolean | æ˜¯å¦ä¿å­˜æˆåŠŸ |
      | message | String | ä¿å­˜ç»“æœä¿¡æ¯ |
      | data | Array | ä¿å­˜ç»“æœæ•°æ® |

  - **approveImportData($id, Request $request)**
    - **åŠŸèƒ½æè¿°**:é€šè¿‡Viewå¯¼å…¥æ•°æ®å®¡æ‰¹ï¼ŒåŒæ­¥åˆ°Viewç³»ç»Ÿï¼Œä¸å‘é€å¾®ä¿¡æ¨é€
    - **æ–¹æ³•çŠ¶æ€**:æ–°å¢
    - **è°ƒç”¨é¡ºåº**:é”€å”®ç‚¹å‡»é€šè¿‡æŒ‰é’®æ—¶è°ƒç”¨
    - **ä¾èµ–æœåŠ¡**:ModChannelPartnerApprovalService, ModChannelDataSyncService
    - **è¯·æ±‚å‚æ•°**:

      | å‚æ•°åç§° | æ•°æ®ç±»å‹ | æ˜¯å¦å¿…å¡« | æè¿° |
      |----------|----------|----------|------|
      | id | Integer | æ˜¯ | æ¸ é“å•†è®°å½•ID |
      | companyData | Array | æ˜¯ | å…¬å¸æ•°æ®å¯¹è±¡ |
      | contactsData | Array | æ˜¯ | è”ç³»äººæ•°æ®æ•°ç»„ |
      | portalAccountSettings | Array | å¦ | Portalè´¦æˆ·è®¾ç½® |
      | questionListData | Array | å¦ | é—®é¢˜åˆ—è¡¨æ•°æ® |

    - **å“åº”æ•°æ®**:

      | å‚æ•°åç§° | æ•°æ®ç±»å‹ | æè¿° |
      |----------|----------|------|
      | success | Boolean | æ˜¯å¦å®¡æ‰¹æˆåŠŸ |
      | message | String | å®¡æ‰¹ç»“æœä¿¡æ¯ |
      | data | Array | å®¡æ‰¹ç»“æœæ•°æ® |

  - **rejectImportData($id, Request $request)**
    - **åŠŸèƒ½æè¿°**:æ‹’ç»Viewå¯¼å…¥æ•°æ®å®¡æ‰¹ï¼Œä¸å‘é€å¾®ä¿¡æ¨é€
    - **æ–¹æ³•çŠ¶æ€**:æ–°å¢
    - **è°ƒç”¨é¡ºåº**:é”€å”®ç‚¹å‡»æ‹’ç»æŒ‰é’®æ—¶è°ƒç”¨
    - **ä¾èµ–æœåŠ¡**:ModChannelPartnerApprovalService
    - **è¯·æ±‚å‚æ•°**:

      | å‚æ•°åç§° | æ•°æ®ç±»å‹ | æ˜¯å¦å¿…å¡« | æè¿° |
      |----------|----------|----------|------|
      | id | Integer | æ˜¯ | æ¸ é“å•†è®°å½•ID |
      | rejectReason | String | æ˜¯ | æ‹’ç»åŸå›  |

    - **å“åº”æ•°æ®**:

      | å‚æ•°åç§° | æ•°æ®ç±»å‹ | æè¿° |
      |----------|----------|------|
      | success | Boolean | æ˜¯å¦æ‹’ç»æˆåŠŸ |
      | message | String | æ‹’ç»ç»“æœä¿¡æ¯ |
      | data | Array | æ‹’ç»ç»“æœæ•°æ® |

  - **approvePortalPartner($portalId, Request $request)**
    - **åŠŸèƒ½æè¿°**:é€šè¿‡Portalæ–°å…¬å¸ç”³è¯·å®¡æ‰¹ï¼ŒåŒæ­¥åˆ°Viewç³»ç»Ÿï¼Œå‘é€å¾®ä¿¡æ¨é€
    - **æ–¹æ³•çŠ¶æ€**:æ–°å¢
    - **è°ƒç”¨é¡ºåº**:é”€å”®ç‚¹å‡»é€šè¿‡æŒ‰é’®æ—¶è°ƒç”¨
    - **ä¾èµ–æœåŠ¡**:ModChannelPartnerApprovalService, ModChannelDataSyncService, ModChannelNotificationService
    - **è¯·æ±‚å‚æ•°**:

      | å‚æ•°åç§° | æ•°æ®ç±»å‹ | æ˜¯å¦å¿…å¡« | æè¿° |
      |----------|----------|----------|------|
      | portalId | Integer | æ˜¯ | Portalç«¯ç”³è¯·ID |
      | companyData | Array | æ˜¯ | å…¬å¸æ•°æ®å¯¹è±¡ |
      | contactsData | Array | æ˜¯ | è”ç³»äººæ•°æ®æ•°ç»„ |
      | taxCode | String | æ˜¯ | ç¨å· |
      | questionListData | Array | å¦ | é—®é¢˜åˆ—è¡¨æ•°æ® |

    - **å“åº”æ•°æ®**:

      | å‚æ•°åç§° | æ•°æ®ç±»å‹ | æè¿° |
      |----------|----------|------|
      | success | Boolean | æ˜¯å¦å®¡æ‰¹æˆåŠŸ |
      | message | String | å®¡æ‰¹ç»“æœä¿¡æ¯ |
      | data | Array | å®¡æ‰¹ç»“æœæ•°æ® |

  - **rejectPortalPartner($portalId, Request $request)**
    - **åŠŸèƒ½æè¿°**:æ‹’ç»Portalæ–°å…¬å¸ç”³è¯·å®¡æ‰¹ï¼Œåˆ›å»ºdeclineè®°å½•ï¼Œè°ƒç”¨Portalè§£ç»‘APIï¼Œä¸å‘é€å¾®ä¿¡æ¨é€
    - **æ–¹æ³•çŠ¶æ€**:æ–°å¢
    - **è°ƒç”¨é¡ºåº**:é”€å”®ç‚¹å‡»æ‹’ç»æŒ‰é’®æ—¶è°ƒç”¨
    - **ä¾èµ–æœåŠ¡**:ModChannelPartnerApprovalService, ModChannelDataSyncService
    - **è¯·æ±‚å‚æ•°**:

      | å‚æ•°åç§° | æ•°æ®ç±»å‹ | æ˜¯å¦å¿…å¡« | æè¿° |
      |----------|----------|----------|------|
      | portalId | Integer | æ˜¯ | Portalç«¯ç”³è¯·ID |
      | rejectReason | String | æ˜¯ | æ‹’ç»åŸå›  |
      | contactsData | Array | æ˜¯ | è”ç³»äººæ•°æ®æ•°ç»„ |

    - **å“åº”æ•°æ®**:

      | å‚æ•°åç§° | æ•°æ®ç±»å‹ | æè¿° |
      |----------|----------|------|
      | success | Boolean | æ˜¯å¦æ‹’ç»æˆåŠŸ |
      | message | String | æ‹’ç»ç»“æœä¿¡æ¯ |
      | data | Array | æ‹’ç»ç»“æœæ•°æ® |

  - **approvePortalContract($portalId, Request $request)**
    - **åŠŸèƒ½æè¿°**:é€šè¿‡Portalæ–°è”ç³»äººç”³è¯·å®¡æ‰¹ï¼ŒåŒæ­¥è”ç³»äººåˆ°Viewç³»ç»Ÿï¼Œå‘é€å¾®ä¿¡æ¨é€
    - **æ–¹æ³•çŠ¶æ€**:æ–°å¢
    - **è°ƒç”¨é¡ºåº**:é”€å”®ç‚¹å‡»é€šè¿‡æŒ‰é’®æ—¶è°ƒç”¨
    - **ä¾èµ–æœåŠ¡**:ModChannelPartnerApprovalService, ModChannelDataSyncService, ModChannelNotificationService
    - **è¯·æ±‚å‚æ•°**:

      | å‚æ•°åç§° | æ•°æ®ç±»å‹ | æ˜¯å¦å¿…å¡« | æè¿° |
      |----------|----------|----------|------|
      | portalId | Integer | æ˜¯ | Portalç«¯ç”³è¯·ID |
      | contactsData | Array | æ˜¯ | è”ç³»äººæ•°æ®æ•°ç»„ |
      | questionListData | Array | å¦ | é—®é¢˜åˆ—è¡¨æ•°æ® |

    - **å“åº”æ•°æ®**:

      | å‚æ•°åç§° | æ•°æ®ç±»å‹ | æè¿° |
      |----------|----------|------|
      | success | Boolean | æ˜¯å¦å®¡æ‰¹æˆåŠŸ |
      | message | String | å®¡æ‰¹ç»“æœä¿¡æ¯ |
      | data | Array | å®¡æ‰¹ç»“æœæ•°æ® |

  - **rejectPortalContract($portalId, Request $request)**
    - **åŠŸèƒ½æè¿°**:æ‹’ç»Portalæ–°è”ç³»äººç”³è¯·å®¡æ‰¹ï¼Œåˆ›å»ºdeclineè®°å½•ï¼Œè°ƒç”¨Portalè§£ç»‘APIï¼Œä¸å‘é€å¾®ä¿¡æ¨é€
    - **æ–¹æ³•çŠ¶æ€**:æ–°å¢
    - **è°ƒç”¨é¡ºåº**:é”€å”®ç‚¹å‡»æ‹’ç»æŒ‰é’®æ—¶è°ƒç”¨
    - **ä¾èµ–æœåŠ¡**:ModChannelPartnerApprovalService, ModChannelDataSyncService
    - **è¯·æ±‚å‚æ•°**:

      | å‚æ•°åç§° | æ•°æ®ç±»å‹ | æ˜¯å¦å¿…å¡« | æè¿° |
      |----------|----------|----------|------|
      | portalId | Integer | æ˜¯ | Portalç«¯ç”³è¯·ID |
      | rejectReason | String | æ˜¯ | æ‹’ç»åŸå›  |
      | contactsData | Array | æ˜¯ | è”ç³»äººæ•°æ®æ•°ç»„ |

    - **å“åº”æ•°æ®**:

      | å‚æ•°åç§° | æ•°æ®ç±»å‹ | æè¿° |
      |----------|----------|------|
      | success | Boolean | æ˜¯å¦æ‹’ç»æˆåŠŸ |
      | message | String | æ‹’ç»ç»“æœä¿¡æ¯ |
      | data | Array | æ‹’ç»ç»“æœæ•°æ® |

  - **reactivateDeclinedData(Request $request)**
    - **åŠŸèƒ½æè¿°**:é‡æ–°æ¿€æ´»è¢«declineçš„æ•°æ®ï¼Œæ ¹æ®æ•°æ®æ¥æºå†³å®šæ˜¯å¦å‘é€å¾®ä¿¡æ¨é€
    - **æ–¹æ³•çŠ¶æ€**:æ–°å¢
    - **è°ƒç”¨é¡ºåº**:é”€å”®ä»Dashboardç‚¹å‡»é‡æ–°æ¿€æ´»æ—¶è°ƒç”¨
    - **ä¾èµ–æœåŠ¡**:ModChannelPartnerApprovalService, ModChannelNotificationService
    - **è¯·æ±‚å‚æ•°**:

      | å‚æ•°åç§° | æ•°æ®ç±»å‹ | æ˜¯å¦å¿…å¡« | æè¿° |
      |----------|----------|----------|------|
      | recordId | Integer | æ˜¯ | declineè®°å½•ID |
      | reactivationType | String | æ˜¯ | é‡æ–°æ¿€æ´»ç±»å‹(portal/import) |

    - **å“åº”æ•°æ®**:

      | å‚æ•°åç§° | æ•°æ®ç±»å‹ | æè¿° |
      |----------|----------|------|
      | success | Boolean | æ˜¯å¦é‡æ–°æ¿€æ´»æˆåŠŸ |
      | message | String | é‡æ–°æ¿€æ´»ç»“æœä¿¡æ¯ |
      | data | Array | é‡æ–°æ¿€æ´»ç»“æœæ•°æ® |

- **ModChannelProjectAssignmentController.php**

- **æ–‡ä»¶è·¯å¾„**:`app/Http/Controllers/ModChannelPlatform/ModChannelProjectAssignmentController.php`
- **æ–‡ä»¶çŠ¶æ€**:æ–°å¢
- **ä¾èµ–æœåŠ¡**:ModChannelProjectAssignmentService, ModChannelNotificationService
- **æ—¥å¿—è®°å½•**:DynamicLoggerFactory
- **æ–¹æ³•**:

  - **showAssignmentList(Request $request)**
    - **åŠŸèƒ½æè¿°**:æ˜¾ç¤ºé¡¹ç›®åˆ†é…åˆ—è¡¨é¡µé¢ï¼Œæ”¯æŒå¤šæ¡ä»¶ç­›é€‰
    - **æ–¹æ³•çŠ¶æ€**:æ–°å¢
    - **è°ƒç”¨é¡ºåº**:æ¸ é“å•†ç‚¹å‡»åˆ†é…é¡¹ç›®æŒ‰é’®æ—¶è°ƒç”¨
    - **ä¾èµ–æœåŠ¡**:ModChannelProjectAssignmentService
    - **è¯·æ±‚å‚æ•°**:

      | å‚æ•°åç§° | æ•°æ®ç±»å‹ | æ˜¯å¦å¿…å¡« | æè¿° |
      |----------|----------|----------|------|
      | filters | Array | å¦ | ç­›é€‰æ¡ä»¶æ•°ç»„ |

    - **å“åº”æ•°æ®**:

      | å‚æ•°åç§° | æ•°æ®ç±»å‹ | æè¿° |
      |----------|----------|------|
      | view | Blade | assignment-list.blade.phpè§†å›¾ |
      | projects | Array | å¯åˆ†é…é¡¹ç›®åˆ—è¡¨ |
      | filters | Array | ç­›é€‰æ¡ä»¶ |

  - **getAvailableProjects(Request $request)**
    - **åŠŸèƒ½æè¿°**:è·å–å¯åˆ†é…é¡¹ç›®åˆ—è¡¨APIï¼ŒåŒ…æ‹¬è¢«æ‹’ç»çš„é¡¹ç›®
    - **æ–¹æ³•çŠ¶æ€**:æ–°å¢
    - **è°ƒç”¨é¡ºåº**:å‰ç«¯AJAXè°ƒç”¨è·å–é¡¹ç›®åˆ—è¡¨æ—¶è°ƒç”¨
    - **ä¾èµ–æœåŠ¡**:ModChannelProjectAssignmentService
    - **è¯·æ±‚å‚æ•°**:

      | å‚æ•°åç§° | æ•°æ®ç±»å‹ | æ˜¯å¦å¿…å¡« | æè¿° |
      |----------|----------|----------|------|
      | filters | Array | å¦ | ç­›é€‰æ¡ä»¶æ•°ç»„ |

    - **å“åº”æ•°æ®**:

      | å‚æ•°åç§° | æ•°æ®ç±»å‹ | æè¿° |
      |----------|----------|------|
      | success | Boolean | æ˜¯å¦è·å–æˆåŠŸ |
      | data | Array | é¡¹ç›®åˆ—è¡¨æ•°æ® |

  - **batchAssignProjects(Request $request)**
    - **åŠŸèƒ½æè¿°**:æ‰§è¡Œæ‰¹é‡é¡¹ç›®åˆ†é…ï¼Œå‘é€å¾®ä¿¡é€šçŸ¥ï¼Œè®°å½•æ“ä½œæ—¥å¿—
    - **æ–¹æ³•çŠ¶æ€**:æ–°å¢
    - **è°ƒç”¨é¡ºåº**:ç”¨æˆ·é€‰æ‹©é¡¹ç›®å¹¶æ‰§è¡Œåˆ†é…æ—¶è°ƒç”¨
    - **ä¾èµ–æœåŠ¡**:ModChannelProjectAssignmentService, ModChannelNotificationService
    - **è¯·æ±‚å‚æ•°**:

      | å‚æ•°åç§° | æ•°æ®ç±»å‹ | æ˜¯å¦å¿…å¡« | æè¿° |
      |----------|----------|----------|------|
      | projectIds | Array | æ˜¯ | é¡¹ç›®IDæ•°ç»„ |
      | partnerId | Integer | æ˜¯ | æ¸ é“å•†ID |
      | assignedBy | Integer | æ˜¯ | åˆ†é…æ“ä½œäººID |

    - **å“åº”æ•°æ®**:

      | å‚æ•°åç§° | æ•°æ®ç±»å‹ | æè¿° |
      |----------|----------|------|
      | success | Boolean | æ˜¯å¦åˆ†é…æˆåŠŸ |
      | message | String | åˆ†é…ç»“æœä¿¡æ¯ |
      | data | Array | åˆ†é…ç»“æœæ•°æ® |

- **Viewç³»ç»ŸCustomerController.php**

- **æ–‡ä»¶è·¯å¾„**:`app/Http/Controllers/Legacy/CustomerController.php`
- **æ–‡ä»¶çŠ¶æ€**:ä¿®æ”¹
- **ä¾èµ–æœåŠ¡**:CustomerService, AccountService
- **æ–¹æ³•**:

  - **showManageCustomer($customerId)**
    - **åŠŸèƒ½æè¿°**:æ˜¾ç¤ºViewç³»ç»ŸManageCustomeré¡µé¢ï¼Œæ–°å¢Partner Info Tab
    - **æ–¹æ³•çŠ¶æ€**:ä¿®æ”¹
    - **è°ƒç”¨é¡ºåº**:Viewç³»ç»Ÿç”¨æˆ·è®¿é—®å®¢æˆ·ç®¡ç†é¡µé¢æ—¶è°ƒç”¨
    - **ä¾èµ–æœåŠ¡**:CustomerService, AccountService
    - **è¯·æ±‚å‚æ•°**:

      | å‚æ•°åç§° | æ•°æ®ç±»å‹ | æ˜¯å¦å¿…å¡« | æè¿° |
      |----------|----------|----------|------|
      | customerId | Integer | æ˜¯ | å®¢æˆ·ID |

    - **å“åº”æ•°æ®**:

      | å‚æ•°åç§° | æ•°æ®ç±»å‹ | æè¿° |
      |----------|----------|------|
      | view | Blade | manage-customer.blade.phpè§†å›¾ |
      | customerData | Array | å®¢æˆ·æ•°æ®å¯¹è±¡ |
      | partnerInfo | Array | æ¸ é“å•†ä¿¡æ¯ï¼ˆæ–°å¢ï¼‰ |

  - **approveNewContact(Request $request)**
    - **åŠŸèƒ½æè¿°**:åœ¨Partner Info Tabä¸­é€šè¿‡æ–°è”ç³»äººç”³è¯·
    - **æ–¹æ³•çŠ¶æ€**:æ–°å¢
    - **è°ƒç”¨é¡ºåº**:Viewç³»ç»Ÿç”¨æˆ·åœ¨Partner Info Tabä¸­ç‚¹å‡»é€šè¿‡æ—¶è°ƒç”¨
    - **ä¾èµ–æœåŠ¡**:AccountService
    - **è¯·æ±‚å‚æ•°**:

      | å‚æ•°åç§° | æ•°æ®ç±»å‹ | æ˜¯å¦å¿…å¡« | æè¿° |
      |----------|----------|----------|------|
      | customerId | Integer | æ˜¯ | å®¢æˆ·ID |
      | portalUserId | Integer | æ˜¯ | Portalç«¯ç”¨æˆ·ID |
      | contactsData | Array | æ˜¯ | è”ç³»äººæ•°æ®æ•°ç»„ |

    - **å“åº”æ•°æ®**:

      | å‚æ•°åç§° | æ•°æ®ç±»å‹ | æè¿° |
      |----------|----------|------|
      | success | Boolean | æ˜¯å¦å®¡æ‰¹æˆåŠŸ |
      | message | String | å®¡æ‰¹ç»“æœä¿¡æ¯ |
      | data | Array | å®¡æ‰¹ç»“æœæ•°æ® |

  - **rejectNewContact(Request $request)**
    - **åŠŸèƒ½æè¿°**:åœ¨Partner Info Tabä¸­æ‹’ç»æ–°è”ç³»äººç”³è¯·
    - **æ–¹æ³•çŠ¶æ€**:æ–°å¢
    - **è°ƒç”¨é¡ºåº**:Viewç³»ç»Ÿç”¨æˆ·åœ¨Partner Info Tabä¸­ç‚¹å‡»æ‹’ç»æ—¶è°ƒç”¨
    - **ä¾èµ–æœåŠ¡**:AccountService
    - **è¯·æ±‚å‚æ•°**:

      | å‚æ•°åç§° | æ•°æ®ç±»å‹ | æ˜¯å¦å¿…å¡« | æè¿° |
      |----------|----------|----------|------|
      | customerId | Integer | æ˜¯ | å®¢æˆ·ID |
      | portalUserId | Integer | æ˜¯ | Portalç«¯ç”¨æˆ·ID |
      | rejectReason | String | æ˜¯ | æ‹’ç»åŸå›  |

    - **å“åº”æ•°æ®**:

      | å‚æ•°åç§° | æ•°æ®ç±»å‹ | æè¿° |
      |----------|----------|------|
      | success | Boolean | æ˜¯å¦æ‹’ç»æˆåŠŸ |
      | message | String | æ‹’ç»ç»“æœä¿¡æ¯ |
      | data | Array | æ‹’ç»ç»“æœæ•°æ® |

- **ModChannelPartnerApprovalService.php**
  - **æ–‡ä»¶è·¯å¾„**:`app/Services/ModChannelPlatform/ModChannelPartnerApprovalService.php`
  - **æ–‡ä»¶çŠ¶æ€**:æ–°å¢
  - **æ–¹æ³•**:
    - **getApprovalData($id, $source)**
      - **åŠŸèƒ½æè¿°**:æ ¹æ®æ•°æ®æ¥æºè·å–å®¡æ‰¹æ•°æ®ï¼ŒViewå¯¼å…¥ä»æœ¬åœ°è¡¨è·å–ï¼ŒPortalç”³è¯·é€šè¿‡APIå®æ—¶æ‹‰å–
      - **æ–¹æ³•çŠ¶æ€**:æ–°å¢
      - **è°ƒç”¨é¡ºåº**:æ§åˆ¶å™¨æ˜¾ç¤ºå®¡æ‰¹é¡µé¢æ—¶è°ƒç”¨

    - **getPortalUserAndCompanyData($portalId)**
      - **åŠŸèƒ½æè¿°**:è°ƒç”¨Portal APIè·å–ç”¨æˆ·å’Œå…¬å¸æ•°æ®ã€é¡¹ç›®ã€å’¨è¯¢ã€é—®é¢˜å›ç­”ç­‰ä¿¡æ¯
      - **æ–¹æ³•çŠ¶æ€**:æ–°å¢
      - **è°ƒç”¨é¡ºåº**:æ˜¾ç¤ºPortalå®¡æ‰¹é¡µé¢æ—¶è°ƒç”¨

    - **saveApprovalDraft($data)**
      - **åŠŸèƒ½æè¿°**:ä¿å­˜å®¡æ‰¹è‰ç¨¿ï¼Œä¸æ”¹å˜å®¡æ‰¹çŠ¶æ€ï¼Œè¢«åˆ é™¤çš„è”ç³»äººé»˜è®¤æ ‡è®°ä¸ºæ‹’ç»çŠ¶æ€
      - **æ–¹æ³•çŠ¶æ€**:æ–°å¢
      - **è°ƒç”¨é¡ºåº**:ç”¨æˆ·ç‚¹å‡»ä¿å­˜æŒ‰é’®æ—¶è°ƒç”¨

- **ModChannelDataSyncService.php**
  - **æ–‡ä»¶è·¯å¾„**:`app/Services/ModChannelPlatform/ModChannelDataSyncService.php`
  - **æ–‡ä»¶çŠ¶æ€**:æ–°å¢
  - **æ–¹æ³•**:
    - **syncToLegacySystem($customerData)**
      - **åŠŸèƒ½æè¿°**:åŒæ­¥å®¢æˆ·å’Œè”ç³»äººæ•°æ®åˆ°Viewç³»ç»Ÿcustomerå’Œcontactsè¡¨
      - **æ–¹æ³•çŠ¶æ€**:æ–°å¢
      - **è°ƒç”¨é¡ºåº**:å®¡æ‰¹é€šè¿‡åè°ƒç”¨

    - **callPortalApprovalAPI($approvalResult)**
      - **åŠŸèƒ½æè¿°**:è°ƒç”¨Portalç«¯ä¸“é—¨çš„å®¡æ‰¹ç»“æœæ¨é€API
      - **æ–¹æ³•çŠ¶æ€**:æ–°å¢
      - **è°ƒç”¨é¡ºåº**:Portalå®¡æ‰¹æ“ä½œåè°ƒç”¨

    - **callPortalUserUnbindAPI($unbindData)**
      - **åŠŸèƒ½æè¿°**:è°ƒç”¨Portalç«¯ä¸“é—¨çš„ç”¨æˆ·è§£ç»‘API
      - **æ–¹æ³•çŠ¶æ€**:æ–°å¢
      - **è°ƒç”¨é¡ºåº**:Portalç”³è¯·è¢«æ‹’ç»æ—¶è°ƒç”¨

- **ModChannelNotificationService.php**
  - **æ–‡ä»¶è·¯å¾„**:`app/Services/ModChannelPlatform/ModChannelNotificationService.php`
  - **æ–‡ä»¶çŠ¶æ€**:æ–°å¢
  - **æ–¹æ³•**:
    - **callWechatPushAPI($notificationData)**
      - **åŠŸèƒ½æè¿°**:è°ƒç”¨Portalç«¯ä¸“é—¨çš„å¾®ä¿¡æ¨é€API
      - **æ–¹æ³•çŠ¶æ€**:æ–°å¢
      - **è°ƒç”¨é¡ºåº**:éœ€è¦å‘é€å¾®ä¿¡æ¨é€æ—¶è°ƒç”¨

- **Viewç³»ç»ŸAccountService.php**
  - **æ–‡ä»¶è·¯å¾„**:`app/Services/Legacy/AccountService.php`
  - **æ–‡ä»¶çŠ¶æ€**:ä¿®æ”¹
  - **æ–¹æ³•**:
    - **getPartnerAccountInfo($customerId)**
      - **åŠŸèƒ½æè¿°**:è·å–æ¸ é“å•†è´¦æˆ·ä¿¡æ¯ï¼Œç”¨äºPartner Info Tabæ˜¾ç¤º
      - **æ–¹æ³•çŠ¶æ€**:æ–°å¢
      - **è°ƒç”¨é¡ºåº**:æ˜¾ç¤ºPartner Infoæ—¶è°ƒç”¨

    - **processPartnerContactApproval($approvalData)**
      - **åŠŸèƒ½æè¿°**:å¤„ç†æ¸ é“å•†æ–°è”ç³»äººå®¡æ‰¹ï¼Œç”¨äºPartner Info TabåŠŸèƒ½
      - **æ–¹æ³•çŠ¶æ€**:æ–°å¢
      - **è°ƒç”¨é¡ºåº**:Partner Info Tabä¸­å®¡æ‰¹æ“ä½œæ—¶è°ƒç”¨

### 6.4 Channel Partner Status Summaryæ¨¡å—

#### 6.4.1 ä¸šåŠ¡æµç¨‹

##### 6.4.1.1 ä¸šåŠ¡èƒŒæ™¯

- **èƒŒæ™¯**:Channel Partner Status Summaryæ˜¯æ¸ é“å•†çŠ¶æ€ç»Ÿè®¡æ±‡æ€»æ¨¡å—ï¼ŒæŒ‰ç…§country->region->branch->partner owner 4çº§ç»“æ„å±•ç¤ºå„çŠ¶æ€æ¸ é“å•†çš„æ•°é‡ç»Ÿè®¡ã€‚æä¾›å¤šç»´åº¦ç­›é€‰åŠŸèƒ½ï¼Œæ”¯æŒç‚¹å‡»ç»Ÿè®¡æ•°å­—è·³è½¬è‡³Channel Partner DashboardæŸ¥çœ‹å…·ä½“åˆ—è¡¨ã€‚**ç»Ÿè®¡æ•°æ®æ¥æºäºViewç«¯æœ¬åœ°å­˜å‚¨çš„æ•°æ®ï¼ˆExcelå¯¼å…¥çš„inactiveæ•°æ® + å®¡æ‰¹é€šè¿‡ååŒæ­¥çš„activeæ•°æ®ï¼‰å’Œé€šè¿‡APIå®æ—¶è·å–çš„Portalç«¯inactiveç”¨æˆ·æ•°æ®ã€‚**

- **ä¸»è¦æµç¨‹**
  - **Summary List**
    - è·å– Portal&Upload æ•°æ®è¿›è¡Œæ±‡æ€»ç»Ÿè®¡
    - æŒ‰4çº§ç»“æ„ç»Ÿè®¡å„çŠ¶æ€æ¸ é“å•†æ•°é‡
    - æ”¯æŒçŠ¶æ€åˆ†ç±»:Allï¼ˆæ‰€æœ‰ï¼‰ã€Pending on Branchï¼ˆæœªå¤„ç†-åˆ†å…¬å¸ï¼‰ã€Pending on Salesï¼ˆæœªå¤„ç†-é”€å”®ï¼‰ã€Declinedï¼ˆå·²æ‹’ç»ï¼‰ã€Activeï¼ˆå·²æ¿€æ´»ï¼‰
    - å®æ—¶è®¡ç®—å„å±‚çº§æ±‡æ€»æ•°æ®
    - æ ¹æ®saleså½“viewæƒé™ å¯ä»¥çœ‹åˆ°å¯¹åº”branchæˆ–è‡ªå·±ç›¸å…³çš„æ•°æ®
    ![alt text](<003 - Channel Partner Status Summary.png>)
    - ç‚¹å‡»ç»Ÿè®¡æ•°å­— å¼¹å‡ºPopup åŒChannel Partner Dashboard
    ![alt text](<004 - Channel Partner Status Summary - Window Popup.png>)

- **å¼‚å¸¸æµç¨‹**:
  - Portal APIè°ƒç”¨å¤±è´¥ â†’ ä»…æ˜¾ç¤ºViewç«¯æ•°æ®ç»Ÿè®¡ï¼Œæ ‡è®°Portalæ•°æ®è·å–å¤±è´¥
  - ç­›é€‰æ¡ä»¶æ— ç»“æœ â†’ æ˜¾ç¤ºæ— æ•°æ®æç¤º

- **æµç¨‹å›¾**:

```mermaid
flowchart TD
    START[è¿›å…¥Status Summaryé¡µé¢] --> LOAD_VIEW[åŠ è½½Viewç«¯æ•°æ®]
    LOAD_VIEW --> CALL_API[è°ƒç”¨Portal APIè·å–inactiveæ•°æ®]
    CALL_API --> MERGE[åˆå¹¶Viewæ•°æ®å’ŒPortalæ•°æ®]
    MERGE --> DISPLAY[æŒ‰4çº§ç»“æ„å±•ç¤ºç»Ÿè®¡]
    DISPLAY --> FILTER[æœç´¢ç­›é€‰]
    FILTER --> UPDATE[æ›´æ–°ç»Ÿè®¡ç»“æœ]
    UPDATE --> CLICK[ç‚¹å‡»ç»Ÿè®¡æ•°å­—]
    CLICK --> REDIRECT[è·³è½¬Dashboardå¸¦å±‚çº§+çŠ¶æ€å‚æ•°]
    REDIRECT --> LIST[å±•ç¤ºç­›é€‰ååˆ—è¡¨]
    
    CALL_API -->|APIå¤±è´¥| ONLY_VIEW[ä»…æ˜¾ç¤ºViewç«¯ç»Ÿè®¡]
    ONLY_VIEW --> DISPLAY
```

#### 6.4.2 å½±å“çš„æ•°æ®è¡¨

- Viewç«¯
  - **[mod_channel_partner_companies](#table-mod_channel_partner_companies)** : Viewç«¯ Upload CompanyåŸºç¡€ä¿¡æ¯è¡¨
  - **[mod_channel_partner_user](#table-mod_channel_partner_user)** : Viewç«¯ Upload UseråŸºç¡€ä¿¡æ¯è¡¨

- Portalç«¯
  - **[user_company](#table-user_company)** : User&Company å…³è”è¡¨(è®°å½• Partner å½“å‰çŠ¶æ€)

#### 6.4.3 å‰ç«¯å®ç°

##### 6.4.3.1 è§†å›¾ç›®å½•ç»“æ„

```plaintext
/resources/views/partner-summary/
  index.blade.php              - çŠ¶æ€ç»Ÿè®¡ä¸»é¡µé¢
```

##### 6.4.3.2 å…³é”®ç»„ä»¶åŠŸèƒ½

- **index.blade.php** åŒ…å«:
  - æœç´¢ç­›é€‰è¡¨å•ï¼ˆ5ä¸ªç­›é€‰å­—æ®µï¼‰
  - 4çº§å±‚æ¬¡ç»Ÿè®¡è¡¨æ ¼ï¼ˆCountry > Region > Branch > Partner Ownerï¼‰
  - çŠ¶æ€åˆ†ç±»ç»Ÿè®¡åˆ—ï¼ˆAll, Pending on Branch, Pending on Sales, Declined, Activeï¼‰
  - å¯ç‚¹å‡»ç»Ÿè®¡æ•°å­—ï¼ˆç›´æ¥è·³è½¬Dashboardå¸¦å±‚çº§+çŠ¶æ€å‚æ•°ï¼‰
  - æ±‡æ€»ç»Ÿè®¡è¡Œ
  - Portalæ•°æ®åŠ è½½çŠ¶æ€æç¤º

##### 6.4.3.3 è·¯ç”±è®¾è®¡

| HTTPæ–¹æ³• | ç«¯ç‚¹ | æè¿° |
|----------|------|------|
| GET | `/partner-summary` | çŠ¶æ€ç»Ÿè®¡ä¸»é¡µé¢ |
| GET | `/partner-summary/stats` | è·å–ç»Ÿè®¡æ•°æ®ï¼ˆAjaxï¼‰ |

#### 6.4.4 é”™è¯¯å¤„ç†å’Œæ—¥å¿—è®°å½•

##### 6.4.4.1 æ—¥å¿—è®°å½•

ä½¿ç”¨DynamicLoggerFactoryè¿›è¡Œæ¨¡å—åŒ–æ—¥å¿—è®°å½•:

- **ç³»ç»Ÿé”™è¯¯æ—¥å¿—è®°å½•åœºæ™¯**:

  | æ“ä½œç±»å‹ | è®°å½•æ—¶æœº |
  |----------|----------|
  | portal_api_failed | Portal APIè°ƒç”¨å¤±è´¥ |
  | stats_calculation_failed | ç»Ÿè®¡æ•°æ®è®¡ç®—å¤±è´¥ |
  | filter_query_failed | ç­›é€‰æŸ¥è¯¢å¤±è´¥ |

#### 6.4.5 åŠŸèƒ½å¼€å‘ä¸å®ç°

##### 6.4.5.1 ç±»å…³ç³»å›¾

```mermaid
classDiagram
    class PartnerStatusSummaryController {
        +index()
        +getStats()
    }

    class PartnerStatusSummaryService {
        +getStatusSummary(filters)
        +getViewPartnerData(filters)
        +getPortalInactiveData()
        +mergePartnerData(viewData, portalData)
        +calculateHierarchyStats(mergedData)
        +applyFilters(query, filters)
        +getFilterOptions()
        +calculateStatusCounts(groupData)
    }

    class DynamicLoggerFactory {
        +getLogger(system, module)
    }

    PartnerStatusSummaryController --> PartnerStatusSummaryService : ç»Ÿè®¡å¤„ç†
    PartnerStatusSummaryService --> DynamicLoggerFactory : æ—¥å¿—è®°å½•
```

##### 6.4.5.2 ä»£ç å®ç°

- **PartnerStatusSummaryController.php**
  - **æ–‡ä»¶è·¯å¾„**:`app/Http/Controllers/ModChannelPlatform/PartnerStatusSummaryController.php`
  - **æ–‡ä»¶çŠ¶æ€**:æ–°å¢
  - **æ–¹æ³•**:
    - **index()**  
      - **åŠŸèƒ½æè¿°**:æ˜¾ç¤ºçŠ¶æ€ç»Ÿè®¡ä¸»é¡µé¢ï¼ŒåŠ è½½é»˜è®¤ç»Ÿè®¡æ•°æ®å’Œç­›é€‰é€‰é¡¹ã€‚åˆå¹¶Viewç«¯æ•°æ®å’ŒPortal APIè·å–çš„inactiveæ•°æ®è¿›è¡Œç»Ÿè®¡ã€‚
      - **æ–¹æ³•çŠ¶æ€**:æ–°å¢  
      - **è°ƒç”¨é¡ºåº**:ç”¨æˆ·è®¿é—®çŠ¶æ€ç»Ÿè®¡é¡µé¢æ—¶è°ƒç”¨  
      - **ä¾èµ–æœåŠ¡**:PartnerStatusSummaryService
      - **è¯·æ±‚å‚æ•°**:æ— 

      - **å“åº”æ•°æ®**:  

          | å‚æ•°åç§° | æ•°æ®ç±»å‹ | æè¿° |
          |----------|----------|------|
          | view | Blade | index.blade.phpè§†å›¾ |
          | statsData | Array | 4çº§å±‚æ¬¡ç»Ÿè®¡æ•°æ®ï¼ˆåˆå¹¶åï¼‰ |
          | filterOptions | Object | ç­›é€‰é€‰é¡¹æ•°æ® |
          | totalStats | Object | æ€»è®¡ç»Ÿè®¡æ•°æ® |
          | portalDataStatus | String | Portalæ•°æ®è·å–çŠ¶æ€ |

    - **getStats()**
      - **åŠŸèƒ½æè¿°**:æ ¹æ®ç­›é€‰æ¡ä»¶è·å–çŠ¶æ€ç»Ÿè®¡æ•°æ®ï¼ŒæŒ‰4çº§ç»“æ„æ±‡æ€»å„çŠ¶æ€æ¸ é“å•†æ•°é‡ã€‚å…ˆè·å–Viewç«¯æ•°æ®ï¼Œå†è°ƒç”¨Portal APIè·å–inactiveæ•°æ®ï¼Œæœ€ååˆå¹¶ç»Ÿè®¡ã€‚
      - **æ–¹æ³•çŠ¶æ€**:æ–°å¢  
      - **è°ƒç”¨é¡ºåº**:ç”¨æˆ·åº”ç”¨ç­›é€‰æ¡ä»¶æ—¶Ajaxè°ƒç”¨  
      - **ä¾èµ–æœåŠ¡**:PartnerStatusSummaryService
      - **è¯·æ±‚å‚æ•°**:  

          | å‚æ•°åç§° | æ•°æ®ç±»å‹ | æ˜¯å¦å¿…å¡« | æè¿° |
          |----------|----------|----------|------|
          | region | String | å¦ | åŒºåŸŸç­›é€‰ |
          | branch | String | å¦ | åˆ†å…¬å¸ç­›é€‰ |
          | province | String | å¦ | çœä»½ç­›é€‰ |
          | city | String | å¦ | åŸå¸‚ç­›é€‰ |
          | district | String | å¦ | åŒºå¿ç­›é€‰ |
          | dataSource | String | å¦ | æ•°æ®æ¥æºç­›é€‰ |
          | partnerOwner | String | å¦ | å®¢æˆ·è´Ÿè´£äººç­›é€‰ |

      - **å“åº”æ•°æ®**:  

          | å‚æ•°åç§° | æ•°æ®ç±»å‹ | æè¿° |
          |----------|----------|------|
          | success | Boolean | æ˜¯å¦è·å–æˆåŠŸ |
          | hierarchyStats | Array | 4çº§å±‚æ¬¡ç»Ÿè®¡æ•°æ®ï¼ˆåˆå¹¶åï¼‰ |
          | totalStats | Object | æ€»è®¡ç»Ÿè®¡ |
          | appliedFilters | Object | åº”ç”¨çš„ç­›é€‰æ¡ä»¶ |
          | portalDataStatus | String | Portalæ•°æ®è·å–çŠ¶æ€ |

- **PartnerStatusSummaryService.php**
  - **æ–‡ä»¶è·¯å¾„**:`app/Services/ModChannelPlatform/PartnerStatusSummaryService.php`
  - **æ–‡ä»¶çŠ¶æ€**:æ–°å¢
  - **æ–¹æ³•**:
    - **getStatusSummary($filters)**
      - **åŠŸèƒ½æè¿°**:è·å–4çº§å±‚æ¬¡çŠ¶æ€ç»Ÿè®¡æ±‡æ€»,æ•´åˆViewç«¯å’ŒPortalç«¯æ•°æ®å¹¶è®¡ç®—å„çŠ¶æ€æ•°é‡
      - **æ–¹æ³•çŠ¶æ€**:æ–°å¢
      - **è¿”å›æ•°æ®**:å±‚æ¬¡åŒ–ç»Ÿè®¡æ•°æ®ç»“æ„

    - **getFilterOptions()**
      - **åŠŸèƒ½æè¿°**:è·å–ç­›é€‰é€‰é¡¹(åŒºåŸŸã€åˆ†å…¬å¸ã€è´Ÿè´£äººç­‰)
      - **æ–¹æ³•çŠ¶æ€**:æ–°å¢
      - **è¿”å›æ•°æ®**:ç­›é€‰é€‰é¡¹æ•°ç»„

### 6.5 Pre-Lead Project Upload, Creation and Updatesæ¨¡å—

#### 6.5.1 ä¸šåŠ¡æµç¨‹

##### 6.5.1.1 ä¸šåŠ¡èƒŒæ™¯

- **èƒŒæ™¯**ï¼šPre-Lead Project Upload, Creation and Updatesæ¨¡å—å¯¹Viewç³»ç»Ÿé¡¹ç›®ç®¡ç†åŠŸèƒ½è¿›è¡Œæ”¹é€ ã€‚å°†åŸæœ‰"mod lead upload"é¡¹ç›®çŠ¶æ€æ”¹ä¸º"pre-lead"çŠ¶æ€ï¼Œæ”¯æŒExcelæ‰¹é‡ä¸Šä¼ å’Œæ‰‹åŠ¨åˆ›å»ºPre-Leadé¡¹ç›®ã€‚**Portalç«¯activeç”¨æˆ·åˆ›å»ºçš„é¡¹ç›®ä¼šæ¨é€åˆ°Viewç«¯å¹¶å­˜å‚¨ï¼Œinactiveç”¨æˆ·çš„é¡¹ç›®ä»…åœ¨Portalç«¯å­˜å‚¨ï¼Œæ¿€æ´»åæ‰åŒæ­¥åˆ°Viewç«¯ã€‚**

  - **å¯¼å…¥é¡¹ç›®**
    - æ”¹é€ åŸæœ‰"Upload Project Data"åŠŸèƒ½
    - æ–°å¢"import projects from offline units"é€‰é¡¹ï¼Œä¸ç°æœ‰"import projects from service units"å¹¶åˆ—ï¼Œæä¾›ä¸åŒExcelæ¨¡æ¿
    - **éªŒè¯è§„åˆ™**ï¼š
      - å¦‚æœç”¨æˆ·åœ¨æ¨¡æ¿ä¸­å¡«å†™äº†Taxcodeï¼Œ"åˆ†é…åŸå› "ä¹Ÿå°†å¼ºåˆ¶ä¸Šä¼ 
      - å¦‚æœä¸Šä¼ çš„é¡¹ç›®åç§°ä¸CN VIEWä¸­çš„ç°æœ‰é¡¹ç›®åŒ¹é…ï¼ŒæŒ‰ç…§"é¡¹ç›®åç§°é‡å¤éªŒè¯"å¼€å…³ï¼Œé˜»æ­¢ä¸Šä¼ å¹¶å¼¹å‡ºæé†’"è¯¥é¡¹ç›®å¯èƒ½å·²å­˜åœ¨äºæ‚¨çš„åˆ†æ”¯ä¸­ã€‚è¯·ä»”ç»†æ£€æŸ¥æ‚¨çš„è¾“å…¥ã€‚é¡¹ç›®ID:244649ï¼ˆMODï¼‰/é¡¹ç›®åç§°åœ¨æ‚¨æ‰€åœ¨åˆ†å…¬å¸å·²å­˜åœ¨ï¼Œè¯·æ£€æŸ¥æ›´æ–°ã€‚"
    - ç°æœ‰çš„"mod lead upload"é¡¹ç›®çŠ¶æ€æ”¹ä¸ºpre-lead
    ![alt text](project_export.png)
    - **Excelæ¨¡æ¿**
    [Pre-Lead_projects_upload_template](Pre-Lead_projects_upload_template.xls)

  - **æ–°å»ºé¡¹ç›®**
    - æ–°å»ºé¡¹ç›®æ—¶å¢åŠ "pre-lead project"å‹¾é€‰æ¡†
    - å‹¾é€‰åä»£è¡¨æ˜¯å¯ä»¥åˆ†é…çš„é¡¹ç›®
    - å¿…é¡»é€‰æ‹©ä»£ç†å•†æˆ–åˆ†é”€å•†
    - å¿…é¡»é€‰æ‹©"åˆ†é…åŸå› "
    ![alt text](<014 - Project Info.png>)

  - **Project Info å¢åŠ å†…å®¹**
    - **æ”¹é€ Agent/Distributoræ˜¾ç¤º**ï¼šä¹‹å‰åªæ˜¾ç¤ºNAMEï¼Œç°åœ¨å¤šäº†çŠ¶æ€å’ŒåŸå› 
    - **Agent/Distributorä¸åŒé˜¶æ®µæ˜¾ç¤ºæƒ…å†µ**ï¼š
      - å¦‚æœPartneræ­£åœ¨ç­‰å¾…æ¥å—æˆ–æ‹’ç»ï¼Œè¯·æ˜¾ç¤ºç­‰å¾…çŠ¶æ€
      - å¦‚æœè¢«æ‹’ç»ï¼Œè¯·æ˜¾ç¤ºæ‹’ç»çŠ¶æ€å¹¶è¯´æ˜åŸå› ã€‚å¯¹åº”çš„é”€å”®äººå‘˜å°†æ”¶åˆ°æ‹’ç»é€šçŸ¥ï¼ˆé‚®ä»¶ï¼‰
      - å¦‚æœ24å°æ—¶å†…æ²¡æœ‰å“åº”ï¼Œåˆ™è‡ªåŠ¨æ˜¾ç¤ºå–æ¶ˆçŠ¶æ€ã€‚å¯¹åº”çš„é”€å”®äººå‘˜å°†æ”¶åˆ°å–æ¶ˆé€šçŸ¥ï¼ˆé‚®ä»¶ï¼‰
      - å¦‚æœæ¥å—ï¼Œåˆ™æ˜¾ç¤ºæ¥å—çŠ¶æ€ã€‚å¯¹åº”çš„é”€å”®äººå‘˜å°†æ”¶åˆ°å·²æ¥å—çš„é€šçŸ¥ï¼ˆé‚®ä»¶ï¼‰ï¼Œç„¶åç»§ç»­è·Ÿè¿›
    - **Pre-Leadé¡¹ç›®è§„åˆ™**ï¼š
      - åˆå§‹é”€å”®é˜¶æ®µçŠ¶Pre-Lead
      - åªæœ‰æ´»è·ƒçš„Partneræ‰èƒ½åˆ†é…Pre-Leadé¡¹ç›®ï¼ŒPre-Leadé˜¶æ®µåªé™åˆ¶ä¸€ä¸ªPartner
      - TKEå’ŒPartneréƒ½å¯ä»¥æ›´æ–°æ¥å—çŠ¶æ€ï¼Œæ‹’ç»æˆ–å–æ¶ˆæ—¶é¡¹ç›®ä»Partneré—¨æˆ·ä¸­åˆ é™¤
      - é¡¹ç›®é˜¶æ®µè½¬å˜ä¸ºleadæˆ–å…¶å®ƒåç»­çŠ¶æ€ï¼Œæ£€æµ‹Partneræ˜¯å¦æ¥å—,å¦‚æœPartneræœªæ“ä½œåˆ™ç›´æ¥åˆ é™¤
      - éPre-leadé¡¹ç›®ï¼ŒTKEæ·»åŠ æ–°Partneræ—¶æ— éœ€æ¥å—æµç¨‹
    ![alt text](<015 - Project Info.png>)
    - Partner å¾…å¤„ç†
    ![alt text](image-4.png)
    - Partner æ‹’ç»é¡¹ç›®
    ![alt text](image-5.png)
    - Partner 24å°æ—¶æœªå¤„ç† - æ ‡è®° Cancel
    ![alt text](image-7.png)
    - Partneræ¥å—é¡¹ç›® 
    ![alt text](image-6.png)

  - **æ¥æ”¶Portalç«¯åŒæ­¥é¡¹ç›®**ï¼š
    - æ¥æ”¶ä»Portalç«¯activeç”¨æˆ·æ¨é€è¿‡æ¥çš„é¡¹ç›®æ•°æ® ä»¥åŠå˜æ›´Activeæ—¶ åŒæ­¥çš„é¡¹ç›®
    - è‡ªåŠ¨å­˜å‚¨åˆ°Viewç«¯projectè¡¨ï¼Œè®¾ç½®ä¸ºPre-Leadé¡¹ç›®ï¼ŒLead Sourceä¸º"MOD Lead"
    ![alt text](image-8.png)

- **å¼‚å¸¸æµç¨‹**ï¼š
  - Excelæ–‡ä»¶æ ¼å¼éªŒè¯å¤±è´¥ â†’ è¿”å›æ ¼å¼é”™è¯¯ä¿¡æ¯ï¼Œé˜»æ­¢ä¸Šä¼ 
  - Taxcodeå·²å¡«å†™ä½†åˆ†é…åŸå› ä¸ºç©º â†’ è¿”å›éªŒè¯é”™è¯¯ï¼Œé˜»æ­¢ä¸Šä¼ 
  - é¡¹ç›®åç§°é‡å¤ä¸”éªŒè¯å¼€å…³å¯ç”¨ â†’ æ˜¾ç¤ºé‡å¤è­¦å‘Šï¼Œé˜»æ­¢åˆ›å»º
  - Pre-Leadé¡¹ç›®å¿…å¡«ä¿¡æ¯ç¼ºå¤± â†’ è¿”å›å­—æ®µéªŒè¯é”™è¯¯

- **æµç¨‹å›¾**ï¼š

```mermaid
flowchart TD
    START[é¡¹ç›®ç®¡ç†] --> EXCEL[Excelæ‰¹é‡ä¸Šä¼ ]
    START --> MANUAL[æ‰‹åŠ¨åˆ›å»ºé¡¹ç›®]
    START --> PORTAL[Portalç«¯é¡¹ç›®æ¨é€]
    
    EXCEL --> VALIDATE[æ•°æ®éªŒè¯]
    VALIDATE --> CHECK_TAX{æ˜¯å¦å¡«å†™Taxcode}
    CHECK_TAX -->|æ˜¯| CHECK_REASON{æ˜¯å¦å¡«å†™åˆ†é…åŸå› }
    CHECK_REASON -->|å¦| ERROR1[éªŒè¯å¤±è´¥]
    CHECK_REASON -->|æ˜¯| CHECK_NAME[é¡¹ç›®åç§°é‡å¤æ£€æŸ¥]
    CHECK_TAX -->|å¦| CHECK_NAME
    CHECK_NAME -->|é‡å¤| ERROR2[é˜»æ­¢ä¸Šä¼ ]
    CHECK_NAME -->|ä¸é‡å¤| STORE_EXCEL[å­˜å‚¨åˆ°projectè¡¨]
    
    MANUAL --> SELECT_AGENT[é€‰æ‹©Agent/Distributor]
    SELECT_AGENT --> SELECT_REASON[é€‰æ‹©åˆ†é…åŸå› ]
    SELECT_REASON --> STORE_MANUAL[å­˜å‚¨åˆ°projectè¡¨]
    
    PORTAL --> CHECK_USER{ç”¨æˆ·çŠ¶æ€}
    CHECK_USER -->|active| PUSH[æ¨é€åˆ°Viewç«¯]
    PUSH --> STORE_PORTAL[å­˜å‚¨åˆ°projectè¡¨]
    STORE_PORTAL --> NOTIFY[é€šçŸ¥TKEé”€å”®]
    CHECK_USER -->|inactive| PORTAL_ONLY[ä»…åœ¨Portalç«¯å­˜å‚¨]
    PORTAL_ONLY --> WAIT_ACTIVE[ç­‰å¾…ç”¨æˆ·æ¿€æ´»]
    WAIT_ACTIVE -->|æ¿€æ´»| SYNC[åŒæ­¥åˆ°Viewç«¯]
    SYNC --> STORE_SYNC[å­˜å‚¨åˆ°projectè¡¨]
    
    STORE_EXCEL --> AGENT_MANAGE[Agent/DistributorçŠ¶æ€ç®¡ç†]
    STORE_MANUAL --> AGENT_MANAGE
    STORE_PORTAL --> AGENT_MANAGE
    STORE_SYNC --> AGENT_MANAGE
```

#### 6.5.2 å½±å“çš„æ•°æ®è¡¨

- Viewç«¯
  - **[project](#table-project)** : Viewç«¯ ProjectåŸºç¡€ä¿¡æ¯è¡¨
  - **[project_customer](#table-project_customer)** : Viewç«¯ Project Agentå…³è”è¡¨
  - **[project_distributor](#table-project_distributor)** : Viewç«¯ Project Distributorå…³è”è¡¨
  - **[mod_channel_project_assignments](#table-mod_channel_project_assignments)** : Viewç«¯ åˆ†é…è®°å½•è¡¨

#### 6.5.3 å‰ç«¯å®ç°

##### 6.5.3.1 è§†å›¾ç›®å½•ç»“æ„

```plaintext
/web/sharp/modules/importproject/views/scripts/index/
  index.phtml                   - Excelå¯¼å…¥é¡µé¢(ä¿®æ”¹)
/web/nimod/application/views/scripts/projectinfolite/
  newproject.phtml             - æ–°å»ºé¡¹ç›®é¡µé¢(ä¿®æ”¹)
  index.phtml                  - é¡¹ç›®è¯¦æƒ…é¡µé¢(ä¿®æ”¹)
/web/nimod/application/views/scripts/projectinfo/
  project.phtml                - é¡¹ç›®è¯¦æƒ…é¡µé¢(ä¿®æ”¹)
```

##### 6.5.3.2 å…³é”®ç»„ä»¶åŠŸèƒ½

- **index.phtmlï¼ˆExcelå¯¼å…¥ï¼‰** åŒ…å«ï¼š
  - åŒæ¨¡æ¿é€‰é¡¹ï¼ˆoffline unitså’Œservice unitsï¼‰
  - æ¨¡æ¿ä¸‹è½½åŠŸèƒ½
  - Excelæ–‡ä»¶ä¸Šä¼ å’ŒéªŒè¯

- **newproject.phtml** åŒ…å«ï¼š
  - Pre-Lead projectå‹¾é€‰æ¡†
  - ä»£ç†å•†/åˆ†é”€å•†é€‰æ‹©æ§ä»¶
  - åˆ†é…åŸå› é€‰æ‹©æ§ä»¶
  - åˆ›å»ºå‰ç½®é¡¹ç›®æŒ‰é’®

- **project.phtml** åŒ…å«ï¼š
  - AgentsçŠ¶æ€æ˜¾ç¤ºï¼ˆç­‰å¾…/æ¥å—/æ‹’ç»/å–æ¶ˆï¼‰
  - æ‹’ç»åŸå› å±•ç¤º
  - çŠ¶æ€å˜æ›´æ“ä½œæŒ‰é’®
  - æ•°æ®æ¥æºæ ‡è¯†ï¼ˆView/Portalï¼‰

##### 6.5.3.3 è·¯ç”±è®¾è®¡

| HTTP æ–¹æ³• | ç«¯ç‚¹ | æè¿° |
|----------|------|------|
| GET | `/importproject/template` | ä¸‹è½½Excelæ¨¡æ¿ |
| POST | `/importproject/upload` | ä¸Šä¼ Pre-Leadé¡¹ç›®Excel |
| POST | `/projectinfolite/create` | åˆ›å»ºPre-Leadé¡¹ç›® |
| PUT | `/projectinfo/updatestatus` | æ›´æ–°AgentsçŠ¶æ€ |
| POST | `/projectinfo/sync-from-portal` | æ¥æ”¶Portalé¡¹ç›®æ¨é€ |

#### 6.5.4 é”™è¯¯å¤„ç†å’Œæ—¥å¿—è®°å½•

##### 6.5.4.1 æ—¥å¿—è®°å½•

ä½¿ç”¨Viewç³»ç»Ÿç°æœ‰æ—¥å¿—æœºåˆ¶ï¼š

- **ç³»ç»Ÿé”™è¯¯æ—¥å¿—è®°å½•åœºæ™¯**ï¼š

  | æ“ä½œç±»å‹ | è®°å½•æ—¶æœº |
  |----------|----------|
  | excel_validation_failed | Excelæ•°æ®éªŒè¯å¤±è´¥ |
  | creation_failed | é¡¹ç›®åˆ›å»ºå¤±è´¥ |
  | status_update_failed | AgentsçŠ¶æ€æ›´æ–°å¤±è´¥ |
  | portal_push_failed | Portalé¡¹ç›®æ¨é€æ¥æ”¶å¤±è´¥ |
  | portal_sync_failed | Portalé¡¹ç›®åŒæ­¥å¤±è´¥ |

#### 6.5.5 åŠŸèƒ½å¼€å‘ä¸å®ç°

##### 6.5.5.1 ç±»å…³ç³»å›¾

```mermaid
classDiagram
    class IndexController {
        +uploadAction()
        +downloadTemplateAction()
        +indexAction()
    }

    class ProjectinfoLiteController {
        +newprojectAction()
        +createAction()
        +indexAction()
        +addproject()
    }

    class ProjectinfoController {
        +UpdateProjectAction()
        +updateStatusAction()
        +syncFromPortalAction()
    }

    class ProjectinfoLiteService {
        +validatePreLeadForm(formData)
        +createPreLeadProject(data)
    }

    class ProjectService {
        +updateAgentStatus(projectId, distributorId, status, reason)
        +processSyncFromPortal(portalProjectData)
        +storePortalProject(projectData)
        +sendEmailNotification(projectId, status, reason)
        +processTimeoutCancellation(projectId)
    }

    class importproject {
        +validateExcelData(data)
        +importOfflineUnits(data)
        +checkProjectNameDuplicate(projectName, branch)
    }

    IndexController --> importproject : Excelå¯¼å…¥
    ProjectinfoLiteController --> ProjectinfoLiteService : é¡¹ç›®åˆ›å»º
    ProjectinfoController --> ProjectService : é¡¹ç›®ç®¡ç†
```

##### 6.5.5.2 ä»£ç å®ç°

- **IndexController.php**
  - **æ–‡ä»¶è·¯å¾„**ï¼š`web\sharp\modules\importproject\controllers\IndexController.php`
  - **æ–‡ä»¶çŠ¶æ€**ï¼šMODIFY
  - **æ–¹æ³•**:
    - **uploadAction()**  
      - **åŠŸèƒ½æè¿°**ï¼šå¤„ç†Excelæ–‡ä»¶ä¸Šä¼ ï¼Œæ”¯æŒoffline unitså’Œservice unitsåŒæ¨¡æ¿ã€‚  
      - **æ–¹æ³•çŠ¶æ€**ï¼šæ”¹é€   
      - **è¯·æ±‚å‚æ•°**ï¼š  

        | å‚æ•°åç§° | æ•°æ®ç±»å‹ | æ˜¯å¦å¿…å¡« | æè¿° |
        |----------|----------|----------|------|
        | templateType | String | æ˜¯ | æ¨¡æ¿ç±»å‹(offline_units/service_units) |
        | excelFile | File | æ˜¯ | Excelä¸Šä¼ æ–‡ä»¶ |

      - **å“åº”æ•°æ®**ï¼š  

        | å‚æ•°åç§° | æ•°æ®ç±»å‹ | æè¿° |
        |----------|----------|------|
        | success | Boolean | æ˜¯å¦ä¸Šä¼ æˆåŠŸ |
        | message | String | å¤„ç†ç»“æœä¿¡æ¯ |

    - **indexAction()**
      - **åŠŸèƒ½æè¿°**ï¼šå¯¼å…¥é¡µé¢å±•ç¤ºï¼Œå¢åŠ åŒæ¨¡æ¿é€‰æ‹©åŠŸèƒ½ã€‚  
      - **æ–¹æ³•çŠ¶æ€**ï¼šæ”¹é€   

- **ProjectinfoLiteController.php**
  - **æ–‡ä»¶è·¯å¾„**ï¼š`web\nimod\application\controllers\ProjectinfoliteController.php`
  - **æ–‡ä»¶çŠ¶æ€**ï¼šMODIFY
  - **æ–¹æ³•**:
    - **newprojectAction()**  
      - **åŠŸèƒ½æè¿°**ï¼šæ–°å»ºé¡¹ç›®é¡µé¢ï¼Œé›†æˆPre-Leadå¤é€‰æ¡†å’Œç›¸å…³æ§ä»¶ã€‚  
      - **æ–¹æ³•çŠ¶æ€**ï¼šæ”¹é€   

    - **createAction()**
      - **åŠŸèƒ½æè¿°**ï¼šåˆ›å»ºé¡¹ç›®å¤„ç†ï¼Œæ”¯æŒPre-Leadé¡¹ç›®åˆ›å»ºé€»è¾‘ã€‚  
      - **æ–¹æ³•çŠ¶æ€**ï¼šæ”¹é€   
      - **è¯·æ±‚å‚æ•°**ï¼š  

        | å‚æ•°åç§° | æ•°æ®ç±»å‹ | æ˜¯å¦å¿…å¡« | æè¿° |
        |----------|----------|----------|------|
        | isPrelead | Boolean | å¦ | æ˜¯å¦ä¸ºPre-Leadé¡¹ç›® |
        | agentDistributorId | Integer | å¦ | ä»£ç†å•†ID |
        | assignmentReason | String | å¦ | åˆ†é…åŸå›  |

    - **indexAction()**
      - **åŠŸèƒ½æè¿°**ï¼šé¡¹ç›®åˆ—è¡¨é¡µé¢ï¼Œå¢åŠ Pre-Leadé¡¹ç›®å­—æ®µæ˜¾ç¤ºã€‚  
      - **æ–¹æ³•çŠ¶æ€**ï¼šæ”¹é€   

    - **addproject()**
      - **åŠŸèƒ½æè¿°**ï¼šæ–°å¢é¡¹ç›®æ–¹æ³•, å¢åŠ Pre-Leadé¡¹ç›®æ·»åŠ   
      - **æ–¹æ³•çŠ¶æ€**ï¼šæ”¹é€   

- **ProjectinfoController.php**
  - **æ–‡ä»¶è·¯å¾„**ï¼š`web\nimod\application\controllers\ProjectinfoController.php`
  - **æ–‡ä»¶çŠ¶æ€**ï¼šMODIFY
  - **æ–¹æ³•**:

    - **UpdateProjectAction()**  
      - **åŠŸèƒ½æè¿°**ï¼šé¡¹ç›®ç¼–è¾‘é¡µé¢ï¼Œæ˜¾ç¤ºAgentsçŠ¶æ€ç®¡ç†ç•Œé¢å’Œæ•°æ®æ¥æºæ ‡è¯†ã€‚  
      - **æ–¹æ³•çŠ¶æ€**ï¼šæ”¹é€   

    - **updateStatusAction()**
      - **åŠŸèƒ½æè¿°**ï¼šæ›´æ–°é¡¹ç›®AgentsçŠ¶æ€ï¼Œè§¦å‘TKEé”€å”®é‚®ä»¶é€šçŸ¥ã€‚  
      - **æ–¹æ³•çŠ¶æ€**ï¼šæ–°å¢  
      - **è¯·æ±‚å‚æ•°**ï¼š  

        | å‚æ•°åç§° | æ•°æ®ç±»å‹ | æ˜¯å¦å¿…å¡« | æè¿° |
        |----------|----------|----------|------|
        | projectId | Integer | æ˜¯ | é¡¹ç›®ID |
        | distributorId | Integer | æ˜¯ | åˆ†é”€å•†ID |
        | status | String | æ˜¯ | çŠ¶æ€(pending/accepted/rejected/cancelled) |
        | rejectionReason | String | å¦ | æ‹’ç»åŸå›  |

      - **å“åº”æ•°æ®**ï¼š

        | å‚æ•°åç§° | æ•°æ®ç±»å‹ | æè¿° |
        |----------|----------|------|
        | success | Boolean | æ›´æ–°æ˜¯å¦æˆåŠŸ |
        | message | String | å¤„ç†ç»“æœä¿¡æ¯ |

- **ProjectinfoLiteService.php**
  - **æ–‡ä»¶è·¯å¾„**ï¼š`sys\libs\logic\NiSales\Service\ProjectInfoLiteService.php`
  - **æ–‡ä»¶çŠ¶æ€**ï¼šMODIFY
  - **æ–¹æ³•**:

    - **validatePreLeadForm($formData)**
      - **åŠŸèƒ½æè¿°**ï¼šéªŒè¯Pre-Leadé¡¹ç›®è¡¨å•æ•°æ®
      - **æ–¹æ³•çŠ¶æ€**ï¼šæ–°å¢

    - **createPreLeadProject($data)**
      - **åŠŸèƒ½æè¿°**ï¼šåˆ›å»ºPre-Leadé¡¹ç›®ï¼Œè®¾ç½®ç›¸å…³æ ‡è¯†å’ŒçŠ¶æ€
      - **æ–¹æ³•çŠ¶æ€**ï¼šæ–°å¢

- **ProjectService.php**
  - **æ–‡ä»¶è·¯å¾„**ï¼š`sys\libs\logic\NiSales\Project\SalesProject\Bo\Project.php`
  - **æ–‡ä»¶çŠ¶æ€**ï¼šMODIFY
  - **æ–¹æ³•**:
    - **storePortsalProject($projectData)**
      - **åŠŸèƒ½æè¿°**ï¼šå­˜å‚¨Portalç«¯æ¨é€çš„é¡¹ç›®æ•°æ®åˆ°Viewç«¯projectè¡¨
      - **æ–¹æ³•çŠ¶æ€**ï¼šæ–°å¢
      - **å¤„ç†æµç¨‹**ï¼š
        1. éªŒè¯Portalé¡¹ç›®æ•°æ®å®Œæ•´æ€§
        2. åˆ›å»ºprojectè®°å½•ï¼Œè®¾ç½®DataSource='portal's
        3. è®°å½•PortalProjectIdå’ŒPortalUserId
        4. è®¾ç½®IsPreLead=1ï¼ŒLeadSource='MOD Lead'
        5. è¿”å›Viewç«¯é¡¹ç›®ID

  - **sendEmailNotification($projectId, $status, $reason)**
    - **åŠŸèƒ½æè¿°**ï¼šå‘é€TKEé”€å”®é‚®ä»¶é€šçŸ¥ï¼ˆæ‹’ç»/å–æ¶ˆ/æ¥å—ï¼‰
    - **æ–¹æ³•çŠ¶æ€**ï¼šæ–°å¢

- **importproject.php**
  - **æ–‡ä»¶è·¯å¾„**ï¼š`web\sharp\modules\importproject\models\importproject.php`
  - **æ–‡ä»¶çŠ¶æ€**ï¼šMODIFY
  - **æ–¹æ³•**:
    - **validateExcelData($data)**
      - **åŠŸèƒ½æè¿°**ï¼šéªŒè¯Excelæ•°æ®ï¼ŒTaxcodeåˆ†é…åŸå› å…³è”éªŒè¯
      - **æ–¹æ³•çŠ¶æ€**ï¼šæ”¹é€ 

    - **importOfflineUnits($data)**
      - **åŠŸèƒ½æè¿°**ï¼šå¯¼å…¥æ¨¡æ¿æ•°æ®
      - **æ–¹æ³•çŠ¶æ€**ï¼šæ–°å¢

    - **checkProjectNameDuplicate($projectName, $branch)**
      - **åŠŸèƒ½æè¿°**ï¼šæ£€æŸ¥é¡¹ç›®åç§°é‡å¤æ€§ï¼Œæ ¹æ®å¼€å…³é…ç½®æ‰§è¡Œ
      - **æ–¹æ³•çŠ¶æ€**ï¼šæ–°å¢

### 6.6 Channel Partner Project Summaryæ¨¡å—

#### 6.6.1 ä¸šåŠ¡æµç¨‹

##### 6.6.1.1 ä¸šåŠ¡èƒŒæ™¯

- **èƒŒæ™¯**ï¼šChannel Partner Project Summaryæ˜¯æ¸ é“åˆä½œä¼™ä¼´é¡¹ç›®ç»Ÿè®¡æ¨¡å—ï¼Œä¸ºé”€å”®äººå‘˜å’Œç®¡ç†å±‚æä¾›å¤šç»´åº¦çš„é¡¹ç›®æ•°æ®æ±‡æ€»åˆ†æã€‚**ç»Ÿè®¡æ•°æ®ä»…æ¥æºäºViewç«¯projectè¡¨ä¸­çš„Pre-Leadé˜¶æ®µé¡¹ç›®ï¼Œä¸é€šè¿‡APIè·å–Portalç«¯æ•°æ®ã€‚**æ”¯æŒ4çº§å±‚æ¬¡ç»“æ„é’»å–ï¼ˆCountryâ†’Regionâ†’Branchâ†’TKE Salesï¼‰å’Œæƒé™æ§åˆ¶çš„æ•°æ®å±•ç¤ºã€‚

- **ä¸»è¦æµç¨‹**
  - **Summary List**
    - ä»…ç»Ÿè®¡Viewç«¯projectè¡¨ä¸­çŠ¶æ€ä¸ºPre-Leadçš„é¡¹ç›®
    - åŒ…æ‹¬Viewç«¯å¯¼å…¥/æ–°å»ºçš„Pre-Leadé¡¹ç›®
    - åŒ…æ‹¬Portalç«¯activeç”¨æˆ·æ¨é€åå­˜å‚¨åœ¨Viewç«¯çš„é¡¹ç›®
    - **ä¸é€šè¿‡APIè·å–Portalç«¯æ•°æ®**
    - å¯¹åº”é”€å”®åªèƒ½çœ‹åˆ°è‡ªå·±æœ‰æƒé™çš„branchä¸‹å¾—é¡¹ç›®
    ![alt text](<016 - Channel Partner Project Summary.png>)
    - ç‚¹å‡»ç»Ÿè®¡æ•°å­—è·³è½¬è‡³Popupåˆ—è¡¨ å±•ç¤ºPre-leadé¡¹ç›®
    ![alt text](<017 - Window Popup.png>)

- **å¼‚å¸¸æµç¨‹**ï¼š
  - ç»Ÿè®¡æ•°æ®æŸ¥è¯¢å¤±è´¥ â†’ æ˜¾ç¤ºé”™è¯¯æç¤ºå¹¶è®°å½•æ—¥å¿—
  - æƒé™ä¸è¶³ â†’ ä»…æ˜¾ç¤ºç”¨æˆ·æƒé™èŒƒå›´å†…çš„æ•°æ®
  - ç­›é€‰æ¡ä»¶æ— ç»“æœ â†’ æ˜¾ç¤ºæ— æ•°æ®æç¤º

- **æµç¨‹å›¾**ï¼š

```mermaid
flowchart TD
    START[è¿›å…¥Project Summary] --> QUERY[æŸ¥è¯¢Viewç«¯projectè¡¨]
    QUERY --> FILTER[ç­›é€‰çŠ¶æ€ä¸ºPre-Leadçš„é¡¹ç›®]
    FILTER --> STATS[æŒ‰å±‚çº§ç»Ÿè®¡é¡¹ç›®æ•°æ®]
    STATS --> CLASSIFY[æŒ‰ç»´åº¦åˆ†ç±»ç»Ÿè®¡]
    CLASSIFY --> DISPLAY[å±•ç¤ºç»Ÿè®¡ç»“æœ]
    
    DISPLAY --> USER_FILTER[ç”¨æˆ·åº”ç”¨ç­›é€‰æ¡ä»¶]
    USER_FILTER --> REFRESH[åˆ·æ–°ç»Ÿè®¡æ•°æ®]
    
    DISPLAY --> CLICK[ç‚¹å‡»ç»Ÿè®¡æ•°å­—]
    CLICK --> REDIRECT[è·³è½¬Project Reportå¸¦ç­›é€‰å‚æ•°]
```

#### 6.6.2 å½±å“çš„æ•°æ®è¡¨

- **[project](#table-project)** : Viewç«¯ ProjectåŸºç¡€ä¿¡æ¯è¡¨
- **[project_customer](#table-project_customer)** : Viewç«¯ Project Agentå…³è”è¡¨
- **[project_distributor](#table-project_distributor)** : Viewç«¯ Project Distributorå…³è”è¡¨
- **[mod_channel_project_assignments](#table-mod_channel_project_assignments)** : Viewç«¯ åˆ†é…è®°å½•è¡¨

#### 6.6.3 å‰ç«¯å®ç°

##### 6.6.3.1 è§†å›¾ç›®å½•ç»“æ„

```plaintext
/web/nimod/application/views/scripts/channel-summary/
  index.phtml                  - é¡¹ç›®ç»Ÿè®¡ä¸»é¡µé¢
```

##### 6.6.3.2 å…³é”®ç»„ä»¶åŠŸèƒ½

- **å¤šå±‚çº§ç»Ÿè®¡æ ‘** åŒ…å«ï¼š
  - 4çº§å±‚æ¬¡å±•å¼€æ”¶èµ·åŠŸèƒ½
  - å„çŠ¶æ€æ•°é‡ç»Ÿè®¡æ˜¾ç¤º
  - æ•°å­—é“¾æ¥ç‚¹å‡»è·³è½¬åŠŸèƒ½

- **ç­›é€‰æ¡ä»¶ç»„ä»¶** åŒ…å«ï¼š
  - Region, Branch, Partner, Project Salesä¸‹æ‹‰é€‰æ‹©
  - æœç´¢å’Œé‡ç½®åŠŸèƒ½

##### 6.6.3.3 è·¯ç”±è®¾è®¡

| HTTP æ–¹æ³• | ç«¯ç‚¹ | æè¿° |
|----------|------|------|
| GET | `/channel-summary/stats` | è·å–é¡¹ç›®ç»Ÿè®¡æ•°æ® |
| GET | `/channel-summary/drill-down` | é’»å–è·å–è¯¦ç»†ç»Ÿè®¡ |

#### 6.6.4 é”™è¯¯å¤„ç†å’Œæ—¥å¿—è®°å½•

##### 6.6.4.1 æ—¥å¿—è®°å½•

ä½¿ç”¨Viewç³»ç»Ÿç°æœ‰æ—¥å¿—æœºåˆ¶ï¼š

- **ç³»ç»Ÿé”™è¯¯æ—¥å¿—è®°å½•åœºæ™¯**ï¼š

  | æ“ä½œç±»å‹ | è®°å½•æ—¶æœº |
  |----------|----------|
  | stats_query_failed | ç»Ÿè®¡æ•°æ®æŸ¥è¯¢å¤±è´¥ |
  | permission_denied | æƒé™ä¸è¶³ |

#### 6.6.5 åŠŸèƒ½å¼€å‘ä¸å®ç°

##### 6.6.5.1 ç±»å…³ç³»å›¾

```mermaid
classDiagram
    class ChannelSummaryController {
        +index()
        +getStats()
        +getDrillDown()
    }

    class ChannelSummaryService {
        +getProjectStatsByLevel(level, parentId, userId, filters)
        +buildDrillDownUrl(level, filters)
        +getFilterOptions(userId)
        +buildSummaryTree(userId, filters, expandLevel)
        +queryPreLeadProjects(filters)
        +calculateStatsByDimension(projects)
    }

    class ProjectListService {
        +getProjectsWithFilters(filters)
        +getProjectStats(filters)
        +formatProjectListData(projects)
        +getProjectUnitsCount(projectId)
    }

    class DynamicLoggerFactory {
        +getLogger(system, module)
    }

    ChannelSummaryController --> ChannelSummaryService : ç»Ÿè®¡å¤„ç†
    ChannelSummaryController --> ProjectListService : é¡¹ç›®æ•°æ®
    ChannelSummaryService --> ProjectListService : é¡¹ç›®æŸ¥è¯¢
    ChannelSummaryService --> DynamicLoggerFactory : æ—¥å¿—è®°å½•
```

##### 6.6.5.2 ä»£ç å®ç°

- **ChannelSummaryController.php**
  - **æ–‡ä»¶è·¯å¾„**ï¼š`app/Http/Controllers/ModChannelPlatform/ChannelSummaryController.php`
  - **æ–‡ä»¶çŠ¶æ€**ï¼šæ–°å¢
  - **æ–¹æ³•**:
    - **index()**
      - **åŠŸèƒ½æè¿°**ï¼šæ˜¾ç¤ºé¡¹ç›®ç»Ÿè®¡ä¸»é¡µé¢ï¼Œæ ¹æ®ç”¨æˆ·æƒé™åŠ è½½å¯¹åº”æ•°æ®ã€‚ä»…ç»Ÿè®¡Viewç«¯projectè¡¨ä¸­é¡¹ç›®çŠ¶æ€ä¸ºPre-Leadçš„ã€‚
      - **æ–¹æ³•çŠ¶æ€**ï¼šæ–°å¢
      - **ä¾èµ–æœåŠ¡**ï¼šChannelSummaryService, ProjectListService
      - **è¯·æ±‚å‚æ•°**ï¼š

        | å‚æ•°åç§° | æ•°æ®ç±»å‹ | æ˜¯å¦å¿…å¡« | æè¿° |
        |----------|----------|----------|------|
        | region | String | å¦ | åŒºåŸŸç­›é€‰ |
        | branch | String | å¦ | åˆ†æ”¯ç­›é€‰ |
        | partner | String | å¦ | åˆä½œä¼™ä¼´ç­›é€‰ |
        | projectSales | String | å¦ | é¡¹ç›®é”€å”®ç­›é€‰ |
        | expandLevel | String | å¦ | é»˜è®¤å±•å¼€å±‚çº§ |

      - **å“åº”æ•°æ®**ï¼š

        | å‚æ•°åç§° | æ•°æ®ç±»å‹ | æè¿° |
        |----------|----------|------|
        | summaryTree | Object | å¤šå±‚çº§ç»Ÿè®¡æ ‘æ•°æ® |
        | filterOptions | Object | ç­›é€‰æ¡ä»¶é€‰é¡¹ |
        | defaultExpanded | String | é»˜è®¤å±•å¼€å±‚çº§ |
        | breadcrumb | Array | å¯¼èˆªé¢åŒ…å±‘ |

    - **getStats()**
      - **åŠŸèƒ½æè¿°**ï¼šè·å–å¤šå±‚çº§ç»Ÿè®¡æ•°æ®ï¼Œæ”¯æŒæƒé™è¿‡æ»¤ã€‚ä»…æŸ¥è¯¢Viewç«¯projectè¡¨ã€‚
      - **æ–¹æ³•çŠ¶æ€**ï¼šæ–°å¢
      - **ä¾èµ–æœåŠ¡**ï¼šChannelSummaryService
      - **è¯·æ±‚å‚æ•°**ï¼š

        | å‚æ•°åç§° | æ•°æ®ç±»å‹ | æ˜¯å¦å¿…å¡« | æè¿° |
        |----------|----------|----------|------|
        | level | String | å¦ | ç»Ÿè®¡å±‚çº§(country/region/branch/sales) |
        | parentId | String | å¦ | çˆ¶çº§ID |
        | filters | Object | å¦ | ç­›é€‰æ¡ä»¶ |
        | expand | Boolean | å¦ | æ˜¯å¦å±•å¼€ä¸‹çº§ |

      - **å“åº”æ•°æ®**ï¼š

        | å‚æ•°åç§° | æ•°æ®ç±»å‹ | æè¿° |
        |----------|----------|------|
        | level_data | Array | å½“å‰å±‚çº§ç»Ÿè®¡æ•°æ® |
        | statistics | Object | å„çŠ¶æ€ç»Ÿè®¡æ•°é‡ |
        | drill_down_urls | Object | é’»å–è·³è½¬é“¾æ¥ |
        | sub_levels | Array | ä¸‹çº§å±‚æ¬¡æ•°æ®ï¼ˆå¦‚æœå±•å¼€ï¼‰ |
        | total_counts | Object | æ±‡æ€»ç»Ÿè®¡ |

    - **getDrillDown()**
      - **åŠŸèƒ½æè¿°**ï¼šé’»å–è·å–è¯¦ç»†ç»Ÿè®¡ï¼Œè·³è½¬åˆ°è¯¦ç»†æŠ¥å‘Šé¡µé¢
      - **æ–¹æ³•çŠ¶æ€**ï¼šæ–°å¢
      - **ä¾èµ–æœåŠ¡**ï¼šChannelSummaryService, ProjectListService
      - **è¯·æ±‚å‚æ•°**ï¼š

        | å‚æ•°åç§° | æ•°æ®ç±»å‹ | æ˜¯å¦å¿…å¡« | æè¿° |
        |----------|----------|----------|------|
        | level | String | æ˜¯ | é’»å–å±‚çº§ |
        | levelId | String | æ˜¯ | å±‚çº§ID |
        | status | String | æ˜¯ | é¡¹ç›®çŠ¶æ€ç­›é€‰ |
        | region | String | å¦ | åŒºåŸŸç­›é€‰ |
        | branch | String | å¦ | åˆ†æ”¯ç­›é€‰ |
        | projectSales | String | å¦ | é¡¹ç›®é”€å”®ç­›é€‰ |

      - **å“åº”æ•°æ®**ï¼š

        | å‚æ•°åç§° | æ•°æ®ç±»å‹ | æè¿° |
        |----------|----------|------|
        | redirectUrl | String | è¯¦ç»†æŠ¥å‘Šé¡µé¢URL |
        | appliedFilters | Object | åº”ç”¨çš„ç­›é€‰æ¡ä»¶ |
        | context | Object | é’»å–ä¸Šä¸‹æ–‡ä¿¡æ¯ |

- **ChannelSummaryService.php**
  - **æ–‡ä»¶è·¯å¾„**ï¼š`app/Services/ModChannelPlatform/ChannelSummaryService.php`
  - **æ–‡ä»¶çŠ¶æ€**ï¼šæ–°å¢
  - **æ–¹æ³•**:

    - **getProjectStatsByLevel($level, $parentId, $userId, $filters)**
      - **åŠŸèƒ½æè¿°**ï¼šè·å–æŒ‡å®šå±‚çº§çš„é¡¹ç›®ç»Ÿè®¡æ•°æ®ï¼Œæ ¹æ®ç”¨æˆ·æƒé™è¿‡æ»¤ã€‚ä»…æŸ¥è¯¢Viewç«¯projectè¡¨ä¸­çŠ¶æ€ä¸ºPre-Leadçš„é¡¹ç›®çš„é¡¹ç›®ã€‚
      - **æ–¹æ³•çŠ¶æ€**ï¼šæ–°å¢
      - **è¯·æ±‚å‚æ•°**ï¼š

        | å‚æ•°åç§° | æ•°æ®ç±»å‹ | æ˜¯å¦å¿…å¡« | æè¿° |
        |----------|----------|----------|------|
        | level | String | æ˜¯ | ç»Ÿè®¡å±‚çº§ |
        | parentId | String | å¦ | çˆ¶çº§ID |
        | userId | Integer | æ˜¯ | ç”¨æˆ·ID |
        | filters | Array | å¦ | ç­›é€‰æ¡ä»¶ |

      - **è¿”å›æ•°æ®**ï¼š

        | å‚æ•°åç§° | æ•°æ®ç±»å‹ | æè¿° |
        |----------|----------|------|
        | levelStats | Array | å±‚çº§ç»Ÿè®¡æ•°æ® |
        | summaryCounts | Object | å„çŠ¶æ€æ±‡æ€»æ•°é‡ |
        | permissionFiltered | Boolean | æ˜¯å¦åº”ç”¨äº†æƒé™è¿‡æ»¤ |

    - **queryPreLeadProjects($filters)**
      - **åŠŸèƒ½æè¿°**ï¼šæŸ¥è¯¢Viewç«¯projectè¡¨ä¸­çŠ¶æ€ä¸ºPre-Leadçš„é¡¹ç›®ï¼Œåº”ç”¨ç­›é€‰æ¡ä»¶
      - **æ–¹æ³•çŠ¶æ€**ï¼šæ–°å¢
      - **è¿”å›æ•°æ®**ï¼šPre-Leadé¡¹ç›®åˆ—è¡¨

    - **calculateStatsByDimension($projects)**
      - **åŠŸèƒ½æè¿°**ï¼šè®¡ç®—å„ç»Ÿè®¡ç»´åº¦çš„é¡¹ç›®æ•°é‡
      - **æ–¹æ³•çŠ¶æ€**ï¼šæ–°å¢
      - **å¤„ç†é€»è¾‘**ï¼š
        - All (Created by Partner): DataSource='portal'
        - To Be Assigned: DataSource='view' AND DistributorId IS NULL
        - Accepted: AcceptanceStatus='accepted'
        - Pending: AcceptanceStatus='pending' AND ResponseDeadline > NOW()
        - Declined: AcceptanceStatus='rejected'
        - Cancelled: AcceptanceStatus='cancelled'
      - **è¿”å›æ•°æ®**ï¼šå„ç»´åº¦ç»Ÿè®¡æ•°é‡

    - **buildDrillDownUrl($level, $filters)**
      - **åŠŸèƒ½æè¿°**ï¼šæ„å»ºé’»å–è·³è½¬URLï¼Œä¼ é€’ç­›é€‰æ¡ä»¶
      - **æ–¹æ³•çŠ¶æ€**ï¼šæ–°å¢
      - **è¿”å›æ•°æ®**ï¼šè·³è½¬URLå’ŒæŸ¥è¯¢å‚æ•°

    - **getFilterOptions($userId)**
      - **åŠŸèƒ½æè¿°**ï¼šè·å–ç”¨æˆ·å¯è®¿é—®çš„ç­›é€‰é€‰é¡¹ï¼ˆRegion, Branch, Partner, Project Salesï¼‰
      - **æ–¹æ³•çŠ¶æ€**ï¼šæ–°å¢
      - **è¿”å›æ•°æ®**ï¼šç­›é€‰é€‰é¡¹æ•°ç»„

    - **buildSummaryTree($userId, $filters, $expandLevel)**
      - **åŠŸèƒ½æè¿°**ï¼šæ„å»ºå¤šå±‚çº§ç»Ÿè®¡æ ‘ç»“æ„ï¼Œæ”¯æŒæƒé™æ§åˆ¶å’Œé»˜è®¤å±•å¼€
      - **æ–¹æ³•çŠ¶æ€**ï¼šæ–°å¢
      - **è¿”å›æ•°æ®**ï¼šå¤šå±‚çº§æ ‘ç»“æ„å’Œæ€»ä½“ç»Ÿè®¡ä¿¡æ¯

### 6.7 Channel Partner Project Reportæ¨¡å—

#### 6.7.1 ä¸šåŠ¡æµç¨‹

##### 6.7.1.1 ä¸šåŠ¡èƒŒæ™¯

- **èƒŒæ™¯**ï¼šChannel Partner Project Reportæ˜¯æ¸ é“åˆä½œä¼™ä¼´é¡¹ç›®è¯¦ç»†æŠ¥å‘Šæ¨¡å—ï¼Œæä¾›Pre-Leadé˜¶æ®µé¡¹ç›®çš„è¯¦ç»†ä¿¡æ¯ç›‘æ§å’Œç®¡ç†åŠŸèƒ½ã€‚**æŠ¥å‘Šæ•°æ®æ¥æºäºViewç«¯projectè¡¨ä¸­å·²å­˜å‚¨çš„é¡¹ç›®ï¼ŒåŒ…æ‹¬Viewç«¯åˆ›å»ºçš„å’ŒPortalç«¯activeç”¨æˆ·æ¨é€åŒæ­¥çš„é¡¹ç›®ã€‚**æ”¯æŒåŸºäºæƒé™çš„æ•°æ®è®¿é—®æ§åˆ¶ã€‚

- **ä¸»è¦æµç¨‹**
  
  - **Report List**
    - æŸ¥è¯¢Viewç«¯projectè¡¨ä¸­çŠ¶æ€ä¸ºPre-Leadçš„é¡¹ç›®
    - åŒ…æ‹¬Viewç«¯å¯¼å…¥/æ–°å»ºçš„Pre-Leadé¡¹ç›®
    - åŒ…æ‹¬Portalç«¯activeç”¨æˆ·æ¨é€åå­˜å‚¨åœ¨Viewç«¯çš„é¡¹ç›®
    - **ä¸é€šè¿‡APIè·å–Portalç«¯æ•°æ®ï¼Œæ‰€æœ‰æ•°æ®å·²å­˜å‚¨åœ¨Viewç«¯**
    - æŸ¥è¯¢Viewç«¯projectè¡¨ä¸­çŠ¶æ€ä¸ºPre-Leadçš„é¡¹ç›®
    - åŒ…æ‹¬Viewç«¯å¯¼å…¥/æ–°å»ºçš„Pre-Leadé¡¹ç›®
    - åŒ…æ‹¬Portalç«¯activeç”¨æˆ·æ¨é€åå­˜å‚¨åœ¨Viewç«¯çš„é¡¹ç›®
    - **ä¸é€šè¿‡APIè·å–Portalç«¯æ•°æ®ï¼Œæ‰€æœ‰æ•°æ®å·²å­˜å‚¨åœ¨Viewç«¯**
    ![alt text](<018 - æ¸ é“å•†é¡¹ç›®æ±‡æ€»æŠ¥å‘Š.png>)

- **æƒé™æ§åˆ¶è®¿é—®**ï¼š
  - **"æŸ¥çœ‹"æƒé™**ï¼šSalesåªèƒ½æŸ¥çœ‹å’Œå¤„ç†è‡ªå·±è´Ÿè´£çš„é¡¹ç›®
  - **"æŸ¥çœ‹å…¨éƒ¨"æƒé™**ï¼šæ ¹æ®å½“å‰viewæƒé™èµ°çœ‹å¯¹åº”branchæƒé™å’Œè§’è‰²
  - æ ¹æ®æƒé™åŠ¨æ€è¿‡æ»¤é¡¹ç›®åˆ—è¡¨

- **å¼‚å¸¸æµç¨‹**ï¼š
  - é¡¹ç›®æ•°æ®æŸ¥è¯¢å¤±è´¥ â†’ æ˜¾ç¤ºé”™è¯¯æç¤ºå¹¶è®°å½•æ—¥å¿—
  - æƒé™ä¸è¶³ â†’ ä»…æ˜¾ç¤ºç”¨æˆ·æƒé™èŒƒå›´å†…çš„æ•°æ®
  - ç­›é€‰æ¡ä»¶æ— ç»“æœ â†’ æ˜¾ç¤ºæ— æ•°æ®æç¤º

- **æµç¨‹å›¾**ï¼š

```mermaid
flowchart TD
    START[è¿›å…¥Project Report] --> CHECK_PERMISSION{æ£€æŸ¥ç”¨æˆ·æƒé™}
    CHECK_PERMISSION -->|æŸ¥çœ‹| QUERY_OWN[æŸ¥è¯¢ç”¨æˆ·è‡ªå·±çš„é¡¹ç›®]
    CHECK_PERMISSION -->|æŸ¥çœ‹å…¨éƒ¨| QUERY_ALL[æŸ¥è¯¢æ‰€æœ‰Pre-Leadé¡¹ç›®]
    
    QUERY_OWN --> FILTER[åº”ç”¨ç­›é€‰æ¡ä»¶]
    QUERY_ALL --> FILTER
    
    FILTER --> QUERY_DB[ä»projectè¡¨æŸ¥è¯¢çŠ¶æ€ä¸ºPre-Leadçš„é¡¹ç›®]
    QUERY_DB --> JOIN[å…³è”project_distributorå’Œprojectbank_units]
    JOIN --> FORMAT[æ ¼å¼åŒ–æŠ¥å‘Šæ•°æ®]
    FORMAT --> DISPLAY[å±•ç¤ºé¡¹ç›®åˆ—è¡¨]
    
    DISPLAY --> USER_ACTION{ç”¨æˆ·æ“ä½œ}
    USER_ACTION -->|ç‚¹å‡»Partner Name| JUMP_PARTNER[è·³è½¬PartnerInfo]
    USER_ACTION -->|ç‚¹å‡»Project| JUMP_PROJECT[è·³è½¬ProjectInfo]
    USER_ACTION -->|åº”ç”¨ç­›é€‰| FILTER
```

#### 6.7.2 å½±å“çš„æ•°æ®è¡¨

- **[project](#table-project)** : Viewç«¯ ProjectåŸºç¡€ä¿¡æ¯è¡¨
- **[project_customer](#table-project_customer)** : Viewç«¯ Project Agentå…³è”è¡¨
- **[project_distributor](#table-project_distributor)** : Viewç«¯ Project Distributorå…³è”è¡¨
- **[mod_channel_project_assignments](#table-mod_channel_project_assignments)** : Viewç«¯ åˆ†é…è®°å½•è¡¨

#### 6.7.3 å‰ç«¯å®ç°

##### 6.7.3.1 è§†å›¾ç›®å½•ç»“æ„

```plaintext
/web/nimod/application/views/scripts/channel-report/
  index.phtml                  - é¡¹ç›®æŠ¥å‘Šä¸»é¡µé¢
```

##### 6.7.3.2 å…³é”®ç»„ä»¶åŠŸèƒ½

- **é¡¹ç›®åˆ—è¡¨è¡¨æ ¼** åŒ…å«ï¼š
  - Region, Branch, Project ID, Project Name, Partner Nameï¼ˆå¯ç‚¹å‡»ï¼‰
  - Contact, Project Sales, Lead Source, Sales Stage
  - Accept Status, Partner Decline Reason, Units, Latest Update
  - æ•°æ®æ¥æºæ ‡è¯†ï¼ˆView/Portalï¼‰
  - æ’åºå’Œåˆ†é¡µåŠŸèƒ½

- **æœç´¢ç­›é€‰ç»„ä»¶** åŒ…å«ï¼š
  - Region, Branch, Partner, Project Sales, Project Name, Project ID
  - Accept Status, Lead Source, Data Sourceç­›é€‰

##### 6.7.3.3 è·¯ç”±è®¾è®¡

| HTTP æ–¹æ³• | ç«¯ç‚¹ | æè¿° |
|----------|------|------|
| GET | `/channel-report` | è·å–é¡¹ç›®æŠ¥å‘Šåˆ—è¡¨ |
| GET | `/channel-report/export` | å¯¼å‡ºæŠ¥å‘Šæ•°æ® |

#### 6.7.4 é”™è¯¯å¤„ç†å’Œæ—¥å¿—è®°å½•

##### 6.7.4.1 æ—¥å¿—è®°å½•

ä½¿ç”¨Viewç³»ç»Ÿç°æœ‰æ—¥å¿—æœºåˆ¶ï¼š

- **ç³»ç»Ÿé”™è¯¯æ—¥å¿—è®°å½•åœºæ™¯**ï¼š

  | æ“ä½œç±»å‹ | è®°å½•æ—¶æœº |
  |----------|----------|
  | report_query_failed | æŠ¥å‘Šæ•°æ®æŸ¥è¯¢å¤±è´¥ |
  | permission_denied | æƒé™ä¸è¶³ |
  | export_failed | å¯¼å‡ºå¤±è´¥ |

#### 6.7.5 åŠŸèƒ½å¼€å‘ä¸å®ç°

##### 6.7.5.1 ç±»å…³ç³»å›¾

```mermaid
classDiagram
    class ChannelReportController {
        +index()
        +getReportData()
        +exportReport()
    }

    class ProjectListService {
        +getProjectsWithFilters(filters)
        +getProjectStats(filters)
        +formatProjectListData(projects)
        +getProjectUnitsCount(projectId)
        +getProjectsWithPermission(userId, filters, pagination)
        +formatReportData(projects)
        +queryPreLeadProjects(filters, userId)
    }

    class DynamicLoggerFactory {
        +getLogger(system, module)
    }

    ChannelReportController --> ProjectListService : æŠ¥å‘Šæ•°æ®
    ProjectListService --> DynamicLoggerFactory : æ—¥å¿—è®°å½•
```

##### 6.7.5.2 ä»£ç å®ç°

- **ChannelReportController.php**
  - **æ–‡ä»¶è·¯å¾„**ï¼š`app/Http/Controllers/ModChannelPlatform/ChannelReportController.php`
  - **æ–‡ä»¶çŠ¶æ€**ï¼šæ–°å¢
  - **æ–¹æ³•**:
    - **index()**
      - **åŠŸèƒ½æè¿°**ï¼šæ˜¾ç¤ºé¡¹ç›®æŠ¥å‘Šåˆ—è¡¨é¡µé¢ï¼Œæ ¹æ®ç”¨æˆ·æƒé™è¿‡æ»¤æ•°æ®ï¼Œæ”¯æŒä»Summaryé¡µé¢è·³è½¬å¹¶ä¿æŒç­›é€‰æ¡ä»¶ã€‚ä»…æŸ¥è¯¢Viewç«¯projectè¡¨ä¸­å·²å­˜å‚¨çš„Pre-Leadé¡¹ç›®ã€‚
      - **æ–¹æ³•çŠ¶æ€**ï¼šæ–°å¢
      - **ä¾èµ–æœåŠ¡**ï¼šProjectListService
      - **è¯·æ±‚å‚æ•°**ï¼š

        | å‚æ•°åç§° | æ•°æ®ç±»å‹ | æ˜¯å¦å¿…å¡« | æè¿° |
        |----------|----------|----------|------|
        | region | String | å¦ | åŒºåŸŸç­›é€‰ |
        | branch | String | å¦ | åˆ†æ”¯ç­›é€‰ |
        | partner | String | å¦ | åˆä½œä¼™ä¼´ç­›é€‰ |
        | projectSales | String | å¦ | é¡¹ç›®é”€å”®ç­›é€‰ |
        | projectName | String | å¦ | é¡¹ç›®åç§°æœç´¢ |
        | projectId | String | å¦ | é¡¹ç›®IDæœç´¢ |
        | acceptStatus | String | å¦ | æ¥å—çŠ¶æ€ç­›é€‰ |
        | leadSource | String | å¦ | Leadæ¥æºç­›é€‰ |
        | dataSource | String | å¦ | æ•°æ®æ¥æºç­›é€‰(view/portal) |
        | fromSummary | Boolean | å¦ | æ˜¯å¦ä»Summaryé¡µé¢è·³è½¬ |

      - **å“åº”æ•°æ®**ï¼š

        | å‚æ•°åç§° | æ•°æ®ç±»å‹ | æè¿° |
        |----------|----------|------|
        | view | Blade | index.phtmlè§†å›¾ |
        | projects | Array | é¡¹ç›®æŠ¥å‘Šåˆ—è¡¨ |
        | total | Integer | æ€»è®°å½•æ•° |
        | hasMore | Boolean | æ˜¯å¦æœ‰æ›´å¤šæ•°æ® |
        | filterOptions | Object | ç­›é€‰æ¡ä»¶é€‰é¡¹ |

    - **getReportData()**
      - **åŠŸèƒ½æè¿°**ï¼šè·å–é¡¹ç›®æŠ¥å‘Šæ•°æ®APIï¼Œæ ¹æ®æƒé™è¿”å›å¯¹åº”é¡¹ç›®åˆ—è¡¨ã€‚ä»…æŸ¥è¯¢Viewç«¯projectè¡¨ã€‚
      - **æ–¹æ³•çŠ¶æ€**ï¼šæ–°å¢
      - **è°ƒç”¨é¡ºåº**ï¼šå‰ç«¯Ajaxè·å–æŠ¥å‘Šæ•°æ®æ—¶è°ƒç”¨
      - **ä¾èµ–æœåŠ¡**ï¼šProjectListService
      - **è¯·æ±‚å‚æ•°**ï¼š

        | å‚æ•°åç§° | æ•°æ®ç±»å‹ | æ˜¯å¦å¿…å¡« | æè¿° |
        |----------|----------|----------|------|
        | filters | Object | å¦ | ç­›é€‰æ¡ä»¶å¯¹è±¡ |
        | page | Integer | å¦ | é¡µç  |
        | perPage | Integer | å¦ | æ¯é¡µæ¡æ•° |

      - **å“åº”æ•°æ®**ï¼š

        | å‚æ•°åç§° | æ•°æ®ç±»å‹ | æè¿° |
        |----------|----------|------|
        | success | Boolean | æ˜¯å¦è·å–æˆåŠŸ |
        | projects | Array | é¡¹ç›®æŠ¥å‘Šåˆ—è¡¨ |
        | total | Integer | æ€»è®°å½•æ•° |
        | hasMore | Boolean | æ˜¯å¦æœ‰æ›´å¤šæ•°æ® |

    - **exportReport()**
      - **åŠŸèƒ½æè¿°**ï¼šå¯¼å‡ºé¡¹ç›®æŠ¥å‘Šæ•°æ®ä¸ºExcelæ–‡ä»¶
      - **æ–¹æ³•çŠ¶æ€**ï¼šæ–°å¢
      - **ä¾èµ–æœåŠ¡**ï¼šProjectListService
      - **è¯·æ±‚å‚æ•°**ï¼š

        | å‚æ•°åç§° | æ•°æ®ç±»å‹ | æ˜¯å¦å¿…å¡« | æè¿° |
        |----------|----------|----------|------|
        | filters | Object | å¦ | ç­›é€‰æ¡ä»¶å¯¹è±¡ |

      - **å“åº”æ•°æ®**ï¼š

        | å‚æ•°åç§° | æ•°æ®ç±»å‹ | æè¿° |
        |----------|----------|------|
        | file | File | Excelæ–‡ä»¶æµ |
        | filename | String | æ–‡ä»¶å |

- **ProjectListService.php**
  - **æ–‡ä»¶è·¯å¾„**ï¼š`app/Services/ModChannelPlatform/ProjectListService.php`
  - **æ–‡ä»¶çŠ¶æ€**ï¼šMODIFY
  - **æ–¹æ³•**:
    - **getProjectsWithPermission($userId, $filters, $pagination)**
      - **åŠŸèƒ½æè¿°**ï¼šæ ¹æ®ç”¨æˆ·æƒé™è·å–é¡¹ç›®åˆ—è¡¨ï¼Œ"æŸ¥çœ‹"æƒé™åªè¿”å›è‡ªå·±çš„é¡¹ç›®ï¼Œ"æŸ¥çœ‹å…¨éƒ¨"æƒé™è¿”å›æ‰€æœ‰é¡¹ç›®ã€‚ä»…æŸ¥è¯¢Viewç«¯projectè¡¨ä¸­çŠ¶æ€ä¸ºPre-Leadçš„é¡¹ç›®ã€‚
      - **æ–¹æ³•çŠ¶æ€**ï¼šæ–°å¢
      - **è¿”å›æ•°æ®**ï¼šæƒé™è¿‡æ»¤åçš„é¡¹ç›®åˆ—è¡¨

    - **queryPreLeadProjects($filters, $userId)**
      - **åŠŸèƒ½æè¿°**ï¼šæŸ¥è¯¢Viewç«¯projectè¡¨ä¸­çŠ¶æ€ä¸ºPre-Leadçš„é¡¹ç›®ï¼Œåº”ç”¨æƒé™å’Œç­›é€‰æ¡ä»¶
      - **æ–¹æ³•çŠ¶æ€**ï¼šæ–°å¢
      - **å¤„ç†æµç¨‹**ï¼š
        1. æ„å»ºåŸºç¡€æŸ¥è¯¢
        2. åº”ç”¨ç”¨æˆ·æƒé™è¿‡æ»¤
        3. åº”ç”¨ç­›é€‰æ¡ä»¶ï¼ˆRegion, Branch, Partnerç­‰ï¼‰
        4. JOIN mod_channel_project_assignmentsè·å–AcceptanceStatus
        5. JOIN projectbank_unitsç»Ÿè®¡Units
        6. JOIN customerè·å–Partnerä¿¡æ¯
      - **è¿”å›æ•°æ®**ï¼šPre-Leadé¡¹ç›®åˆ—è¡¨

    - **formatReportData($projects)**
      - **åŠŸèƒ½æè¿°**ï¼šæ ¼å¼åŒ–æŠ¥å‘Šæ•°æ®ï¼ŒåŒ…å«Partner Nameé“¾æ¥ã€Unitsç»Ÿè®¡ã€æ•°æ®æ¥æºæ ‡è¯†ç­‰
      - **æ–¹æ³•çŠ¶æ€**ï¼šæ–°å¢
      - **è¿”å›æ•°æ®**ï¼šæ ¼å¼åŒ–çš„æŠ¥å‘Šæ•°æ®

### 6.8 Inquiry æ¨¡å—

#### 6.8.1 ä¸šåŠ¡æµç¨‹

##### 6.8.1.1 ä¸šåŠ¡èƒŒæ™¯

- **èƒŒæ™¯**ï¼šInquiryæ˜¯CNViewç«¯å’¨è¯¢ç®¡ç†æ¨¡å—ï¼Œé”€å”®äººå‘˜é€šè¿‡æ­¤æ¨¡å—ç®¡ç†ä¸åˆä½œä¼™ä¼´çš„è¯¢ç›˜äº¤äº’ã€‚**Activeç”¨æˆ·çš„å’¨è¯¢æ•°æ®åœ¨æ¿€æ´»æ—¶åŒæ­¥åˆ°Viewç«¯å¹¶å­˜å‚¨åœ¨inquiriesè¡¨ä¸­ï¼Œinactiveç”¨æˆ·çš„å’¨è¯¢æ•°æ®é€šè¿‡APIå®æ—¶è·å–å’Œæ“ä½œã€‚**æ”¯æŒåŸºäºæƒé™çš„æ•°æ®è®¿é—®æ§åˆ¶ã€å¤šçŠ¶æ€ç®¡ç†å’Œè‡ªåŠ¨è¿‡æœŸæœºåˆ¶ã€‚

- **ä¸»è¦æµç¨‹**

  - **Inactive/Active**ï¼šä¸¤ç«¯æ•°æ®åˆ†å¼€å±•ç¤º
  - **Open**ï¼šæ–°å»ºå’¨è¯¢ï¼Œç­‰å¾…é”€å”®å›å¤ï¼Œé»˜è®¤æ˜¾ç¤ºçŠ¶æ€ï¼Œ åˆ—è¡¨å±•ç¤º partner å¯¹åº”çš„é”€å”® (å¯å¤šä¸ª)
  - **Rating**ï¼šé”€å”®å·²å›å¤ï¼Œç­‰å¾…åˆä½œä¼™ä¼´è¯„ä»·ï¼Œ åˆ—è¡¨å±•ç¤º å›ç­”é—®é¢˜çš„é”€å”®
  - **Closed**ï¼šå·²å®Œæˆè¯„ä»·æˆ–è‡ªåŠ¨å…³é—­çš„å’¨è¯¢ï¼Œ åˆ—è¡¨å±•ç¤º å›ç­”é—®é¢˜çš„é”€å”®
  - **All**ï¼šæ˜¾ç¤ºæ‰€æœ‰çŠ¶æ€å’¨è¯¢
  
  - **Inquiry Open List**
    - å¾…å›å¤åˆ—è¡¨, Partner Pendingæ—¶,æ•°æ®å­˜å‚¨è‡³Portal
    - å¯¹åº”é”€å”®å¯ä»¥å›å¤ä¿¡æ¯
    - åˆ—è¡¨é”€å”®åç§°ä¸º ï¼š åˆ†é…çš„é”€å”®/æ‰«ç çš„é”€å”®
    ![alt text](<019 - Inquiry - Open.png>)

  - **Inquiry Rating List**
    - å¾…è¯„ä»·åˆ—è¡¨,ä»…æŸ¥çœ‹æ•°æ® ç­‰å¾…Portalç«¯Partnerå›å¤
    - åˆ—è¡¨å±•ç¤ºçš„é”€å”®ä¸º å›å¤inquiryçš„é”€å”®
    ![alt text](<020 - Inquiry - Rating.png>)

  - **Inquiry Closed List**
    - å·²è¯„ä»·çš„åˆ—è¡¨, ä»…æŸ¥çœ‹ å¹¶å±•ç¤ºç»Ÿè®¡æ•°æ®
    ![alt text](<021 - Inquiry â€“ Closed.png>)
    ![alt text](<022 - Inquiry â€“ Closed â€“ Country.png>)

- **æƒé™æ§åˆ¶è®¿é—®**ï¼š
  - **"æŸ¥çœ‹"æƒé™**ï¼šSalesåªèƒ½æŸ¥çœ‹è‡ªå·±è´Ÿè´£çš„å’¨è¯¢
  - **"æŸ¥çœ‹å…¨éƒ¨"æƒé™**ï¼šæœ‰æƒé™çš„äººæŸ¥çœ‹æ‰€æœ‰å’¨è¯¢å’Œç»Ÿè®¡æ•°æ®
  - å¤šé”€å”®åˆ†é…æ—¶ï¼Œæ‰€æœ‰Saleséƒ½èƒ½æ”¶åˆ°é€šçŸ¥

- **è¯„ä»·ç»Ÿè®¡ç³»ç»Ÿ**ï¼š
  - **"æŸ¥çœ‹å…¨éƒ¨"æƒé™ç”¨æˆ·**ï¼šå¯æŸ¥çœ‹å›½å®¶å¹³å‡åˆ†ã€åˆ†å…¬å¸å¹³å‡åˆ†ã€é”€å”®å¹³å‡åˆ†å’Œè¯¦ç»†è¯„ä»·
  - **"æŸ¥çœ‹"æƒé™ç”¨æˆ·**ï¼šä¸æ˜¾ç¤ºæ˜Ÿçº§å’Œå¹³å‡åˆ†æ•°
  - ClosedçŠ¶æ€æ˜¾ç¤ºè¯„ä»·ç»Ÿè®¡

- **å¼‚å¸¸æµç¨‹**ï¼š
  - é”€å”®å›å¤å¤±è´¥ â†’ ä¿æŒOpençŠ¶æ€ï¼Œå…è®¸é‡è¯•
  - è¿‡æœŸå¤„ç†å¤±è´¥ â†’ è®°å½•é”™è¯¯ï¼Œä¸‹æ¬¡å®šæ—¶ä»»åŠ¡é‡è¯•

- **æµç¨‹å›¾**ï¼š

```mermaid
flowchart TD
    START[è¿›å…¥Inquiryæ¨¡å—] --> CHECK_SOURCE{æ£€æŸ¥æ•°æ®æ¥æº}
    
    CHECK_SOURCE -->|Activeç”¨æˆ·| QUERY_VIEW[æŸ¥è¯¢Viewç«¯inquiriesè¡¨]
    CHECK_SOURCE -->|Inactiveç”¨æˆ·| CALL_API[è°ƒç”¨Portal APIè·å–]
    
    QUERY_VIEW --> MERGE[åˆå¹¶æ•°æ®]
    CALL_API --> MERGE
    
    MERGE --> FILTER_PERMISSION[åº”ç”¨æƒé™è¿‡æ»¤]
    FILTER_PERMISSION --> DISPLAY[å±•ç¤ºå’¨è¯¢åˆ—è¡¨]
    
    DISPLAY --> USER_ACTION{ç”¨æˆ·æ“ä½œ}
    USER_ACTION -->|å›å¤Activeç”¨æˆ·| REPLY_ACTIVE[å­˜å‚¨å›å¤åˆ°Viewç«¯]
    USER_ACTION -->|å›å¤Inactiveç”¨æˆ·| REPLY_INACTIVE[é€šè¿‡APIæ“ä½œPortalç«¯]
    
    REPLY_ACTIVE --> UPDATE_STATUS[æ›´æ–°çŠ¶æ€ä¸ºRating]
    REPLY_INACTIVE --> UPDATE_STATUS
    
    UPDATE_STATUS --> SET_DEADLINE[è®¾ç½®30å¤©è¯„ä»·æœŸé™]
    SET_DEADLINE --> CHECK_RATING{æ˜¯å¦è¯„ä»·}
    
    CHECK_RATING -->|30å¤©å†…è¯„ä»·| RATING[å­˜å‚¨è¯„ä»·æ•°æ®JSON]
    CHECK_RATING -->|30å¤©æœªè¯„ä»·| AUTO_CLOSE[è‡ªåŠ¨å…³é—­]
    
    RATING --> UPDATE_STATS[å®æ—¶è®¡ç®—ç»Ÿè®¡æ•°æ®]
    AUTO_CLOSE --> CLOSED[çŠ¶æ€å˜ä¸ºClosed]
    UPDATE_STATS --> CLOSED
```

#### 6.8.2 å½±å“çš„æ•°æ®è¡¨

- Viewç«¯
  - **[customer_employee](#table-customer_employee)** : Viewç«¯ customerå…³è”çš„é”€å”®
  - **[mod_channel_inquiries](#table-mod_channel_inquiries)** : Viewç«¯ InquiryåŸºç¡€è¡¨
  - **[mod_channel_inquiry_rating](#table-mod_channel_inquiry_rating)** : Viewç«¯ Inquiryè¯„åˆ†è¡¨

- Portalç«¯
  - **[users](#table-users)** : Portalç«¯ UseråŸºç¡€ä¿¡æ¯è¡¨
  - **[user_company](#table-user_company)** : User&Company å…³è”è¡¨(è®°å½• Partner å½“å‰çŠ¶æ€)
  - **[user_company_assignment](#table-user_company_assignment)** : Portalç«¯ Partner å…³è” é”€å”®è¡¨
  - **[inquiries](#table-inquiries)** : Portalç«¯ Partner å…³è” é”€å”®è¡¨
  - **[inquiry_rating](#table-inquiry_rating)** : Portalç«¯ Partner å…³è” é”€å”®è¡¨

#### 6.8.3 å‰ç«¯å®ç°

##### 6.8.3.1 è§†å›¾ç›®å½•ç»“æ„

```plaintext
/web/nimod/application/views/scripts/inquiry/
  index.phtml                  - å’¨è¯¢åˆ—è¡¨ä¸»é¡µé¢
  reply.phtml                  - å’¨è¯¢å›å¤é¡µé¢
  stats.phtml                  - å’¨è¯¢ç»Ÿè®¡é¡µé¢
```

##### 6.8.3.2 å…³é”®ç»„ä»¶åŠŸèƒ½

- **çŠ¶æ€æ ‡ç­¾é¡µ** åŒ…å«ï¼š
  - Open (é»˜è®¤)ã€Ratingã€Closedã€All å››ä¸ªçŠ¶æ€åˆ‡æ¢
  - å„çŠ¶æ€ä¸‹çš„å’¨è¯¢æ•°é‡ç»Ÿè®¡

- **å’¨è¯¢åˆ—è¡¨** åŒ…å«ï¼š
  - ç­›é€‰æ¡ä»¶ï¼šSales, Partner, Q&A Category, Create Date
  - åˆ—è¡¨å­—æ®µï¼šå’¨è¯¢æ ‡é¢˜ã€åˆä½œä¼™ä¼´ã€åˆ†ç±»ã€é”€å”®ã€åˆ›å»ºæ—¥æœŸã€çŠ¶æ€
  - æ¯é¡µ15æ¡è®°å½•ï¼Œåˆ†é¡µåŠŸèƒ½
  - ä»…æ˜¾ç¤ºæœ€è¿‘12ä¸ªæœˆæ•°æ®
  - æ•°æ®æ¥æºæ ‡è¯†ï¼ˆActiveç”¨æˆ·/Inactiveç”¨æˆ·ï¼‰

- **è¯„ä»·ç»Ÿè®¡** åŒ…å«ï¼š
  - æƒé™æ§åˆ¶çš„æ˜Ÿçº§è¯„åˆ†æ˜¾ç¤º
  - å›½å®¶/åˆ†å…¬å¸/é”€å”®å¹³å‡åˆ†ï¼ˆä»…"æŸ¥çœ‹å…¨éƒ¨"æƒé™å¯è§ï¼‰
  - åŸºäºJSONè¯„ä»·æ•°æ®çš„å®æ—¶è®¡ç®—

##### 6.8.3.3 è·¯ç”±è®¾è®¡

| HTTP æ–¹æ³• | ç«¯ç‚¹ | æè¿° |
|----------|------|------|
| GET | `/inquiry` | è·å–å’¨è¯¢åˆ—è¡¨ï¼ˆæ”¯æŒç­›é€‰ï¼‰ |
| GET | `/inquiry/{id}` | è·å–å’¨è¯¢è¯¦æƒ… |
| POST | `/inquiry/{id}/reply` | å›å¤å’¨è¯¢ |
| GET | `/inquiry/stats` | è·å–å’¨è¯¢ç»Ÿè®¡æ•°æ® |
| POST | `/inquiry/sync-from-portal` | ä»PortalåŒæ­¥å’¨è¯¢æ•°æ®ï¼ˆæ¿€æ´»æ—¶ï¼‰ |

#### 6.8.4 é”™è¯¯å¤„ç†å’Œæ—¥å¿—è®°å½•

##### 6.8.4.1 æ—¥å¿—è®°å½•

ä½¿ç”¨DynamicLoggerFactoryè¿›è¡Œæ¨¡å—åŒ–æ—¥å¿—è®°å½•ï¼š

- **ç³»ç»Ÿé”™è¯¯æ—¥å¿—è®°å½•åœºæ™¯**ï¼š

  | æ“ä½œç±»å‹ | è®°å½•æ—¶æœº |
  |----------|----------|
  | portal_api_failed | Portal APIè°ƒç”¨å¤±è´¥ |
  | reply_failed | å›å¤å‘é€å¤±è´¥ |
  | sync_failed | PortalåŒæ­¥å¤±è´¥ |
  | auto_close_failed | è‡ªåŠ¨å…³é—­å¤±è´¥ |
  | stats_calculation_failed | ç»Ÿè®¡è®¡ç®—å¤±è´¥ |
  | exclusive_lock_failed | å›å¤ç‹¬å é”å¤±è´¥ |
  | json_parse_failed | JSONæ•°æ®è§£æå¤±è´¥ |

#### 6.8.5 åŠŸèƒ½å¼€å‘ä¸å®ç°

##### 6.8.5.1 ç±»å…³ç³»å›¾

```mermaid
classDiagram
    class InquiryController {
        +index()
        +show()
        +reply()
        +getStats()
        +syncFromPortal()
    }

    class InquiryService {
        +getInquiriesWithPermission(userId, filters, pagination)
        +getActiveUserInquiries(userId, filters)
        +getInactiveUserInquiries(userId)
        +replyToActiveInquiry(inquiryId, userId, replyContent)
        +replyToInactiveInquiry(userId, replyContent)
        +processAutoClose()
        +syncInquiriesFromPortal(userId, portalData)
    }

    class InquiryStatsService {
        +getStatsWithPermission(userId, statsType)
        +calculateAverageRatings(statsType, statsKey)
    }

    class DynamicLoggerFactory {
        +getLogger(system, module)
    }

    InquiryController --> InquiryService : å’¨è¯¢å¤„ç†
    InquiryController --> InquiryStatsService : ç»Ÿè®¡æœåŠ¡
    InquiryController --> DynamicLoggerFactory : æ—¥å¿—è®°å½•
    InquiryService --> DynamicLoggerFactory : æ—¥å¿—è®°å½•
    InquiryStatsService --> DynamicLoggerFactory : æ—¥å¿—è®°å½•
```

##### 6.8.5.2 ä»£ç å®ç°

- **InquiryController.php**
  - **æ–‡ä»¶è·¯å¾„**ï¼š`app/Http/Controllers/ModChannelPlatform/InquiryController.php`
  - **æ–‡ä»¶çŠ¶æ€**ï¼šæ–°å¢
  - **æ–¹æ³•**:
    - **index()**
      - **åŠŸèƒ½æè¿°**ï¼šæ˜¾ç¤ºå’¨è¯¢åˆ—è¡¨é¡µé¢ï¼Œæ ¹æ®ç”¨æˆ·æƒé™è¿‡æ»¤æ•°æ®ã€‚Activeç”¨æˆ·å’¨è¯¢ä»Viewç«¯inquiriesè¡¨æŸ¥è¯¢ï¼Œinactiveç”¨æˆ·å’¨è¯¢é€šè¿‡Portal APIè·å–ï¼Œæœ€ååˆå¹¶å±•ç¤ºã€‚ä»…æ˜¾ç¤ºæœ€è¿‘12ä¸ªæœˆæ•°æ®ï¼Œé»˜è®¤æ˜¾ç¤ºOpençŠ¶æ€ã€‚
      - **æ–¹æ³•çŠ¶æ€**ï¼šæ–°å¢
      - **ä¾èµ–æœåŠ¡**ï¼šInquiryService, InquiryStatsService
      - **è¯·æ±‚å‚æ•°**ï¼š

        | å‚æ•°åç§° | æ•°æ®ç±»å‹ | æ˜¯å¦å¿…å¡« | æè¿° |
        |----------|----------|----------|------|
        | status | String | å¦ | çŠ¶æ€ç­›é€‰(open/rating/closed/all)ï¼Œé»˜è®¤open |
        | sales | String | å¦ | é”€å”®äººå‘˜ç­›é€‰ |
        | partner | String | å¦ | åˆä½œä¼™ä¼´ç­›é€‰ |
        | category | String | å¦ | åˆ†ç±»ç­›é€‰ |
        | createDate | String | å¦ | åˆ›å»ºæ—¥æœŸç­›é€‰ |
        | page | Integer | å¦ | é¡µç ï¼Œé»˜è®¤1 |
        | perPage | Integer | å¦ | æ¯é¡µæ¡æ•°ï¼Œé»˜è®¤15 |

      - **å“åº”æ•°æ®**ï¼š

        | å‚æ•°åç§° | æ•°æ®ç±»å‹ | æè¿° |
        |----------|----------|------|
        | inquiries | Array | å’¨è¯¢åˆ—è¡¨ï¼ˆåˆå¹¶Activeå’ŒInactiveæ•°æ®ï¼‰ |
        | pagination | Object | åˆ†é¡µä¿¡æ¯ {current_page, total_pages, total_count} |
        | filterOptions | Object | ç­›é€‰æ¡ä»¶é€‰é¡¹ {sales_list, category_list} |
        | statusCounts | Object | å„çŠ¶æ€å’¨è¯¢æ•°é‡ {open, rating, closed, all} |
        | defaultStatus | String | é»˜è®¤çŠ¶æ€ï¼ˆopenï¼‰ |
        | portalDataStatus | String | Portalæ•°æ®è·å–çŠ¶æ€ (success/failed/partial) |

    - **reply()**
      - **åŠŸèƒ½æè¿°**ï¼šå¤„ç†å’¨è¯¢å›å¤ï¼Œå®ç°ç‹¬å æœºåˆ¶ã€‚Activeç”¨æˆ·å’¨è¯¢å­˜å‚¨å›å¤åˆ°Viewç«¯inquiriesè¡¨çš„SalesReplyå­—æ®µï¼Œinactiveç”¨æˆ·å’¨è¯¢é€šè¿‡APIæ“ä½œPortalç«¯ã€‚å›å¤åå…¶ä»–é”€å”®æ— æ³•æŸ¥çœ‹ï¼ŒçŠ¶æ€å˜ä¸ºRatingï¼Œè®¾ç½®RatingDeadlineä¸º30å¤©åã€‚
      - **æ–¹æ³•çŠ¶æ€**ï¼šæ–°å¢
      - **ä¾èµ–æœåŠ¡**ï¼šInquiryService
      - **è¯·æ±‚å‚æ•°**ï¼š

        | å‚æ•°åç§° | æ•°æ®ç±»å‹ | æ˜¯å¦å¿…å¡« | æè¿° |
        |----------|----------|----------|------|
        | inquiryId | Integer | æ˜¯ | å’¨è¯¢ID |
        | replyContent | String | æ˜¯ | å›å¤å†…å®¹ |
        | registerChannel | Boolean | å¦ | æ˜¯å¦ä¸ºPortalç«¯æ•°æ® |
        | portalInquiryId | Integer | å¦ | Portalç«¯å’¨è¯¢ID |

      - **å“åº”æ•°æ®**ï¼š

        | å‚æ•°åç§° | æ•°æ®ç±»å‹ | æè¿° |
        |----------|----------|------|
        | success | Boolean | å›å¤æ˜¯å¦æˆåŠŸ |
        | inquiryStatus | String | æ›´æ–°åå’¨è¯¢çŠ¶æ€ï¼ˆratingï¼‰ |
        | exclusiveLocked | Boolean | æ˜¯å¦è·å¾—ç‹¬å é” |
        | ratingDeadline | String | è¯„ä»·æˆªæ­¢æ—¶é—´ |
        | message | String | æ“ä½œç»“æœä¿¡æ¯ |
        | registerChannel | String | æ•°æ®æ¥æº(view/portal) |

    - **getStats()**
      - **åŠŸèƒ½æè¿°**ï¼šè·å–å’¨è¯¢ç»Ÿè®¡æ•°æ®ï¼Œæ ¹æ®æƒé™è¿”å›ä¸åŒè¯¦ç»†ç¨‹åº¦çš„ç»Ÿè®¡ä¿¡æ¯ã€‚ä»…ç»Ÿè®¡Viewç«¯inquiriesè¡¨ä¸­çš„Activeç”¨æˆ·æ•°æ®ã€‚
      - **æ–¹æ³•çŠ¶æ€**ï¼šæ–°å¢
      - **ä¾èµ–æœåŠ¡**ï¼šInquiryStatsService
      - **è¯·æ±‚å‚æ•°**ï¼š

        | å‚æ•°åç§° | æ•°æ®ç±»å‹ | æ˜¯å¦å¿…å¡« | æè¿° |
        |----------|----------|----------|------|
        | statsType | String | å¦ | ç»Ÿè®¡ç±»å‹(country/branch/sales)ï¼Œé»˜è®¤sales |
        | dateRange | String | å¦ | æ—¥æœŸèŒƒå›´(last_year) |
        | salesFilter | String | å¦ | é”€å”®äººå‘˜ç­›é€‰ |

      - **å“åº”æ•°æ®**ï¼š

        | å‚æ•°åç§° | æ•°æ®ç±»å‹ | æè¿° |
        |----------|----------|------|
        | stats | Object | ç»Ÿè®¡æ•°æ® |
        | averages | Object | å¹³å‡è¯„åˆ† {professional, timeliness, satisfaction, overall}ï¼ˆä»…æŸ¥çœ‹å…¨éƒ¨æƒé™ï¼‰ |
        | showRatings | Boolean | æ˜¯å¦æ˜¾ç¤ºè¯„åˆ†ï¼ˆåŸºäºæƒé™ï¼‰ |
        | permissionLevel | String | ç”¨æˆ·æƒé™çº§åˆ«(view/view_all) |
        | totalInquiries | Integer | æ€»å’¨è¯¢æ•° |
        | ratingDistribution | Object | è¯„åˆ†åˆ†å¸ƒï¼ˆä»…æŸ¥çœ‹å…¨éƒ¨æƒé™ï¼‰ |

- **InquiryService.php**
  - **æ–‡ä»¶è·¯å¾„**ï¼š`app/Services/ModChannelPlatform/InquiryService.php`
  - **æ–‡ä»¶çŠ¶æ€**ï¼šæ–°å¢
  - **æ–¹æ³•**:
    - **getInquiriesWithPermission($userId, $filters, $pagination)**
      - **åŠŸèƒ½æè¿°**ï¼šæ ¹æ®ç”¨æˆ·æƒé™è·å–å’¨è¯¢åˆ—è¡¨ã€‚æŸ¥è¯¢Viewç«¯inquiriesè¡¨è·å–Activeç”¨æˆ·å’¨è¯¢ï¼Œè°ƒç”¨Portal APIè·å–inactiveç”¨æˆ·å’¨è¯¢ï¼Œæœ€ååˆå¹¶è¿”å›ã€‚Salesåªèƒ½çœ‹è‡ªå·±çš„ï¼ŒSalesManagerèƒ½çœ‹æ‰€æœ‰ã€‚è§£æJSONå­—æ®µç”¨äºå±•ç¤ºã€‚
      - **æ–¹æ³•çŠ¶æ€**ï¼šæ–°å¢
      - **å¤„ç†æµç¨‹**ï¼š
          1. æ£€æŸ¥ç”¨æˆ·æƒé™ï¼ˆview/view_allï¼‰
          2. æŸ¥è¯¢inquiriesè¡¨ï¼Œè¿‡æ»¤æœ€è¿‘12ä¸ªæœˆæ•°æ®
          3. è§£æAssignedSales
          4. è°ƒç”¨Portal APIè·å–inactiveç”¨æˆ·æ•°æ®
          5. åˆå¹¶ä¸¤éƒ¨åˆ†æ•°æ®å¹¶åˆ†é¡µ
          6. è§£æRatingç”¨äºåˆ—è¡¨å±•ç¤º
      - **è¿”å›æ•°æ®**ï¼šæƒé™è¿‡æ»¤åçš„å’¨è¯¢åˆ—è¡¨ï¼ˆåˆå¹¶æ•°æ®ï¼‰

    - **getActiveUserInquiries($userId, $filters)**
      - **åŠŸèƒ½æè¿°**ï¼šä»Viewç«¯inquiriesè¡¨æŸ¥è¯¢Activeç”¨æˆ·çš„å’¨è¯¢æ•°æ®ï¼Œè§£æJSONå­—æ®µ
      - **æ–¹æ³•çŠ¶æ€**ï¼šæ–°å¢
      - **è¿”å›æ•°æ®**ï¼šActiveç”¨æˆ·å’¨è¯¢åˆ—è¡¨

    - **getInactiveUserInquiries($userId)**
      - **åŠŸèƒ½æè¿°**ï¼šè°ƒç”¨Portal APIè·å–inactiveç”¨æˆ·çš„å’¨è¯¢æ•°æ®
      - **æ–¹æ³•çŠ¶æ€**ï¼šæ–°å¢
      - **è¿”å›æ•°æ®**ï¼šInactiveç”¨æˆ·å’¨è¯¢åˆ—è¡¨

    - **replyToActiveInquiry($inquiryId, $userId, $replyContent)**
      - **åŠŸèƒ½æè¿°**ï¼šå›å¤Activeç”¨æˆ·å’¨è¯¢ï¼Œå­˜å‚¨å›å¤åˆ°Viewç«¯inquiriesè¡¨çš„SalesReplyå­—æ®µï¼Œå®ç°ç‹¬å æœºåˆ¶ï¼Œæ›´æ–°çŠ¶æ€ä¸ºRatingï¼Œè®¾ç½®RatingDeadlineä¸º30å¤©å
      - **æ–¹æ³•çŠ¶æ€**ï¼šæ–°å¢
      - **å¤„ç†æµç¨‹**ï¼š
          1. æ£€æŸ¥å’¨è¯¢æ˜¯å¦ä»ä¸ºOpençŠ¶æ€
          2. è®¾ç½®ç‹¬å é”ï¼Œæ›´æ–°RepliedByå’ŒRepliedNameå­—æ®µ
          3. æ›´æ–°SalesReplyå­—æ®µå­˜å‚¨å›å¤å†…å®¹
          4. æ›´æ–°Statusä¸º'rating'ï¼Œè®¾ç½®RatingDeadlineï¼ˆå½“å‰æ—¶é—´+30å¤©ï¼‰
          5. æ›´æ–°LastModifiedDate
          6. å¯¹å…¶ä»–é”€å”®éšè—è¯¥å’¨è¯¢
          7. è°ƒç”¨Portal APIé€šçŸ¥ç”¨æˆ·ï¼ˆå‘é€å¾®ä¿¡æ¶ˆæ¯ï¼‰
      - **è¿”å›æ•°æ®**ï¼šå›å¤ç»“æœå’ŒçŠ¶æ€

    - **replyToInactiveInquiry($userId, $replyContent)**
      - **åŠŸèƒ½æè¿°**ï¼šå›å¤Inactiveç”¨æˆ·å’¨è¯¢ï¼Œé€šè¿‡Portal APIæ“ä½œPortalç«¯æ•°æ®ï¼Œè®¾ç½®è¯„ä»·æˆªæ­¢æ—¶é—´
      - **æ–¹æ³•çŠ¶æ€**ï¼šæ–°å¢
      - **å¤„ç†æµç¨‹**ï¼š
          1. è°ƒç”¨Portal APIå‘é€å›å¤
          2. Portalç«¯æ›´æ–°çŠ¶æ€ä¸ºRating
          3. Portalç«¯è®¾ç½®30å¤©è¯„ä»·æœŸé™
          4. Portalç«¯è§¦å‘å¾®ä¿¡é€šçŸ¥
      - **è¿”å›æ•°æ®**ï¼šå›å¤ç»“æœ

    - **processAutoClose()**
      - **åŠŸèƒ½æè¿°**ï¼šå®šæ—¶ä»»åŠ¡å¤„ç†å’¨è¯¢è‡ªåŠ¨å…³é—­ï¼Œä»…å¤„ç†Viewç«¯inquiriesè¡¨ä¸­çš„æ•°æ®
      - **æ–¹æ³•çŠ¶æ€**ï¼šæ–°å¢
      - **å¤„ç†æµç¨‹**ï¼š
          1. æ‰«æç”¨æˆ·30å¤©æœªè¯„ä»·çš„RatingçŠ¶æ€å’¨è¯¢ï¼ˆRatingDeadline < NOW()ï¼‰
          2. æ‰¹é‡æ›´æ–°Statusä¸º'closed'ï¼Œè®¾ç½®AutoClosed=1
          3. è®¾ç½®ClosedDateä¸ºå½“å‰æ—¶é—´
          4. è®°å½•è‡ªåŠ¨å…³é—­æ—¥å¿—
      - **è¿”å›æ•°æ®**ï¼šå¤„ç†çš„å’¨è¯¢æ•°é‡ç»Ÿè®¡

    - **syncInquiriesFromPortal($userId, $portalData)**
      - **åŠŸèƒ½æè¿°**ï¼šç”¨æˆ·æ¿€æ´»æ—¶å°†Portalç«¯æ‰€æœ‰å’¨è¯¢æ•°æ®åŒæ­¥åˆ°Viewç«¯inquiriesè¡¨å­˜å‚¨ï¼Œå°†Portalç«¯çš„æ•°ç»„æ•°æ®è½¬æ¢ä¸ºJSONæ ¼å¼
      - **æ–¹æ³•çŠ¶æ€**ï¼šæ–°å¢
      - **å¤„ç†æµç¨‹**ï¼š
          1. éªŒè¯Portalå’¨è¯¢æ•°æ®å®Œæ•´æ€§
          2. è½¬æ¢AssignedSales é€—å·åˆ†å‰²
          3. å¤„ç†å¤±è´¥é¡¹è®°å½•é”™è¯¯æ—¥å¿—
      - **è¿”å›æ•°æ®**ï¼šåŒæ­¥ç»“æœç»Ÿè®¡

- **InquiryStatsService.php**
  - **æ–‡ä»¶è·¯å¾„**ï¼š`app/Services/ModChannelPlatform/InquiryStatsService.php`
  - **æ–‡ä»¶çŠ¶æ€**ï¼šæ–°å¢
  - **æ–¹æ³•**:
    - **getStatsWithPermission($userId, $statsType)**
      - **åŠŸèƒ½æè¿°**ï¼šæ ¹æ®æƒé™è·å–ç»Ÿè®¡æ•°æ®ï¼Œä»…ç»Ÿè®¡Viewç«¯inquiriesè¡¨ä¸­çš„æ•°æ®ã€‚"æŸ¥çœ‹"æƒé™ä¸æ˜¾ç¤ºæ˜Ÿçº§ï¼Œ"æŸ¥çœ‹å…¨éƒ¨"æƒé™æ˜¾ç¤ºå®Œæ•´ç»Ÿè®¡ã€‚ä»Ratingå­—æ®µè§£æè¯„åˆ†æ•°æ®ã€‚
      - **æ–¹æ³•çŠ¶æ€**ï¼šæ–°å¢
      - **å¤„ç†æµç¨‹**ï¼š
          1. æ£€æŸ¥ç”¨æˆ·æƒé™
          2. æŸ¥è¯¢inquiriesè¡¨ï¼Œç­›é€‰status='closed'ä¸”Ratingä¸ä¸ºNULLçš„è®°å½•
          3. è§£æRatingå­—æ®µæå–è¯„åˆ†æ•°æ®
          4. æ ¹æ®statsTypeåˆ†ç»„ç»Ÿè®¡ï¼ˆcountry/branch/salesï¼‰
          5. è®¡ç®—å¹³å‡åˆ†å’Œåˆ†å¸ƒ
          6. æ ¹æ®æƒé™è¿‡æ»¤è¿”å›æ•°æ®
      - **è¿”å›æ•°æ®**ï¼šæƒé™è¿‡æ»¤çš„ç»Ÿè®¡æ•°æ®

    - **calculateAverageRatings($statsType, $statsKey)**
      - **åŠŸèƒ½æè¿°**ï¼šè®¡ç®—æŒ‡å®šç»´åº¦çš„å¹³å‡è¯„åˆ†ï¼ˆå›½å®¶/åˆ†å…¬å¸/é”€å”®ï¼‰ï¼Œä»Ratingå­—æ®µæå–æ•°æ®è®¡ç®—
      - **æ–¹æ³•çŠ¶æ€**ï¼šæ–°å¢
      - **å¤„ç†æµç¨‹**ï¼š
          1. æ ¹æ®statsTypeå’ŒstatsKeyç­›é€‰æ•°æ®
          2. è§£ææ‰€æœ‰ç›¸å…³è®°å½•çš„Rating
          3. æå–professionalã€timelinessã€satisfactionè¯„åˆ†
          4. è®¡ç®—å„ç»´åº¦å¹³å‡åˆ†
          5. è®¡ç®—ç»¼åˆå¹³å‡åˆ†
      - **è¿”å›æ•°æ®**ï¼šå¹³å‡è¯„åˆ†æ•°æ® {professionalAvg, timelinessAvg, satisfactionAvg, overall_avg}

### 6.9 TKE Libraryæ¨¡å—

#### 6.9.1 ä¸šåŠ¡æµç¨‹

##### 6.9.1.1 ä¸šåŠ¡èƒŒæ™¯

- **èƒŒæ™¯**ï¼šTKE Libraryæ˜¯Viewç«¯æ–‡ä»¶ç®¡ç†æ¨¡å—ï¼ŒTKEç”¨æˆ·ç»´æŠ¤å‘Portalç«¯åˆä½œä¼™ä¼´å¼€æ”¾çš„æ–‡æ¡£èµ„æ–™ã€‚

- **è®¾è®¡å›¾**
  
  - **TKE Library**
    - TKEç”¨æˆ·åˆ›å»ºç›®å½•ç»“æ„ï¼Œä¸Šä¼ æ–‡ä»¶åˆ°ç›®å½•
    - æ–‡ä»¶å­˜å‚¨åˆ°NASæœåŠ¡å™¨ï¼Œå…ƒæ•°æ®è®°å½•åˆ°Libraryè¡¨
    - åªæœ‰å…·æœ‰æƒé™çš„äººå¯ä»¥ç»´æŠ¤æ–‡ä»¶å’Œç›®å½•
    - æ ¹æ®é…ç½®çš„ä¸åŒæ˜¾ç¤ºæ–‡ä»¶ ä¸åŒçŠ¶æ€çš„Userå¯ä»¥çœ‹åˆ°ä¸åŒçš„æ–‡ä»¶èµ„æ–™
    ![alt text](<023 - TKE Tour.png>)

**å¼‚å¸¸æµç¨‹**ï¼š

- æ–‡ä»¶ä¸Šä¼ å¤±è´¥ â†’ æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯ï¼Œå…è®¸é‡è¯•
- ç›®å½•åˆ›å»ºå¤±è´¥ â†’ æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯ï¼Œå…è®¸é‡è¯•

**æµç¨‹å›¾**ï¼š

```mermaid
flowchart TD
    START[TKEç”¨æˆ·è¿›å…¥TKE Library] --> CHECK_PERM{æ£€æŸ¥ç”¨æˆ·æƒé™}
    CHECK_PERM -->|æ— ä¸Šä¼ åˆ é™¤æƒé™| VIEW[ä»…æŸ¥çœ‹æ¨¡å¼]
    CHECK_PERM -->|æœ‰ä¸Šä¼ åˆ é™¤æƒé™| MANAGE[ç®¡ç†æ¨¡å¼]
    
    MANAGE --> CREATE_DIR[åˆ›å»ºç›®å½•]
    CREATE_DIR --> SET_DIR_LEVEL[è®¾ç½®ç›®å½•è®¿é—®çº§åˆ«<br/>Inactive/Active/AGR]
    SET_DIR_LEVEL --> SAVE_DIR[ä¿å­˜ç›®å½•åˆ°Libraryè¡¨]
    
    MANAGE --> UPLOAD[ä¸Šä¼ æ–‡ä»¶]
    UPLOAD --> SELECT_PARENT[é€‰æ‹©çˆ¶ç›®å½•]
    SELECT_PARENT --> SELECT_LEVEL[è®¾ç½®æ–‡ä»¶è®¿é—®çº§åˆ«<br/>Inactive/Active/AGR]
    SELECT_LEVEL --> STORE_NAS[å­˜å‚¨åˆ°NASæœåŠ¡å™¨]
    STORE_NAS --> SAVE_META[ä¿å­˜å…ƒæ•°æ®åˆ°Libraryè¡¨]
    
    MANAGE --> DELETE[åˆ é™¤æ–‡ä»¶/ç›®å½•]
    DELETE --> DELETE_NAS[åˆ é™¤NASæ–‡ä»¶]
    DELETE_NAS --> SOFT_DELETE[è½¯åˆ é™¤è¡¨è®°å½•IsDeleted=1]
    
    VIEW --> LIST[æŸ¥çœ‹æ–‡ä»¶æ ‘ç»“æ„]
    MANAGE --> LIST
```

#### 6.9.2 å½±å“çš„æ•°æ®è¡¨

- Viewç«¯
  - **[mod_channel_library](#table-mod_channel_library)** : Viewç«¯ æ–‡ä»¶èµ„æ–™åŸºç¡€è¡¨

- Portalç«¯
  - **[library](#table-library)** : Portalç«¯ æ–‡ä»¶èµ„æ–™è¡¨

#### 6.9.3 å‰ç«¯å®ç°

##### 6.9.3.1 è§†å›¾ç›®å½•ç»“æ„

```plaintext
/web/nimod/application/views/scripts/tke-library/
  index.phtml                  - TKE Libraryä¸»é¡µé¢
  upload.phtml                 - æ–‡ä»¶ä¸Šä¼ é¡µé¢
  create-directory.phtml       - åˆ›å»ºç›®å½•é¡µé¢
```

##### 6.9.3.2 å…³é”®ç»„ä»¶åŠŸèƒ½

- **æ ‘å½¢ç›®å½•å±•ç¤º** åŒ…å«ï¼š
  - ç›®å½•æ ‘ç»“æ„å±•ç¤ºï¼ˆæ”¯æŒå±•å¼€/æŠ˜å ï¼‰
  - ç›®å½•å’Œæ–‡ä»¶å›¾æ ‡åŒºåˆ†
  - è®¿é—®çº§åˆ«æ ‡ç­¾æ˜¾ç¤º

- **è®¿é—®çº§åˆ«æ ‡ç­¾é¡µ** åŒ…å«ï¼š
  - Inactiveã€Activeã€AGR ä¸‰ä¸ªæ ‡ç­¾åˆ‡æ¢
  - å„æ ‡ç­¾ä¸‹çš„æ–‡ä»¶æ ‘å±•ç¤º
  - æ–‡ä»¶å’Œç›®å½•æ•°é‡ç»Ÿè®¡

- **æ–‡ä»¶ç®¡ç†æ“ä½œ** åŒ…å«ï¼š
  - åˆ›å»ºç›®å½•æŒ‰é’®ï¼ˆæƒé™æ§åˆ¶æ˜¾ç¤ºï¼‰
  - æ–‡ä»¶ä¸Šä¼ æŒ‰é’®ï¼ˆæƒé™æ§åˆ¶æ˜¾ç¤ºï¼‰
  - æ–‡ä»¶/ç›®å½•åˆ é™¤æŒ‰é’®ï¼ˆæƒé™æ§åˆ¶æ˜¾ç¤ºï¼‰
  - æ–‡ä»¶ä¸‹è½½åŠŸèƒ½
  - è®¿é—®çº§åˆ«æ ‡ç­¾é€‰æ‹©
  - æ’åºè°ƒæ•´åŠŸèƒ½

- **æ–‡ä»¶åˆ—è¡¨å±•ç¤º** åŒ…å«ï¼š
  - æ–‡ä»¶åç§°æ˜¾ç¤º
  - æ–‡ä»¶å¤§å°å’Œä¸Šä¼ æ—¶é—´
  - ä¸Šä¼ äººä¿¡æ¯
  - ä¸‹è½½æ¬¡æ•°ç»Ÿè®¡
  - æ“ä½œæŒ‰é’®ç»„ï¼ˆä¸‹è½½ã€åˆ é™¤ï¼‰

##### 6.9.3.3 è·¯ç”±è®¾è®¡

| HTTP æ–¹æ³• | ç«¯ç‚¹ | æè¿° |
|----------|------|------|
| GET | `/tke-library` | TKE Libraryæ–‡ä»¶ç®¡ç†é¡µé¢ |
| GET | `/tke-library/nodes` | è·å–èŠ‚ç‚¹æ ‘ç»“æ„ |
| POST | `/tke-library/directory` | åˆ›å»ºç›®å½• |
| POST | `/tke-library/upload` | ä¸Šä¼ æ–‡ä»¶ |
| PUT | `/tke-library/nodes/{id}` | æ›´æ–°èŠ‚ç‚¹ä¿¡æ¯ |
| DELETE | `/tke-library/nodes/{id}` | åˆ é™¤èŠ‚ç‚¹ |
| GET | `/tke-library/files/{id}/download` | ä¸‹è½½æ–‡ä»¶ |

#### 6.9.4 é”™è¯¯å¤„ç†å’Œæ—¥å¿—è®°å½•

##### 6.9.4.1 æ—¥å¿—è®°å½•

ä½¿ç”¨DynamicLoggerFactoryè¿›è¡Œæ¨¡å—åŒ–æ—¥å¿—è®°å½•ï¼š

- **ç³»ç»Ÿé”™è¯¯æ—¥å¿—è®°å½•åœºæ™¯**ï¼š

  | æ“ä½œç±»å‹ | è®°å½•æ—¶æœº |
  |----------|----------|
  | upload_failed | æ–‡ä»¶ä¸Šä¼ å¤±è´¥ |
  | delete_failed | æ–‡ä»¶æˆ–ç›®å½•åˆ é™¤å¤±è´¥ |
  | create_directory_failed | ç›®å½•åˆ›å»ºå¤±è´¥ |
  | nas_connection_failed | NASè¿æ¥å¤±è´¥ |
  | permission_denied | æƒé™ä¸è¶³æ“ä½œ |

#### 6.9.5 åŠŸèƒ½å¼€å‘ä¸å®ç°

##### 6.9.5.1 ç±»å…³ç³»å›¾

```mermaid
classDiagram
    class TkeLibraryController {
        +index()
        +createDirectory()
        +upload()
        +updateNode()
        +delete()
        +download()
    }

    class TkeLibraryService {
        +getNodeTree(filters)
        +createDirectory(directoryData, userId)
        +uploadFile(fileData, parentId, userId)
        +updateNode(nodeId, updateData, userId)
        +deleteNode(nodeId, userId)
        +checkUserPermission(userId)
    }

    class DynamicLoggerFactory {
        +getLogger(system, module)
    }

    TkeLibraryController --> TkeLibraryService : æ–‡ä»¶ç®¡ç†
    TkeLibraryController --> DynamicLoggerFactory : æ—¥å¿—è®°å½•
    TkeLibraryService --> DynamicLoggerFactory : æ—¥å¿—è®°å½•
```

##### 6.9.5.2 ä»£ç å®ç°

- **TkeLibraryController.php**
  - **æ–‡ä»¶è·¯å¾„**ï¼š`app/Http/Controllers/ModChannelPlatform/TkeLibraryController.php`
  - **æ–‡ä»¶çŠ¶æ€**ï¼šæ–°å¢
  - **æ–¹æ³•**

    - **index()**
      - **åŠŸèƒ½æè¿°**ï¼šæ˜¾ç¤ºTKE Libraryæ–‡ä»¶ç®¡ç†é¡µé¢ï¼Œæ ¹æ®TKEç”¨æˆ·æƒé™æ˜¾ç¤ºæ“ä½œæŒ‰é’®
      - **æ–¹æ³•çŠ¶æ€**ï¼šæ–°å¢
      - **ä¾èµ–æœåŠ¡**ï¼šTkeLibraryService
      - **è¯·æ±‚å‚æ•°**ï¼š

        | å‚æ•°åç§° | æ•°æ®ç±»å‹ | æ˜¯å¦å¿…å¡« | æè¿° |
        |----------|----------|----------|------|
        | accessLevel | String | å¦ | è®¿é—®çº§åˆ«ç­›é€‰(inactive/active/agr) |
        | parentId | Integer | å¦ | çˆ¶èŠ‚ç‚¹IDç­›é€‰ |

      - **å“åº”æ•°æ®**ï¼š

        | å‚æ•°åç§° | æ•°æ®ç±»å‹ | æè¿° |
        |----------|----------|------|
        | hasUploadPermission | Boolean | æ˜¯å¦æœ‰ä¸Šä¼ æƒé™ |
        | nodeTree | Array | èŠ‚ç‚¹æ ‘ç»“æ„ |
        | stats | Object | æ–‡ä»¶ç»Ÿè®¡ä¿¡æ¯ |

    - **createDirectory()**
      - **åŠŸèƒ½æè¿°**ï¼šåˆ›å»ºç›®å½•èŠ‚ç‚¹ï¼Œè®°å½•åˆ°Libraryè¡¨
      - **æ–¹æ³•çŠ¶æ€**ï¼šæ–°å¢
      - **ä¾èµ–æœåŠ¡**ï¼šTkeLibraryService
      - **è¯·æ±‚å‚æ•°**ï¼š

        | å‚æ•°åç§° | æ•°æ®ç±»å‹ | æ˜¯å¦å¿…å¡« | æè¿° |
        |----------|----------|----------|------|
        | name | String | æ˜¯ | ç›®å½•åç§° |
        | parentId | Integer | å¦ | çˆ¶ç›®å½•ID(NULLè¡¨ç¤ºæ ¹ç›®å½•) |
        | accessLevel | String | æ˜¯ | è®¿é—®çº§åˆ«(inactive/active/agr) |
        | sortOrder | Integer | å¦ | æ’åºé¡ºåº |

      - **å“åº”æ•°æ®**ï¼š

        | å‚æ•°åç§° | æ•°æ®ç±»å‹ | æè¿° |
        |----------|----------|------|
        | success | Boolean | åˆ›å»ºæ˜¯å¦æˆåŠŸ |
        | nodeId | Integer | ç›®å½•èŠ‚ç‚¹ID |
        | message | String | å¤„ç†ç»“æœä¿¡æ¯ |

    - **upload()**
      - **åŠŸèƒ½æè¿°**ï¼šä¸Šä¼ æ–‡ä»¶åˆ°NASï¼Œé€‰æ‹©è®¿é—®çº§åˆ«æ ‡ç­¾ï¼Œè®°å½•å…ƒæ•°æ®åˆ°Libraryè¡¨
      - **æ–¹æ³•çŠ¶æ€**ï¼šæ–°å¢
      - **ä¾èµ–æœåŠ¡**ï¼šTkeLibraryService
      - **è¯·æ±‚å‚æ•°**ï¼š

        | å‚æ•°åç§° | æ•°æ®ç±»å‹ | æ˜¯å¦å¿…å¡« | æè¿° |
        |----------|----------|----------|------|
        | file | File | æ˜¯ | ä¸Šä¼ çš„æ–‡ä»¶ |
        | parentId | Integer | å¦ | çˆ¶ç›®å½•ID(NULLè¡¨ç¤ºæ ¹ç›®å½•) |
        | accessLevel | String | æ˜¯ | è®¿é—®çº§åˆ«(inactive/active/agr) |
        | sortOrder | Integer | å¦ | æ’åºé¡ºåº |

      - **å“åº”æ•°æ®**ï¼š

        | å‚æ•°åç§° | æ•°æ®ç±»å‹ | æè¿° |
        |----------|----------|------|
        | success | Boolean | ä¸Šä¼ æ˜¯å¦æˆåŠŸ |
        | nodeId | Integer | æ–‡ä»¶èŠ‚ç‚¹ID |
        | message | String | å¤„ç†ç»“æœä¿¡æ¯ |

    - **updateNode()**
      - **åŠŸèƒ½æè¿°**ï¼šæ›´æ–°èŠ‚ç‚¹ä¿¡æ¯ï¼ˆåç§°ã€è®¿é—®çº§åˆ«ã€æ’åºç­‰ï¼‰
      - **æ–¹æ³•çŠ¶æ€**ï¼šæ–°å¢
      - **ä¾èµ–æœåŠ¡**ï¼šTkeLibraryService
      - **è¯·æ±‚å‚æ•°**ï¼š

        | å‚æ•°åç§° | æ•°æ®ç±»å‹ | æ˜¯å¦å¿…å¡« | æè¿° |
        |----------|----------|----------|------|
        | nodeId | Integer | æ˜¯ | èŠ‚ç‚¹ID |
        | name | String | å¦ | èŠ‚ç‚¹åç§° |
        | accessLevel | String | å¦ | è®¿é—®çº§åˆ«(inactive/active/agr) |
        | sortOrder | Integer | å¦ | æ’åºé¡ºåº |

      - **å“åº”æ•°æ®**ï¼š

        | å‚æ•°åç§° | æ•°æ®ç±»å‹ | æè¿° |
        |----------|----------|------|
        | success | Boolean | æ›´æ–°æ˜¯å¦æˆåŠŸ |
        | message | String | å¤„ç†ç»“æœä¿¡æ¯ |

    - **delete()**
      - **åŠŸèƒ½æè¿°**ï¼šåˆ é™¤NASæ–‡ä»¶ï¼Œè½¯åˆ é™¤Libraryè¡¨è®°å½•(IsDeleted=1)ï¼Œçº§è”åˆ é™¤å­èŠ‚ç‚¹
      - **æ–¹æ³•çŠ¶æ€**ï¼šæ–°å¢
      - **ä¾èµ–æœåŠ¡**ï¼šTkeLibraryService
      - **è¯·æ±‚å‚æ•°**ï¼š

        | å‚æ•°åç§° | æ•°æ®ç±»å‹ | æ˜¯å¦å¿…å¡« | æè¿° |
        |----------|----------|----------|------|
        | nodeId | Integer | æ˜¯ | èŠ‚ç‚¹ID |

      - **å“åº”æ•°æ®**ï¼š

        | å‚æ•°åç§° | æ•°æ®ç±»å‹ | æè¿° |
        |----------|----------|------|
        | success | Boolean | åˆ é™¤æ˜¯å¦æˆåŠŸ |
        | message | String | å¤„ç†ç»“æœä¿¡æ¯ |

    - **download()**
      - **åŠŸèƒ½æè¿°**ï¼šç”ŸæˆNASä¸‹è½½URLï¼Œæ›´æ–°ä¸‹è½½ç»Ÿè®¡
      - **æ–¹æ³•çŠ¶æ€**ï¼šæ–°å¢
      - **ä¾èµ–æœåŠ¡**ï¼šTkeLibraryService
      - **è¯·æ±‚å‚æ•°**ï¼š

        | å‚æ•°åç§° | æ•°æ®ç±»å‹ | æ˜¯å¦å¿…å¡« | æè¿° |
        |----------|----------|----------|------|
        | nodeId | Integer | æ˜¯ | æ–‡ä»¶èŠ‚ç‚¹ID |

      - **å“åº”æ•°æ®**ï¼š

        | å‚æ•°åç§° | æ•°æ®ç±»å‹ | æè¿° |
        |----------|----------|------|
        | success | Boolean | ä¸‹è½½æ˜¯å¦æˆåŠŸ |
        | downloadUrl | String | NASä¸‹è½½URL |
        | fileName | String | æ–‡ä»¶å |

- **TkeLibraryService.php**
  - **æ–‡ä»¶è·¯å¾„**ï¼š`app/Services/ModChannelPlatform/TkeLibraryService.php`
  - **æ–‡ä»¶çŠ¶æ€**ï¼šæ–°å¢
  - **æ–¹æ³•**

    - **getNodeTree($filters)**
      - **åŠŸèƒ½æè¿°**ï¼šè·å–èŠ‚ç‚¹æ ‘ç»“æ„ï¼Œæ”¯æŒæŒ‰è®¿é—®çº§åˆ«æ ‡ç­¾ç­›é€‰
      - **æ–¹æ³•çŠ¶æ€**ï¼šæ–°å¢
      - **è¿”å›æ•°æ®**ï¼šèŠ‚ç‚¹æ ‘ç»“æ„æ•°æ®

    - **createDirectory($directoryData, $userId)**
      - **åŠŸèƒ½æè¿°**ï¼šåˆ›å»ºç›®å½•èŠ‚ç‚¹å¹¶è®°å½•åˆ°Libraryè¡¨
      - **æ–¹æ³•çŠ¶æ€**ï¼šæ–°å¢
      - **å¤„ç†æµç¨‹**ï¼š
          1. éªŒè¯ç›®å½•åç§°æ ¼å¼
          2. éªŒè¯çˆ¶èŠ‚ç‚¹å­˜åœ¨æ€§ï¼ˆå¦‚æœæŒ‡å®šï¼‰
          3. æ’å…¥Libraryè¡¨ï¼ŒNodeType='directory'
          4. è¿”å›ç›®å½•èŠ‚ç‚¹ID
      - **è¿”å›æ•°æ®**ï¼šåˆ›å»ºç»“æœ

    - **uploadFile($fileData, $parentId, $userId)**
      - **åŠŸèƒ½æè¿°**ï¼šä¸Šä¼ æ–‡ä»¶åˆ°NASå¹¶è®°å½•å…ƒæ•°æ®åˆ°Libraryè¡¨
      - **æ–¹æ³•çŠ¶æ€**ï¼šæ–°å¢
      - **å¤„ç†æµç¨‹**ï¼š
          1. éªŒè¯æ–‡ä»¶æ ¼å¼å’Œå¤§å°
          2. éªŒè¯çˆ¶ç›®å½•å­˜åœ¨æ€§ï¼ˆå¦‚æœæŒ‡å®šï¼‰
          3. ä¸Šä¼ æ–‡ä»¶åˆ°NASæœåŠ¡å™¨
          4. æ’å…¥Libraryè¡¨ï¼ŒNodeType='file'ï¼Œè®°å½•NasFilePathã€FileSizeç­‰å…ƒæ•°æ®
          5. è¿”å›æ–‡ä»¶èŠ‚ç‚¹ID
      - **è¿”å›æ•°æ®**ï¼šä¸Šä¼ ç»“æœ

    - **updateNode($nodeId, $updateData, $userId)**
      - **åŠŸèƒ½æè¿°**ï¼šæ›´æ–°èŠ‚ç‚¹ä¿¡æ¯ï¼ˆåç§°ã€è®¿é—®çº§åˆ«ã€æ’åºç­‰ï¼‰
      - **æ–¹æ³•çŠ¶æ€**ï¼šæ–°å¢
      - **å¤„ç†æµç¨‹**ï¼š
          1. éªŒè¯èŠ‚ç‚¹å­˜åœ¨
          2. æ›´æ–°Libraryè¡¨æŒ‡å®šå­—æ®µ
          3. æ›´æ–°LastModifiedDateå’ŒLastModifiedBy
      - **è¿”å›æ•°æ®**ï¼šæ›´æ–°ç»“æœ

    - **deleteNode($nodeId, $userId)**
      - **åŠŸèƒ½æè¿°**ï¼šåˆ é™¤NASæ–‡ä»¶å¹¶è½¯åˆ é™¤Libraryè¡¨è®°å½•(IsDeleted=1)ï¼Œçº§è”å¤„ç†å­èŠ‚ç‚¹
      - **æ–¹æ³•çŠ¶æ€**ï¼šæ–°å¢
      - **å¤„ç†æµç¨‹**ï¼š
          1. æ£€æŸ¥ç”¨æˆ·åˆ é™¤æƒé™
          2. å¦‚æœæ˜¯ç›®å½•ï¼Œé€’å½’æŸ¥æ‰¾æ‰€æœ‰å­èŠ‚ç‚¹
          3. åˆ é™¤æ–‡ä»¶èŠ‚ç‚¹å¯¹åº”çš„NASæ–‡ä»¶
          4. è½¯åˆ é™¤æ‰€æœ‰ç›¸å…³èŠ‚ç‚¹ï¼ˆè®¾ç½®IsDeleted=1ï¼‰
      - **è¿”å›æ•°æ®**ï¼šåˆ é™¤ç»“æœ

## ç¬¬7ç« ï¼šViewç«¯ Testing Strategy

### 7.1 å•å…ƒæµ‹è¯•ï¼ˆPHPUnitï¼‰

#### 7.1.1 æœåŠ¡å±‚æµ‹è¯•è®¾è®¡

##### 7.1.1.1 Channel Partner Upload æ¨¡å—æœåŠ¡æµ‹è¯•

**PartnerUploadServiceTest.php**

```php
class PartnerUploadServiceTest extends TestCase
{
    // å¯¹åº” 6.1.5.2 PartnerUploadService::processUploadFile
    public function testProcessUploadFileParsesExcelAndValidatesData() { /* éªŒè¯20å­—æ®µè§£æä¸æ ¼å¼æ ¡éªŒ */ }
    public function testCheckDuplicatesHandlesActiveRecordsAsAutoSkipped() { /* Activeé‡å¤è®°å½•è‡ªåŠ¨è·³è¿‡ */ }
    public function testCheckDuplicatesReturnsInactiveRecordsForConfirmation() { /* Inactive/Declinedéœ€ç¡®è®¤ */ }
    public function testImportPartnersCreatesInactiveRecordsInModChannelTables() { /* æˆåŠŸè®°å½•çŠ¶æ€ä¸ºinactive */ }
    public function testGenerateResultFileCreatesErrorExcelWithFailedRecords() { /* ç”Ÿæˆå«é”™è¯¯çš„Excelç»“æœæ–‡ä»¶ */ }
}
```

##### 7.1.1.2 Channel Partner Dashboard æ¨¡å—æœåŠ¡æµ‹è¯•

**PartnerDashboardServiceTest.php**

```php
class PartnerDashboardServiceTest extends TestCase
{
    // å¯¹åº” 6.2.6.2 PartnerDashboardService::batchAssign
    public function testBatchAssignUpdatesPartnerOwnerAndRecordsHistory() { /* æ‰¹é‡åˆ†é…é”€å”®å¹¶è®°å½•å†å² */ }
    public function testGetPartnerListMergesPortalAndViewDataByTaxCode() { /* æŒ‰TaxCodeåˆå¹¶Portalä¸Viewæ•°æ® */ }
    public function testValidateAssignmentSkipsAlreadyAssignedPartners() { /* è·³è¿‡å·²åˆ†é…è®°å½• */ }
}
```

##### 7.1.1.3 Channel Partner Approval æ¨¡å—æœåŠ¡æµ‹è¯•

**ModChannelPartnerApprovalServiceTest.php**

```php
class ModChannelPartnerApprovalServiceTest extends TestCase
{
    // å¯¹åº” 6.3.6.2 ModChannelPartnerApprovalService::getPortalUserAndCompanyData
    public function testGetPortalUserAndCompanyDataFetchesFromPortalApi() { /* è°ƒç”¨Portal APIè·å–ç”¨æˆ·/å…¬å¸/é¡¹ç›®/é—®è¯¢ */ }
    public function testSaveApprovalDraftMarksDeletedContactsAsDeclined() { /* ä¿å­˜è‰ç¨¿æ—¶åˆ é™¤çš„è”ç³»äººé»˜è®¤æ‹’ç» */ }
    public function testProcessPortalPartnerApprovalCreatesCustomerAndContact() { /* å®¡æ‰¹é€šè¿‡åˆ›å»ºViewç«¯Customer/Contact */ }
    public function testProcessPortalPartnerApprovalSendsWechatPushOnApprove() { /* Portalå®¡æ‰¹é€šè¿‡å‘é€å¾®ä¿¡é€šçŸ¥ */ }
    public function testProcessPortalPartnerApprovalCallsUnbindApiOnReject() { /* æ‹’ç»æ—¶è°ƒç”¨Portalè§£ç»‘API */ }
    public function testReactivateDeclinedPartnerCreatesNewContactIfExists() { /* é‡æ–°æ¿€æ´»æ—¶è‹¥Partnerå­˜åœ¨ä»…å»ºContact */ }
}
```

**ModChannelDataSyncServiceTest.php**

```php
class ModChannelDataSyncServiceTest extends TestCase
{
    // å¯¹åº” 6.3.6.2 ModChannelDataSyncService::syncToLegacySystem
    public function testSyncToLegacySystemCreatesCustomerWithPortalCompanyId() { /* åŒæ­¥æ—¶å†™å…¥PortalCompanyId */ }
    public function testCallPortalApprovalApiPushesCustomerIdAndContractId() { /* æ¨é€å®¡æ‰¹ç»“æœå«Viewç«¯ID */ }
    public function testCallPortalUserUnbindApiUnbindsUserCompanyRelation() { /* è§£ç»‘Portalç«¯user_companyå…³è” */ }
}
```

##### 7.1.1.4 Channel Partner Status Summary æ¨¡å—æœåŠ¡æµ‹è¯•

**PartnerStatusSummaryServiceTest.php**

```php
class PartnerStatusSummaryServiceTest extends TestCase
{
    // å¯¹åº” 6.4.5.2 PartnerStatusSummaryService::getStatusSummary
    public function testGetStatusSummaryMergesViewAndPortalInactiveData() { /* åˆå¹¶Viewæœ¬åœ°ä¸Portal APIæ•°æ® */ }
    public function testCalculateHierarchyStatsGroupsByCountryRegionBranchOwner() { /* æŒ‰4çº§ç»“æ„ç»Ÿè®¡å„çŠ¶æ€æ•°é‡ */ }
    public function testGetStatsHandlesPortalApiFailureGracefully() { /* Portal APIå¤±è´¥æ—¶ä»…æ˜¾ç¤ºViewæ•°æ® */ }
}
```

##### 7.1.1.5 Pre-Lead Project Upload/Creation æ¨¡å—æœåŠ¡æµ‹è¯•

**ProjectinfoLiteServiceTest.php**

```php
class ProjectinfoLiteServiceTest extends TestCase
{
    // å¯¹åº” 6.5.5.2 ProjectinfoLiteService::validatePreLeadForm
    public function testValidatePreLeadFormRequiresAssignmentReasonWhenTaxcodeFilled() { /* Taxcodeå¡«å†™æ—¶åˆ†é…åŸå› å¿…å¡« */ }
    public function testCreatePreLeadProjectSetsIsPreLeadAndLeadSourceModLead() { /* åˆ›å»ºæ—¶æ ‡è®°Pre-Leadå’ŒMOD Leadæ¥æº */ }
}
```

**ProjectServiceTest.php**

```php
class ProjectServiceTest extends TestCase
{
    // å¯¹åº” 6.5.5.2 ProjectService::storePortalProject
    public function testStorePortalProjectSetsDataSourceToPortal() { /* å­˜å‚¨Portalé¡¹ç›®æ ‡è®°DataSource=portal */ }
    public function testUpdateAgentStatusSendsEmailOnRejectOrCancel() { /* æ‹’ç»/å–æ¶ˆæ—¶å‘é‚®ä»¶ç»™TKEé”€å”® */ }
    public function testProcessTimeoutCancellationMarksAsCancelledAfter24Hours() { /* 24å°æ—¶æœªå¤„ç†è‡ªåŠ¨æ ‡è®°å–æ¶ˆ */ }
}
```

##### 7.1.1.6 Channel Partner Project Summary/Report æ¨¡å—æœåŠ¡æµ‹è¯•

**ChannelSummaryServiceTest.php**

```php
class ChannelSummaryServiceTest extends TestCase
{
    // å¯¹åº” 6.6.5.2 ChannelSummaryService::queryPreLeadProjects
    public function testQueryPreLeadProjectsOnlyQueriesViewProjectTable() { /* ä»…æŸ¥Viewç«¯projectè¡¨ï¼Œä¸è°ƒPortal API */ }
    public function testCalculateStatsByDimensionClassifiesByDataSourceAndStatus() { /* æŒ‰DataSourceå’ŒAcceptanceStatusåˆ†ç±»ç»Ÿè®¡ */ }
}
```

**ProjectListServiceTest.php**

```php
class ProjectListServiceTest extends TestCase
{
    // å¯¹åº” 6.7.5.2 ProjectListService::getProjectsWithPermission
    public function testGetProjectsWithPermissionFiltersByUserPermission() { /* â€œæŸ¥çœ‹â€æƒé™ä»…çœ‹è‡ªå·±ï¼Œâ€œæŸ¥çœ‹å…¨éƒ¨â€çœ‹æ‰€æœ‰ */ }
    public function testFormatReportDataIncludesPartnerNameLinkAndDataSourceTag() { /* æŠ¥å‘Šå«Partnerè·³è½¬é“¾æ¥å’Œæ•°æ®æ¥æºæ ‡è¯† */ }
}
```

##### 7.1.1.7 Inquiry æ¨¡å—æœåŠ¡æµ‹è¯•

**InquiryServiceTest.php**

```php
class InquiryServiceTest extends TestCase
{
    // å¯¹åº” 6.8.5.2 InquiryService::getInquiriesWithPermission
    public function testGetInquiriesWithPermissionMergesActiveAndViewData() { /* ActiveæŸ¥Viewè¡¨ï¼ŒInactiveè°ƒPortal API */ }
    public function testReplyToActiveInquirySetsRatingDeadlineAndExclusiveLock() { /* Activeå›å¤è®¾30å¤©æœŸé™å¹¶ç‹¬å é” */ }
    public function testReplyToInactiveInquiryCallsPortalApiForReply() { /* Inactiveå›å¤é€šè¿‡Portal APIæ“ä½œ */ }
    public function testProcessAutoCloseMarksExpiredInquiriesAsClosed() { /* 30å¤©æœªè¯„ä»·è‡ªåŠ¨å…³é—­ */ }
    public function testSyncInquiriesFromPortalConvertsArrayToViewJson() { /* æ¿€æ´»æ—¶åŒæ­¥å°†Portalæ•°ç»„è½¬JSONå­˜View */ }
}
```

**InquiryStatsServiceTest.php**

```php
class InquiryStatsServiceTest extends TestCase
{
    // å¯¹åº” 6.8.5.2 InquiryStatsService::getStatsWithPermission
    public function testGetStatsWithPermissionShowsRatingsOnlyForViewAllPermission() { /* ä»…â€œæŸ¥çœ‹å…¨éƒ¨â€æ˜¾ç¤ºæ˜Ÿçº§ */ }
    public function testCalculateAverageRatingsParsesJsonFromRatingField() { /* ä»Ratingå­—æ®µJSONè§£æè¯„åˆ†è®¡ç®—å¹³å‡åˆ† */ }
}
```

##### 7.1.1.8 TKE Library æ¨¡å—æœåŠ¡æµ‹è¯•

**TkeLibraryServiceTest.php**

```php
class TkeLibraryServiceTest extends TestCase
{
    // å¯¹åº” 6.9.5.2 TkeLibraryService::uploadFile
    public function testUploadFileStoresToNasAndRecordsMetadataInLibraryTable() { /* ä¸Šä¼ æ–‡ä»¶åˆ°NASï¼Œå…ƒæ•°æ®å­˜Libraryè¡¨ */ }
    public function testCreateDirectorySetsAccessLevelAndParentId() { /* åˆ›å»ºç›®å½•è®°å½•è®¿é—®çº§åˆ«å’Œçˆ¶ID */ }
    public function testDeleteNodeSoftDeletesAndCascadesToChildren() { /* åˆ é™¤èŠ‚ç‚¹è½¯åˆ å¹¶çº§è”å­èŠ‚ç‚¹ */ }
    public function testCheckUserPermissionControlsUploadDeleteAccess() { /* æƒé™æ§åˆ¶ä¸Šä¼ /åˆ é™¤æŒ‰é’®æ˜¾ç¤º */ }
}
```

### 7.2 BDDæµ‹è¯•æ¡†æ¶ï¼ˆCucumberï¼‰

#### 7.2.1 åŠŸèƒ½æ–‡ä»¶è®¾è®¡

##### 7.2.1.1 Channel Partner Upload åŠŸèƒ½æ–‡ä»¶

**features/partner_upload.feature**

```gherkin
Feature: æ‰¹é‡ä¸Šä¼ æ¸ é“å•†æ•°æ®
  ä½œä¸ºTKEé”€å”®ç»ç†ï¼Œæˆ‘å¸Œæœ›é€šè¿‡Excelæ‰¹é‡å¯¼å…¥æ½œåœ¨æ¸ é“å•†

  Scenario: ä¸Šä¼ å«Activeé‡å¤ç¨å·çš„æ–‡ä»¶
    Given æˆ‘ä¸Šä¼ ä¸€ä¸ªExcelæ–‡ä»¶ï¼Œå…¶ä¸­ä¸€æ¡è®°å½•ç¨å·ä¸ç°æœ‰Activeå…¬å¸é‡å¤
    When ç³»ç»Ÿæ ¡éªŒæ•°æ®
    Then è¯¥é‡å¤è®°å½•è‡ªåŠ¨è·³è¿‡å¹¶æ ‡è®°å¤±è´¥
    And å…¶ä»–è®°å½•æ­£å¸¸å¤„ç†

  Scenario: ä¸Šä¼ å«Inactiveé‡å¤ç¨å·çš„æ–‡ä»¶
    Given æˆ‘ä¸Šä¼ ä¸€ä¸ªExcelæ–‡ä»¶ï¼Œå…¶ä¸­ä¸€æ¡è®°å½•ç¨å·ä¸Inactiveå…¬å¸é‡å¤
    When ç³»ç»Ÿæ ¡éªŒæ•°æ®
    Then å¼¹çª—æç¤ºæˆ‘ç¡®è®¤æ˜¯å¦æ›¿æ¢
    When æˆ‘é€‰æ‹©â€œæ›¿æ¢â€
    Then è¯¥è®°å½•è¢«æ›´æ–°ï¼ŒçŠ¶æ€ä»ä¸ºinactive
```

##### 7.2.1.2 Channel Partner Approval åŠŸèƒ½æ–‡ä»¶

**features/partner_approval.feature**

```gherkin
Feature: å®¡æ‰¹Portalç«¯æ³¨å†Œç”³è¯·
  ä½œä¸ºTKEé”€å”®ï¼Œæˆ‘éœ€è¦å®¡æ‰¹æ¥è‡ªPortalçš„æ³¨å†Œç”³è¯·

  Scenario: å®¡æ‰¹é€šè¿‡Portalæ–°å…¬å¸ç”³è¯·
    Given æˆ‘æ‰“å¼€ä¸€ä¸ªPortalæ–°å…¬å¸ç”³è¯·
    And è¯¥å…¬å¸æœªå¡«å†™ç¨å·
    When æˆ‘å¡«å†™ç¨å·å¹¶ç‚¹å‡»â€œé€šè¿‡â€
    Then Viewç³»ç»Ÿåˆ›å»ºCustomerå’ŒContactè®°å½•
    And Portalç«¯æ”¶åˆ°å®¡æ‰¹é€šè¿‡é€šçŸ¥
    And ç”¨æˆ·æ”¶åˆ°å¾®ä¿¡æ¿€æ´»é€šçŸ¥

  Scenario: æ‹’ç»Portalæ–°å…¬å¸ç”³è¯·
    Given æˆ‘æ‰“å¼€ä¸€ä¸ªPortalæ–°å…¬å¸ç”³è¯·
    When æˆ‘é€‰æ‹©æ‹’ç»åŸå› å¹¶ç‚¹å‡»â€œæ‹’ç»â€
    Then Portalç«¯user_companyå…³è”è¢«è§£ç»‘
    And ç”¨æˆ·çŠ¶æ€å˜ä¸ºdecline
    And ä¸å‘é€å¾®ä¿¡é€šçŸ¥
```

##### 7.2.1.3 Pre-Lead Project åŠŸèƒ½æ–‡ä»¶

**features/prelead_project.feature**

```gherkin
Feature: Pre-Leadé¡¹ç›®ç®¡ç†
  ä½œä¸ºTKEé”€å”®ï¼Œæˆ‘éœ€è¦ç®¡ç†Pre-Leadé¡¹ç›®

  Scenario: åˆ›å»ºPre-Leadé¡¹ç›®
    Given æˆ‘è¿›å…¥æ–°å»ºé¡¹ç›®é¡µé¢
    When æˆ‘å‹¾é€‰â€œPre-Lead projectâ€
    And æˆ‘é€‰æ‹©ä»£ç†å•†å’Œåˆ†é…åŸå› 
    And æˆ‘æäº¤é¡¹ç›®
    Then é¡¹ç›®çŠ¶æ€ä¸ºPre-Leadï¼ŒLead Sourceä¸ºâ€œMOD Leadâ€

  Scenario: Partner 24å°æ—¶æœªå¤„ç†é¡¹ç›®
    Given æˆ‘åˆ†é…äº†ä¸€ä¸ªPre-Leadé¡¹ç›®ç»™Partner
    When 24å°æ—¶å†…Partneræœªæ“ä½œ
    Then é¡¹ç›®çŠ¶æ€è‡ªåŠ¨å˜ä¸ºâ€œCancelledâ€
    And æˆ‘æ”¶åˆ°å–æ¶ˆé€šçŸ¥é‚®ä»¶
```

##### 7.2.1.4 Inquiry ç®¡ç†åŠŸèƒ½æ–‡ä»¶

**features/inquiry_management.feature**

```gherkin
Feature: å’¨è¯¢å›å¤ä¸è¯„ä»·ç®¡ç†
  ä½œä¸ºTKEé”€å”®ï¼Œæˆ‘éœ€è¦å›å¤Partnerçš„å’¨è¯¢

  Scenario: å›å¤Activeç”¨æˆ·å’¨è¯¢
    Given æˆ‘æœ‰ä¸€æ¡OpençŠ¶æ€çš„Activeç”¨æˆ·å’¨è¯¢
    When æˆ‘è¾“å…¥å›å¤å†…å®¹å¹¶æäº¤
    Then å’¨è¯¢çŠ¶æ€å˜ä¸ºRating
    And è®¾ç½®30å¤©è¯„ä»·æœŸé™
    And å…¶ä»–é”€å”®æ— æ³•å†çœ‹åˆ°è¯¥å’¨è¯¢

  Scenario: å›å¤Inactiveç”¨æˆ·å’¨è¯¢
    Given æˆ‘æœ‰ä¸€æ¡OpençŠ¶æ€çš„Inactiveç”¨æˆ·å’¨è¯¢
    When æˆ‘å›å¤è¯¥å’¨è¯¢
    Then Portalç«¯çŠ¶æ€å˜ä¸ºRating
    And ç”¨æˆ·æ”¶åˆ°å¾®ä¿¡é€šçŸ¥
```

##### 7.2.1.5 TKE Library æ–‡ä»¶ç®¡ç†åŠŸèƒ½æ–‡ä»¶

**features/tke_Library_management.feature**

```gherkin
Feature: TKE Libraryæ–‡ä»¶ç»´æŠ¤
  ä½œä¸ºTKEç®¡ç†å‘˜ï¼Œæˆ‘éœ€è¦ç»´æŠ¤å‘Partnerå¼€æ”¾çš„æ–‡æ¡£

  Scenario: ä¸Šä¼ æ–‡ä»¶å¹¶è®¾ç½®è®¿é—®çº§åˆ«
    Given æˆ‘æœ‰TKE Libraryç®¡ç†æƒé™
    When æˆ‘ä¸Šä¼ ä¸€ä¸ªPDFæ–‡ä»¶
    And æˆ‘è®¾ç½®è®¿é—®çº§åˆ«ä¸ºâ€œactive_partnerâ€
    Then æ–‡ä»¶å­˜å‚¨åˆ°NAS
    And å…ƒæ•°æ®è®°å½•åˆ°Libraryè¡¨
    And ActiveçŠ¶æ€Partnerå¯çœ‹åˆ°è¯¥æ–‡ä»¶

  Scenario: åˆ é™¤ç›®å½•
    Given æˆ‘æœ‰ä¸€ä¸ªåŒ…å«å­æ–‡ä»¶çš„ç›®å½•
    When æˆ‘åˆ é™¤è¯¥ç›®å½•
    Then NASä¸­æ‰€æœ‰å­æ–‡ä»¶è¢«åˆ é™¤
    And Libraryè¡¨ä¸­æ‰€æœ‰èŠ‚ç‚¹æ ‡è®°ä¸ºIsDeleted=1
```

##### 7.2.1.6 Portalæ•°æ®åŒæ­¥åŠŸèƒ½æ–‡ä»¶

**features/portal_data_sync.feature**

```gherkin
Feature: Portalæ•°æ®åŒæ­¥åˆ°View
  ä½œä¸ºç³»ç»Ÿï¼Œæˆ‘éœ€è¦åœ¨å®¡æ‰¹é€šè¿‡æ—¶åŒæ­¥Portalæ•°æ®

  Scenario: ç”¨æˆ·æ¿€æ´»æ—¶åŒæ­¥å†å²é—®è¯¢
    Given ä¸€ä¸ªPendingç”¨æˆ·åœ¨Portalç«¯åˆ›å»ºäº†3æ¡é—®è¯¢
    When é”€å”®åœ¨Viewç«¯å®¡æ‰¹é€šè¿‡è¯¥ç”¨æˆ·
    Then Portalç«¯æ¨é€æ‰€æœ‰é—®è¯¢æ•°æ®åˆ°View
    And Viewç«¯inquiriesè¡¨å­˜å‚¨è¿™äº›è®°å½•ï¼ŒçŠ¶æ€ä¸ºclosed/open
    And Ratingå­—æ®µä»¥JSONæ ¼å¼å­˜å‚¨

  Scenario: Activeç”¨æˆ·åˆ›å»ºé¡¹ç›®åŒæ­¥åˆ°View
    Given ä¸€ä¸ªActiveç”¨æˆ·åœ¨Portalç«¯åˆ›å»ºæ–°é¡¹ç›®
    When ç”¨æˆ·æäº¤é¡¹ç›®
    Then Portalç«¯æ¨é€é¡¹ç›®æ•°æ®åˆ°View
    And Viewç«¯projectè¡¨åˆ›å»ºPre-Leadé¡¹ç›®ï¼ŒDataSource=portal
```

## 8. é™„å½•

### 8.1 æ•°æ®åº“è¡¨è®¾è®¡

#### 8.1.1 Portalç«¯

<a id="table-users"></a>

- **users**
  - **ç”¨é€”**:å­˜å‚¨ç”¨æˆ·åŸºæœ¬ä¿¡æ¯ã€å¾®ä¿¡ç»‘å®šå’Œé”€å”®æ¥æºè¿½è¸ªã€‚

| å­—æ®µå         | ç±»å‹        | çº¦æŸ | æè¿°          |
|----------------|-------------|------|---------------|
| Id             | INT         | PK, AI | ç”¨æˆ·ID      |
| BusinessUserID |   VARCHAR(32) |   UNIQUE, NOT NULL  |  ç”¨æˆ·ç¼–ç  |
| FirstName      | VARCHAR(50) | NOT NULL | å§“æ°       |
| LastName       | VARCHAR(50) | NOT NULL | åå­—       |
| Role           | INT | NOT NULL | èŒåŠ¡       |
| Mobile          | VARCHAR(20) | UNIQUE   | æ‰‹æœºå·     |
| Email          | VARCHAR(100)|          | é‚®ç®±       |
| OpenId         | VARCHAR(64) | UNIQUE   | å¾®ä¿¡ openid |
| Status | ENUM('active','deleted') | DEFAULT 'active' | è´¦å·çŠ¶æ€ï¼ˆactive=ä½¿ç”¨ä¸­ï¼Œdeleted=å·²æ³¨é”€ï¼‰ |
| LastLoginTime  | DATETIME         |          | æœ€åç™»å½•æ—¶é—´ |
| LastVisitCompanyId  | INT         | FK(companies.Id) | æœ€åæ“ä½œçš„å…¬å¸ID |
| Language  | VARCHAR(10) | DEFAULT 'zh' | ç”¨æˆ·è¯­è¨€åå¥½(zh/en) |
| PrivacyAccepted | TINYINT(1) | DEFAULT 0 | æ˜¯å¦åŒæ„éšç§åè®®(0=æœªåŒæ„ï¼Œ1=å·²åŒæ„) |
| PrivacyAcceptedAt | DATETIME | NULL    | åŒæ„éšç§åè®®çš„æ—¶é—´ |
| PrivacyVersion | VARCHAR(20) | NULL    | åŒæ„çš„éšç§åè®®ç‰ˆæœ¬å· |
| CreatedDate    | DATETIME    |         | åˆ›å»ºæ—¶é—´    |
| LastModifiedDate | DATETIME  |          | æœ€åæ›´æ–°æ—¶é—´ |

<a id="table-companies"></a>

- **companies**
  - **ç”¨é€”**:å­˜å‚¨å…¬å¸ä¿¡æ¯å’Œä¸»è¥ä¸šåŠ¡ã€‚

| å­—æ®µå          | ç±»å‹         | çº¦æŸ      | æè¿°                   |
|-----------------|--------------|-----------|------------------------|
| Id              | INT          | PK, AI    | å…¬å¸ID                 |
| TaxCode         | VARCHAR(30)  | NULL UNIQUE    | ç¨å·               |
| CompanyName     | VARCHAR(200) | NOT NULL  | å…¬å¸åç§°               |
| ProvinceId | INT | NOT NULL  | çœ                     |
| CityId     | INT | NOT NULL  | å¸‚                     |
| DistrictId | INT | NOT NULL  | åŒº                     |
| DetailAddress   | VARCHAR(200) |           | è¯¦ç»†åœ°å€               |
| IsNiSales         | TINYINT(1)   | DEFAULT 0 | ä¸»è¥ä¸šåŠ¡ - æ–°æ¢¯é”€å”®     |
| IsInstallation    | TINYINT(1)   | DEFAULT 0 | ä¸»è¥ä¸šåŠ¡ - ç”µæ¢¯å®‰è£…         |
| IsMaintenance     | TINYINT(1)   | DEFAULT 0 | ä¸»è¥ä¸šåŠ¡ - ç”µæ¢¯ä¿å…»         |
| IsModernization   | TINYINT(1)   | DEFAULT 0 | ä¸»è¥ä¸šåŠ¡ - ç”µæ¢¯æ”¹é€         |
| IsSpareparts      | TINYINT(1)   | DEFAULT 0 | ä¸»è¥ä¸šåŠ¡ - é…ä»¶é”€å”®      |
| NoOfMaintenanceUnits| INT          |           | ç»´ä¿è®¾å¤‡æ•°é‡ (ä»…åœ¨ç»´ä¿ä¸šåŠ¡æ—¶å¿…å¡«) |
| MainOperatingCities       | JSON         | NOT NULL  | ä¸»è¥ä¸šåŠ¡è¦†ç›–åŸå¸‚ï¼ˆå¤šé€‰ï¼‰ |
| CreatedDate     | DATETIME     |           | åˆ›å»ºæ—¶é—´               |
| CreatedBy     | INT     | FK(users.Id) | ç”¨æˆ·ID               |
| LastModifiedDate| DATETIME     |           | æœ€åæ›´æ–°æ—¶é—´           |
| LastModifiedBy     | INT     | FK(users.Id) | ç”¨æˆ·ID               |

<a id="table-user_company"></a>

- **user_company**
  - **ç”¨é€”**:ç”¨æˆ·ä¸å…¬å¸å…³è”å…³ç³»ã€‚

| å­—æ®µå         | ç±»å‹ | çº¦æŸ | æè¿°             |
|----------------|------|------|------------------|
| Id             | INT  | PK, AI | å…³è”ID        |
| UserId         | INT  | FK(users.Id) | ç”¨æˆ·ID     |
| CompanyId      | INT  | FK(companies.Id) | å…¬å¸ID  |
| contractId         | INT  | NULL | Viewç«¯è”ç³»äººId     |
| CustomerId      | INT  | NULL | Viewç«¯å…¬å¸ID  |
| Status | ENUM('pending', 'active', 'signed', 'declined')| DEFAULT 'pending' | å®¡æ ¸çŠ¶æ€ |
| RegisterChannel  | TINYINT(1)| DEFAULT 1  | æ³¨å†Œæ¸ é“ portalç«¯ or VIEWç«¯ |
| CreatedDate    | DATETIME     |        | åˆ›å»ºæ—¶é—´ |
| LastModifiedDate | DATETIME |  | æœ€åæ›´æ–°æ—¶é—´ |

<a id="table-registration_requests"></a>

- **registration_requests**
  - **ç”¨é€”**:Portalç«¯ç”¨æˆ·çš„æ³¨å†Œç”³è¯·å®¡æ‰¹è®°å½•ã€‚

| å­—æ®µå         | ç±»å‹         | çº¦æŸ | æè¿°                     |
|----------------|--------------|------|-------------------------|
| Id             | INT          | PK, AI | ç”³è¯·ID                |
| UserId         | INT          | FK(users.Id) | ç”¨æˆ·ID          |
| CompanyId      | INT          | FK(companies.Id) | å…¬å¸ID      |
| CustomerId      | INT  | NULL | Viewç«¯customer ID  |
| contractId         | INT  | NULL | Viewç«¯è”ç³»äººId     |
| Status         | ENUM('pending','approved','declineded')| DEFAULT 'pending' | å®¡æ ¸çŠ¶æ€ |
| SalesId    | INT  |        | å®¡æ ¸çš„é”€å”®          |
| SalesName    | VARCHAR(50)  |        | å®¡æ ¸çš„é”€å”®          |
| Remark         | TEXT         |        | å¤‡æ³¨                   |
| CreatedDate    | DATETIME     |        | åˆ›å»ºæ—¶é—´               |
| LastModifiedDate | DATETIME   |        | æœ€åæ›´æ–°æ—¶é—´           |

<a id="table-user_company_assignment"></a>

- **user_company_assignment**  
  - **ç”¨é€”**:å…³è”ç³»ç»Ÿç”¨æˆ·ï¼ˆUserï¼‰ã€å®¢æˆ·å…¬å¸ï¼ˆCompanyï¼‰ä¸é”€å”®äººå‘˜ï¼ˆSalesï¼‰ï¼Œè®°å½•ä¸‰æ–¹ç»‘å®šå…³ç³»ï¼Œå¹¶ç¼“å­˜é”€å”®äººå‘˜åŠå…¬å¸å…³é”®ä¿¡æ¯ç”¨äºå¿«é€ŸæŸ¥è¯¢æˆ–å†å²è¿½æº¯ã€‚

| å­—æ®µå               | ç±»å‹            | çº¦æŸ         | æè¿° |
|----------------------|-----------------|--------------|------|
| Id                   | INT            | PK, AI | å…³è”ID        |
| CompanyId            | INT             | NOT NULL     | å…¬å¸IDï¼Œå…³è” companies è¡¨ |
| UserId               | INT             | NOT NULL     | ç³»ç»Ÿç”¨æˆ·IDï¼Œå…³è” users è¡¨  |
| BranchId             | INT             | NULL         | åˆ†æ”¯æœºæ„ID |
| SalesId              | INT             | NOT NULL     | é”€å”®äººå‘˜ä¸šåŠ¡ID |
| LastName             | VARCHAR(100)    | NOT NULL     | é”€å”®äººå‘˜å§“æ° |
| FirstName            | VARCHAR(100)    | NOT NULL     | é”€å”®äººå‘˜åå­— |
| CompanyName          | VARCHAR(255)    | NOT NULL     | å…¬å¸åç§° |
| Email                | VARCHAR(255)    | NULL         | é”€å”®äººå‘˜é‚®ç®± |
| CompanyWebsite       | VARCHAR(255)    | NULL         | å…¬å¸å®˜ç½‘ |
| MobileCountryCode    | VARCHAR(10)     | NULL         | æ‰‹æœºå›½é™…åŒºå·ï¼ˆå¦‚ +86ï¼‰ |
| MobileNumber         | VARCHAR(20)     | NULL         | æ‰‹æœºå·ç  |
| Address              | VARCHAR(255)     | NULL         | åœ°å€ |

<a id="table-inquiries"></a>

- **inquiries**  
  - **ç”¨é€”**:å­˜å‚¨é—®è¯¢è®°å½•ï¼ŒPartneræ¿€æ´»å è¿ç§»è‡³Viewç«¯ inquiriesè¡¨ã€‚

| å­—æ®µå         | ç±»å‹        | çº¦æŸ | æè¿°          |
|----------------|-------------|------|---------------|
| Id             | INT         | PK, AI | é—®è¯¢ID      |
| UserId         | INT         | FK(users.Id) | å‘èµ·ç”¨æˆ·ID |
| CompanyId      | INT         | FK(companies.Id), NULL | å…³è”å…¬å¸ID |
| CategoryId     | INT         | FK(general_options.Id) | é—®é¢˜åˆ†ç±»IDï¼ˆ`OptionType = 'inquiry_category'`ï¼‰ |
| Content        | TEXT        | NOT NULL | é—®é¢˜å†…å®¹ |
| Status         | ENUM('open','rating','closed') | DEFAULT 'open' | é—®è¯¢çŠ¶æ€ |
| SalesResponse     | TEXT        |      | é”€å”®å›å¤å†…å®¹ |
| SalesId        | INT         |      | å›å¤é”€å”®ID |
| SalesName      | VARCHAR(50) |      | å›å¤é”€å”®åå­— |
| ResponseTime    | DATETIME    |      | å›å¤æ—¶é—´ |
| RatedTime      | DATETIME    |      | è¯„ä»·æ—¶é—´ |
| IsDeleted      | INT    |      | æ˜¯å¦åˆ é™¤ |
| CreatedDate    | DATETIME    |      | åˆ›å»ºæ—¶é—´ |
| LastModifiedDate | DATETIME  |      | æœ€åæ›´æ–°æ—¶é—´ |

<a id="table-inquiry_ratings"></a>

- **inquiry_ratings**  
  - **ç”¨é€”**:å­˜å‚¨é—®è¯¢çš„ç»“æ„åŒ–è¯„åˆ†æ˜ç»†ï¼Œæ¯æ¡è®°å½•å¯¹åº”ä¸€ä¸ªè¯„åˆ†ç»´åº¦ã€‚

| å­—æ®µå         | ç±»å‹        | çº¦æŸ | æè¿°          |
|----------------|-------------|------|---------------|
| Id             | INT         | PK, AI | è¯„åˆ†æ˜ç»†ID |
| InquiryId      | INT         | FK(inquiries.Id) | æ‰€å±é—®è¯¢ID |
| RatePerspectiveId    | INT         | FK(general_options.Id) | è¯„åˆ†ç»´åº¦IDï¼ˆ`OptionType = 'inquiry_rating_perspective'`ï¼‰ |
| Score          | TINYINT UNSIGNED | NOT NULL | è¯„åˆ†å€¼ï¼ˆ1-5ï¼‰ |
| RatedBy  | INT    | NOT NULL | è¯„ä»·äºº |
| RatedTime    | DATETIME    | NOT NULL | è¯„ä»·æ—¶é—´ |
| CreatedBy | INT | NOT NULL | åˆ›å»ºäººID |
| CreatedDate    | DATETIME    |      | åˆ›å»ºæ—¶é—´ |
| LastModifiedBy | INT | NOT NULL | æœ€åæ›´æ–°äºº |
| LastModifiedDate | DATETIME  |      | æœ€åæ›´æ–°æ—¶é—´ |

<a id="table-leads"></a>

- **leads**
  - **ç”¨é€”**:å­˜å‚¨å®¢æˆ·æä¾›çš„é¡¹ç›®ä¿¡æ¯, ç”¨æˆ·æ¿€æ´»å è¿ç§»è‡³Viewçš„Projectè¡¨ã€‚

| å­—æ®µå         | ç±»å‹        | çº¦æŸ | æè¿°          |
|----------------|-------------|------|---------------|
| Id             | INT         | PK, AI | é¡¹ç›®ID      |
| Name    | VARCHAR(200) | NOT NULL | é¡¹ç›®åç§° |
| UserId         | INT         | FK(users.Id) | åˆ›å»ºç”¨æˆ·ID |
| CompanyId      | INT         | FK(companies.Id), NULL | å…³è”å…¬å¸ID |
| BusinessLine | ENUM('ni','mod','serivce') | DEFAULT 'mod' | ä¸šåŠ¡èŒƒå›´ |
| ModernizationScope | ENUM('full_mod','partial_mod') | NOT NULL | æ”¹é€ èŒƒå›´ |
| Brand          | TINYINT(1) | NOT NULL | å“ç‰Œé€‰æ‹© 1 tke 2 å°šé€” |
| Province       | INT | NOT NULL | çœä»½ |
| City           | INT | NOT NULL | åŸå¸‚ |
| District       | INT | NOT NULL | åŒºå¿ |
| DetailAddress  | VARCHAR(200) |     | è¯¦ç»†åœ°å€ |
| UnitsCount     | INT         | NOT NULL | æ¢¯å°æ•° |
| ContractValue  | DECIMAL(15,2) | NOT NULL | åˆåŒé‡‘é¢ |
| ForecastTenderDate | DATE    | NOT NULL | é¢„è®¡æŠ¥ä»·æ—¥æœŸ |
| IsDeleted      | INT    |      | æ˜¯å¦åˆ é™¤ |
| CreatedDate    | DATETIME    |     | åˆ›å»ºæ—¶é—´ |
| LastModifiedDate | DATETIME  |     | æœ€åæ›´æ–°æ—¶é—´ |

<a id="table-librarys"></a>

- **librarys**  
  - **ç”¨é€”**:å­˜å‚¨TKE Libraryæ–‡ä»¶çš„å…³è”å…³ç³»å’Œæƒé™é…ç½®ã€‚

| å­—æ®µå | ç±»å‹ | çº¦æŸ | æè¿° |
|--------|------|------|------|
| Id | BIGINT | PK, AI | èŠ‚ç‚¹ID |
| ParentId | BIGINT | NULL | çˆ¶èŠ‚ç‚¹IDï¼ˆæŒ‡å‘æœ¬è¡¨Idï¼Œæ ¹èŠ‚ç‚¹ä¸ºNULLï¼‰ |
| NodeType | TINYINT | NOT NULL | 0=æ–‡ä»¶å¤¹, 1=æ–‡ä»¶ |
| Filename | VARCHAR(255) | NOT NULL | æ–‡ä»¶åæˆ–æ–‡ä»¶å¤¹åï¼ˆå¦‚ `Report_Exception.pdf`ï¼‰ |
| FileID | INT | NULL | æ–‡ä»¶IDï¼ˆä»…æ–‡ä»¶æœ‰æ•ˆï¼‰ |
| Visiability | ENUM('pending_partner', 'active_partner', 'signed_partner') | NOT NULL | Portalç«¯è®¿é—®çº§åˆ« |
| Rank | INT | DEFAULT 0 | åŒçº§èŠ‚ç‚¹æ’åºé¡ºåº |
| IsDeleted | TINYINT(1) | DEFAULT 0 | æ˜¯å¦åˆ é™¤ |
| Path | VARCHAR(2000) | NOT NULL | å®Œæ•´è·¯å¾„ |
| LibraryId | INT | UNIQUE, NOT NULL | View.Library.Idï¼ˆç”¨äºå¢é‡åŒæ­¥å¯¹é½ï¼‰ |
| CreatedBy | INT | NOT NULL | åˆ›å»ºäººID |
| CreatedDate | DATETIME | NOT NULL | åˆ›å»ºæ—¶é—´|
| LastModifiedBy | INT | NOT NULL | æœ€åæ›´æ–°äºº |
| LastModifiedDate | DATETIME | NOT NULL | æœ€åæ›´æ–°æ—¶é—´|

<a id="table-audit_log"></a>

- **audit_log**
  - **ç”¨é€”**:ç”¨äºè®°å½•ç”¨æˆ·åœ¨ç³»ç»Ÿå†…å„ç±»æ“ä½œä¸çŠ¶æ€å˜æ›´çš„æ—¥å¿—ã€‚

| å­—æ®µå | ç±»å‹ | çº¦æŸ | æè¿° |
|--------|------|------|------|
| Id | INT | PK, AI | å†å²è®°å½•ID |
| EntityType | VARCHAR(50) | NOT NULL | å®ä½“ç±»å‹ |
| EntityId | INT | NOT NULL | å®ä½“ID |
| OldValue | JSON | | ä¿®æ”¹å‰å€¼ |
| NewValue | JSON | | ä¿®æ”¹åå€¼ |
| ChangeType | ENUM('create','update','delete') | NOT NULL | å˜æ›´ç±»å‹ |
| ChangedInPortalBy | INT | FK(users.Id) | ä¿®æ”¹äººID |
| ChangedInViewBy | INT |  | VIEW user ID |
| CreatedDate | DATETIME | NOT NULL | åˆ›å»ºæ—¶é—´ |

```
// old_valueç¤ºä¾‹
{
    "FirstName": "å¼ ",
    "LastName": "ä¸‰",
    "Mobile": "13800138000",
    "taxCode": "91110105MA00B7GT2W",
    "DetailAddress": "åŒ—äº¬å¸‚æœé˜³åŒº"
    ...
}

// new_valueç¤ºä¾‹
{
    "FirstName": "æ",
    "LastName": "å››",
    "Mobile": "13900139000",
    "TaxCode": "91110105MA00B7GT2W",
    "DetailAddress": "ä¸Šæµ·å¸‚æµ¦ä¸œæ–°åŒº"
    ...
}
```

<a id="table-general_options"></a>

- **general_options**
  - **ç”¨é€”**:è¡¨ç”¨äºå­˜å‚¨ç³»ç»Ÿä¸­å„ç±»ä¸‹æ‹‰é€‰é¡¹ã€æšä¸¾å€¼å’Œé…ç½®é¡¹ã€‚

| å­—æ®µå | æ•°æ®ç±»å‹ | çº¦æŸ | æè¿° |
|--------|----------|------|------|
| Id | BIGINT | PRIMARY KEY, AUTO_INCREMENT | ä¸»é”®ID |
| OptionType | VARCHAR(50) NOT NULL | é€‰é¡¹åˆ†ç±»|
| Title | VARCHAR(100) | NOT NULL | é€‰é¡¹æ ‡é¢˜/åç§° |
| DefineSymbol | VARCHAR(50) | NOT NULL | é€‰é¡¹ä»£ç  |
| Value | VARCHAR(255) | NOT NULL | é€‰é¡¹æ˜¾ç¤ºå€¼ |
| Description | TEXT | NULL | é€‰é¡¹æè¿° |
| Rank | INT | DEFAULT 0 | æ’åºé¡ºåº |
| IsDefault | BOOLEAN | DEFAULT FALSE | æ˜¯å¦ä¸ºé»˜è®¤é€‰é¡¹ |
| IsActive | BOOLEAN | DEFAULT TRUE | æ˜¯å¦æ¿€æ´» |
| CreatedDate | DATETIME | NOT NULL | åˆ›å»ºæ—¶é—´ |
| LastModifiedDate | DATETIME | NOT NULL | æœ€åä¿®æ”¹æ—¶é—´ |

#### 8.1.2 Viewç«¯

<a id="table-mod_channel_partner_uploads"></a>

- **mod_channel_partner_uploads**
  - **ç”¨é€”**:å­˜å‚¨æ¸ é“å•†ä¸Šä¼ æ‰¹æ¬¡è®°å½•ï¼ŒåŒ…æ‹¬æ–‡ä»¶ä¿¡æ¯ã€å¤„ç†çŠ¶æ€å’Œé”™è¯¯æ±‡æ€»ã€‚

| å­—æ®µå | ç±»å‹ | çº¦æŸ | æè¿° |
|--------|------|------|------|
| Id | INT | PK, AI | ä¸Šä¼ è®°å½•ID |
| OriginalFileName | VARCHAR(255) | NOT NULL | åŸå§‹æ–‡ä»¶å |
| FailedFileName | VARCHAR(255) | NULL | ç»“æœæ–‡ä»¶å |
| TotalRecords | INT | NOT NULL | æ€»è®°å½•æ•° |
| SucceededRecords | INT | DEFAULT 0 | æˆåŠŸè®°å½•æ•° |
| FailedRecords | INT | DEFAULT 0 | å¤±è´¥è®°å½•æ•° |
| CreatedBy | INT | NOT NULL | åˆ›å»ºäººID |
| CreatedDate | DATETIME | NOT NULL | åˆ›å»ºæ—¶é—´ |
| LastModifiedBy | INT | NOT NULL | æœ€åæ›´æ–°äºº |
| LastModifiedDate | DATETIME | NOT NULL | æœ€åæ›´æ–°æ—¶é—´ |

<a id="table-mod_channel_partner_companies"></a>

- **mod_channel_partner_companies**
  - **ç”¨é€”**:å­˜å‚¨æ‰€æœ‰æ¸ é“å•†æ•°æ®Excelå¯¼å…¥çš„Partneræ•°æ®

| å­—æ®µå | ç±»å‹ | çº¦æŸ | æè¿° |
|--------|------|------|------|
| Id | INT | PK, AI | è®°å½•ID |
| PartnerUploadId | INT | FK(mod_channel_partner_uploads.Id), NULL | ä¸Šä¼ è®°å½•IDï¼ˆExcelå¯¼å…¥æ—¶æœ‰å€¼ï¼‰ |
| PortalCompanyId | INT | NULL | Portalç«¯å…¬å¸ID |
| CompanyName | VARCHAR(200) | NOT NULL | å…¬å¸åç§° |
| Taxcode | VARCHAR(30) | NULL | çº³ç¨äººè¯†åˆ«å· |
| BranchId | INT | NULL | BranchId |
| Province | INT | NOT NULL | çœä»½ |
| City | INT | NOT NULL | åŸå¸‚ |
| District | INT | NOT NULL | åŒºå¿ |
| DetailAddress   | VARCHAR(200) |           | è¯¦ç»†åœ°å€               |
| IsNiSales         | TINYINT(1)   | DEFAULT 0 | ä¸»è¥ä¸šåŠ¡ - æ–°æ¢¯é”€å”®     |
| IsInstallation    | TINYINT(1)   | DEFAULT 0 | ä¸»è¥ä¸šåŠ¡ - ç”µæ¢¯å®‰è£…         |
| IsMaintenance     | TINYINT(1)   | DEFAULT 0 | ä¸»è¥ä¸šåŠ¡ - ç”µæ¢¯ä¿å…»         |
| IsModernization         | TINYINT(1)   | DEFAULT 0 | ä¸»è¥ä¸šåŠ¡ - ç”µæ¢¯æ”¹é€         |
| IsSpareparts      | TINYINT(1)   | DEFAULT 0 | ä¸»è¥ä¸šåŠ¡ - é…ä»¶é”€å”®      |
| NoOfMaintenanceUnits| INT          |           | ç»´ä¿è®¾å¤‡æ•°é‡ (ä»…åœ¨ç»´ä¿ä¸šåŠ¡æ—¶å¿…å¡«) |
| MainOperatingCities       | JSON         | NOT NULL  | ä¸»è¥ä¸šåŠ¡è¦†ç›–åŸå¸‚ï¼ˆå¤šé€‰ï¼‰ |
| LegalRepresentative | VARCHAR(100) | NULL | æ³•å®šä»£è¡¨äºº |
| RegisteredCapital | VARCHAR(100) | NULL | æ³¨å†Œèµ„æœ¬ |
| EstablishmentDate | DATE | NULL | æˆç«‹æ—¥æœŸ |
| Website | VARCHAR(255) | NULL | ç½‘å€ |
| LatestAnnualReportAddress | VARCHAR(200) | NULL | æœ€æ–°å¹´æŠ¥åœ°å€ |
| OthercontractNumber | VARCHAR(200) | NULL | æ›´å¤šç”µè¯ |
| CooperationIntent |INT | NULL | åˆä½œæ„å‘ |
| Remarks | VARCHAR(200) | NULL | å¤‡æ³¨ |
| IsPortalRegistered | TINYINT(1) | NULL | æ˜¯å¦portalç«¯å·²ç»æ³¨å†Œ 0,1 |
| CreatedBy | INT | NOT NULL | åˆ›å»ºäººID |
| CreatedDate | DATETIME | NOT NULL | åˆ›å»ºæ—¶é—´ |
| LastModifiedBy | INT | NOT NULL | æœ€åæ›´æ–°äºº |
| LastModifiedDate | DATETIME | NOT NULL | æœ€åæ›´æ–°æ—¶é—´ |

<a id="table-mod_channel_partner_users"></a>

- **mod_channel_partner_users**
  - **ç”¨é€”**:å­˜å‚¨æ‰€æœ‰æ¸ é“å•†æ•°æ®Excelå¯¼å…¥çš„Partneræ•°æ®

| å­—æ®µå | ç±»å‹ | çº¦æŸ | æè¿° |
|--------|------|------|------|
| Id | INT | PK, AI | è®°å½•ID |
| CompanyId | INT | FK(mod_channel_partner_companies.Id),NULL | å…¬å¸ID |
| PortalUserId | INT | NULL | Portalç«¯ç”¨æˆ·ID |
| FirstName      | VARCHAR(50) | NOT NULL | å§“æ°       |
| LastName       | VARCHAR(50) | NOT NULL | åå­—       |
| Mobile          | VARCHAR(20) | UNIQUE   | æ‰‹æœºå·     |
| Email          | VARCHAR(100)|   NULL   | é‚®ç®±       |
| Role           | INT | NOT NULL | èŒåŠ¡       |
| HasPortalAccount | TINYINT(1) | DEFAULT 0 | æ˜¯å¦å¼€é€šPortalè´¦æˆ· |
| CreatedBy | INT | NOT NULL | åˆ›å»ºäººID |
| CreatedDate | DATETIME | NOT NULL | åˆ›å»ºæ—¶é—´ |
| LastModifiedBy | INT | NOT NULL | æœ€åæ›´æ–°äºº |
| LastModifiedDate | DATETIME | NOT NULL | æœ€åæ›´æ–°æ—¶é—´ |

<a id="table-mod_channel_registration_requests"></a>

- **mod_channel_registration_requests**
  - **ç”¨é€”**:Viewç«¯ç”¨æˆ·çš„æ³¨å†Œç”³è¯·å®¡æ‰¹è®°å½•ã€‚

| å­—æ®µå | ç±»å‹ | çº¦æŸ | æè¿° |
|--------|------|------|------|
| Id | INT  | PK, AI | å®¡æ‰¹è®°å½•ID |
| CompanyId | INT | NULL | ç”³è¯·çš„å…¬å¸ID |
| UserId | INT | NULL | ç”³è¯·çš„ç”¨æˆ·ID |
| CustomerId      | INT  | NULL | View customerid  |
| contractId       | INT  | NULL | View contractid  |
| RegisterChannel | TINYINT(1)| DEFAULT 1  | æ³¨å†Œæ¸ é“ Upload or Customer Approval |
| Status | ENUM('pending', 'active', 'declined')| DEFAULT 'pending' | å®¡æ ¸çŠ¶æ€ |
| DeclineReason  | INT | NULL | å®¡æ‰¹æ‹’ç»åŸå›  |
| CreatedBy      | INT | NOT NULL | åˆ›å»ºäººID |
| CreatedDate    | DATETIME | NOT NULL | åˆ›å»ºæ—¶é—´ |
| LastModifiedBy | INT | NOT NULL | æœ€åæ›´æ–°äºº |
| LastModifiedDate | DATETIME | NOT NULL | æœ€åæ›´æ–°æ—¶é—´ |

<a id="table-mod_channel_assignment_history"></a>

- **mod_channel_assignment_history**
  - **ç”¨é€”**:è®°å½•åˆ†é…é”€å”®å¾—æ—¥å¿—

| å­—æ®µå | ç±»å‹ | çº¦æŸ | æè¿° |
|--------|------|------|------|
| Id | INT | PK, AI | åˆ†é…å†å²ID |
| PartnerCompanyId | INT | FK(mod_channel_partner_companies.Id) | å…¬å¸ID |
| PortalCompanyId | INT | NULL | Portalç«¯å…¬å¸ID |
| AssignedSales | INT | NOT NULL | åˆ†é…çš„é”€å”®äººå‘˜ |
| RegisterChannel | TINYINT | NOT NULL | æ³¨å†Œæ¸ é“ portalç«¯ or VIEWç«¯ |
| CreatedBy | INT | NOT NULL | åˆ›å»ºäººID |
| CreatedDate | DATETIME | NOT NULL | åˆ›å»ºæ—¶é—´ |
| LastModifiedBy | INT | NOT NULL | æœ€åæ›´æ–°äºº |
| LastModifiedDate | DATETIME | NOT NULL | æœ€åæ›´æ–°æ—¶é—´ |

<a id="table-mod_channel_contract_bindings"></a>

- **mod_channel_contract_bindings**

| å­—æ®µå | ç±»å‹ | çº¦æŸ | æè¿° |
|--------|------|------|------|
| contractId | TINYINT(1) | DEFAULT 0 | æ³¨å†Œæ¸ é“ |
| PortalUserId | INT | NULL | Portalç”¨æˆ·ID |
| BusinessUserID |   VARCHAR(32) |   UNIQUE, NOT NULL  |  ç”¨æˆ·ç¼–ç  |
| RegisterChannel | TINYINT(1) | DEFAULT 0 | æ³¨å†Œæ¸ é“ Portal(1) or ViewUpload(2) or View add(0)  |

<a id="table-mod_channel_question_answers"></a>

- **mod_channel_question_answers**
  - **ç”¨é€”**:å­˜å‚¨é”€å”®å›ç­”çš„é—®é¢˜ç­”æ¡ˆã€‚

| å­—æ®µå | ç±»å‹ | çº¦æŸ | æè¿° |
|--------|------|------|------|
| Id | INT | PK, AI | è®°å½•ID |
| CompanyId | INT | NOT NULL | æäº¤æ‰¹æ¬¡IDï¼ˆå…³è”å®¡æ‰¹ç”³è¯·æˆ–æ£€æŸ¥ä»»åŠ¡ï¼‰ |
| CustomerId | INT | NOT NULL, FK(`customer.Id`) | å…¬å¸ID |
| TemplateId | INT | NOT NULL, FK(`general_checklist_template.Id`) | æ‰€å± checklist æ¨¡æ¿ID |
| SectionId | INT | NOT NULL, FK(`general_checklist_section.Id`) | æ‰€å±ç« èŠ‚ID |
| ItemId | INT | NOT NULL, FK(`general_checklist_item.Id`) | æ£€æŸ¥é¡¹ï¼ˆé—®é¢˜ï¼‰ID |
| OptionId | INT | NULL, FK(`general_checklist_option.Id`) | é€‰é¡¹IDï¼ˆä»…å½“é—®é¢˜ä¸ºå•é€‰/å¤šé€‰æ—¶ä½¿ç”¨ï¼‰ |
| AnswerText | VARCHAR(1000) | NULL | è‡ªç”±æ–‡æœ¬ç­”æ¡ˆï¼ˆç”¨äºæ–‡æœ¬ã€æ–‡ä»¶è¯´æ˜ç­‰ï¼‰ |
| CreatedBy | INT | NOT NULL | åˆ›å»ºäººï¼ˆé”€å”®IDï¼‰ |
| CreatedDate | DATETIME | NOT NULL DEFAULT CURRENT_TIMESTAMP | åˆ›å»ºæ—¶é—´ |
| LastModifiedBy | INT | NOT NULL | æœ€åæ›´æ–°äºº |
| LastModifiedDate | DATETIME | NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP | æœ€åæ›´æ–°æ—¶é—´ |

<a id="table-mod_channel_project_assignments"></a>

- **mod_channel_project_assignments**
  - **ç”¨é€”**:è®°å½•é¡¹ç›®åˆ†é…æ“ä½œè®°å½•ã€‚

| å­—æ®µå | ç±»å‹ | çº¦æŸ | æè¿° |
|--------|------|------|------|
| Id | INT | PK, AI | åˆ†é…è®°å½•ID |
| CustomerId | INT | NOT NULL | æ¸ é“å•†ID |
| contractId  | INT | FK(contracts.Id) | æ“ä½œçš„è”ç³»äºº(æ¥å—æ‹’ç») |
| ProjectCustomerType  | TINYINT | NOT NULL | Customerç±»å‹ Agent = 1/Distributor = 5 |
| ProjectId  | INT | NOT NULL | é¡¹ç›®ID |
| AssignedDate | DATETIME | NOT NULL | åˆ†é…æ—¶é—´ |
| AcceptanceStatus | ENUM('pending','accepted','declined','cancelled') | DEFAULT 'pending' | Agentsæ¥å—çŠ¶æ€ |
| ResponseDeadline | DATETIME | NULL | å“åº”æˆªæ­¢æ—¶é—´ï¼ˆ24å°æ—¶ï¼‰ |
| AssignmentReason | VARCHAR(200) | NULL | é¡¹ç›®åˆ†é…åŸå›  |
| RejectionReason | VARCHAR(500) | NULL | æ‹’ç»åŸå› è¯´æ˜ |
| OperatingTime | DATETIME | NULL | Partneræ“ä½œæ—¶é—´ |
| CreatedBy | INT | NOT NULL | åˆ›å»ºäººID |
| CreatedDate | DATETIME | NOT NULL | åˆ›å»ºæ—¶é—´ |
| LastModifiedBy | INT | NOT NULL | æœ€åæ›´æ–°äºº |
| LastModifiedDate | DATETIME | NOT NULL | æœ€åæ›´æ–°æ—¶é—´ |

<a id="table-mod_channel_inquiries"></a>

- **mod_channel_inquiries**  
  - **ç”¨é€”**:å­˜å‚¨Activeç”¨æˆ·çš„å’¨è¯¢å®Œæ•´ä¿¡æ¯ï¼Œæ¿€æ´»æ—¶ä»Portalç«¯åŒæ­¥ã€‚åŒ…å«å’¨è¯¢å†…å®¹ã€å›å¤ç­‰æ‰€æœ‰æ•°æ®ã€‚

| å­—æ®µå         | ç±»å‹        | çº¦æŸ | æè¿°          |
|----------------|-------------|------|---------------|
| Id             | INT         | PK, AI | å’¨è¯¢ID |
| CustomerId     | INT         | FK(customer.Id) | å…³è”å®¢æˆ·ID |
| contractId      | INT         | FK(contracts.Id) | å‘èµ·è”ç³»äººID |
| CategoryId     | INT         | FK(general_options.Id) | åˆ†ç±»IDï¼ˆ`OptionType = 'inquiry_category'`ï¼‰ |
| Content        | TEXT        | NOT NULL | å’¨è¯¢å†…å®¹ |
| Status         | ENUM('open','rating','closed') | DEFAULT 'open' | å’¨è¯¢çŠ¶æ€ |
| Reply          | TEXT        | NULL | å›å¤å†…å®¹ |
| RepliedBy      | INT         | FK(users.Id), NULL | å›å¤é”€å”®ID |
| RepliedDate    | DATETIME    | NULL | å›å¤æ—¶é—´ |
| RatedDate      | DATETIME    | NULL | è¯„ä»·æ—¶é—´ |
| RatingDeadline | DATETIME    | NULL | è¯„ä»·æˆªæ­¢æ—¶é—´ï¼ˆå›å¤å30å¤©ï¼‰ |
| AutoClosed     | TINYINT(1)  | DEFAULT 0 | æ˜¯å¦è‡ªåŠ¨å…³é—­ |
| ClosedDate     | DATETIME    | NULL | å…³é—­æ—¶é—´ |
| CreatedBy      | INT         | NOT NULL | åˆ›å»ºäººID |
| CreatedDate    | DATETIME    | NOT NULL | åˆ›å»ºæ—¶é—´ |
| LastModifiedBy | INT         | NOT NULL | æœ€åæ›´æ–°äºº |
| LastModifiedDate | DATETIME  | NOT NULL | æœ€åæ›´æ–°æ—¶é—´ |

<a id="table-mod_channel_inquiry_ratings"></a>

- **mod_channel_inquiry_ratings**  
  - **ç”¨é€”**:å­˜å‚¨å’¨è¯¢çš„ç»“æ„åŒ–è¯„åˆ†æ˜ç»†ï¼Œæ¯æ¡è®°å½•å¯¹åº”ä¸€ä¸ªè¯„åˆ†ç»´åº¦ã€‚

| å­—æ®µå         | ç±»å‹        | çº¦æŸ | æè¿°          |
|----------------|-------------|------|---------------|
| Id             | INT         | PK, AI | è¯„åˆ†æ˜ç»†ID |
| InquiryId      | INT         | FK(mod_channel_inquiries.Id) | æ‰€å±å’¨è¯¢ID |
| CriterionId    | INT         | FK(general_options.Id) | è¯„åˆ†ç»´åº¦IDï¼ˆ`OptionType = 'inquiry_rating_perspective'`ï¼‰ |
| Score          | TINYINT UNSIGNED | NOT NULL | è¯„åˆ†å€¼ï¼ˆ1-5ï¼‰ |
| RatedBy        | INT         | NOT NULL | è¯„ä»·äºº |
| RatedTime      | DATETIME    | NOT NULL | è¯„ä»·æ—¶é—´ |
| CreatedBy      | INT         | NOT NULL | åˆ›å»ºäººID |
| CreatedDate    | DATETIME    | NOT NULL | åˆ›å»ºæ—¶é—´ |
| LastModifiedBy | INT         | NOT NULL | æœ€åæ›´æ–°äºº |
| LastModifiedDate | DATETIME  | NOT NULL | æœ€åæ›´æ–°æ—¶é—´ |

<a id="table-mod_channel_library"></a>

- **mod_channel_library**
  - **ç”¨é€”**: TKEå¼€æ”¾ç»™ Portalç«¯ç”¨æˆ·èµ„æ–™å­˜å‚¨ æ–‡ä»¶nameæ ‡å‡† {filaname}_Exception   / {filaname}_å¼‚å¸¸

| å­—æ®µå | ç±»å‹ | çº¦æŸ | æè¿° |
|--------|------|------|------|
| Id | INT | PK, AI | èŠ‚ç‚¹ID |
| FileDirectoryStructureID | INT | NOT NULL | æ–‡ä»¶ç›®å½•ç»“æ„ID |
| FileID | INT | NULL | æ–‡ä»¶ID |
| NodeType | TINYINT |NOT NULL DEFAULT 1 | æ–‡ä»¶/æ–‡ä»¶å¤¹ |
| Visiability | ENUM('pending_partner', 'active_partner', 'signed_partner') | NOT NULL | Portalç«¯è®¿é—®çº§åˆ« |
| Rank | INT | DEFAULT 0 | åŒçº§èŠ‚ç‚¹æ’åºé¡ºåº |
| IsDeleted | TINYINT(1) | DEFAULT 0 | æ˜¯å¦åˆ é™¤ |
| CreatedBy | INT | NOT NULL | åˆ›å»ºäººID |
| CreatedDate | DATETIME | NOT NULL | åˆ›å»ºæ—¶é—´ |
| LastModifiedBy | INT | NOT NULL | æœ€åæ›´æ–°äºº |
| LastModifiedDate | DATETIME | NOT NULL | æœ€åæ›´æ–°æ—¶é—´ |

<a id="table-customer"></a>

- **customer (view å¯„å­˜ï¼‰**

| å­—æ®µå | ç±»å‹ | çº¦æŸ | æè¿° |
|--------|------|------|------|
| Id | INT | PK, AI | èŠ‚ç‚¹ID |
| PortalCompanyId | INT | NULL | Portalå…¬å¸ID (æ–°å¢) |
| RegisterChannel | TINYINT(1) | DEFAULT 0 | æ³¨å†Œæ¸ é“ Portal(1) or ViewUpload(2) or View add(0) (æ–°å¢) |

<a id="table-contract"></a>

- **contractï¼ˆview å¯„å­˜ï¼‰**

| å­—æ®µå | ç±»å‹ | çº¦æŸ | æè¿° |
|--------|------|------|------|
| Id | INT | PK, AI | ID |
| CustomerID | INT | NOT NULL | CustomerId |

<a id="table-customer_employee"></a>

- **customer_employee (view å¯„å­˜ï¼‰**

| å­—æ®µå | ç±»å‹ | çº¦æŸ | æè¿° |
|--------|------|------|------|
| CustomerID | INT | PK, AI | CustomerId  |
| EmployeeID | INT | PK, AI | SalesId |

<a id="table-project"></a>

- **project (view å¯„å­˜ï¼‰**

| å­—æ®µå | ç±»å‹ | çº¦æŸ | æè¿° |
|--------|------|------|------|
| Id | INT | PK, AI | ID |

<a id="table-project_customer"></a>

- **project_customer (view å¯„å­˜ï¼‰**

| å­—æ®µå | ç±»å‹ | çº¦æŸ | æè¿° |
|--------|------|------|------|
| Id | INT | PK, AI | ID |
| ProjectID | INT | NOT NULL | ProjectID |
| CustomerID | INT | NOT NULL | Customerid |
| ProjectCustomerType | TINYINT  | PK, AI | Customerç±»å‹ (1 agent) |

<a id="table-project_distributor"></a>

- **project_distributor (view å¯„å­˜ï¼‰**

| å­—æ®µå | ç±»å‹ | çº¦æŸ | æè¿° |
|--------|------|------|------|
| Id | INT | PK, AI | ID |
| CustomerID | INT | NOT NULL | Customerid |

<a id="table-projectbank"></a>

- **projectbank (view å¯„å­˜ï¼‰**

| å­—æ®µå | ç±»å‹ | çº¦æŸ | æè¿° |
|--------|------|------|------|
| Id | INT | PK, AI | ID |
| ProjectId | INT | NOT NULL | ProjectId |

<a id="table-projectbank_unitdetails"></a>

- **projectbank_unitdetails (view å¯„å­˜ï¼‰**

| å­—æ®µå | ç±»å‹ | çº¦æŸ | æè¿° |
|--------|------|------|------|
| Id | INT | PK, AI | ID |
| Bankid | INT | NOT NULL| BankId |
| ProjectId | INT | NOT NULL | ID |

#### 8.1.3 Portalç«¯&Viewç«¯ ERå…³ç³»å›¾

```plantuml
@startuml
' =============== å…¨å±€æ ·å¼ ===============
' ç§»é™¤ orthoï¼Œä½¿ç”¨é»˜è®¤æŠ˜çº¿
skinparam rectangle {
    BackgroundColor #FFFFFF
    BorderColor #000000
}
skinparam class {
    BorderColor #000000
    BackgroundColor #FEFECE
}

' =============== å·¦ä¾§:Portal åŸŸ ===============
rectangle "Portal" {
    class users <<P>> {
        + Id: PK
        + BusinessUserID: UK
        + Mobile: UK
        + Email
        + OpenId: UK
        + Status
        + LastVisitCompanyId: FK
    }

    class companies <<P>> {
        + Id: PK
        + TaxCode: UK
        + CompanyName
        + MainOperatingCities: JSON
    }

    class user_company <<P>> {
        + Id: PK
        + UserId: FK
        + CompanyId: FK
        + CustomerId
        + contractId
        + Status
    }

    class registration_requests <<P>> {
        + Id: PK
        + UserId: FK
        + CompanyId: FK
        + CustomerId
        + contractId
        + Status
    }
}

' =============== å³ä¾§:View åŸŸ ===============
rectangle "View" {
    class customer <<V>> {
        + Id: PK
        + Taxcode: UK
        + PortalCompanyId: UK
    }

    class contracts <<V>> {
        + Id: PK
        + MobileNumber: UK
        + PortalUserId: UK
        + CustomerId: FK
    }

    class mod_channel_partner_uploads <<V>> {
        + Id: PK
        + OriginalFileName
        + TotalRecords
    }

    class mod_channel_partner_companies <<V>> {
        + Id: PK
        + PartnerUploadId: FK
        + Taxcode: UK
        + PortalCompanyId
        + IsPortalRegistered
    }

    class mod_channel_partner_users <<V>> {
        + Id: PK
        + CompanyId: FK
        + PortalUserId
        + Mobile: UK
        + HasPortalAccount
    }

    class mod_channel_registration_requests <<V>> {
        + Id: PK
        + CompanyId
        + UserId
        + CustomerId
        + contractId
        + RegisterChannel
        + Status
        + DeclineReason
    }
}

' =============== é»‘è‰²å®çº¿:çœŸå®å¤–é”® ===============
mod_channel_partner_uploads --> mod_channel_partner_companies
mod_channel_partner_companies --> mod_channel_partner_users
customer --> contracts

' =============== çº¢è‰²è™šçº¿:ä¸€æ¬¡æ€§åŒæ­¥ï¼ˆå®¡æ‰¹/æ¿€æ´»ï¼‰ ===============
mod_channel_partner_companies ..> customer : Active>åˆ›å»º/æ¿€æ´»
mod_channel_partner_users ..> contracts : Active>åˆ›å»º
registration_requests ..> mod_channel_registration_requests : ç”³è¯·æäº¤
mod_channel_registration_requests ..> registration_requests : å®¡æ‰¹ç»“æœå›å†™
mod_channel_registration_requests ..> customer : å…³è”æ­£å¼Customer
mod_channel_registration_requests ..> contracts : å…³è”æ­£å¼contract
user_company ..> mod_channel_registration_requests : å…³è”å®¡æ‰¹è®°å½•

' =============== ç»¿è‰²è™šçº¿:åç»­å˜æ›´åŒæ­¥ ===============
customer ..> companies : Manageç¼–è¾‘>åŒæ­¥Portal Company
contracts ..> users : Manageæ”¹æ‰‹æœºå·>åŒæ­¥å¹¶æ¸…ç©ºopenid
companies ..> customer : Portalæ”¹å…¬å¸>ä»…å¿«ç…§ï¼ˆæé†’ç”¨ï¼‰

note right of customer
  **1:1 åŒæ­¥è§„åˆ™**:
  - View.customer æ˜¯ä¸»æ•°æ®
  - ç¼–è¾‘æ—¶åŒæ­¥ Portal.companies
  - Portal.companies å˜æ›´ä¸è¦†ç›– customer
end note

note right of contracts
  **å…³è”è§„åˆ™**:
  - contracts.PortalUserId â†” users.Id
  - user_company è¡¨ç»´æŠ¤ User-Company-contract æ˜ å°„
end note

@enduml
```

### 8.2 é‚®ä»¶é€šçŸ¥è§„åˆ™

| è§¦å‘æ¡ä»¶                  | æ¥æ”¶å¯¹è±¡                | é‚®ä»¶å†…å®¹|
|---------------------------|-------------------------|--------------------------|
| æ‰«æå…¬å¸äºŒç»´ç æ³¨å†Œ              | åˆ†å…¬å¸é”€å”®ç»ç†åˆ†é…é”€å”®          | å¾…å®š |
| æ‰«æå…¬å¸äºŒç»´ç æ³¨å†Œ | åˆ†å…¬å¸é”€å”®ç»ç†åˆ†é…é”€å”®              | å¾…å®š |
| é€šè¿‡æ‰«æé”€å”®äºŒç»´ç è¿›è¡Œæ³¨å†Œ | é”€å”®äººå‘˜å‘é€é€šçŸ¥  | å¾…å®š |
| æ¯æ—¥æé†’ å¾…åˆ†é…é”€å”®çš„æ•°æ® | åˆ†å…¬å¸é”€å”®ç»ç†  |å¾…å®š |
| æ¯æ—¥æé†’ åˆ†é…å¾…å¤„ç†çš„è¯·æ±‚ | é”€å”®äººå‘˜  | å¾…å®š |
| New inquiry notice | åˆ†å…¬å¸é”€å”®ç»ç†æˆ–è€…é”€å”®  |
| partneråˆ›å»ºçš„é¡¹ç›®é€šçŸ¥ï¼ˆå¦‚æœæœ‰å¤šä¸ªé”€å”®ï¼Œé»˜è®¤ç¬¬ä¸€ä¸ªé”€å”®ä¸ºä¸»é”€å”®ï¼Œç”¨æˆ·çŠ¶æ€æ—¶activeï¼‰ã€‚ | é”€å”®äººå‘˜  | å¾…å®š |
| partneræ¥å—é¡¹ç›®é€šçŸ¥ | é”€å”®äººå‘˜  | å¾…å®š |
| é¡¹ç›®24å°æ—¶åè‡ªåŠ¨å–æ¶ˆé€šçŸ¥æ— å“åº” | é”€å”®äººå‘˜  | å¾…å®š |
| partneré€šçŸ¥æ‹’ç»é¡¹ç›® | é”€å”®äººå‘˜  | å¾…å®š |

### 8.3 å¾®ä¿¡æ¨é€é€šçŸ¥è§„åˆ™

| è§¦å‘æ¡ä»¶                  | æ¨¡æ¿å†…å®¹ |
|---------------------------|-----------------------------|
| ç”¨æˆ·å…³æ³¨TKEæœåŠ¡å¸æˆ·æ—¶çš„æ¬¢è¿æ¶ˆæ¯ | å¾…å®š |
| TKEæ¥å—å¸æˆ·æ³¨å†Œé€šçŸ¥ | å¾…å®š |
| è¯¢ä»·å›å¤é€šçŸ¥ | å¾…å®š |
| æŒ‡å®šé¡¹ç›®é€šçŸ¥ | å¾…å®š |

### 8.4 Portalç«¯APIå“åº”æ ¼å¼å®Œæ•´è§„èŒƒ

#### 8.4.1 ç»Ÿä¸€å“åº”æ ¼å¼

æ‰€æœ‰APIæ¥å£é‡‡ç”¨ç»Ÿä¸€çš„JSONå“åº”æ ¼å¼:

```json
{
  "code": 200,
  "message": "æ“ä½œæˆåŠŸ",
  "data": {},
  "timestamp": "2025-10-11T14:30:05Z"
}
```

#### 8.4.2 ä¸šåŠ¡çŠ¶æ€ç å®Œæ•´å®šä¹‰

**æˆåŠŸçŠ¶æ€ç **

- `200`: æ“ä½œæˆåŠŸ

**é€šç”¨é”™è¯¯ (1000-1999)**

- `1001`: å‚æ•°ç¼ºå¤±
- `1002`: å‚æ•°æ ¼å¼é”™è¯¯
- `1003`: æ•°æ®éªŒè¯å¤±è´¥
- `1004`: æ“ä½œå¤±è´¥
- `1005`: æ•°æ®ä¸å­˜åœ¨
- `1006`: æ•°æ®é‡å¤
- `1007`: è¯·æ±‚é¢‘ç‡è¿‡å¿«
- `1008`: æ–‡ä»¶ä¸Šä¼ å¤±è´¥
- `1009`: æ–‡ä»¶æ ¼å¼ä¸æ”¯æŒ
- `1010`: æ–‡ä»¶å¤§å°è¶…é™

**å¾®ä¿¡ç›¸å…³ (2000-2099)**

- `2001`: å¾®ä¿¡æˆæƒå¤±è´¥
- `2002`: è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥
- `2003`: openidæ— æ•ˆ
- `2004`: å¾®ä¿¡æ¥å£è°ƒç”¨å¤±è´¥
- `2005`: å¾®ä¿¡æ¶ˆæ¯å‘é€å¤±è´¥

**ç”¨æˆ·è®¤è¯ç›¸å…³ (3000-3099)**

- `3001`: æœªç™»å½•
- `3002`: ç™»å½•å·²è¿‡æœŸ
- `3003`: æ— æƒé™è®¿é—®
- `3004`: è´¦å·è¢«ç¦ç”¨
- `3005`: è´¦å·æœªæ¿€æ´»
- `3006`: tokenæ— æ•ˆ
- `3007`: tokenå·²è¿‡æœŸ

**çŸ­ä¿¡éªŒè¯ç›¸å…³ (3100-3199)**

- `3101`: éªŒè¯ç é”™è¯¯
- `3102`: éªŒè¯ç å·²è¿‡æœŸ
- `3103`: éªŒè¯ç å‘é€å¤±è´¥
- `3104`: éªŒè¯ç å‘é€è¿‡äºé¢‘ç¹
- `3105`: éªŒè¯ç å·²ä½¿ç”¨
- `3106`: æ‰‹æœºå·æ ¼å¼é”™è¯¯

**ç”¨æˆ·ç®¡ç†ç›¸å…³ (4000-4099)**

- `4001`: æ‰‹æœºå·å·²å­˜åœ¨
- `4002`: ç”¨æˆ·ä¸å­˜åœ¨
- `4003`: ç”¨æˆ·ä¿¡æ¯ä¸å®Œæ•´
- `4004`: ç”¨æˆ·çŠ¶æ€å¼‚å¸¸
- `4005`: ä¿®æ”¹ä¸ªäººä¿¡æ¯å¤±è´¥

**å…¬å¸ç®¡ç†ç›¸å…³ (4100-4199)**

- `4101`: å…¬å¸åç§°å·²å­˜åœ¨
- `4102`: ç¨å·å·²å­˜åœ¨
- `4103`: å…¬å¸ä¿¡æ¯ä¸å®Œæ•´
- `4104`: å…¬å¸å®¡æ ¸æœªé€šè¿‡

**é—®è¯¢ç›¸å…³ (5000-5099)**

- `5001`: é—®è¯¢æäº¤å¤±è´¥
- `5002`: é—®è¯¢ä¸å­˜åœ¨
- `5003`: é—®è¯¢çŠ¶æ€ä¸å…è®¸æ“ä½œ
- `5004`: é—®è¯¢å·²å…³é—­
- `5005`: è¯„ä»·æäº¤å¤±è´¥
- `5006`: å·²è¯„ä»·ä¸èƒ½é‡å¤è¯„ä»·

**é¡¹ç›®ç®¡ç†ç›¸å…³ (5100-5199)**

- `5101`: é¡¹ç›®åˆ›å»ºå¤±è´¥
- `5102`: é¡¹ç›®ä¸å­˜åœ¨
- `5103`: é¡¹ç›®çŠ¶æ€ä¸å…è®¸ä¿®æ”¹
- `5104`: é¡¹ç›®å·²é”å®š
- `5105`: é¡¹ç›®ä¿¡æ¯ä¸å®Œæ•´

**TKE Libraryç›¸å…³ (5200-5299)**

- `5201`: TKEé¡¹ç›®åˆ†é…å¤±è´¥
- `5202`: TKEé¡¹ç›®å·²è¿‡æœŸ
- `5203`: TKEé¡¹ç›®å“åº”å¤±è´¥
- `5204`: æ–‡ä»¶ä¸‹è½½å¤±è´¥
- `5205`: æ–‡ä»¶è®¿é—®æƒé™ä¸è¶³

**åœ°å€æ•°æ®ç›¸å…³ (6000-6099)**

- `6001`: åœ°å€æ•°æ®è·å–å¤±è´¥
- `6002`: åœ°å€çº§åˆ«é”™è¯¯

**AGRä¸“ç”¨çŠ¶æ€ç  (7000-7099)**

- `7001`: AGRå…¬å¸ä¸å­˜åœ¨
- `7002`: AGRæƒé™ä¸è¶³
- `7003`: è·³è½¬è®¤è¯å¤±è´¥
- `7004`: Viewç³»ç»Ÿä¸å¯ç”¨
- `7005`: Viewä¼šè¯å·²è¿‡æœŸ
- `7006`: è¿”å›è®¤è¯å¤±è´¥
- `7007`: AGRè·³è½¬ä»¤ç‰Œæ— æ•ˆ
- `7008`: AGRä¼šè¯åˆ›å»ºå¤±è´¥

**ç³»ç»Ÿç›¸å…³ (9000-9999)**

- `9001`: ç³»ç»Ÿç»´æŠ¤ä¸­
- `9002`: æœåŠ¡æš‚æ—¶ä¸å¯ç”¨
- `9003`: æ¥å£ä¸å­˜åœ¨
- `9999`: ç³»ç»ŸæœªçŸ¥é”™è¯¯

#### 8.4.3 å‰ç«¯å¤„ç†ç¤ºä¾‹

```javascript
// axioså“åº”æ‹¦æˆªå™¨
axios.interceptors.response.use(
  response => {
    const { code, message, data } = response.data;
    
    if (code === 200) {
      // æˆåŠŸï¼Œè¿”å›æ•°æ®
      return data;
    } else if (code === 3001 || code === 3002) {
      // æœªç™»å½•æˆ–ç™»å½•è¿‡æœŸï¼Œè·³è½¬ç™»å½•
      router.push('/login');
      showToast(message);
      return Promise.reject(new Error(message));
    } else {
      // å…¶ä»–ä¸šåŠ¡é”™è¯¯ï¼Œæ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
      showToast(message);
      return Promise.reject(new Error(message));
    }
  },
  error => {
    // ç½‘ç»œé”™è¯¯æˆ–æœåŠ¡å™¨é”™è¯¯
    showToast('ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•');
    return Promise.reject(error);
  }
);
```

#### 8.4.4 Portalç«¯ API æ¥å£å“åº”ç¤ºä¾‹(VUE)

**ç”¨æˆ·ç™»å½•æˆåŠŸå“åº”**

```json
{
  "code": 200,
  "message": "ç™»å½•æˆåŠŸ",
  "data": {
    "token": "1|abcdef123456...",
    "userInfo": {
      "userId": 123,
      "firstName": "å¼ ä¸‰",
      "mobile": "13800138000",
    },
    "permissions": {
      "canCreateProject": true,
      "canSubmitInquiry": true
    }
  },
  "timestamp": "2025-10-11T14:30:05Z"
}
```

**å‚æ•°é”™è¯¯å“åº”**

```json
{
  "code": 1002,
  "message": "æ‰‹æœºå·æ ¼å¼é”™è¯¯",
  "data": null,
  "timestamp": "2025-10-11T14:30:05Z"
}
```

**æƒé™ä¸è¶³å“åº”**

```json
{
  "code": 3003,
  "message": "æ‚¨æ²¡æœ‰æƒé™è®¿é—®æ­¤åŠŸèƒ½",
  "data": null,
  "timestamp": "2025-10-11T14:30:05Z"
}
```

**åˆ†é¡µæ•°æ®å“åº”**

```json
{
  "code": 200,
  "message": "è·å–æˆåŠŸ",
  "data": {
    "list": [
      {
        "id": 1,
        "title": "é—®è¯¢æ ‡é¢˜",
        "status": "replied",
        "createdDate": "2025-01-01 10:00:00"
      }
    ],
    "pagination": {
      "total": 100,
      "currentPage": 1,
      "pageSize": 10,
      "totalPages": 10
    }
  },
  "timestamp": "2025-10-11T14:30:05Z"
}
```

#### 8.4.5 Portal ä¸ CNView åŒå‘ API æ¥å£æ¸…å•

##### 8.4.5.1 Portal æä¾›ç»™ CNView çš„ APIï¼ˆCNView è°ƒç”¨ Portalï¼‰

- **è¯·æ±‚/å“åº”ç¤ºä¾‹**

**1. æ‹‰å–ç”¨æˆ·æ¡£æ¡ˆ**

```http
GET /api/intersystem/user-profile/101 HTTP/1.1
X-API-Key: your-secret-key
```

```json
{
  "success": true,
  "userInfo": {
    "portalUserId": 101,
    "firstName": "å¼ ",
    "lastName": "ä¸‰",
    "mobile": "13800138000",
    "email": "zhangsan@example.com",
    "openId": "oAbc123",
    "status": "inactive"
  },
  "companyInfo": {
    "companyName": "ABCç”µæ¢¯å…¬å¸",
    "taxCode": "91310101MA1FL12345",
    "mainOperatingCities": ["110000", "310000"]
  }
}
```

**2. æ‹‰å–é—®è¯¢åˆ—è¡¨**

```http
POST /api/intersystem/inquiries HTTP/1.1
X-API-Key: your-secret-key
Content-Type: application/json

{
  "portalCompanyId": 201,
  "statusFilter": "open",
  "page": 1,
  "pageSize": 50
}
```

```json
{
  "success": true,
  "inquiries": [
    {
      "portalInquiryId": 501,
      "title": "ç”µæ¢¯å™ªéŸ³é—®é¢˜",
      "content": "è¿è¡Œæ—¶å™ªéŸ³è¿‡å¤§",
      "status": "open",
      "createdDate": "2025-10-11T10:00:00Z"
    }
  ],
  "total": 1
}
```

**3. æ‹‰å–é¡¹ç›®åˆ—è¡¨**

```http
POST /api/intersystem/projects HTTP/1.1
X-API-Key: your-secret-key
Content-Type: application/json

{
  "portalCompanyId": 201,
  "statusFilter": "Pre-Lead",
  "page": 1,
  "pageSize": 20
}
```

```json
{
  "success": true,
  "projects": [
    {
      "portalProjectId": 701,
      "projectName": "ä¸‡è¾¾å¹¿åœºç”µæ¢¯æ”¹é€ ",
      "contractValue": 500000.00,
      "currency": "CNY",
      "createdDate": "2025-10-11T09:00:00Z"
    }
  ],
  "total": 1
}
```

##### 8.4.5.2 CNView æä¾›ç»™ Portal çš„ APIï¼ˆPortal è°ƒç”¨ CNViewï¼‰

- **è¯·æ±‚/å“åº”ç¤ºä¾‹**

**1. æ¨é€å®¡æ‰¹ç»“æœ**

```json
{
  "dataType": "approvalResult",
  "dataPayload": {
    "approvalAction": "approved",
    "portalUserId": 101,
    "portalCompanyId": 201,
    "approvalReason": "èµ„è´¨ç¬¦åˆè¦æ±‚",
    "approvalDate": "2025-10-11T12:00:00Z"
  },
  "sourceSystem": "CNView",
  "timestamp": "2025-10-11T12:00:05Z"
}
```

**2. æ¨é€é—®è¯¢å›å¤**

```json
{
  "dataType": "inquiryReply",
  "dataPayload": {
    "portalInquiryId": 501,
    "replyContent": "å»ºè®®æ£€æŸ¥æ›³å¼•æœºæ¶¦æ»‘æƒ…å†µ",
    "repliedBy": 301,
    "repliedName": "å¼ é”€å”®",
    "repliedDate": "2025-10-11T14:30:00Z"
  },
  "sourceSystem": "CNView",
  "timestamp": "2025-10-11T14:30:05Z"
}
```

**3. æ¨é€ç”¨æˆ·çŠ¶æ€å˜æ›´**

```json
{
  "dataType": "userStatusUpdate",
  "dataPayload": {
    "portalUserId": 101,
    "portalCompanyId": 201,
    "newcontractStatus": "active",
    "effectiveDate": "2025-10-11T10:00:00Z",
    "changedBy": 301
  },
  "sourceSystem": "CNView",
  "timestamp": "2025-10-11T10:00:05Z"
}
```

**4. æ¨é€ç”¨æˆ·æ³¨é”€é€šçŸ¥**

```json
{
  "dataType": "userDeactivation",
  "dataPayload": {
    "portalUserId": 101,
    "portalCompanyId": 201,
    "deactivationReason": "manual_unbind",
    "deactivatedBy": 301
  },
  "sourceSystem": "CNView",
  "timestamp": "2025-10-11T16:00:05Z"
}
```

**é€šç”¨å“åº”æ ¼å¼**

```json
{
  "success": true,
  "message": "æ•°æ®æ¥æ”¶æˆåŠŸ"
}
```

##### 8.4.5.3 Portal ä¸»åŠ¨æ¨é€æ•°æ®åˆ° CNView çš„ APIï¼ˆPortal è°ƒç”¨ CNViewï¼‰

| åºå· | ä¸šåŠ¡åœºæ™¯                 | dataType                | æ¨é€æ—¶æœº                     |
|------|--------------------------|-------------------------|------------------------------|
| 1    | ç”¨æˆ·æ³¨å†Œç”³è¯·             | `user_registration`     | ç”¨æˆ·å®Œæˆæ³¨å†Œè¡¨å•æäº¤æ—¶       |
| 2    | æ¿€æ´»ç”¨æˆ·å†å²æ•°æ®è¿ç§»     | `user_activation_data`  | VIEWç«¯é”€å”®å®¡æ‰¹é€šè¿‡æ—¶         |
| 3    | æ¿€æ´»ç”¨æˆ·é—®è¯¢æäº¤         | `inquiry_create`        | å·²æ¿€æ´»ç”¨æˆ·å‘èµ·æ–°é—®è¯¢æ—¶       |
| 4    | é—®è¯¢è¯„ä»·ç»“æœåŒæ­¥         | `inquiry_rating`        | ç”¨æˆ·å®Œæˆé—®è¯¢è¯„ä»·æ—¶           |
| 5    | æ¿€æ´»ç”¨æˆ·é¡¹ç›®æ“ä½œ         | `project_update`        | å·²æ¿€æ´»ç”¨æˆ·æ–°å»º/ç¼–è¾‘é¡¹ç›®æ—¶    |
| 6    | TKEé¡¹ç›®å¤„ç†ç»“æœ          | `project_response`      | ç”¨æˆ·æ¥å—/æ‹’ç»TKEé¡¹ç›®æ—¶       |

- **ç»Ÿä¸€æ¨é€ç«¯ç‚¹**

- **å½’å±æ–¹**:CNView  
- **ç«¯ç‚¹**:`POST /api/modchannel/receive`  
- **è®¤è¯æ–¹å¼**:API Keyï¼ˆé€šè¿‡ `X-API-Key` Header ä¼ é€’ï¼‰  
- **Content-Type**:`application/json`

- **é€šç”¨è¯·æ±‚ envelope ç»“æ„**

```json
{
  "dataType": "string",
  "dataPayload": { /* ä¸šåŠ¡æ•°æ® */ },
  "sourceSystem": "Portal",
  "timestamp": "ISO8601"
}
```

- **å…·ä½“æ¨é€ç¤ºä¾‹**

**1. ç”¨æˆ·æ³¨å†Œç”³è¯·**

```json
{
  "dataType": "user_registration",
  "dataPayload": {
    "portalUserId": 123,
    "firstName": "å¼ ",
    "lastName": "ä¸‰",
    "mobile": "13800138000",
    "email": "zhang@example.com",
    "openId": "oAbc123",
    "companyInfo": {
      "companyName": "ABCç”µæ¢¯å…¬å¸",
      "taxCode": "91310101MA12345678",
      "province": 110000,
      "city": 110100,
      "district": 110105,
      "mainOperatingCities": ["110000", "310000"]
    },
    "salesId": 456
  },
  "sourceSystem": "Portal",
  "timestamp": "2025-10-11T10:30:00Z"
}
```

**2. é—®è¯¢åˆ›å»ºï¼ˆæ¿€æ´»ç”¨æˆ·ï¼‰**

```json
{
  "dataType": "inquiry_create",
  "dataPayload": {
    "portalInquiryId": 456,
    "portalUserId": 123,
    "portalCompanyId": 789,
    "categoryId": 1,
    "content": "ç”µæ¢¯å™ªéŸ³è¿‡å¤§ï¼Œå¦‚ä½•è§£å†³ï¼Ÿ"
  },
  "sourceSystem": "Portal",
  "timestamp": "2025-10-11T13:00:00Z"
}
```

**3. TKEé¡¹ç›®å¤„ç†ç»“æœ**

```json
{
  "dataType": "project_response",
  "dataPayload": {
    "portalProjectId": 1001,
    "portalUserId": 123,
    "action": "accept",
    "responseTime": "2025-10-11T17:00:00Z"
  },
  "sourceSystem": "Portal",
  "timestamp": "2025-10-11T17:00:05Z"
}
```

- **é€šç”¨å“åº”æ ¼å¼**

```json
{
  "success": true,
  "message": "æ•°æ®æ¥æ”¶æˆåŠŸ"
}
```
